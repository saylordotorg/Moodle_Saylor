{"version":3,"file":"vplvnc.min.js","sources":["../src/vplvnc.js"],"sourcesContent":["// This file is part of VPL for Moodle - http://vpl.dis.ulpgc.es/\n//\n// VPL for Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// VPL for Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with VPL for Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * VNC client control\n *\n * @copyright 2014 Juan Carlos Rodríguez-del-Pino\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @author Juan Carlos Rodríguez-del-Pino <jcrodriguez@dis.ulpgc.es>\n */\n\n/* globals RFB */\n/* globals Util */\n\ndefine(\n    [\n        'jquery',\n        'jqueryui',\n        'mod_vpl/vplutil',\n        'mod_vpl/vplclipboard',\n        'core/log'\n    ],\n    function($, jqui, VPLUtil, VPLClipboard, console) {\n        window.INCLUDE_URI = \"../editor/noVNC/include/\";\n        /**\n         * Load VNC Script after the Util (\"util.js\" is loaded\n         */\n        function loadVNCScripts() {\n            if (typeof Util == 'undefined') {\n                VPLUtil.delay('loadVNCScripts', loadVNCScripts);\n            } else {\n                Util.load_scripts([\"webutil.js\", \"base64.js\", \"websock.js\", \"des.js\",\n                \"keysymdef.js\", \"keyboard.js\", \"input.js\", \"display.js\",\n                \"jsunzip.js\", \"rfb.js\", \"keysym.js\"]);\n            }\n        }\n        VPLUtil.delay('loadVNCScripts', loadVNCScripts);\n        var VPLVNCClient = function(VNCDialogId, str) {\n            var self = this;\n            var rfb;\n            var title = '';\n            var message = '';\n            var lastState = '';\n            var VNCDialog = $('#' + VNCDialogId);\n            var canvas = $('#' + VNCDialogId + \" canvas\");\n            var onCloseAction = VPLUtil.doNothing;\n            var clipboard;\n            var needResize = true;\n            var titleText;\n            var inputarea = window.document.createElement('input');\n            inputarea.style.position = 'absolute';\n            inputarea.style.left = '0px';\n            inputarea.style.top = '-10000px';\n            inputarea.style.width = '1em';\n            inputarea.style.height = '1ex';\n            inputarea.style.opacity = '0';\n            inputarea.style.backgroundColor = 'transparent';\n            inputarea.style.borderStyle = 'none';\n            inputarea.style.outlineStyle = 'none';\n            inputarea.autocapitalize = 'off';\n            inputarea.autocomplete = 'off';\n            inputarea.autocorrect = 'off';\n            inputarea.wrap = 'off';\n            inputarea.spellcheck = 'false';\n            VNCDialog.append(inputarea);\n            /**\n             * Event handler of keyboard button.\n             */\n            function keyboardButton() {\n                if ($(inputarea).is(':focus')) {\n                    inputarea.blur();\n                } else {\n                    inputarea.focus();\n                }\n            }\n            /**\n             * Event handler of paste button at clipboard.\n             */\n            function pasteClipboard() {\n                if (self.isConnected()) {\n                    rfb.clipboardPasteFrom(clipboard.getEntry2());\n                }\n            }\n            /**\n             * Event handler of paste button at clipboard.\n             *\n             * @param {object} rfb vnc client object\n             * @param {string} text Text received\n             */\n            function receiveClipboard(rfb, text) {\n                clipboard.setEntry1(text);\n            }\n            /**\n             * Event handler of clipboard button.\n             */\n            function openClipboard() {\n                clipboard.show();\n            }\n            /**\n             * Inform rfb of focus received.\n             */\n            function getFocus() {\n                if (self.isConnected()) {\n                    rfb.get_keyboard().set_focused(true);\n                }\n            }\n            /**\n             * Inform rfb of focus lost.\n             */\n            function lostFocus() {\n                if (self.isConnected()) {\n                    rfb.get_keyboard().set_focused(false);\n                }\n            }\n            /**\n             * Tries to do a copy.\n             */\n            function copyAction() {\n                clipboard.setEntry1(clipboard.getEntry1());\n                document.execCommand('copy');\n            }\n            var HTMLUpdateClipboard = VPLUtil.genIcon('copy', 'sw') + ' ' + str('copy');\n            var HTMLPaste = VPLUtil.genIcon('paste', 'sw') + ' ' + str('paste');\n            clipboard = new VPLClipboard('vpl_dialog_vnc_clipboard', HTMLUpdateClipboard, copyAction, HTMLPaste, pasteClipboard,\n                    lostFocus);\n            canvas.on('click', function(e) {\n                if (e.target == canvas[0]) {\n                    getFocus();\n                } else {\n                    lostFocus();\n                }\n            });\n            this.displayResize = function() { // TODO hot screen resize.\n                if (self.isConnected()) {\n                    var w = VNCDialog.width();\n                    var h = VNCDialog.height();\n                    self.setCanvasSize(w, h);\n                    rfb.get_display().viewportChange(0, 0, w, h);\n                }\n            };\n            /**\n             * Event handler that limit the size of the vnc client windows.\n             *\n             */\n            function controlDialogSize() {\n                // Resize if dialog is large than screen.\n                var bw = $('html').width();\n                var bh = $(window).height();\n                if (VNCDialog.width() > bw) {\n                    needResize = true;\n                    VNCDialog.dialog(\"option\", \"width\", bw);\n                }\n                if (VNCDialog.parent().height() > bh) {\n                    needResize = true;\n                    VNCDialog.dialog(\"option\", \"height\", bh - VNCDialog.prev().outerHeight());\n                }\n            }\n            VNCDialog.dialog({\n                closeOnEscape: false,\n                autoOpen: false,\n                modal: true,\n                width: 'auto',\n                height: 'auto',\n                dialogClass: 'vpl_ide vpl_vnc',\n                create: function() {\n                    titleText = VPLUtil.setTitleBar(VNCDialog, 'vnc', 'graphic', ['clipboard', 'keyboard'], [openClipboard,\n                            keyboardButton]);\n                },\n                dragStop: controlDialogSize,\n                focus: getFocus,\n                open: controlDialogSize,\n                beforeClose: function() {\n                    if (needResize) {\n                        var w = VNCDialog.width();\n                        var h = VNCDialog.height();\n                        needResize = false;\n                        self.setCanvasSize(w, h);\n                    }\n                },\n                close: function() {\n                    self.disconnect();\n                },\n                resizeStop: function() {\n                    controlDialogSize();\n                    needResize = true;\n                }\n            });\n            VNCDialog.css(\"padding\", \"1px\");\n            VNCDialog.parent().css('z-index', 2000);\n            this.updateTitle = function() {\n                var text = title;\n                if (message !== '') {\n                    text += ' (' + message + ')';\n                }\n                titleText.text(str('console') + \": \" + text);\n            };\n            this.setTitle = function(t) {\n                title = t;\n                this.updateTitle();\n            };\n            this.setMessage = function(t) {\n                message = t;\n                this.updateTitle();\n            };\n            /**\n             * Event handler to show vnc client state in windows title.\n             *\n             * @param {object} rfb vnc client\n             * @param {string} state Name of the state\n             * @param {string} oldstate Name of the old state. Not used\n             * @param {string} msg State detail message\n             */\n            function updateState(rfb, state, oldstate, msg) {\n                lastState = state;\n                switch (state) {\n                    case \"normal\":\n                        self.setMessage('');\n                        self.setTitle(str('connected'));\n                        break;\n                    case \"disconnect\":\n                    case \"disconnected\":\n                        self.setTitle(str('connection_closed'));\n                        break;\n                    case \"failed\":\n                        self.setTitle(str('connection_fail'));\n                        console.log(\"VNC client: \" + msg);\n                        break;\n                    default:\n                        self.setMessage('');\n                        self.setTitle(str('connecting'));\n                }\n            }\n\n            this.connect = function(secure, host, port, password, path, onClose) {\n                clipboard.setEntry1('');\n                onCloseAction = onClose;\n                self.show();\n                var target = $('#' + VNCDialogId + \" canvas\")[0];\n                if (!rfb) {\n                    rfb = new RFB({\n                        'target': target,\n                        'encrypt': secure,\n                        'repeaterID': '',\n                        'true_color': true,\n                        'local_cursor': true,\n                        'shared': false,\n                        'view_only': false,\n                        'onUpdateState': updateState,\n                        'onPasswordRequired': null,\n                        'onClipboard': receiveClipboard\n                    });\n                    rfb.set_local_cursor(rfb.get_display().get_cursor_uri());\n                }\n                if (!port) {\n                    port = secure ? 443 : 80;\n                }\n                rfb.connect(host, port, password, path);\n            };\n            this.isOpen = function() {\n                return VNCDialog.dialog(\"isOpen\");\n            };\n            this.close = function() {\n                VNCDialog.dialog(\"close\");\n            };\n            this.isConnected = function() {\n                return rfb && lastState != 'disconnected';\n            };\n            this.disconnect = function() {\n                if (rfb) {\n                    rfb.disconnect();\n                }\n                onCloseAction();\n                clipboard.hide();\n            };\n            /**\n             * Round a number to event and not less than 100.\n             *\n             * @param {number} v value to round\n             *\n             * @returns {int}\n             */\n            function round(v) {\n                if (v < 100) {\n                    v = 100;\n                }\n                return Math.floor(v / 2) * 2;\n            }\n            this.getCanvasSize = function() {\n                return canvas.width() + \"x\" + canvas.height();\n            };\n\n            this.setCanvasSize = function(w, h) {\n                canvas.width(round(w));\n                canvas.height(round(h));\n            };\n            this.show = function() {\n                VNCDialog.dialog('open');\n                VNCDialog.width('auto');\n                VNCDialog.height('auto');\n            };\n            self.setCanvasSize($(window).width() - 150, $(window).height() - 150);\n        };\n        return VPLVNCClient;\n    }\n);\n"],"names":["define","$","jqui","VPLUtil","VPLClipboard","console","window","INCLUDE_URI","delay","loadVNCScripts","Util","load_scripts","VNCDialogId","str","rfb","clipboard","titleText","self","this","title","message","lastState","VNCDialog","canvas","onCloseAction","doNothing","needResize","inputarea","document","createElement","keyboardButton","is","blur","focus","receiveClipboard","text","setEntry1","openClipboard","show","getFocus","isConnected","get_keyboard","set_focused","lostFocus","style","position","left","top","width","height","opacity","backgroundColor","borderStyle","outlineStyle","autocapitalize","autocomplete","autocorrect","wrap","spellcheck","append","HTMLUpdateClipboard","genIcon","HTMLPaste","controlDialogSize","bw","bh","dialog","parent","prev","outerHeight","updateState","state","oldstate","msg","setMessage","setTitle","log","round","v","Math","floor","getEntry1","execCommand","clipboardPasteFrom","getEntry2","on","e","target","displayResize","w","h","setCanvasSize","get_display","viewportChange","closeOnEscape","autoOpen","modal","dialogClass","create","setTitleBar","dragStop","open","beforeClose","close","disconnect","resizeStop","css","updateTitle","t","connect","secure","host","port","password","path","onClose","RFB","encrypt","repeaterID","true_color","local_cursor","shared","view_only","onUpdateState","onPasswordRequired","onClipboard","set_local_cursor","get_cursor_uri","isOpen","hide","getCanvasSize"],"mappings":"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"}