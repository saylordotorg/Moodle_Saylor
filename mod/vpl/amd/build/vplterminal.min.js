define ("mod_vpl/vplterminal",["jquery","jqueryui","mod_vpl/vplutil","mod_vpl/vplclipboard"],function(a,b,c,d){var e=function(b,e,f){var m=this,n=null,o=c.doNothing,p="",q="",r=a("#"+b),s=a("#vplide"),t="",u=null,v=64e3,w="",x,y=a("#"+e);this.updateTitle=function(){var a=p;if(""!==q){a+=" ("+q+")"}t.text(f("console")+": "+a)};this.setTitle=function(a){p=a;this.updateTitle()};this.setMessage=function(a){q=a;this.updateTitle()};function g(a){w+=a;if(w.length>v){var b=w.length-v/2;w=w.substr(b)}}function h(){if(n&&n.readyState==n.OPEN){n.send(u.getEntry2())}}function i(){u.setEntry1(w)}function j(){i();u.show()}this.write=function(a){x.write(a);return a};this.connect=function(a,b){o=b;if("WebSocket"in window){x.reset();x.startBlink();m.show();if(n){n.close()}w="";m.setMessage("");m.setTitle(f("connecting"));n=new WebSocket(a);n.writeBuffer="";n.writeIt=function(){x.write(n.writeBuffer);g(n.writeBuffer);n.writeBuffer=""};n.onmessage=function(a){if(0<n.writeBuffer.length){n.writeBuffer+=a.data}else{n.writeBuffer=a.data;setTimeout(n.writeIt,35)}};n.onopen=function(){m.setMessage("");m.setTitle(f("connected"))};n.onclose=function(){m.setTitle(f("connection_closed"));x.blur();x.stopBlink();b();n.stopOutput=!0}}else{x.write("WebSocket not available: Upgrade your browser")}};this.writeLocal=function(a){n.onmessage({data:a});return a};this.setDataCallback=function(a){n.onData=a};this.closeLocal=function(){if(n){n.writeIt();n.close();x.stopBlink();m.setTitle(f("connection_closed"))}};this.connectLocal=function(a,b){o=a;x.reset();x.startBlink();m.show();if(n){n.close()}w="";m.setMessage("");m.setTitle(f("running"));n={};n.onData=b;n.writeBuffer="";n.readBuffer="";n.readyState=1;n.OPEN=1;n.close=function(){n=!1};n.onmessage=function(a){n.writeBuffer=a.data;n.writeIt()};n.writeIt=function(){if(n){x.write(n.writeBuffer);g(n.writeBuffer);n.writeBuffer=""}};n.send=function(a){if("\x7F"==a){if(0<n.readBuffer.length){m.writeLocal("\b \b");n.readBuffer=n.readBuffer.substr(0,n.readBuffer.length-1)}}else{m.writeLocal(a);n.readBuffer+=a}var b=n.readBuffer.indexOf("\r");if(-1!=b){var c=n.readBuffer.substr(0,b);n.readBuffer=n.readBuffer.substr(b+1);n.onData(c)}}};this.isOpen=function(){return r.dialog("isOpen")};this.close=function(){r.dialog("close")};this.isConnected=function(){return n&&n.readyState!=n.CLOSED};this.disconnect=function(){if(n&&n.readyState==n.OPEN){o();if(n){n.close()}x.stopBlink()}};var z=c.genIcon("copy","sw")+" "+f("copy"),A=c.genIcon("paste","sw")+" "+f("paste");u=new d("vpl_dialog_terminal_clipboard",z,function(){i();document.execCommand("copy")},A,h);this.closeDialog=function(){u.hide();m.disconnect()};function k(a){r.data("terminal_theme",a);c.setUserPreferences({terminalTheme:a});for(var b=0;b<5;b++){r.removeClass("vpl_terminal_theme"+b)}r.addClass("vpl_terminal_theme"+a)}function l(){var a=s.width(),b=s.height();if(r.width()>a){r.dialog("option","width",a)}if(r.parent().height()>b){r.dialog("option","height",b-r.prev().outerHeight())}}r.dialog({closeOnEscape:!1,autoOpen:!1,width:"auto",height:"auto",resizable:!0,dragStop:l,open:l,focus:function focus(){l();x.focus()},dialogClass:"vpl_ide vpl_vnc",create:function create(){t=c.setTitleBar(r,"console","console",["clipboard","keyboard","theme"],[j,function(){x.focus()},function(){var a=(r.data("terminal_theme")+1)%5;k(a)}])},close:function close(){m.closeDialog()},resizeStop:function resizeStop(){r.width(r.parent().width());r.height(r.parent().height()-r.prev().outerHeight());l();x.focus()}});this.setFontSize=function(a){y.css("font-size",a+"px")};c.getUserPreferences(function(a){k(a.preferences.terminalTheme)});r.css("padding","1px");r.parent().css("z-index",2e3);this.show=function(){r.dialog("open");x.focus()};this.init=function(){if("undefined"==typeof Terminal){c.loadScript(["../../vpl/editor/xterm/term.js"],function(){m.init()});return}x=new Terminal({cols:80,rows:24,useStyle:!0,screenKeys:!0});x.on("data",function(a){if(n&&n.readyState==n.OPEN){n.send(a)}});x.open(y[0]);x.reset();x.stopBlink();x.setLineCallback(function(a,b){var c=y.height(),d=r.scrollTop(),e=r.innerHeight();if(e>=c){return}var f=c/b,g=a*f;if(g>=d&&g<e+d-f){return}if(g<d){r.scrollTop(g)}else{r.scrollTop(g-e+2*f)}})};this.init()};window.VPLTerminal=e;return e});
//# sourceMappingURL=vplterminal.min.js.map
