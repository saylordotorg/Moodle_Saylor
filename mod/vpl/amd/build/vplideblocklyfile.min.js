function _typeof(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(a){return typeof a}}else{_typeof=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return _typeof(a)}define ("mod_vpl/vplideblocklyfile",["jquery","mod_vpl/vplutil"],function(a,b){return function(){var c=this,d=this.getVPLIDE();this.firstContent=!0;this.workspaceInstance=!1;var e=function(){if("undefined"==typeof Blockly.PHP.workspaceToCodeOld){Blockly.PHP.workspaceToCodeOld=Blockly.PHP.workspaceToCode;Blockly.PHP.workspaceToCode=function(a){return"<?php\n"+Blockly.PHP.workspaceToCodeOld(a)}}if("undefined"==typeof Blockly.Python.workspaceToCodeOld){Blockly.Python.workspaceToCodeOld=Blockly.Python.workspaceToCode;Blockly.Python.workspaceToCode=function(a){return"# -*- coding: utf-8 -*-\n"+Blockly.Python.workspaceToCodeOld(a)}}},f=this.adjustSize;this.adjustSize=function(){if(f.call(this)){var b=a(this.getTId());if(0===b.length){return!1}var c=b.parent(),d=c.height();d-=b.position().top;b.height(d);a("#"+this.bdiv).height(d);a("#"+this.bdiv).width(b.width());Blockly.svgResize(this.workspaceInstance);return!1}return!1};this.undo=function(){if(this.isOpen()){this.workspaceInstance.undo(!1)}};this.redo=function(){if(this.isOpen()){this.workspaceInstance.undo(!0)}};this.interpreter=!1;this.animateRun=!1;this.RUNSTATE=1;this.STEPSTATE=2;this.STOPSTATE=3;this.executionState=this.STOPSTATE;this.goNext=!1;this.initRun=function(a){var e=d.getTerminal();if(e.isConnected()){e.closeLocal()}this.animateRun=a;Blockly.JavaScript.STATEMENT_PREFIX="highlightBlock(%1);\n";Blockly.JavaScript.addReservedWords("highlightBlock");var f=Blockly.JavaScript.workspaceToCode(c.workspaceInstance);c.interpreter=new Interpreter(f,function initApi(a,f){a.setProperty(f,"alert",a.createNativeFunction(function wrapperAlert(b){b="string"!=typeof b?b.toString()+"\r\n":b+"\r\n";return a.createPrimitive(e.writeLocal(b))}));a.setProperty(f,"prompt",a.createAsyncFunction(function wrapperPrompt(a,b){a="string"!=typeof a?a.toString():""+a;e.writeLocal(a);e.setDataCallback(function(a){e.writeLocal("\n");b(a)})}));a.setProperty(f,"highlightBlock",a.createNativeFunction(function wrapperHighlightBlock(a){if(a==c.getBreakpoint()){c.executionState=c.STEPSTATE;c.updateRunButtons();d.getTerminal().setMessage(b.str("breakpoint"))}if(c.animateRun||c.executionState==c.STEPSTATE){c.workspaceInstance.highlightBlock(a)}c.goNext=!1}))});e.connectLocal(c.stop,b.doNothing)};this.reservedWords={Infinity:!0,Array:!0,Boolean:!0,Date:!0,Error:!0,EvalError:!0,Function:!0,JSON:!0,Math:!0,NaN:!0,Number:!0,Object:!0,RangeError:!0,ReferenceError:!0,RegExp:!0,String:!0,SyntaxError:!0,TypeError:!0,URIError:!0,alert:!0,arguments:!0,constructor:!0,eval:!0,highlightBlock:!0,isFinite:!0,isNaN:!0,parseFloat:!0,parseInt:!0,prompt:!0,self:!0,this:!0,window:!0};(function(){var a=null,b=null;c.getBreakpoint=function(){return a};c.setBreakpoint=function(){a=b};c.removeBreakpoint=function(){a=null};c.setLastSelection=function(a){b=a};c.isSelectingBreakpoint=function(){return null===a&&null!==b}})();this.getVarValue=function(a){var d="";if(null===a){d="<b>null</b>"}else if(a!=void 0){var e=_typeof(a);if("string"==e){d="\""+b.sanitizeText(a)+"\""}else if("boolean"==e){d="<b>"+a+"</b>"}else if("object"==e&&"Array"===a.class){d="[";for(var f=a.properties,g=0;g<f.length;g++){d+=c.getVarValue(f[g]);if(g!=f.length-1){d+=", "}}d+="]"}else if("object"==e){d="<b>"+a.toString()+"</b>"}else{d+=""+a}}return d};this.getVariables=function(a){var d="";for(var e in a){if(!0===this.reservedWords[e]){continue}var f=a[e];if(f!=void 0&&!("Function"===f.class)){var g=b.sanitizeText(c.getVarValue(f));d+="<b>"+e+"</b>:&nbsp;"+g+"<br>\n"}}return d};this.getParameters=function(a){for(var b="(",c=0;c<a.length;c++){b+=""+a[c];if(c<a.length-1){b+=", "}}return b+")"};this.showStack=function(a){for(var b=0,e="<table class=\"generaltable\">",f=a.stateStack,g="<tr><td>0</td><td><b>Globals</b></td>",h=0,j;h<f.length;h++){j=f[h];if(""<g&&("CallExpression"==j.node.type||h==f.length-1)){e+=g+"<td>"+c.getVariables(j.scope.properties);e+="</td></tr>"}if("CallExpression"==j.node.type){if(!0!==c.reservedWords[j.node.callee.name]&&j.node.callee.name!=void 0){b++;g="<tr><td>"+b+"</td>";g+="<td>"+j.node.callee.name+c.getParameters(j.arguments_)+"</td>"}else{g=""}}}e+="</table>";d.setResult({variables:e})};this.runLoop=function(){if(!c.interpreter){return}c.goNext=!0;for(var a=0;3e4>a&&c.goNext;a++){if(c.executionState==c.STOPSTATE){break}if(!c.interpreter||!c.interpreter.step()){c.executionState=c.STOPSTATE;c.updateRunButtons();break}}if(c.executionState==c.STOPSTATE){c.workspaceInstance.highlightBlock(-1);d.getTerminal().closeLocal();d.setResult({variables:""});return}if(c.executionState==c.RUNSTATE){if(c.animateRun){setTimeout(c.runLoop,1e3);c.showStack(c.interpreter)}else{setTimeout(c.runLoop,0)}}else{c.showStack(c.interpreter)}};this.start=function(){if(c.executionState!=c.STOPSTATE){return}c.initRun(!1);c.executionState=c.RUNSTATE;c.updateRunButtons();d.getTerminal().setMessage(b.str("start"));c.runLoop()};this.startAnimate=function(){if(c.executionState!=c.STOPSTATE){return}c.initRun(!0);c.executionState=c.RUNSTATE;c.updateRunButtons();d.getTerminal().setMessage(b.str("startanimate"));c.runLoop()};this.stop=function(){c.executionState=c.STOPSTATE;c.workspaceInstance.highlightBlock(-1);c.updateRunButtons();d.getTerminal().setMessage(b.str("stop"));d.getTerminal().closeLocal();c.interpreter=!1;d.setResult({variables:""})};this.pause=function(){if(c.executionState!=c.RUNSTATE){return}c.executionState=c.STEPSTATE;d.getTerminal().setMessage(b.str("pause"));c.updateRunButtons()};this.resume=function(){if(c.executionState!=c.STEPSTATE){return}c.executionState=c.RUNSTATE;d.getTerminal().setMessage(b.str("resume"));c.updateRunButtons();c.runLoop()};this.step=function(){if(c.executionState==c.STOPSTATE){c.initRun(!0)}c.executionState=c.STEPSTATE;c.updateRunButtons();d.getTerminal().setMessage(b.str("step"));c.runLoop()};this.hasUndo=function(){return!0};this.hasRedo=function(){return!0};this.oldSetFileName=this.setFileName;this.generatorMap={py:"Python",dart:"Dart",js:"JavaScript",lua:"Lua",php:"PHP"};this.generator="";this.setFileName=function(a){var d=this.getFileName(),e=b.fileExtension(d);if(!c.oldSetFileName(a)){b.log("Blockly setFileName: name no acepted "+a);return!1}b.log("Blockly set filename "+a);var f=/\.([^.]+)\.blockly[123]?$/.exec(a),g=/(.+)\.blockly[123]?$/.exec(a);if(null!==f&&null!==g&&"string"==typeof this.generatorMap[f[1]]){this.generator=this.generatorMap[f[1]];this.generatedFilename=g[1];b.log("Blockly generator "+this.generator+" for filename "+this.generatedFilename);this.updateGeneratedCode()}else{this.generator=""}if(e!=b.fileExtension(a)){b.log("Blockly extension changed");b.afterAll("reopenBlockly",function(){b.log("reopenBlockly");c.close();c.open()})}return!0};this.updateGeneratedCode=function(){if(c.blocklyNotLoaded){return}var a=c.getFileManager();if(""!=c.generator){b.log("Blockly generate "+c.generator);var d=Blockly[c.generator].workspaceToCode(c.workspaceInstance),e=a.fileNameExists(c.generatedFilename);if(-1==e){b.log("try to create "+c.generatedFilename+" files");a.addFile({name:c.generatedFilename,contents:""},!1,b.doNothing,b.doNothing);e=a.fileNameExists(c.generatedFilename)}if(-1!=e){var f=a.getFile(e);if(f.getContent()!=d){f.setContent(d);f.change();f.gotoLine(1);f.setReadOnly(!0)}}}};this.changeCode=function(a){b.log(a);if("ui"==a.type&&"selected"==a.element){c.setLastSelection(a.newValue);return}if("ui"==a.type&&"category"==a.element&&a.newValue==b.str("run")){b.longDelay("updateRunButtons",c.updateRunButtons);return}if(c.firstContent){if("finished_loading"==a.type){c.firstContent=!1;c.workspaceInstance.clearUndo()}else{return}}if(!a.recordUndo){return}b.log("Call change due changeCode");c.change();if(""!=c.generator){b.afterAll("generate"+c.getFileName(),c.updateGeneratedCode)}};var g=0;this.updateRunButtons=function(){if(0==a(".blocklySelectBreakpointC").length){g++;if(g>20){g=0;b.log("Giving up to tries of updateRunButtons");return}b.longDelay("updateRunButtons",c.updateRunButtons);return}b.log("updateRunButtons");g=0;if(c.isSelectingBreakpoint()){a(".blocklySelectBreakpointC").removeClass("vpl_dimmed")}else{a(".blocklySelectBreakpointC").addClass("vpl_dimmed")}if(null===c.getBreakpoint()){a(".blocklyRemoveBreakpointC").addClass("vpl_dimmed")}else{a(".blocklyRemoveBreakpointC").removeClass("vpl_dimmed")}switch(c.executionState){case c.RUNSTATE:{a(".blocklyStartC").addClass("vpl_dimmed");a(".blocklyStartAnimateC").addClass("vpl_dimmed");a(".blocklyStopC").removeClass("vpl_dimmed");a(".blocklyPauseC").removeClass("vpl_dimmed");a(".blocklyResumeC").addClass("vpl_dimmed");a(".blocklyStepC").addClass("vpl_dimmed");break}case c.STEPSTATE:{a(".blocklyStartC").addClass("vpl_dimmed");a(".blocklyStartAnimateC").addClass("vpl_dimmed");a(".blocklyStopC").removeClass("vpl_dimmed");a(".blocklyPauseC").addClass("vpl_dimmed");a(".blocklyResumeC").removeClass("vpl_dimmed");a(".blocklyStepC").removeClass("vpl_dimmed");break}case c.STOPSTATE:{a(".blocklyStartC").removeClass("vpl_dimmed");a(".blocklyStartAnimateC").removeClass("vpl_dimmed");a(".blocklyStopC").addClass("vpl_dimmed");a(".blocklyPauseC").addClass("vpl_dimmed");a(".blocklyResumeC").addClass("vpl_dimmed");a(".blocklyStepC").removeClass("vpl_dimmed");break}}};this.setToolbox=function(){var d=b.fileExtension(this.getFileName()),e=d+"Toolbox";if(!1===c[e]){a.ajax({url:"../editor/blocklytoolboxes/"+e+".xml",dataType:"text",success:function success(a){c[e]=c.blocklyIn18(a);c.setToolbox()}});return}var f=function(a){return function(){a();c.updateRunButtons()}},g={blocklyStartButton:this.start,blocklyStartAnimateButton:this.startAnimate,blocklyStopButton:this.stop,blocklyPauseButton:this.pause,blocklyResumeButton:this.resume,blocklyStepButton:this.step,blocklySelectBreakpointButton:this.setBreakpoint,blocklyRemoveBreakpointButton:this.removeBreakpoint},h=this.workspaceInstance;h.updateToolbox(this[e]);for(var i in g){h.registerButtonCallback(i,f(g[i]))}this.adjustSize()};this.open=function(){this.showFileName();if(c.blocklyNotLoaded){b.loadScript(["../editor/blockly/blockly_compressed.js","../editor/blockly/msg/js/en.js","../editor/blockly/blocks_compressed.js","../editor/blockly/python_compressed.js","../editor/blockly/javascript_compressed.js","../editor/blockly/php_compressed.js","../editor/blockly/lua_compressed.js","../editor/blockly/dart_compressed.js","../editor/acorn/acorn.js","../editor/acorn/interpreter.js"],function(){b.log("Blocklyloaded",!0);e();c.blocklyNotLoaded=!1;c.open()});return!1}var d=this.getContent();this.setOpen(!0);var f=this.getFileName(),g=!1;if(/.*[0-9]$/.test(b.fileExtension(f))){g=!0}var h=this.getTId();a(h).removeClass("ui-widget-content ui-tabs-panel");a(h).addClass("ui-corner-bottom");this.bdiv="bkdiv"+this.getId();a(h).html("<div id=\""+this.bdiv+"\" style=\"height: 480px; width: 600px;\"></div>");var i={toolbox:"<xml><category name=\"\" colour=\"330\"><block type=\"math_number\"></block></category></xml>",media:"../editor/blockly/media/",horizontalLayout:g,zoom:{controls:!0,wheel:!0,startScale:1,maxScale:3,minScale:.2,scaleSpeed:.3}};this.workspaceInstance=Blockly.inject(this.bdiv,i);this.setToolbox();this.firstContent=!0;c.workspaceInstance.addChangeListener(c.changeCode);this.setContent(d);b.adjustBlockly(c.workspaceInstance,10,10);c.workspaceInstance.scrollX=0;c.workspaceInstance.scrollY=0;Blockly.svgResize(c.workspaceInstance);Blockly.resizeSvgContents(c.workspaceInstance);c.adjustSize();return!1};var h=this.getContent;this.getContent=function(){if(!this.isOpen()){return h.call(this)}var a=Blockly.Xml.workspaceToDom(this.workspaceInstance),b=Blockly.Xml.domToPrettyText(a);return b};var i=this.setContent;this.setContent=function(a){i.call(this,a);if(0<a.length&&this.isOpen()){this.workspaceInstance.clear();var b=Blockly.Xml.textToDom(a);Blockly.Xml.domToWorkspace(b,this.workspaceInstance)}};this.close=function(){if(this.isOpen()){i.call(this,this.getContent());this.workspaceInstance.dispose();this.workspaceInstance=!1;this.setOpen(!1)}};this.blocklyNotLoaded=!0;this.blocklyToolbox=!1;this.blockly0Toolbox=!1;this.blockly1Toolbox=!1;this.blockly2Toolbox=!1;this.blockly3Toolbox=!1;this.blocklyStrs=["basic","intermediate","advanced","variables","operatorsvalues","control","inputoutput","functions","lists","math","text","run","start","startanimate","stop","pause","resume","step","breakpoint","selectbreakpoint","removebreakpoint"];this.blocklyIn18=function(a){for(var c=this.blocklyStrs.length,d=0;d<c;d++){var e=this.blocklyStrs[d],f=new RegExp("\\[\\["+e+"\\]\\]","g"),g=b.str(e);a=a.replace(f,g)}return a}}});
//# sourceMappingURL=vplideblocklyfile.min.js.map
