define ("mod_threesixo/questionnaire",["exports","core/notification","core/ajax","core/str","core/modal_factory","core/modal_events","core/toast"],function(a,b,c,d,e,f,g){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=void 0;b=h(b);c=h(c);e=h(e);f=h(f);function h(a){return a&&a.__esModule?a:{default:a}}function i(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function j(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){i(h,d,e,f,g,"next",a)}function g(a){i(h,d,e,f,g,"throw",a)}f(void 0)})}}var k={commentItem:"textarea[data-region=\"comment-item\"]",questionnaireTable:"[data-region=\"questionnaire\"]",ratingOption:"input[type=radio]",questionItem:"[data-region=\"question-item\"]"},l=[],m=function(){n();var a=document.querySelectorAll(k.questionItem);a.forEach(function(a){l[a.getAttribute("data-itemid")]=null});var d=document.querySelector(k.questionnaireTable),e=d.getAttribute("data-fromuserid"),f=d.getAttribute("data-touserid"),g=d.getAttribute("data-threesixtyid"),h=c.default.call([{methodname:"mod_threesixo_get_responses",args:{threesixtyid:g,fromuserid:e,touserid:f}}]);h[0].then(function(b){b.responses.forEach(function(b){l[b.item]=b.value;var c=parseInt(b.item);a.forEach(function(a){var d=parseInt(a.getAttribute("data-itemid"));if(d===c){var e=a.querySelectorAll(k.ratingOption);if(e.length){e.forEach(function(a){var c=a.value;if(c===b.value){o(a)}})}else{var f=a.querySelector(k.commentItem);if(f){f.value=b.value}}}})});return!0}).catch(b.default.exception)};a.init=m;var n=function(){document.addEventListener("change",function(a){var b=a.target.closest(k.ratingOption);if(b){if(b.checked){o(b)}}});document.addEventListener("click",function(a){var b=a.target.closest(k.ratingOption);if(b){var c=b.closest("label");if(c){c.classList.add("focus")}}});document.addEventListener("blur",function(a){var b=a.target.closest(k.ratingOption);if(b){var c=b.closest("label");if(c){c.classList.remove("focus")}}});var a=document.getElementById("save-feedback");a.addEventListener("click",function(){p(!1)});var b=document.getElementById("submit-feedback");b.addEventListener("click",function(){p(!0)})},o=function(a){var b=a.closest(k.questionItem),c=b.getAttribute("data-itemid"),d=b.querySelectorAll(k.ratingOption);d.forEach(function(a){var b=a.nextElementSibling;if(b.classList.contains("btn-success")){b.classList.remove("btn-success");b.classList.add("btn-secondary");a.checked=!1}});var e=a.nextElementSibling;e.classList.remove("btn-secondary");e.classList.remove("btn-info");e.classList.add("btn-success");a.checked=!0;l[c]=a.value},p=function(a){var c=document.querySelectorAll(k.commentItem);c.forEach(function(a){l[a.getAttribute("data-itemid")]=a.value.trim()});var e=document.querySelector(k.questionnaireTable),f=parseInt(e.getAttribute("data-touserid")),g=e.getAttribute("data-tousername"),h=parseInt(e.getAttribute("data-threesixtyid")),i=parseInt(e.getAttribute("data-anonymous"));if(i&&a){(0,d.get_strings)([{key:"finaliseanonymousfeedback",component:"mod_threesixo"},{key:"confirmfinaliseanonymousfeedback",component:"mod_threesixo",param:{name:g}}],"mod_threesixo").then(function(b){return r(b[0],b[1],h,f,l,a)}).catch(b.default.exception)}else{q(h,f,l,a)}},q=function(a,e,f,h){var i=c.default.call([{methodname:"mod_threesixo_save_responses",args:{threesixtyid:a,touserid:e,responses:f,complete:h}}]),j=null;i[0].then(function(a){if(a.result){j=a.redirurl;return(0,d.get_string)("responsessaved","mod_threesixo")}return(0,d.get_string)("errorresponsesavefailed","mod_threesixo")}).then(function(a){return(0,g.add)(a,{})}).then(function(){if(h&&j){window.location=j}return!0}).catch(b.default.exception)},r=function(){var a=j(regeneratorRuntime.mark(function a(b,c,g,h,i,j){var k,l;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.next=2;return(0,d.get_string)("finalise","mod_threesixo");case 2:k=a.sent;a.next=5;return e.default.create({title:b,body:c,large:!0,type:e.default.types.SAVE_CANCEL});case 5:l=a.sent;l.setSaveButtonText(k);l.show();l.getRoot().on(f.default.hidden,function(){l.setBody("")});l.getRoot().on(f.default.save,function(){q(g,h,i,j)});case 10:case"end":return a.stop();}}},a)}));return function(){return a.apply(this,arguments)}}()});
//# sourceMappingURL=questionnaire.min.js.map
