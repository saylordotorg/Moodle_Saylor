{"version":3,"file":"rsquestionmanager.min.js","sources":["../src/rsquestionmanager.js"],"sourcesContent":["/* jshint ignore:start */\ndefine(['jquery', 'core/log','core/templates','mod_minilesson/definitions','mod_minilesson/modalformhelper',\n        'mod_minilesson/modaldeletehelper','mod_minilesson/moveitemhelper','mod_minilesson/modalpreviewhelper',\n        'mod_minilesson/duplicateitemhelper','mod_minilesson/datatables'],\n    function($,  log, templates, def, mfh, mdh, mih, mph,dplh, datatables) {\n\n    \"use strict\"; // jshint ;_;\n\n    log.debug('RSQuestion manager: initialising');\n\n    return {\n\n        cmid: null,\n        controls: null,\n        rowIds: [],\n\n\n        //pass in config\n        init: function(props){\n            var dd = this;\n            dd.contextid=props.contextid;\n            dd.tableid = props.tableid;\n\n            dd.register_events();\n            dd.process_html();\n            dd.collate_rowids();\n            dd.hide_useless_arrows();\n        },\n\n        process_html: function(){\n            this.controls = [];\n            this.controls.questionstable = datatables.getDataTable(this.tableid);\n            this.controls.questionscontainer = $('#' + def.itemscontainer);\n            this.controls.noquestionscontainer = $('#' + def.noitemscontainer);\n            this.controls.movearrows=$('#' + def.movearrow);\n        },\n\n        //we maintain an array of datatable rowids, indexed by itemorder\n        //we need this because moving, adding, deleting requires access to datatable rowid\n        collate_rowids: function(){\n            var dd = this;\n            dd.rowIds=[];\n\n            dd.controls.questionstable.rows().every( function ( rowindex, tableLoop, rowLoop ) {\n                var itemorder = dd.controls.questionstable.cell({row:rowindex, column:0}).data();\n                dd.rowIds[itemorder]=rowindex;\n            } );\n        },\n\n        //we wont to show move arrows, but hide arrows the final down and first up\n        hide_useless_arrows: function(){\n          //first lets show all the arrows\n          $('.mod_minilesson_item_move').attr('style','');\n\n          //if no rows just get out of here.\n          var rowcount=this.controls.questionstable.data().length;\n          if(!rowcount || rowcount<1){return;}\n\n          //hide bottom down arrow\n          var bottomrowindex=this.rowIds[rowcount];\n          var bottomtr = this.controls.questionstable.row(bottomrowindex).node();\n          $(bottomtr).find('.mod_minilesson_item_move[data-direction=\"down\"]').attr('style','visibility: hidden;');\n\n          //hide top up arrow\n          var toprowindex=this.rowIds[1];\n          var toptr = this.controls.questionstable.row(toprowindex).node();\n          $(toptr).find('.mod_minilesson_item_move[data-direction=\"up\"]').attr('style','visibility: hidden;');\n        },\n\n        // we need to renumber rows when we remove one, so we start from there and renumber the next ones\n        renumber_rows:function(fromorder) {\n\n            var thetable= this.controls.questionstable;\n            var rowcount = thetable.data().length;\n            for(var itemorder =fromorder; itemorder<rowcount;itemorder++){\n                var rowindex = this.rowIds[itemorder+1];\n                thetable.cell({row:rowindex, column:0}).data(itemorder);\n            }\n        },\n\n        move_row:function(itemid, direction) {\n            var thetable= this.controls.questionstable;\n            var therow = '#' + def.itemrow + '_' + itemid;\n            var currentrow = thetable.row(therow);\n            var currentindex = currentrow.index();\n            var currentorder = parseInt(thetable.cell({row:currentindex, column:0}).data());\n\n\n            var targetorder;\n            if(direction==\"up\"){\n                targetorder=currentorder-1;\n            } else if(direction==\"down\"){\n                targetorder=currentorder+1;\n            }\n\n            //should never arrive here pitching for out of range. But just in case\n            if(targetorder<1){return;}\n            var rowcount = thetable.data().length;\n            if(targetorder>rowcount){return;}\n\n            var targetindex = this.rowIds[targetorder];\n            var from = thetable.cell({row:currentindex, column:0}).data();\n            var to = thetable.cell({row:targetindex, column:0}).data();\n            thetable.cell({row:currentindex, column:0}).data(to);\n            thetable.cell({row:targetindex, column:0}).data(from);\n            thetable.draw(false);\n            this.collate_rowids();\n            \n        },\n        register_events: function() {\n          \n            var dd = this;\n          \n            var qtypes =[def.qtype_dictation,def.qtype_dictationchat,def.qtype_page,\n                def.qtype_speechcards,def.qtype_listenrepeat, def.qtype_multichoice, def.qtype_multiaudio];\n\n            var after_questionmove= function(itemid, direction) {\n                dd.move_row(itemid,direction);\n                dd.hide_useless_arrows();\n            };\n\n            var after_questionedit= function(item, itemid) {\n                var therow = '#' + def.itemrow + '_' + itemid;\n                dd.controls.questionstable.cell($(therow + ' .c1')).data(decodeURIComponent(item.name));\n            };\n            var after_questionadd= function(item, itemid) {\n                item.id = itemid;\n                item.name = decodeURIComponent(item.name);\n                item.index = dd.controls.questionstable.data().length+1;\n                item.up = {'key': 't/up','component': 'moodle','title': 'up'};\n                item.down = {'key': 't/down','component': 'moodle','title': 'down'};\n                templates.render('mod_minilesson/itemlistitem',item).then(\n                    function(html,js){\n                        //add row move to the last page so we can see the new row if its off page\n                        dd.controls.questionstable.row.add($(html)[0]).page('last').draw(false);\n                        dd.collate_rowids();\n                        dd.hide_useless_arrows();\n                    }\n                );\n                dd.controls.noquestionscontainer.hide();\n                dd.controls.questionscontainer.show();\n            };\n            var after_questionduplicate= function($resp) {\n\n                var ret = JSON.parse($resp);\n                var item={};\n                item.id = ret.newitemid;\n                item.name = decodeURIComponent(ret.newitemname);\n                item.type = ret.type;\n                item.typelabel = decodeURIComponent(ret.typelabel);\n                item.index = dd.controls.questionstable.data().length+1;\n                item.up = {'key': 't/up','component': 'moodle','title': 'up'};\n                item.down = {'key': 't/down','component': 'moodle','title': 'down'};\n                templates.render('mod_minilesson/itemlistitem',item).then(\n                    function(html,js){\n                        //add row move to the last page so we can see the new row if its off page\n                        dd.controls.questionstable.row.add($(html)[0]).page('last').draw(false);\n                        dd.collate_rowids();\n                        dd.hide_useless_arrows();\n                    }\n                );\n                dd.controls.noquestionscontainer.hide();\n                dd.controls.questionscontainer.show();\n            };\n            var after_questiondelete= function(itemid) {\n                log.debug('after question delete');\n                var therow=dd.controls.questionstable.row('#' + def.itemrow + '_' + itemid);\n                var itemorder=parseInt(therow.data()[0]);\n                dd.renumber_rows(itemorder);\n                therow.remove().draw(false);\n                dd.collate_rowids();\n                dd.hide_useless_arrows();\n                var itemcount = dd.controls.questionstable.rows().count();\n                if(!itemcount){\n                    dd.controls.noquestionscontainer.show();\n                    dd.controls.questionscontainer.hide();\n                }\n            };\n            var after_questionpreview= function(itemid) {\n                log.debug('after preview');\n                //we want to remove the question from DOM ... its still there and on subsequent shows, id will match on 2 elements and question will fail to unhide\n                $('#mod_minilesson_quiz_cont').remove();\n            };\n\n            //register ajax modal handler\n            var editcallback=function(item, itemid){console.log(item);};\n            var deletecallback=function(itemid){console.log(itemid);};\n            var addcallback=function(itemid){console.log(itemid);};\n            mfh.init('.' + def.component + '_addlink', dd.contextid,after_questionadd);\n            //edit form helper\n            mfh.init('.' + def.itemrow + '_editlink', dd.contextid,after_questionedit);\n            //delete helpser\n            mdh.init('.' + def.itemrow + '_deletelink', dd.contextid, 'deleteitem',after_questiondelete);\n            //move helper\n            mih.init('.' + def.movearrow , dd.contextid, after_questionmove);\n            //preview helper\n            mph.init('.' + def.itemrow + '_previewlink', dd.contextid, after_questionpreview);\n            //duplicate item helper\n            dplh.init('.' + def.itemrow + '_duplicatelink', dd.contextid, after_questionduplicate);\n        }\n\n    };//end of returned object\n});//total end\n"],"names":["define","$","log","templates","def","mfh","mdh","mih","mph","dplh","datatables","debug","cmid","controls","rowIds","init","props","dd","this","contextid","tableid","register_events","process_html","collate_rowids","hide_useless_arrows","questionstable","getDataTable","questionscontainer","itemscontainer","noquestionscontainer","noitemscontainer","movearrows","movearrow","rows","every","rowindex","tableLoop","rowLoop","itemorder","cell","row","column","data","attr","rowcount","length","bottomrowindex","bottomtr","node","find","toprowindex","toptr","renumber_rows","fromorder","thetable","move_row","itemid","direction","targetorder","therow","itemrow","currentindex","index","currentorder","parseInt","targetindex","from","to","draw","qtype_dictation","qtype_dictationchat","qtype_page","qtype_speechcards","qtype_listenrepeat","qtype_multichoice","qtype_multiaudio","component","item","id","name","decodeURIComponent","up","down","render","then","html","js","add","page","hide","show","remove","count","$resp","ret","JSON","parse","newitemid","newitemname","type","typelabel"],"mappings":"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"}