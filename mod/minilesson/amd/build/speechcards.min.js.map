{"version":3,"file":"speechcards.min.js","sources":["../src/speechcards.js"],"sourcesContent":["define(['jquery', 'jqueryui', 'core/log', 'core/ajax', 'mod_minilesson/definitions', 'mod_minilesson/pollyhelper',\n  'mod_minilesson/cloudpoodllloader','mod_minilesson/ttrecorder'\n], function($, jqui, log, Ajax, def, polly, cloudpoodll, ttrecorder) {\n  \"use strict\"; // jshint ;_;\n\n  /*\n  This file is to manage the quiz stage\n   */\n\n  log.debug('MiniLesson Speechcards: initialising');\n\n  return {\n\n      //for making multiple instances\n      clone: function () {\n          return $.extend(true, {}, this);\n      },\n\n    init: function(index, itemdata, quizhelper) {\n\n      this.init_app(index, itemdata, quizhelper);\n    },\n\n    init_app: function(index, itemdata, quizhelper) {\n\n      console.log(itemdata);\n\n      var app = {\n        passmark: 90,\n        pointer: 1,\n        jsondata: null,\n        props: null,\n        dryRun: false,\n        language: 'en-US',\n        terms: [],\n        phonetics: [],\n        displayterms: [],\n        results: [],\n        controls: {},\n\n        init: function() {\n\n          //init terms\n          for (var i = 0; i < itemdata.sentences.length; i++) {\n            app.terms[i] = itemdata.sentences[i].sentence;\n            app.phonetics[i] = itemdata.sentences[i].phonetic;\n            app.displayterms[i] = itemdata.sentences[i].prompt;\n          }\n          app.language = itemdata.language;\n\n          this.init_controls();\n          this.initComponents();\n          this.register_events();\n        },\n\n        init_controls: function() {\n          app.controls = {};\n          app.controls.star_rating = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_star_rating\");\n          app.controls.next_button = $(\"#\" + itemdata.uniqueid + \"_container .minilesson-speechcards_nextbutton\");\n          app.controls.slider = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_speechcards_target_phrase\");\n        },\n        next_question: function() {\n          var stepdata = {};\n          stepdata.index = index;\n          stepdata.hasgrade = true;\n          stepdata.totalitems = app.terms.length;\n          stepdata.correctitems = app.results.filter(function(e){return e.points>0;}).length;\n          stepdata.grade = Math.round((stepdata.correctitems/stepdata.totalitems)*100);\n          quizhelper.do_next(stepdata);\n        },\n        register_events: function() {\n\n          $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\").on('click', function(e) {\n            app.next_question();\n          });\n\n          app.controls.next_button.click(function() {\n            //user has given up ,update word as failed\n            app.check(false);\n\n            //transition if required\n            if (app.is_end()) {\n              setTimeout(function() {\n                app.do_end();\n              }, 200);\n            } else {\n              setTimeout(function() {\n                app.do_next();\n              }, 200);\n            }\n\n          });\n        },\n\n        initComponents: function() {\n\n          var theCallback = function(message) {\n\n            switch (message.type) {\n              case 'recording':\n\n                break;\n\n              case 'speech':\n                log.debug(\"speech at speechcards\");\n                var speechtext = message.capturedspeech;\n                var spoken_clean  = quizhelper.cleanText(speechtext);\n                var correct_clean = quizhelper.cleanText(app.terms[app.pointer - 1]);\n                var correctphonetic = app.phonetics[app.pointer - 1];\nlog.debug('speechtext:',speechtext);\nlog.debug('spoken:',spoken_clean);\nlog.debug('correct:',correct_clean);\n                //Similarity check by character matching\n                var similarity_js = quizhelper.similarity(spoken_clean, correct_clean);\n                log.debug('JS similarity: ' + spoken_clean + ':' + correct_clean + ':' + similarity_js);\n\n                //Similarity check by direct-match/acceptable-mistranscription\n                if (similarity_js >= app.passmark ||\n                  app.wordsDoMatch(spoken_clean, correct_clean)) {\n                  log.debug('local match:' + ':' + spoken_clean + ':' + correct_clean);\n                  app.showStarRating(100);\n                  app.flagCorrectAndTransition();\n                  return;\n                }\n\n                //Similarity check by phonetics(ajax)\n                quizhelper.checkByPhonetic(correct_clean, spoken_clean, correctphonetic, app.language).then(function(similarity_php) {\n                  if (similarity_php === false) {\n                    return $.Deferred().reject();\n                  } else {\n                    log.debug('PHP similarity: ' + spoken_clean + ':' + correct_clean + ':' + similarity_php);\n\n                    if (similarity_php >= app.passmark) {\n                        app.showStarRating(similarity_php);\n                        app.flagCorrectAndTransition();\n                    }else{\n                        //show the greater of the ratings\n                        app.showStarRating(Math.max(similarity_js,similarity_php));\n                    }\n                  } //end of if check_by_phonetic result\n                }); //end of check by phonetic\n\n            } //end of switch message type\n          };\n\n\n\n         if(quizhelper.use_ttrecorder()) {\n             //init tt recorder\n             var opts = {};\n             opts.uniqueid = itemdata.uniqueid;\n             opts.callback = theCallback;\n             opts.stt_guided=quizhelper.is_stt_guided();\n             ttrecorder.clone().init(opts);\n         }else{\n             //init cloudpoodll push recorder\n             cloudpoodll.init('minilesson-recorder-speechcards-' + itemdata.id, theCallback);\n         }\n\n\n          //init progress dots\n          app.progress_dots(app.results, app.terms);\n\n          app.initSlider();\n\n\n        },\n\n        initSlider: function() {\n          app.controls.slider.text(app.displayterms[app.pointer - 1]);\n          app.controls.slider.show();\n        },\n\n        writeCurrentTerm: function() {\n            app.controls.slider.toggle(\"slide\",{direction:\"left\"});\n            app.controls.slider.text(app.displayterms[app.pointer - 1]);\n            app.controls.slider.toggle(\"slide\",{direction:\"right\"})\n        },\n\n        flagCorrectAndTransition: function() {\n\n          //update students word log if matched\n          app.check(true);\n\n          //transition if required\n          if (app.is_end()) {\n            setTimeout(function() {\n              app.do_end();\n            }, 700);\n          } else {\n            setTimeout(function() {\n              app.do_next();\n            }, 700);\n          }\n\n        },\n\n        wordsDoMatch: function(phraseheard, currentphrase) {\n          //lets lower case everything\n          phraseheard = quizhelper.cleanText(phraseheard);\n          currentphrase = quizhelper.cleanText(currentphrase);\n          if (phraseheard == currentphrase) {\n            return true;\n          }\n          return false;\n        },\n\n\n        showStarRating: function(similarity) {\n          //how many stars code\n          var stars = [true, true, true];\n          if (similarity < app.passmark) {\n            stars = [true, true, false];\n          }\n          if (similarity < .75) {\n            stars = [true, false, false];\n          }\n          if (similarity < 0.5) {\n            stars = [false, false, false];\n          }\n\n          //prepare stars html\n          var code = \"\";\n          stars.forEach(function(star) {\n            if (star === true) {\n              code += '<i class=\"fa fa-star\"></i>';\n            } else {\n              code += '<i class=\"fa fa-star-o\"></i>';\n            }\n          });\n\n          app.controls.star_rating.html(code);\n        },\n\n        check: function(correct) {\n          var points = 1;\n          if (correct == true) {\n            points = 1;\n          } else {\n            points = 0;\n          }\n          var result = {\n            points: points\n          };\n          app.results.push(result);\n        },\n\n        do_next: function() {\n          app.pointer++;\n          app.progress_dots(app.results, app.terms);\n          app.clearStarRating();\n          if (!app.is_end()) {\n            app.writeCurrentTerm();\n          } else {\n            app.do_end();\n          }\n        },\n\n        clearStarRating: function() {\n          app.controls.star_rating.html('· · ·');\n        },\n\n        do_end: function() {\n          app.next_question();\n        },\n\n        is_end: function() {\n          //pointer is 1 based but array is, of course, 0 based\n          if (app.pointer <= app.terms.length) {\n            return false;\n          } else {\n            return true;\n          }\n        },\n\n        progress_dots: function(results, terms) {\n\n          var code = \"\";\n          var color = \"\";\n          terms.forEach(function(o, i) {\n            color = \"darkgray\";\n            if (results[i] !== undefined) {\n              if (results[i].points) {\n                color = \"green\";\n              } else {\n                color = \"red\";\n              }\n            }\n            code += '<i style=\"color:' + color + ';\" class=\"fa fa-circle\"></i>';\n          });\n\n          $(\"#\" + itemdata.uniqueid + \"_container .minilesson_progress_dots\").html(code);\n\n        },\n      }; //end of app definition\n      app.init();\n\n    } //end of init_App\n\n\n  }; //end of return value\n});"],"names":["define","$","jqui","log","Ajax","def","polly","cloudpoodll","ttrecorder","debug","clone","extend","this","init","index","itemdata","quizhelper","init_app","console","app","passmark","pointer","jsondata","props","dryRun","language","terms","phonetics","displayterms","results","controls","i","sentences","length","sentence","phonetic","prompt","init_controls","initComponents","register_events","star_rating","uniqueid","next_button","slider","next_question","stepdata","hasgrade","totalitems","correctitems","filter","e","points","grade","Math","round","do_next","on","click","check","is_end","setTimeout","do_end","theCallback","message","type","speechtext","capturedspeech","spoken_clean","cleanText","correct_clean","correctphonetic","similarity_js","similarity","wordsDoMatch","showStarRating","flagCorrectAndTransition","checkByPhonetic","then","similarity_php","Deferred","reject","max","use_ttrecorder","opts","callback","stt_guided","is_stt_guided","id","progress_dots","initSlider","text","show","writeCurrentTerm","toggle","direction","phraseheard","currentphrase","stars","code","forEach","star","html","correct","result","push","clearStarRating","color","o","undefined"],"mappings":"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"}