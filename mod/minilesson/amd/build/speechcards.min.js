define ("mod_minilesson/speechcards",["jquery","jqueryui","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/cloudpoodllloader","mod_minilesson/ttrecorder"],function(a,b,c,d,e,f,g,h){"use strict";c.debug("MiniLesson Speechcards: initialising");return{clone:function clone(){return a.extend(!0,{},this)},init:function init(a,b,c){this.init_app(a,b,c)},init_app:function init_app(b,d,e){console.log(d);var f={passmark:85,pointer:1,jsondata:null,props:null,dryRun:!1,language:"en-US",terms:[],displayterms:[],results:[],controls:{},init:function init(){for(var a=0;a<d.sentences.length;a++){f.terms[a]=d.sentences[a].sentence;f.displayterms[a]=d.sentences[a].displaysentence}c.debug("app terms",f.terms);f.language=d.language;this.init_controls();this.initComponents();this.register_events()},init_controls:function init_controls(){f.controls={};f.controls.star_rating=a("#"+d.uniqueid+"_container .minilesson_star_rating");f.controls.next_button=a("#"+d.uniqueid+"_container .minilesson-speechcards_nextbutton");f.controls.slider=a("#"+d.uniqueid+"_container .minilesson_speechcards_target_phrase")},next_question:function next_question(){var a={index:b,hasgrade:!0,totalitems:f.terms.length,correctitems:f.results.filter(function(a){return 0<a.points}).length};a.grade=Math.round(100*(a.correctitems/a.totalitems));e.do_next(a)},register_events:function register_events(){a("#"+d.uniqueid+"_container .minilesson_nextbutton").on("click",function(){f.next_question()});f.controls.next_button.click(function(){f.check(!1);if(f.is_end()){setTimeout(function(){f.do_end()},200)}else{setTimeout(function(){f.do_next()},200)}})},initComponents:function initComponents(){var b=function(b){switch(b.type){case"recording":break;case"speech":c.debug("speech at speechcards");var d=b.capturedspeech,g=e.cleanText(d),h=g,i=f.terms[f.pointer-1];c.debug("speechtext:",d);c.debug("spoken:",h);c.debug("correct:",i);var j=e.similarity(h,i);c.debug("JS similarity: "+h+":"+i+":"+j);if(j>=f.passmark||f.wordsDoMatch(g,f.terms[f.pointer-1])){c.debug("local match::"+h+":"+i);f.showStarRating(100);f.flagCorrectAndTransition();return}e.checkByPhonetic(h,i,f.language).then(function(b){if(!1===b){return a.Deferred().reject()}else{c.debug("PHP similarity: "+h+":"+i+":"+b);f.showStarRating(b);if(b>=f.passmark){f.flagCorrectAndTransition()}}});}};if(e.use_ttrecorder()){var i={uniqueid:d.uniqueid,callback:b};h.clone().init(i)}else{g.init("minilesson-recorder-speechcards-"+d.id,b)}f.progress_dots(f.results,f.terms);f.initSlider()},initSlider:function initSlider(){f.controls.slider.text(f.displayterms[f.pointer-1]);f.controls.slider.show()},writeCurrentTerm:function writeCurrentTerm(){f.controls.slider.toggle("slide",{direction:"left"});f.controls.slider.text(f.displayterms[f.pointer-1]);f.controls.slider.toggle("slide",{direction:"right"})},flagCorrectAndTransition:function flagCorrectAndTransition(){f.check(!0);if(f.is_end()){setTimeout(function(){f.do_end()},700)}else{setTimeout(function(){f.do_next()},700)}},wordsDoMatch:function wordsDoMatch(a,b){a=e.cleanText(a);b=e.cleanText(b);if(a==b){return!0}return!1},showStarRating:function showStarRating(a){var b=[!0,!0,!0];if(1>a){b=[!0,!0,!1]}if(a<f.passmark){b=[!0,!1,!1]}if(.5>a){b=[!1,!1,!1]}var c="";b.forEach(function(a){if(!0===a){c+="<i class=\"fa fa-star\"></i>"}else{c+="<i class=\"fa fa-star-o\"></i>"}});f.controls.star_rating.html(c)},check:function check(a){var b=1;if(!0==a){b=1}else{b=0}var c={points:b};f.results.push(c)},do_next:function do_next(){f.pointer++;f.progress_dots(f.results,f.terms);f.clearStarRating();if(!f.is_end()){f.writeCurrentTerm()}else{f.do_end()}},clearStarRating:function clearStarRating(){f.controls.star_rating.html("\xB7 \xB7 \xB7")},do_end:function do_end(){f.next_question()},is_end:function is_end(){if(f.pointer<=f.terms.length){return!1}else{return!0}},progress_dots:function progress_dots(b,c){var e="",f="";c.forEach(function(a,c){f="darkgray";if(b[c]!==void 0){if(b[c].points){f="green"}else{f="red"}}e+="<i style=\"color:"+f+";\" class=\"fa fa-circle\"></i>"});a("#"+d.uniqueid+"_container .minilesson_progress_dots").html(e)}};f.init()}}});
//# sourceMappingURL=speechcards.min.js.map
