define(["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/cloudpoodllloader","mod_minilesson/ttrecorder","mod_minilesson/animatecss"],(function($,log,Ajax,def,polly,cloudpoodll,ttrecorder,anim){return log.debug("MiniLesson Speechcards: initialising"),{clone:function(){return $.extend(!0,{},this)},init:function(index,itemdata,quizhelper){this.init_app(index,itemdata,quizhelper)},init_app:function(index,itemdata,quizhelper){console.log(itemdata);var app={passmark:90,pointer:1,jsondata:null,props:null,dryRun:!1,language:"en-US",terms:[],phonetics:[],displayterms:[],results:[],controls:{},init:function(){for(var i=0;i<itemdata.sentences.length;i++)app.terms[i]=itemdata.sentences[i].sentence,app.phonetics[i]=itemdata.sentences[i].phonetic,app.displayterms[i]=itemdata.sentences[i].prompt;app.language=itemdata.language;var animopts={};animopts.useanimatecss=quizhelper.useanimatecss,anim.init(animopts),this.init_controls(),this.initComponents(),this.register_events()},init_controls:function(){app.controls={},app.controls.star_rating=$("#"+itemdata.uniqueid+"_container .minilesson_star_rating"),app.controls.next_button=$("#"+itemdata.uniqueid+"_container .minilesson-speechcards_nextbutton"),app.controls.slider=$("#"+itemdata.uniqueid+"_container .minilesson_speechcards_target_phrase")},next_question:function(){var stepdata={};stepdata.index=index,stepdata.hasgrade=!0,stepdata.totalitems=app.terms.length,stepdata.correctitems=app.results.filter((function(e){return e.points>0})).length,stepdata.grade=Math.round(stepdata.correctitems/stepdata.totalitems*100),quizhelper.do_next(stepdata)},register_events:function(){$("#"+itemdata.uniqueid+"_container .minilesson_nextbutton").on("click",(function(e){app.next_question()})),app.controls.next_button.click((function(){app.check(!1),app.is_end()?setTimeout((function(){app.do_end()}),200):setTimeout((function(){app.do_next()}),200)}))},initComponents:function(){var theCallback=function(message){switch(message.type){case"recording":break;case"speech":log.debug("speech at speechcards");var speechtext=message.capturedspeech,spoken_clean=quizhelper.cleanText(speechtext),correct_clean=quizhelper.cleanText(app.terms[app.pointer-1]),correctphonetic=app.phonetics[app.pointer-1];log.debug("speechtext:",speechtext),log.debug("spoken:",spoken_clean),log.debug("correct:",correct_clean);var similarity_js=quizhelper.similarity(spoken_clean,correct_clean);if(log.debug("JS similarity: "+spoken_clean+":"+correct_clean+":"+similarity_js),similarity_js>=app.passmark||app.wordsDoMatch(spoken_clean,correct_clean))return log.debug("local match::"+spoken_clean+":"+correct_clean),app.showStarRating(100),void app.flagCorrectAndTransition();quizhelper.checkByPhonetic(correct_clean,spoken_clean,correctphonetic,app.language).then((function(similarity_php){if(!1===similarity_php)return $.Deferred().reject();log.debug("PHP similarity: "+spoken_clean+":"+correct_clean+":"+similarity_php),similarity_php>=app.passmark?(app.showStarRating(similarity_php),app.flagCorrectAndTransition()):app.showStarRating(Math.max(similarity_js,similarity_php))}))}};if(quizhelper.use_ttrecorder()){var opts={};opts.uniqueid=itemdata.uniqueid,opts.callback=theCallback,opts.stt_guided=quizhelper.is_stt_guided(),ttrecorder.clone().init(opts)}else cloudpoodll.init("minilesson-recorder-speechcards-"+itemdata.id,theCallback);app.progress_dots(app.results,app.terms),app.initSlider()},initSlider:function(){app.controls.slider.text(app.displayterms[app.pointer-1]),app.controls.slider.show()},writeCurrentTerm:function(){anim.do_animate(app.controls.slider,"zoomOut animate__faster","out").then((function(){app.controls.slider.text(app.displayterms[app.pointer-1]),anim.do_animate(app.controls.slider,"zoomIn animate__faster","in")}))},flagCorrectAndTransition:function(){app.check(!0),app.is_end()?setTimeout((function(){app.do_end()}),700):setTimeout((function(){app.do_next()}),700)},wordsDoMatch:function(phraseheard,currentphrase){return(phraseheard=quizhelper.cleanText(phraseheard))==(currentphrase=quizhelper.cleanText(currentphrase))},showStarRating:function(similarity){var stars=[!0,!0,!0];similarity<app.passmark&&(stars=[!0,!0,!1]),similarity<.75&&(stars=[!0,!1,!1]),similarity<.5&&(stars=[!1,!1,!1]);var code="";stars.forEach((function(star){code+=!0===star?'<i class="fa fa-star"></i>':'<i class="fa fa-star-o"></i>'})),app.controls.star_rating.html(code)},check:function(correct){var result={points:1==correct?1:0};app.results.push(result)},do_next:function(){app.pointer++,app.progress_dots(app.results,app.terms),app.clearStarRating(),app.is_end()?app.do_end():app.writeCurrentTerm()},clearStarRating:function(){app.controls.star_rating.html("· · ·")},do_end:function(){app.next_question()},is_end:function(){return!(app.pointer<=app.terms.length)},progress_dots:function(results,terms){var code="",color="";terms.forEach((function(o,i){color="darkgray",void 0!==results[i]&&(color=results[i].points?"green":"red"),code+='<i style="color:'+color+';" class="fa fa-circle"></i>'})),$("#"+itemdata.uniqueid+"_container .minilesson_progress_dots").html(code)}};app.init()}}}));

//# sourceMappingURL=speechcards.min.js.map