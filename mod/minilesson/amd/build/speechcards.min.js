define(["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/cloudpoodllloader","mod_minilesson/ttrecorder","mod_minilesson/animatecss"],function(a,b,c,d,e,f,g,h){"use strict";b.debug("MiniLesson Speechcards: initialising");return{clone:function clone(){return a.extend(!0,{},this)},init:function init(a,b,c){this.init_app(a,b,c)},init_app:function init_app(c,d,e){console.log(d);var j={passmark:90,pointer:1,jsondata:null,props:null,dryRun:!1,language:"en-US",terms:[],phonetics:[],displayterms:[],results:[],controls:{},init:function init(){for(var a=0;a<d.sentences.length;a++){j.terms[a]=d.sentences[a].sentence;j.phonetics[a]=d.sentences[a].phonetic;j.displayterms[a]=d.sentences[a].prompt}j.language=d.language;var b={useanimatecss:e.useanimatecss};h.init(b);this.init_controls();this.initComponents();this.register_events()},init_controls:function init_controls(){j.controls={};j.controls.star_rating=a("#"+d.uniqueid+"_container .minilesson_star_rating");j.controls.next_button=a("#"+d.uniqueid+"_container .minilesson-speechcards_nextbutton");j.controls.slider=a("#"+d.uniqueid+"_container .minilesson_speechcards_target_phrase")},next_question:function next_question(){var a={index:c,hasgrade:!0,totalitems:j.terms.length,correctitems:j.results.filter(function(a){return 0<a.points}).length};a.grade=Math.round(100*(a.correctitems/a.totalitems));e.do_next(a)},register_events:function register_events(){a("#"+d.uniqueid+"_container .minilesson_nextbutton").on("click",function(){j.next_question()});j.controls.next_button.click(function(){j.check(!1);if(j.is_end()){setTimeout(function(){j.do_end()},200)}else{setTimeout(function(){j.do_next()},200)}})},initComponents:function initComponents(){var c=function(c){switch(c.type){case"recording":break;case"speech":b.debug("speech at speechcards");var d=c.capturedspeech,f=e.cleanText(d),g=e.cleanText(j.terms[j.pointer-1]),h=j.phonetics[j.pointer-1];b.debug("speechtext:",d);b.debug("spoken:",f);b.debug("correct:",g);var i=e.similarity(f,g);b.debug("JS similarity: "+f+":"+g+":"+i);if(i>=j.passmark||j.wordsDoMatch(f,g)){b.debug("local match::"+f+":"+g);j.showStarRating(100);j.flagCorrectAndTransition();return}e.checkByPhonetic(g,f,h,j.language).then(function(c){if(!1===c){return a.Deferred().reject()}else{b.debug("PHP similarity: "+f+":"+g+":"+c);if(c>=j.passmark){j.showStarRating(c);j.flagCorrectAndTransition()}else{j.showStarRating(Math.max(i,c))}}});}};if(e.use_ttrecorder()){var h={uniqueid:d.uniqueid,callback:c,stt_guided:e.is_stt_guided()};g.clone().init(h)}else{f.init("minilesson-recorder-speechcards-"+d.id,c)}j.progress_dots(j.results,j.terms);j.initSlider()},initSlider:function initSlider(){j.controls.slider.text(j.displayterms[j.pointer-1]);j.controls.slider.show()},writeCurrentTerm:function writeCurrentTerm(){h.do_animate(j.controls.slider,"zoomOut animate__faster","out").then(function(){j.controls.slider.text(j.displayterms[j.pointer-1]);h.do_animate(j.controls.slider,"zoomIn animate__faster","in")})},flagCorrectAndTransition:function flagCorrectAndTransition(){j.check(!0);if(j.is_end()){setTimeout(function(){j.do_end()},700)}else{setTimeout(function(){j.do_next()},700)}},wordsDoMatch:function wordsDoMatch(a,b){a=e.cleanText(a);b=e.cleanText(b);if(a==b){return!0}return!1},showStarRating:function showStarRating(a){var b=[!0,!0,!0];if(a<j.passmark){b=[!0,!0,!1]}if(.75>a){b=[!0,!1,!1]}if(.5>a){b=[!1,!1,!1]}var c="";b.forEach(function(a){if(!0===a){c+="<i class=\"fa fa-star\"></i>"}else{c+="<i class=\"fa fa-star-o\"></i>"}});j.controls.star_rating.html(c)},check:function check(a){var b=1;if(!0==a){b=1}else{b=0}var c={points:b};j.results.push(c)},do_next:function do_next(){j.pointer++;j.progress_dots(j.results,j.terms);j.clearStarRating();if(!j.is_end()){j.writeCurrentTerm()}else{j.do_end()}},clearStarRating:function clearStarRating(){j.controls.star_rating.html("\xB7 \xB7 \xB7")},do_end:function do_end(){j.next_question()},is_end:function is_end(){if(j.pointer<=j.terms.length){return!1}else{return!0}},progress_dots:function progress_dots(b,c){var e="",f="";c.forEach(function(a,c){f="darkgray";if(b[c]!==void 0){if(b[c].points){f="green"}else{f="red"}}e+="<i style=\"color:"+f+";\" class=\"fa fa-circle\"></i>"});a("#"+d.uniqueid+"_container .minilesson_progress_dots").html(e)}};j.init()}}});
//# sourceMappingURL=speechcards.min.js.map
