define("mod_minilesson/multiaudio",["jquery","core/log","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/cloudpoodllloader","mod_minilesson/ttrecorder"],(function($,log,def,polly,cloudpoodll,ttrecorder){return log.debug("MiniLesson Multiaudio: initialising"),{passmark:90,playing:!1,clone:function(){return $.extend(!0,{},this)},init:function(index,itemdata,quizhelper){this.prepare_audio(itemdata),this.register_events(index,itemdata,quizhelper),this.init_components(index,itemdata,quizhelper)},next_question:function(percent){var stepdata={};stepdata.index=this.index,stepdata.hasgrade=!0,stepdata.totalitems=1,stepdata.correctitems=percent>0?1:0,stepdata.grade=percent,this.quizhelper.do_next(stepdata)},register_events:function(index,itemdata,quizhelper){var self=this,theplayer=$("#"+itemdata.uniqueid+"_player");self.index=index,self.quizhelper=quizhelper,$("#"+itemdata.uniqueid+"_container .minilesson_nextbutton").on("click",(function(e){self.next_question(0)})),$("#"+itemdata.uniqueid+"_container .mcplayrow").on("click",(function(e){if(!$("#"+itemdata.uniqueid+"_container .mcplayrow").hasClass("minilesson_mc_disabled"))if(self.playing)theplayer[0].pause(),theplayer[0].currentTime=0,$("#"+itemdata.uniqueid+"_container .minilesson_mc_playstate").removeClass("fa-spin fa-spinner").addClass("fa-play"),self.playing=!1;else{var el=this;self.playing=!0,theplayer.attr("src",$(this).attr("data-src")),theplayer[0].play(),theplayer[0].onended=function(){$(el).find(".minilesson_mc_playstate").removeClass("fa-spin fa-spinner").addClass("fa-play"),self.playing=!1},$(el).find(".minilesson_mc_playstate").removeClass("fa-play").addClass("fa-spin fa-spinner")}}))},prepare_audio:function(itemdata){$.each(itemdata.sentences,(function(index,sentence){polly.fetch_polly_url(sentence.sentence,itemdata.voiceoption,itemdata.usevoice).then((function(audiourl){$("#"+itemdata.uniqueid+"_option"+(index+1)).attr("data-src",audiourl)}))}))},process_accepted_response:function(itemdata,checked){if($("#"+itemdata.uniqueid+"_container .mcplayrow").addClass("minilesson_mc_disabled"),0==parseInt(itemdata.show_text))for(var i=0;i<itemdata.sentences.length;i++){$("#"+itemdata.uniqueid+"_option"+(i+1));$("#"+itemdata.uniqueid+"_option"+(i+1)+" .minilesson_sentence").text(itemdata.sentences[i].sentence)}return $("#"+itemdata.uniqueid+"_container .minilesson_mc_wrong").show(),$("#"+itemdata.uniqueid+"_option"+itemdata.correctanswer+" .minilesson_mc_wrong").hide(),$("#"+itemdata.uniqueid+"_option"+itemdata.correctanswer+" .minilesson_mc_right").show(),$("#"+itemdata.uniqueid+"_option"+checked+" .minilesson_mc_response").addClass("minilesson_mc_selected"),checked==itemdata.correctanswer?100:0},init_components:function(index,itemdata,quizhelper){for(var app=this,correcttext=itemdata.sentences[itemdata.correctanswer-1].sentence,correctphonetic=itemdata.sentences[itemdata.correctanswer-1].phonetic,cleanincorrecttexts=[],i=0;i<itemdata.sentences.length;i++)i+1==itemdata.correctanswer?cleanincorrecttexts[i]="":cleanincorrecttexts[i]=quizhelper.cleanText(itemdata.sentences[i].sentence);var cleancorrecttext=quizhelper.cleanText(correcttext),theCallback=function(message){switch(message.type){case"recording":break;case"speech":log.debug("speech at multiaudio");var speechtext=message.capturedspeech,cleanspeechtext=quizhelper.cleanText(speechtext),spoken=cleanspeechtext;log.debug("speechtext:",speechtext),log.debug("spoken:",spoken),log.debug("correct:",cleancorrecttext);var similarity=quizhelper.similarity(spoken,cleancorrecttext);if(log.debug("JS similarity: "+spoken+":"+cleancorrecttext+":"+similarity),similarity>=app.passmark||app.wordsDoMatch(quizhelper,cleanspeechtext,cleancorrecttext)){log.debug("local correct match::"+spoken+":"+cleancorrecttext);var percent=app.process_accepted_response(itemdata,itemdata.correctanswer);return void setTimeout((function(){$(".minilesson_nextbutton").prop("disabled",!1),app.next_question(percent)}),2e3)}for(var x=0;x<cleanincorrecttexts.length;x++)if(""!==cleanincorrecttexts[x]){var similar=quizhelper.similarity(spoken,cleanincorrecttexts[x]);if(log.debug("JS similarity: "+spoken+":"+cleanincorrecttexts[x]+":"+similar),similar>=app.passmark||app.wordsDoMatch(quizhelper,cleanspeechtext,cleanincorrecttexts[x])){percent=app.process_accepted_response(itemdata,x+1);return $(".minilesson_nextbutton").prop("disabled",!0),void setTimeout((function(){$(".minilesson_nextbutton").prop("disabled",!1),app.next_question(percent)}),2e3)}}quizhelper.checkByPhonetic(cleancorrecttext,spoken,correctphonetic,itemdata.language).then((function(similarity){if(!1===similarity)return $.Deferred().reject();if(log.debug("PHP similarity: "+spoken+":"+cleancorrecttext+":"+similarity),similarity>=app.passmark){var percent=app.process_accepted_response(itemdata,itemdata.correctanswer);$(".minilesson_nextbutton").prop("disabled",!0),setTimeout((function(){$(".minilesson_nextbutton").prop("disabled",!1),app.next_question(percent)}),2e3)}}))}};if(quizhelper.use_ttrecorder()){var opts={};opts.uniqueid=itemdata.uniqueid,log.debug("ma uniqueid:"+itemdata.uniqueid),opts.callback=theCallback,opts.stt_guided=quizhelper.is_stt_guided(),ttrecorder.clone().init(opts)}else cloudpoodll.init("minilesson-recorder-multiaudio-"+itemdata.id,theCallback)},wordsDoMatch:function(quizhelper,phraseheard,currentphrase){return(phraseheard=quizhelper.cleanText(phraseheard))==(currentphrase=quizhelper.cleanText(currentphrase))}}}));

//# sourceMappingURL=multiaudio.min.js.map