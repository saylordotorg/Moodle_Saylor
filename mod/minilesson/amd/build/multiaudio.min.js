define ("mod_minilesson/multiaudio",["jquery","core/log","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/cloudpoodllloader","mod_minilesson/ttrecorder"],function(a,b,c,d,e,f){"use strict";b.debug("MiniLesson Multiaudio: initialising");return{passmark:90,playing:!1,clone:function clone(){return a.extend(!0,{},this)},init:function init(a,b,c){this.prepare_audio(b);this.register_events(a,b,c);this.init_components(a,b,c)},next_question:function next_question(a){var b=this,c={};c.index=b.index;c.hasgrade=!0;c.totalitems=1;c.correctitems=0<a?1:0;c.grade=a;b.quizhelper.do_next(c)},register_events:function register_events(b,c,d){var e=this,f=a("#"+c.uniqueid+"_player");e.index=b;e.quizhelper=d;a("#"+c.uniqueid+"_container .minilesson_nextbutton").on("click",function(){e.next_question(0)});a("#"+c.uniqueid+"_container .mcplayrow").on("click",function(){if(a("#"+c.uniqueid+"_container .mcplayrow").hasClass("minilesson_mc_disabled")){return}if(!e.playing){var b=this;e.playing=!0;f.attr("src",a(this).attr("data-src"));f[0].play();f[0].onended=function(){a(b).find(".minilesson_mc_playstate").removeClass("fa-spin fa-spinner").addClass("fa-play");e.playing=!1};a(b).find(".minilesson_mc_playstate").removeClass("fa-play").addClass("fa-spin fa-spinner")}else{f[0].pause();f[0].currentTime=0;a("#"+c.uniqueid+"_container .minilesson_mc_playstate").removeClass("fa-spin fa-spinner").addClass("fa-play");e.playing=!1}})},prepare_audio:function prepare_audio(b){a.each(b.sentences,function(c,e){d.fetch_polly_url(e.sentence,b.voiceoption,b.usevoice).then(function(d){a("#"+b.uniqueid+"_option"+(c+1)).attr("data-src",d)})})},process_accepted_response:function process_accepted_response(b,c){a("#"+b.uniqueid+"_container .mcplayrow").addClass("minilesson_mc_disabled");if(0==parseInt(b.show_text)){for(var d=0;d<b.sentences.length;d++){a("#"+b.uniqueid+"_option"+(d+1));a("#"+b.uniqueid+"_option"+(d+1)+" .minilesson_sentence").text(b.sentences[d].sentence)}}a("#"+b.uniqueid+"_container .minilesson_mc_wrong").show();a("#"+b.uniqueid+"_option"+b.correctanswer+" .minilesson_mc_wrong").hide();a("#"+b.uniqueid+"_option"+b.correctanswer+" .minilesson_mc_right").show();a("#"+b.uniqueid+"_option"+c+" .minilesson_mc_response").addClass("minilesson_mc_selected");var e=c==b.correctanswer?100:0;return e},init_components:function init_components(c,d,g){for(var h=this,j=d.sentences[d.correctanswer-1].sentence,k=d.sentences[d.correctanswer-1].phonetic,l=[],m=0;m<d.sentences.length;m++){if(m+1==d.correctanswer){l[m]=""}else{l[m]=g.cleanText(d.sentences[m].sentence)}}var n=g.cleanText(j),o=function(c){switch(c.type){case"recording":break;case"speech":b.debug("speech at multiaudio");var e=c.capturedspeech,f=g.cleanText(e),i=f;b.debug("speechtext:",e);b.debug("spoken:",i);b.debug("correct:",n);var j=g.similarity(i,n);b.debug("JS similarity: "+i+":"+n+":"+j);if(j>=h.passmark||h.wordsDoMatch(g,f,n)){b.debug("local correct match::"+i+":"+n);var m=h.process_accepted_response(d,d.correctanswer);setTimeout(function(){a(".minilesson_nextbutton").prop("disabled",!1);h.next_question(m)},2e3);return}else{for(var o=0;o<l.length;o++){if(""===l[o]){continue}var p=g.similarity(i,l[o]);b.debug("JS similarity: "+i+":"+l[o]+":"+p);if(p>=h.passmark||h.wordsDoMatch(g,f,l[o])){var m=h.process_accepted_response(d,o+1);a(".minilesson_nextbutton").prop("disabled",!0);setTimeout(function(){a(".minilesson_nextbutton").prop("disabled",!1);h.next_question(m)},2e3);return}}}g.checkByPhonetic(n,i,k,d.language).then(function(c){if(!1===c){return a.Deferred().reject()}else{b.debug("PHP similarity: "+i+":"+n+":"+c);if(c>=h.passmark){var e=h.process_accepted_response(d,d.correctanswer);a(".minilesson_nextbutton").prop("disabled",!0);setTimeout(function(){a(".minilesson_nextbutton").prop("disabled",!1);h.next_question(e)},2e3)}}});}};if(g.use_ttrecorder()){var p={uniqueid:d.uniqueid};b.debug("ma uniqueid:"+d.uniqueid);p.callback=o;p.ds_only=g.is_ds_only();f.clone().init(p)}else{e.init("minilesson-recorder-multiaudio-"+d.id,o)}},wordsDoMatch:function wordsDoMatch(a,b,c){b=a.cleanText(b);c=a.cleanText(c);if(b==c){return!0}return!1}}});
//# sourceMappingURL=multiaudio.min.js.map
