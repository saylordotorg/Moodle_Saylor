define(["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/animatecss"],function(a,b,c,d,e,f){"use strict";b.debug("MiniLesson dictation chat: initialising");return{clone:function clone(){return a.extend(!0,{},this)},usevoice:"Amy",init:function init(a,b,c){var d=this;d.itemdata=b;d.quizhelper=c;d.index=a;var e={useanimatecss:c.useanimatecss};f.init(e);d.register_events();d.setvoice();d.getItems()},next_question:function next_question(){var a=this,b={};b.index=a.index;b.hasgrade=!0;b.totalitems=a.items.length;b.correctitems=a.items.filter(function(a){return a.correct}).length;b.grade=Math.round(100*(b.correctitems/b.totalitems));a.quizhelper.do_next(b)},register_events:function register_events(){var b=this;a("#"+b.itemdata.uniqueid+"_container .minilesson_nextbutton").on("click",function(){b.next_question()});a("#"+b.itemdata.uniqueid+"_container .dictate_start_btn").on("click",function(){b.start()});a("#"+b.itemdata.uniqueid+"_container .dictate_listen_btn").on("click",function(){b.items[b.game.pointer].audio.load();b.items[b.game.pointer].audio.play()});a("#"+b.itemdata.uniqueid+"_container .dictate_skip_btn").on("click",function(){a("#"+b.itemdata.uniqueid+"_container .dictate_ctrl-btn").prop("disabled",!0);a("#"+b.itemdata.uniqueid+"_container .dictate_speech.dictate_teacher_left").text(b.items[b.game.pointer].prompt+"");a("#"+b.itemdata.uniqueid+"_container .dictate_targetWord").each(function(){var c=a(this).data("realidx"),d=b.items[b.game.pointer].dictate_targetWords[c];a(this).val(d)});if(b.game.pointer<b.items.length-1){setTimeout(function(){b.items[b.game.pointer].answered=!0;b.items[b.game.pointer].correct=!1;b.game.pointer++;b.nextPrompt()},3e3)}else{b.end()}});a("#"+b.itemdata.uniqueid+"_container .dictate_check_btn").on("click",function(){b.check_answer()});a("#"+b.itemdata.uniqueid+"_container").on("keydown",".dictate_targetWord",function(a){if(13==a.which){b.check_answer()}});a("#"+b.itemdata.uniqueid+"_container").on("keyup",".dictate_targetWord",function(c){var d=c.srcElement||c.target,e=parseInt(d.attributes.maxlength.value,10),f=d.value.length,g=c.which;if(f>=e){var h=a(this).data("idx")+1,i=a("#"+b.itemdata.uniqueid+"_container input.dictate_targetWord[data-idx=\""+h+"\"");if(1===i.length){i.focus()}}else if((8==g||46==g)&&0===f){var j=a(this).data("idx")-1,k=a("#"+b.itemdata.uniqueid+"_container input.dictate_targetWord[data-idx=\""+j+"\"");if(1===k.length){k.focus()}}})},game:{pointer:0},check_answer:function check_answer(){var b=this,c=b.items[b.game.pointer].target,d="";a("#"+b.itemdata.uniqueid+"_container .dictate_targetBit").each(function(){if(a(this).hasClass("dictate_targetWord")){d+=a(this).val()}else if(a(this).hasClass("dictate_targetWordPunc")){d+=a(this).text()}});b.getComparison(c,d,function(a){b.gotComparison(a,d)})},setvoice:function setvoice(){var a=this;a.usevoice=a.itemdata.usevoice;a.voiceoption=a.itemdata.voiceoption},getItems:function getItems(){var b=this,c=b.itemdata.sentences;b.items=c.map(function(a){return{dictate_targetWords:a.sentence.trim().split(b.quizhelper.spliton_regexp).filter(function(a){return""!==a}),target:a.sentence,prompt:a.prompt,displayprompt:a.displayprompt,typed:"",answered:!1,correct:!1,audio:null}}).filter(function(a){return""!==a.target});a.each(b.items,function(a,c){e.fetch_polly_url(c.prompt,b.voiceoption,b.usevoice).then(function(a){c.audio=new Audio;c.audio.src=a;if(0==b.items.filter(function(a){return null==a.audio}).length){b.appReady()}else{console.log(b.items)}})})},appReady:function appReady(){var b=this;a("#"+b.itemdata.uniqueid+"_container .dictate_not_loaded").hide();a("#"+b.itemdata.uniqueid+"_container .dictate_loaded").show();a("#"+b.itemdata.uniqueid+"_container .dictate_start_btn").prop("disabled",!1)},gotComparison:function gotComparison(b,c){var d=this;a("#"+d.itemdata.uniqueid+"_container .dictate_targetWord").removeClass("dictate_correct dictate_incorrect");a("#"+d.itemdata.uniqueid+"_container .dictate_feedback").removeClass("fa fa-check fa-times");var e=0==b.filter(function(a){return!a.matched}).length;if(e){a("#"+d.itemdata.uniqueid+"_container .dictate_targetWord").addClass("dictate_correct").prop("disabled",!0);a("#"+d.itemdata.uniqueid+"_container .dictate_feedback").addClass("fa fa-check");a("#"+d.itemdata.uniqueid+"_container .dictate_speech.dictate_teacher_left").text(d.items[d.game.pointer].target+"");d.items[d.game.pointer].answered=!0;d.items[d.game.pointer].correct=!0;d.items[d.game.pointer].typed=c;a("#"+d.itemdata.uniqueid+"_container .dictate_ctrl-btn").prop("disabled",!0);if(d.game.pointer<d.items.length-1){setTimeout(function(){d.game.pointer++;d.nextPrompt()},2200)}else{d.end()}}else{b.forEach(function(b){if(!b.matched){a("#"+d.itemdata.uniqueid+"_container .dictate_targetWord[data-idx='"+b.wordnumber+"']").addClass("dictate_incorrect");a("#"+d.itemdata.uniqueid+"_container .dictate_feedback[data-idx='"+b.wordnumber+"']").addClass("fa fa-times")}else{a("#"+d.itemdata.uniqueid+"_container .dictate_targetWord[data-idx='"+b.wordnumber+"']").addClass("dictate_correct").prop("disabled",!0);a("#"+d.itemdata.uniqueid+"_container .dictate_feedback[data-idx='"+b.wordnumber+"']").addClass("fa fa-check")}});var g=a("#"+d.itemdata.uniqueid+"_container .dictate_reply_"+d.game.pointer);f.do_animate(g,"shakeX animate__faster").then(function(){a("#"+d.itemdata.uniqueid+"_container .dictate_ctrl-btn").prop("disabled",!1)})}a("#"+d.itemdata.uniqueid+"_container .dictate_targetWord.dictate_correct").each(function(){var b=a(this).data("realidx"),c=d.items[d.game.pointer].dictate_targetWords[b];a(this).val(c)})},getWords:function getWords(a){var b=this;if("false"==!1){a=a.toLowerCase()}for(var c=a.split(b.quizhelper.spliton_regexp).filter(function(a){return""!==a}),d=[],e=0;e<c.length;e++){if(!c[e].match(b.quizhelper.spliton_regexp)){d.push(c[e])}}return d},getComparison:function getComparison(b,c,d){var e=this;a(".dictate_ctrl-btn").prop("disabled",!0);e.quizhelper.comparePassageToTranscript(b,c,"",e.itemdata.language).then(function(a){var b=JSON.parse(a);if(b){d(b)}else{d(!1)}})},end:function end(){var b=this;a(".minilesson_nextbutton").prop("disabled",!0);setTimeout(function(){a(".minilesson_nextbutton").prop("disabled",!1);b.next_question()},2200)},start:function start(){var b=this;a("#"+b.itemdata.uniqueid+"_container .dictate_ctrl-btn").prop("disabled",!0);b.items.forEach(function(a){a.spoken="";a.answered=!1;a.correct=!1});b.game.pointer=0;a("#"+b.itemdata.uniqueid+"_container .dictate_game").show();a("#"+b.itemdata.uniqueid+"_container .dictate_start_btn").hide();a("#"+b.itemdata.uniqueid+"_container .dictate_mainmenu").hide();a("#"+b.itemdata.uniqueid+"_container .dictate_controls").show();b.nextPrompt()},nextPrompt:function nextPrompt(){var b=this,c=b.items[b.game.pointer].target,d=b.items[b.game.pointer].prompt,e=b.items[b.game.pointer].displayprompt,g=d.replace(b.quizhelper.nopunc_regexp,""),h=g.replace(b.quizhelper.nonspaces_regexp,"\u2022"),i="<div class='dictate_prompt dictate_prompt_"+b.game.pointer+"' style='display:none;'>";i+="<i class='fa fa-graduation-cap dictate_speech-icon-left'></i>";i+="<div style='margin-left:90px;' class='dictate_speech dictate_teacher_left'>";i+=h;i+="</div>";i+="</div>";a("#"+b.itemdata.uniqueid+"_container .dictate_game").html(i);a(".dictate_ctrl-btn").prop("disabled",!1);var j,k=b.items.map(function(a,c){j="gray";if(b.items[c].answered&&b.items[c].correct){j="green"}else if(b.items[c].answered&&!b.items[c].correct){j="red"}return"<i style='color:"+j+"' class='fa fa-circle'></i>"}).join(" ");a("#"+b.itemdata.uniqueid+"_container .dictate_title").html(k);var l=a(".dictate_prompt_"+b.game.pointer);f.do_animate(l,"zoomIn animate__faster","in").then(function(){});b.nextReply()},nextReply:function nextReply(){var b=this,c=b.items[b.game.pointer].target,d="<div class='dictate_reply dictate_reply_"+b.game.pointer+"' style='display:none;'>";d+="<i class='fa fa-user dictate_speech-icon-right'></i>";var e="",g=1;b.items[b.game.pointer].dictate_targetWords.forEach(function(a,c){if(!a.match(b.quizhelper.spliton_regexp)){e+="<ruby><input type='text' maxlength='"+a.length+"' size='"+(a.length+1)+"' class='dictate_targetBit dictate_targetWord' data-realidx='"+c+"' data-idx='"+g+"'><rt><i data-idx='"+g+"' class='dictate_feedback'></i></rt></ruby>";g++}else{e+="<span class='dictate_targetBit dictate_targetWordPunc' data-idx='"+g+"'>"+a+"</span>"}});d+="<div style='margin-right:90px;' class='dictate_speech dictate_right'>"+e+"</div>";d+="</div>";a("#"+b.itemdata.uniqueid+"_container .dictate_game").append(d);var h=a(".dictate_reply_"+b.game.pointer);f.do_animate(h,"zoomIn animate__faster","in").then(function(){});a("#"+b.itemdata.uniqueid+"_container .dictate_ctrl-btn").prop("disabled",!1);setTimeout(function(){a(".dictate_targetWord").first().focus();a("#"+b.itemdata.uniqueid+"_container .dictate_listen_btn").trigger("click")},500)}}});
//# sourceMappingURL=dictationchat.min.js.map
