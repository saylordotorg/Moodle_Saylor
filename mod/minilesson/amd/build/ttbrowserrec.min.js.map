{"version":3,"sources":["../src/ttbrowserrec.js"],"names":["define","$","log","debug","recognition","recognizing","final_transcript","start_timestamp","lang","interval","clone","extend","will_work_ok","window","init","waveheight","uniqueid","SpeechRecognition","webkitSpeechRecognition","continuous","interimResults","waveHeight","prepare_html","register_events","canvas","canvasCtx","getContext","set_grammar","grammar","SpeechGrammarList","webkitSpeechGrammarList","speechRecognitionList","addFromString","grammars","start","that","Date","now","onstart","setInterval","drawWave","stop","clearInterval","clearRect","width","setTimeout","onfinalspeechcapture","onend","onerror","event","error","timeStamp","onresult","interim_transcript","i","resultIndex","results","length","isFinal","transcript","oninterimspeechcapture","bufferLength","fillStyle","fillRect","lineWidth","strokeStyle","beginPath","x","v","Math","random","y","lineTo","stroke","speechtext"],"mappings":"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","sourcesContent":["/* jshint ignore:start */\ndefine(['jquery', 'core/log'], function ($, log) {\n\n    \"use strict\"; // jshint ;_;\n\n    log.debug('speech_browser: initialising');\n\n    return {\n\n        recognition: null,\n        recognizing: false,\n        final_transcript: '',\n        start_timestamp: 0,\n        lang: 'en-US',\n        interval: 0,\n\n\n        //for making multiple instances\n        clone: function () {\n            return $.extend(true, {}, this);\n        },\n\n        will_work_ok: function(opts){\n            return 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;\n        },\n\n        init: function (lang,waveheight,uniqueid) {\n            var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;\n            this.recognition = new SpeechRecognition();\n            this.recognition.continuous = true;\n            this.recognition.interimResults = false;\n            this.lang = lang;\n            this.waveHeight = waveheight;\n            this.uniqueid = uniqueid;\n            this.prepare_html();\n            this.register_events();\n        },\n\n        prepare_html: function(){\n            this.canvas =$('#' + this.uniqueid + \"_waveform\");\n            this.canvasCtx = this.canvas[0].getContext(\"2d\");\n        },\n\n        set_grammar: function (grammar) {\n            var SpeechGrammarList = SpeechGrammarList || webkitSpeechGrammarList;\n            if (SpeechGrammarList) {\n                var speechRecognitionList = new SpeechGrammarList();\n                speechRecognitionList.addFromString(grammar, 1);\n                this.recognition.grammars = speechRecognitionList;\n            }\n        },\n\n        start: function () {\n            var that =this;\n\n            //If we already started ignore this\n            if (this.recognizing) {\n                return;\n            }\n            this.recognizing = true;\n            this.final_transcript = '';\n            this.recognition.lang = this.lang;//select_dialect.value;\n            this.recognition.start();\n            this.start_timestamp = Date.now();//event.timeStamp;\n            that.onstart();\n\n\n            //kick off animation\n            that.interval = setInterval(function() {\n                that.drawWave();\n            }, 100);\n\n\n        },\n        stop: function () {\n            var that=this;\n            this.recognizing = false;\n            this.recognition.stop();\n            clearInterval(this.interval);\n            this.canvasCtx.clearRect(0, 0, this.canvas.width()*2, this.waveHeight * 2);\n            setTimeout(function() {\n                that.onfinalspeechcapture(that.final_transcript);\n            }, 1000);\n            this.onend();\n        },\n\n        register_events: function () {\n\n            var recognition = this.recognition;\n            var that = this;\n\n            recognition.onerror = function (event) {\n                if (event.error == 'no-speech') {\n                    log.debug('info_no_speech');\n                }\n                if (event.error == 'audio-capture') {\n                    log.debug('info_no_microphone');\n                }\n                if (event.error == 'not-allowed') {\n                    if (event.timeStamp - that.start_timestamp < 100) {\n                        log.debug('info_blocked');\n                    } else {\n                        log.debug('info_denied');\n                    }\n                }\n                that.onerror();\n            };\n\n            recognition.onend = function () {\n                if(that.recognizing){\n                    that.recognition.start();\n                }\n\n            };\n\n            recognition.onresult = function (event) {\n                var interim_transcript = '';\n                for (var i = event.resultIndex; i < event.results.length; ++i) {\n                    if (event.results[i].isFinal) {\n                        that.final_transcript += event.results[i][0].transcript;\n                    } else {\n                        interim_transcript += event.results[i][0].transcript;\n                        that.oninterimspeechcapture(interim_transcript);\n                    }\n                }\n\n            };\n        },//end of register events\n\n        drawWave: function() {\n\n            var width = this.canvas.width() * 2;\n            var bufferLength=4096;\n\n            this.canvasCtx.fillStyle = 'white';\n            this.canvasCtx.fillRect(0, 0, width, this.waveHeight*2);\n\n            this.canvasCtx.lineWidth = 5;\n            this.canvasCtx.strokeStyle = 'gray';\n            this.canvasCtx.beginPath();\n\n            var slicewaveWidth = width / bufferLength;\n            var x = 0;\n\n            for (var i = 0; i < bufferLength; i++) {\n\n                var v = ((Math.random() * 64) + 96) / 128.0;\n                var y = v * this.waveHeight;\n\n                if (i === 0) {\n                    // this.canvasCtx.moveTo(x, y);\n                } else {\n                    this.canvasCtx.lineTo(x, y);\n                }\n                x += slicewaveWidth;\n            }\n\n            this.canvasCtx.lineTo(width, this.waveHeight);\n            this.canvasCtx.stroke();\n\n        },\n\n        onstart: function () {\n            log.debug('started');\n        },\n        onerror: function () {\n            log.debug('error');\n        },\n        onend: function () {\n            log.debug('end');\n        },\n        onfinalspeechcapture: function (speechtext) {\n            log.debug(speechtext);\n        },\n        oninterimspeechcapture: function (speechtext) {\n            // log.debug(speechtext);\n        }\n\n    };//end of returned object\n});//total end\n"],"file":"ttbrowserrec.min.js"}