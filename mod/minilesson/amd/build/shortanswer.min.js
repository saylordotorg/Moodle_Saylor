define(["jquery","core/log","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/cloudpoodllloader","mod_minilesson/ttrecorder","mod_minilesson/animatecss"],function(a,b,c,d,e,f,g){"use strict";b.debug("MiniLesson ShortAnswer: initialising");return{passmark:90,clone:function clone(){return a.extend(!0,{},this)},init:function init(a,b,c){var d={useanimatecss:c.useanimatecss};g.init(d);this.register_events(a,b,c);this.init_components(a,b,c)},next_question:function next_question(a){var b=this,c={};c.index=b.index;c.hasgrade=!0;c.totalitems=1;c.correctitems=0<a?1:0;c.grade=a;b.quizhelper.do_next(c)},prepare_audio:function prepare_audio(b){a.each(b.sentences,function(c,e){d.fetch_polly_url(e.sentence,b.voiceoption,b.usevoice).then(function(d){a("#"+b.uniqueid+"_option"+(c+1)).attr("data-src",d)})})},register_events:function register_events(b,c,d){var e=this;e.index=b;e.quizhelper=d;a("#"+c.uniqueid+"_container .minilesson_nextbutton").on("click",function(){e.next_question(0)});a("#"+c.uniqueid+"_container ."+c.uniqueid+"_option").on("click",function(){a("."+c.uniqueid+"_option").prop("disabled",!0);a("."+c.uniqueid+"_fb").html("<i style='color:red;' class='fa fa-times'></i>");a("."+c.uniqueid+"_option"+c.correctanswer+"_fb").html("<i style='color:green;' class='fa fa-check'></i>");var b=a("input[name="+c.uniqueid+"_options]:checked").data("index"),d=b==c.correctanswer?100:0;a(".minilesson_nextbutton").prop("disabled",!0);setTimeout(function(){a(".minilesson_nextbutton").prop("disabled",!1);e.next_question(d)},2e3)})},init_components:function init_components(c,d,e){for(var h=this,j=d.sentences,k=0;k<j.length;k++){j[k].originalsentence=j[k].sentence;j[k].sentence=e.cleanText(j[k].sentence)}var l=function(c){switch(c.type){case"recording":break;case"speech":b.debug("speech at shortanswer");var f=c.capturedspeech,k=e.cleanText(f),l=k;b.debug("speechtext:",f);b.debug("cleanspeechtext:",l);for(var m=!1,n=0,o=0;o<j.length;o++){if(""===j[o].sentence){continue}var p=e.similarity(l,j[o].sentence);b.debug("JS similarity: "+l+":"+j[o].sentence+":"+p);if(p>=h.passmark||h.spokenIsCorrect(e,k,j[o].sentence)){n=h.process_accepted_response(d,o);m=!0;break}}if(!m){for(o=0;o<j.length;o++){var q=e.checkByPhonetic(j[o].sentence,l,j[o].phonetic,d.language);if(!(!q||q<h.passmark)){m=!0;b.debug("PHP similarity: "+l+q);n=h.process_accepted_response(d,o);break}}}if(!m){for(o=0;o<j.length;o++){for(var r=e.comparePassageToTranscript(j[o].sentence,l,j[o].phonetic,d.language),s=JSON.parse(r),t=!1,u=0;u<s.length;u++){if(!1===s[u].matched){t=!0;break}}if(!t){n=h.process_accepted_response(d,o);m=!0;break}}}if(m){a(".minilesson_nextbutton").prop("disabled",!0);setTimeout(function(){a(".minilesson_nextbutton").prop("disabled",!1);h.next_question(n)},2e3)}else{var v=a("#"+d.uniqueid+"_correctanswer");g.do_animate(v,"rubberBand animate__faster").then(function(){})}}},m={};m.uniqueid=d.uniqueid;b.debug("sa uniqueid:"+d.uniqueid);m.callback=l;m.stt_guided=e.is_stt_guided();f.clone().init(m)},spokenIsCorrect:function spokenIsCorrect(a,b,c){b=a.cleanText(b);c=a.cleanText(c);if(b===c){return!0}return!1},process_accepted_response:function process_accepted_response(b,c){var d=0<=c?100:0;if(0<d){if(0===parseInt(b.show_text)){for(var e=0;e<b.sentences.length;e++){a("#"+b.uniqueid+"_option"+(e+1));a("#"+b.uniqueid+"_option"+(e+1)+" .minilesson_sentence").text(b.sentences[e].sentence)}}var f=a("#"+b.uniqueid+"_correctanswer");f.text(b.sentences[c].originalsentence);f.addClass("minilesson_success")}return d}}});
//# sourceMappingURL=shortanswer.min.js.map
