function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}define("mod_minilesson/shortanswer",["jquery","core/log","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/cloudpoodllloader","mod_minilesson/ttrecorder","mod_minilesson/animatecss"],(function($,log,def,polly,cloudpoodll,ttrecorder,anim){return log.debug("MiniLesson ShortAnswer: initialising"),{passmark:90,clone:function(){return $.extend(!0,{},this)},init:function(index,itemdata,quizhelper){var animopts={};animopts.useanimatecss=quizhelper.useanimatecss,anim.init(animopts),this.register_events(index,itemdata,quizhelper),this.init_components(index,itemdata,quizhelper)},next_question:function(percent){var stepdata={};stepdata.index=this.index,stepdata.hasgrade=!0,stepdata.totalitems=1,stepdata.correctitems=percent>0?1:0,stepdata.grade=percent,this.quizhelper.do_next(stepdata)},prepare_audio:function(itemdata){$.each(itemdata.sentences,(function(index,sentence){polly.fetch_polly_url(sentence.sentence,itemdata.voiceoption,itemdata.usevoice).then((function(audiourl){$("#"+itemdata.uniqueid+"_option"+(index+1)).attr("data-src",audiourl)}))}))},register_events:function(index,itemdata,quizhelper){var self=this;self.index=index,self.quizhelper=quizhelper,$("#"+itemdata.uniqueid+"_container .minilesson_nextbutton").on("click",(function(e){self.next_question(0)})),$("#"+itemdata.uniqueid+"_container ."+itemdata.uniqueid+"_option").on("click",(function(e){$("."+itemdata.uniqueid+"_option").prop("disabled",!0),$("."+itemdata.uniqueid+"_fb").html("<i style='color:red;' class='fa fa-times'></i>"),$("."+itemdata.uniqueid+"_option"+itemdata.correctanswer+"_fb").html("<i style='color:green;' class='fa fa-check'></i>");var percent=$("input[name="+itemdata.uniqueid+"_options]:checked").data("index")==itemdata.correctanswer?100:0;$(".minilesson_nextbutton").prop("disabled",!0),setTimeout((function(){$(".minilesson_nextbutton").prop("disabled",!1),self.next_question(percent)}),2e3)}))},init_components:function(index,itemdata,quizhelper){for(var app=this,sentences=itemdata.sentences,i=0;i<sentences.length;i++)sentences[i].originalsentence=sentences[i].sentence,sentences[i].sentence=quizhelper.cleanText(sentences[i].sentence);var fn,_ref,theCallback=(fn=regeneratorRuntime.mark((function _callee(message){var speechtext,cleanspeechtext,spoken,matched,percent,x,similar,similarity,ajaxresult,result,haserror,i,theanswer;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:_context.t0=message.type,_context.next="recording"===_context.t0?3:"speech"===_context.t0?4:73;break;case 3:return _context.abrupt("break",73);case 4:log.debug("speech at shortanswer"),speechtext=message.capturedspeech,cleanspeechtext=quizhelper.cleanText(speechtext),spoken=cleanspeechtext,log.debug("speechtext:",speechtext),log.debug("cleanspeechtext:",spoken),matched=!1,percent=0,x=0;case 13:if(!(x<sentences.length)){_context.next=25;break}if(""!==sentences[x].sentence){_context.next=16;break}return _context.abrupt("continue",22);case 16:if(similar=quizhelper.similarity(spoken,sentences[x].sentence),log.debug("JS similarity: "+spoken+":"+sentences[x].sentence+":"+similar),!(similar>=app.passmark||app.spokenIsCorrect(quizhelper,cleanspeechtext,sentences[x].sentence))){_context.next=22;break}return percent=app.process_accepted_response(itemdata,x),matched=!0,_context.abrupt("break",25);case 22:x++,_context.next=13;break;case 25:if(matched){_context.next=42;break}x=0;case 27:if(!(x<sentences.length)){_context.next=42;break}return _context.next=30,quizhelper.checkByPhonetic(sentences[x].sentence,spoken,sentences[x].phonetic,itemdata.language);case 30:if(similarity=_context.sent,log.debug(similarity,"PHP similarity"),similarity&&!(similarity<app.passmark)){_context.next=35;break}_context.next=39;break;case 35:return matched=!0,log.debug("PHP similarity: "+spoken+similarity),percent=app.process_accepted_response(itemdata,x),_context.abrupt("break",42);case 39:x++,_context.next=27;break;case 42:if(matched){_context.next=65;break}x=0;case 44:if(!(x<sentences.length)){_context.next=65;break}return _context.next=47,quizhelper.comparePassageToTranscript(sentences[x].sentence,spoken,sentences[x].phonetic,itemdata.language);case 47:ajaxresult=_context.sent,result=JSON.parse(ajaxresult),haserror=!1,i=0;case 51:if(!(i<result.length)){_context.next=58;break}if(!1!==result[i].matched){_context.next=55;break}return haserror=!0,_context.abrupt("break",58);case 55:i++,_context.next=51;break;case 58:if(haserror){_context.next=62;break}return percent=app.process_accepted_response(itemdata,x),matched=!0,_context.abrupt("break",65);case 62:x++,_context.next=44;break;case 65:if(!matched){_context.next=71;break}return $(".minilesson_nextbutton").prop("disabled",!0),setTimeout((function(){$(".minilesson_nextbutton").prop("disabled",!1),app.next_question(percent)}),2e3),_context.abrupt("return");case 71:theanswer=$("#"+itemdata.uniqueid+"_correctanswer"),anim.do_animate(theanswer,"rubberBand animate__faster").then((function(){}));case 73:case"end":return _context.stop()}}),_callee)})),_ref=function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))},function(_x){return _ref.apply(this,arguments)}),opts={};opts.uniqueid=itemdata.uniqueid,log.debug("sa uniqueid:"+itemdata.uniqueid),opts.callback=theCallback,opts.stt_guided=quizhelper.is_stt_guided(),ttrecorder.clone().init(opts)},spokenIsCorrect:function(quizhelper,phraseheard,currentphrase){return(phraseheard=quizhelper.cleanText(phraseheard))===(currentphrase=quizhelper.cleanText(currentphrase))},process_accepted_response:function(itemdata,sentenceindex){var percent=sentenceindex>=0?100:0;if(percent>0){if(0===parseInt(itemdata.show_text))for(var i=0;i<itemdata.sentences.length;i++){$("#"+itemdata.uniqueid+"_option"+(i+1));$("#"+itemdata.uniqueid+"_option"+(i+1)+" .minilesson_sentence").text(itemdata.sentences[i].sentence)}var answerdisplay=$("#"+itemdata.uniqueid+"_correctanswer");answerdisplay.text(itemdata.sentences[sentenceindex].originalsentence),answerdisplay.addClass("minilesson_success")}return percent}}}));

//# sourceMappingURL=shortanswer.min.js.map