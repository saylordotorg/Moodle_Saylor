define ("mod_minilesson/quizhelper",["jquery","core/log","mod_minilesson/definitions","core/templates","core/ajax","mod_minilesson/dictation","mod_minilesson/dictationchat","mod_minilesson/multichoice","mod_minilesson/multiaudio","mod_minilesson/speechcards","mod_minilesson/listenrepeat","mod_minilesson/page","mod_minilesson/smartframe","mod_minilesson/shortanswer"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){"use strict";b.debug("MiniLesson Quiz helper: initialising");return{spliton_regexp:new RegExp(/([!"# $%&'()。「」、*+,-.\/:;<=>?@[\]^_`{|}~])/,"g"),nopunc_regexp:new RegExp(/[!"#$%&'()。「」、*+,-.\/:;<=>?@[\]^_`{|}~]/,"g"),nonspaces_regexp:new RegExp(/[^ ]/,"g"),controls:{},submitbuttonclass:"mod_minilesson_quizsubmitbutton",stepresults:[],init:function init(a,b,c,d,e){this.quizdata=b.quizdata;this.region=b.region;this.ttslanguage=b.ttslanguage;this.controls.quizcontainer=a;this.attemptid=d;this.courseurl=b.courseurl;this.cmid=c;this.reattempturl=b.reattempturl;this.backtocourse=b.backtocourse;this.ds_only=b.ds_only;this.prepare_html();this.init_questions(this.quizdata,e);this.register_events();this.start_quiz()},prepare_html:function prepare_html(){this.controls.quizfinished=a("#mod_minilesson_quiz_finished")},init_questions:function init_questions(b,d){var e=this;a.each(b,function(a,b){switch(b.type){case c.qtype_dictation:f.clone().init(a,b,e,d);break;case c.qtype_dictationchat:g.clone().init(a,b,e,d);break;case c.qtype_multichoice:h.clone().init(a,b,e);break;case c.qtype_multiaudio:i.clone().init(a,b,e);break;case c.qtype_speechcards:j.clone().init(a,b,e);break;case c.qtype_listenrepeat:k.clone().init(a,b,e);break;case c.qtype_page:l.clone().init(a,b,e);break;case c.qtype_smartframe:m.clone().init(a,b,e);break;case c.qtype_shortanswer:n.clone().init(a,b,e);break;}});a("audio.mod_minilesson_itemttsaudio").each(function(){var b=this;d.fetch_polly_url(a(this).data("text"),a(this).data("ttsoption"),a(this).data("voice")).then(function(c){a(b).attr("src",c)})})},register_events:function register_events(){a("."+this.submitbuttonclass).on("click",function(){})},render_quiz_progress:function render_quiz_progress(b,c){for(var d=[],e=0;e<c;e++){d.push(e)}if(6>c){var f=d.slice(0,5),g="width: "+(100-100/f.length)+"%; margin-left: auto; margin-right: auto",h="<div class='minilesson_quiz_progress_line' style='"+g+"'></div>";f.forEach(function(a){h+="<div class='minilesson_quiz_progress_item "+(a==b?"minilesson_quiz_progress_item_current":"")+" "+(a<b?"minilesson_quiz_progress_item_completed":"")+"'>"+(a+1)+"</div>"})}else{if(b>c-6){var f=d.slice(c-5,c-1)}else{var f=d.slice(b,b+4)}if(0==b){var g="width: 80%; margin-left: auto; margin-right: auto"}else{var g="width: "+(100-100/(2*f.length))+"%; margin-left: 0"}var h="<div class='minilesson_quiz_progress_line' style='"+g+"'></div>";f.forEach(function(a){h+="<div class='minilesson_quiz_progress_item "+(a==b?"minilesson_quiz_progress_item_current":"")+" "+(a<b?"minilesson_quiz_progress_item_completed":"")+"'>"+(a+1)+"</div>"});h+="<div class='minilesson_quiz_progress_finalitem'>"+c+"</div>"}h+="";a(".minilesson_quiz_progress").html(h)},do_next:function do_next(b){var e=this,f=b.index,g=this.quizdata[f];if(!0===g.preview){return}e.report_step_grade(b);var h=a("#"+g.uniqueid+"_container");h.hide();if(e.quizdata.length>f+1){var i=this.quizdata[f+1];a("#"+i.uniqueid+"_container").show();switch(i.type){case c.qtype_speechcards:break;case c.qtype_dictation:case c.qtype_dictationchat:case c.qtype_multichoice:case c.qtype_multiaudio:case c.qtype_listenrepeat:case c.qtype_smartframe:case c.qtype_shortanswer:default:}}else{var j=e.stepresults.filter(function(a){return a.hasgrade}),k=0,l=0;j.forEach(function(a,b){a.index=b+1;a.title=e.quizdata[b].title;k+=a.correctitems;l+=a.totalitems});var m=Math.round(100*(k/l));console.log(j,k,l,m);var n={results:j,total:m,courseurl:this.courseurl};if(""!=this.reattempturl){n.reattempturl=this.reattempturl}if(""!=this.backtocourse){n.backtocourse=!0}d.render("mod_minilesson/quizfinished",n).then(function(a,b){e.controls.quizfinished.html(a);e.controls.quizfinished.show();d.runTemplateJS(b)})}this.render_quiz_progress(b.index+1,this.quizdata.length);h.remove()},report_step_grade:function report_step_grade(a){var b=this;this.stepresults.push(a);e.call([{methodname:"mod_minilesson_report_step_grade",args:{cmid:b.cmid,step:JSON.stringify(a)}}])},start_quiz:function start_quiz(){a("#"+this.quizdata[0].uniqueid+"_container").show();this.render_quiz_progress(0,this.quizdata.length)},onSubmit:function onSubmit(){alert("quiz submitted. Override this")},mobile_user:function mobile_user(){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){return!0}else{return!1}},chrome_user:function chrome_user(){if(/Chrome/i.test(navigator.userAgent)){return!0}else{return!1}},use_ttrecorder:function use_ttrecorder(){return!0},is_ds_only:function is_ds_only(){return this.ds_only},similarity:function similarity(a,b){a=a.replace(/\s+/g,"");b=b.replace(/\s+/g,"");var c=a,d=b;if(a.length<b.length){c=b;d=a}var e=c.length;if(0==e){return 100}return 100*((e-this.editDistance(c,d))/parseFloat(e))},editDistance:function editDistance(a,b){a=a.toLowerCase();b=b.toLowerCase();for(var c=[],d=0,e;d<=a.length;d++){e=d;for(var f=0;f<=b.length;f++){if(0==d)c[f]=f;else{if(0<f){var g=c[f-1];if(a.charAt(d-1)!=b.charAt(f-1))g=Math.min(Math.min(g,e),c[f])+1;c[f-1]=e;e=g}}}if(0<d)c[b.length]=e}return c[b.length]},cleanText:function cleanText(a){var b=a.toLowerCase(),c=b.replace(this.nopunc_regexp,""),d=c.replace(/\s+/g," ").trim();return d},checkByPhonetic:function checkByPhonetic(a,b,c,d){return e.call([{methodname:"mod_minilesson_check_by_phonetic",args:{spoken:b,correct:a,language:d,phonetic:c,region:this.region,cmid:this.cmid}}])[0]},comparePassageToTranscript:function comparePassageToTranscript(a,b,c,d){return e.call([{methodname:"mod_minilesson_compare_passage_to_transcript",args:{passage:a,transcript:b,alternatives:"",phonetic:c,language:d,region:this.region,cmid:this.cmid}}])[0]}}});
//# sourceMappingURL=quizhelper.min.js.map
