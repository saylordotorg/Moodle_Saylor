define(["jquery","core/log","mod_minilesson/definitions","core/templates","core/ajax","mod_minilesson/dictation","mod_minilesson/dictationchat","mod_minilesson/multichoice","mod_minilesson/multiaudio","mod_minilesson/speechcards","mod_minilesson/listenrepeat","mod_minilesson/page","mod_minilesson/smartframe","mod_minilesson/shortanswer"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){"use strict";b.debug("MiniLesson Quiz helper: initialising");return{spliton_regexp:new RegExp(/([!"# ¡¿$%&'()。「」、*+,-.\/:;<=>?@[\]^_`{|}~])/,"g"),nopunc_regexp:new RegExp(/[!"#¡¿$%&'()。「」、*+,-.\/:;<=>?@[\]^_`{|}~]/,"g"),nonspaces_regexp:new RegExp(/[^ ]/,"g"),autoplaydelay:800,controls:{},submitbuttonclass:"mod_minilesson_quizsubmitbutton",stepresults:[],init:function init(a,b,c,d,e){this.quizdata=b.quizdata;this.region=b.region;this.ttslanguage=b.ttslanguage;this.controls.quizcontainer=a;this.attemptid=d;this.courseurl=b.courseurl;this.cmid=c;this.reattempturl=b.reattempturl;this.activityurl=b.activityurl;this.backtocourse=b.backtocourse;this.stt_guided=b.stt_guided;this.wwwroot=b.wwwroot;this.useanimatecss=b.useanimatecss;this.prepare_html();this.init_questions(this.quizdata,e);this.register_events();this.start_quiz()},prepare_html:function prepare_html(){this.controls.quizfinished=a("#mod_minilesson_quiz_finished")},init_questions:function init_questions(b,d){var e=this;a.each(b,function(a,b){switch(b.type){case c.qtype_dictation:f.clone().init(a,b,e,d);break;case c.qtype_dictationchat:g.clone().init(a,b,e,d);break;case c.qtype_multichoice:h.clone().init(a,b,e);break;case c.qtype_multiaudio:i.clone().init(a,b,e);break;case c.qtype_speechcards:j.clone().init(a,b,e);break;case c.qtype_listenrepeat:k.clone().init(a,b,e);break;case c.qtype_page:l.clone().init(a,b,e);break;case c.qtype_smartframe:m.clone().init(a,b,e);break;case c.qtype_shortanswer:n.clone().init(a,b,e);break;}});a("audio.mod_minilesson_itemttsaudio").each(function(){var b=this;d.fetch_polly_url(a(this).data("text"),a(this).data("ttsoption"),a(this).data("voice")).then(function(c){a(b).attr("src",c)})})},register_events:function register_events(){a("."+this.submitbuttonclass).on("click",function(){})},render_quiz_progress:function render_quiz_progress(b,c){for(var d=[],e=0;e<c;e++){d.push(e)}if(6>c){var f=d.slice(0,5),g="width: "+(100-100/f.length)+"%; margin-left: auto; margin-right: auto",h="<div class='minilesson_quiz_progress_line' style='"+g+"'></div>";f.forEach(function(a){h+="<div class='minilesson_quiz_progress_item "+(a===b?"minilesson_quiz_progress_item_current":"")+" "+(a<b?"minilesson_quiz_progress_item_completed":"")+"'>"+(a+1)+"</div>"})}else{if(b>c-6){var f=d.slice(c-5,c-1)}else{var f=d.slice(b,b+4)}if(0==b){var g="width: 80%; margin-left: auto; margin-right: auto"}else{var g="width: "+(100-100/(2*f.length))+"%; margin-left: 0"}var h="<div class='minilesson_quiz_progress_line' style='"+g+"'></div>";f.forEach(function(a){h+="<div class='minilesson_quiz_progress_item "+(a===b?"minilesson_quiz_progress_item_current":"")+" "+(a<b?"minilesson_quiz_progress_item_completed":"")+"'>"+(a+1)+"</div>"});h+="<div class='minilesson_quiz_progress_finalitem'>"+c+"</div>"}h+="";a(".minilesson_quiz_progress").html(h)},do_next:function do_next(b){var d=this,e=b.index,f=this.quizdata[e];if(!0===f.preview){return}d.report_step_grade(b);var g=a("#"+f.uniqueid+"_container");g.hide();if(d.quizdata.length>e+1){var h=this.quizdata[e+1];a("#"+h.uniqueid+"_container").show();switch(h.type){case c.qtype_speechcards:break;case c.qtype_dictation:case c.qtype_dictationchat:case c.qtype_multichoice:case c.qtype_multiaudio:case c.qtype_listenrepeat:case c.qtype_smartframe:case c.qtype_shortanswer:default:}var i=a("#"+h.uniqueid+"_container audio.mod_minilesson_itemttsaudio");if("1"==i.data("autoplay")){var j=this;setTimeout(function(){i[0].play()},j.autoplaydelay)}}else{a(".minilesson_nextbutton").prop("disabled",!0);setTimeout(function(){window.location.href=d.activityurl},1e3);return}this.render_quiz_progress(b.index+1,this.quizdata.length);g.remove()},report_step_grade:function report_step_grade(a){var c=this;this.stepresults.push(a);var d=e.call([{methodname:"mod_minilesson_report_step_grade",args:{cmid:c.cmid,step:JSON.stringify(a)},async:!1}])[0];b.debug("report_step_grade success: "+d)},start_quiz:function start_quiz(){a("#"+this.quizdata[0].uniqueid+"_container").show();var b=a("#"+this.quizdata[0].uniqueid+"_container audio.mod_minilesson_itemttsaudio");if("1"==b.data("autoplay")){var c=this;setTimeout(function(){b[0].play()},c.autoplaydelay)}this.render_quiz_progress(0,this.quizdata.length)},onSubmit:function onSubmit(){alert("quiz submitted. Override this")},mobile_user:function mobile_user(){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){return!0}else{return!1}},chrome_user:function chrome_user(){if(/Chrome/i.test(navigator.userAgent)){return!0}else{return!1}},use_ttrecorder:function use_ttrecorder(){return!0},is_stt_guided:function is_stt_guided(){return this.stt_guided},similarity:function similarity(a,b){a=a.replace(/\s+/g,"");b=b.replace(/\s+/g,"");var c=a,d=b;if(a.length<b.length){c=b;d=a}var e=c.length;if(0===e){return 100}return 100*((e-this.editDistance(c,d))/parseFloat(e))},editDistance:function editDistance(a,b){a=a.toLowerCase();b=b.toLowerCase();for(var c=[],d=0,e;d<=a.length;d++){e=d;for(var f=0;f<=b.length;f++){if(0===d)c[f]=f;else{if(0<f){var g=c[f-1];if(a.charAt(d-1)!==b.charAt(f-1))g=Math.min(Math.min(g,e),c[f])+1;c[f-1]=e;e=g}}}if(0<d)c[b.length]=e}return c[b.length]},cleanText:function cleanText(a){var b=a.toLowerCase(),c=b.replace(this.nopunc_regexp,""),d=c.replace(/\s+/g," ").trim();return d},checkByPhonetic:function checkByPhonetic(a,b,c,d){return e.call([{methodname:"mod_minilesson_check_by_phonetic",args:{spoken:b,correct:a,language:d,phonetic:c,region:this.region,cmid:this.cmid},async:!1}])[0]},comparePassageToTranscript:function comparePassageToTranscript(a,b,c,d){return e.call([{methodname:"mod_minilesson_compare_passage_to_transcript",args:{passage:a,transcript:b,alternatives:"",phonetic:c,language:d,region:this.region,cmid:this.cmid},async:!1}])[0]}}});
//# sourceMappingURL=quizhelper.min.js.map
