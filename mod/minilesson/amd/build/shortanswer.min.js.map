{"version":3,"file":"shortanswer.min.js","sources":["../src/shortanswer.js"],"sourcesContent":["define(['jquery',\n      'core/log',\n      'mod_minilesson/definitions',\n      'mod_minilesson/pollyhelper',\n      'mod_minilesson/cloudpoodllloader',\n      'mod_minilesson/ttrecorder',\n      'mod_minilesson/animatecss'],\n    function($, log, def, polly,cloudpoodll, ttrecorder, anim) {\n  \"use strict\"; // jshint ;_;\n\n  /*\n  This file is to manage the quiz stage\n   */\n\n  log.debug('MiniLesson ShortAnswer: initialising');\n\n  return {\n    passmark: 90,//lower this if it often doesnt match (was 85)\n\n    //for making multiple instances\n      clone: function () {\n          return $.extend(true, {}, this);\n     },\n\n    init: function(index, itemdata, quizhelper) {\n\n      //anim\n      var animopts = {};\n      animopts.useanimatecss=quizhelper.useanimatecss;\n      anim.init(animopts);\n\n      this.register_events(index, itemdata, quizhelper);\n      this.init_components(index, itemdata, quizhelper);\n    },\n    next_question: function(percent) {\n      var self = this;\n      var stepdata = {};\n      stepdata.index = self.index;\n      stepdata.hasgrade = true;\n      stepdata.totalitems = 1;\n      stepdata.correctitems = percent>0?1:0;\n      stepdata.grade = percent;\n      self.quizhelper.do_next(stepdata);\n    },\n\n    /* NOT NEEDED */\n    prepare_audio: function(itemdata) {\n      // debugger;\n      $.each(itemdata.sentences, function(index, sentence) {\n        polly.fetch_polly_url(sentence.sentence, itemdata.voiceoption, itemdata.usevoice).then(function(audiourl) {\n          $(\"#\" + itemdata.uniqueid + \"_option\" + (index+1)).attr(\"data-src\", audiourl);\n        });\n      });\n    },\n    \n    register_events: function(index, itemdata, quizhelper) {\n      \n      var self = this;\n      self.index = index;\n      self.quizhelper = quizhelper;\n      \n      $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\").on('click', function(e) {\n        self.next_question(0);\n      });\n      \n      $(\"#\" + itemdata.uniqueid + \"_container .\" + itemdata.uniqueid + \"_option\").on('click', function(e) {\n        \n        $(\".\" + itemdata.uniqueid + \"_option\").prop(\"disabled\", true);\n        $(\".\" + itemdata.uniqueid + \"_fb\").html(\"<i style='color:red;' class='fa fa-times'></i>\");\n        $(\".\" + itemdata.uniqueid + \"_option\" + itemdata.correctanswer + \"_fb\").html(\"<i style='color:green;' class='fa fa-check'></i>\");\n        \n        var checked = $('input[name='+itemdata.uniqueid+'_options]:checked').data('index');\n        var percent = checked == itemdata.correctanswer ? 100 : 0;\n        \n        $(\".minilesson_nextbutton\").prop(\"disabled\", true);\n        setTimeout(function() {\n          $(\".minilesson_nextbutton\").prop(\"disabled\", false);\n          self.next_question(percent);\n        }, 2000);\n        \n      });\n      \n    },\n\n    init_components: function(index, itemdata, quizhelper) {\n      var app= this;\n      var sentences = itemdata.sentences;//sentence & phonetic\n      //clean the text of any junk\n      for(var i=0;i<sentences.length;i++){\n          sentences[i].originalsentence= sentences[i].sentence\n          sentences[i].sentence=quizhelper.cleanText(sentences[i].sentence);\n      }\n\n      var theCallback = async function(message) {\n\n        switch (message.type) {\n          case 'recording':\n\n            break;\n\n          case 'speech':\n            log.debug(\"speech at shortanswer\");\n            var speechtext = message.capturedspeech;\n            var cleanspeechtext = quizhelper.cleanText(speechtext);\n            var spoken = cleanspeechtext;\n\n            log.debug('speechtext:',speechtext);\n            log.debug('cleanspeechtext:',spoken);\n            var matched=false;\n            var percent=0;\n\n            //Similarity check by direct-match/acceptable-mistranscriptio\n            for(var x=0;x<sentences.length;x++){\n              //if this is the correct answer index, just move on\n              if(sentences[x].sentence===''){continue;}\n              var similar = quizhelper.similarity(spoken, sentences[x].sentence);\n              log.debug('JS similarity: ' + spoken + ':' + sentences[x].sentence + ':' + similar);\n              if (similar >= app.passmark ||\n                  app.spokenIsCorrect(quizhelper, cleanspeechtext, sentences[x].sentence)) {\n                  percent = app.process_accepted_response(itemdata, x);\n                  matched=true;\n                  break;\n              }//end of if similarity\n            }//end of for x\n\n            //Similarity check by phonetics(ajax)\n            //this is an expensive call since it goes out to the server and possibly to the cloud\n            if(!matched) {\n              for (x = 0; x < sentences.length; x++) {\n                var similarity = await quizhelper.checkByPhonetic(sentences[x].sentence, spoken, sentences[x].phonetic, itemdata.language);\n                log.debug(similarity, 'PHP similarity');\n                if (!similarity || similarity < app.passmark) {\n                  //keep looking\n                } else {\n                  matched = true;\n                  log.debug('PHP similarity: ' + spoken + similarity);\n                  percent = app.process_accepted_response(itemdata, x);\n                  break;\n                }\n              }//end of Similarity check by phonetics(ajax) loop\n            }\n\n            //we do not do a passage match check , but this is how we would ..\n              if(!matched ) {\n                for (x = 0; x < sentences.length; x++) {\n                  var ajaxresult = await quizhelper.comparePassageToTranscript(sentences[x].sentence, spoken, sentences[x].phonetic, itemdata.language);\n                  var result = JSON.parse(ajaxresult);\n                  var haserror=false;\n                  for (var i=0;i<result.length;i++){\n                    if(result[i].matched===false){haserror=true;break;}\n                  }\n                  if(!haserror){\n                    percent = app.process_accepted_response(itemdata, x);\n                    matched=true;\n                    break;\n                  }\n                }\n              }\n\n              //if we got a match then process it\n            if(matched){\n              //proceed to next question\n              $(\".minilesson_nextbutton\").prop(\"disabled\", true);\n              setTimeout(function () {\n                $(\".minilesson_nextbutton\").prop(\"disabled\", false);\n                app.next_question(percent);\n              }, 2000);\n              return;\n            }else{\n              //shake the screen\n              var theanswer = $(\"#\" + itemdata.uniqueid + \"_correctanswer\");\n              anim.do_animate(theanswer,'rubberBand animate__faster').then(\n                  function() {}\n              );\n              //$(\"#\" + itemdata.uniqueid + \"_correctanswer\").effect(\"shake\");\n            }\n        } //end of switch message type\n      }; //end of callback declaration\n\n      //init TT recorder\n      var opts = {};\n      opts.uniqueid = itemdata.uniqueid;\n      log.debug('sa uniqueid:' + itemdata.uniqueid);\n      opts.callback = theCallback;\n      opts.stt_guided=quizhelper.is_stt_guided();\n      ttrecorder.clone().init(opts);\n\n    } ,//end of init components\n\n    spokenIsCorrect: function(quizhelper, phraseheard, currentphrase) {\n      //lets lower case everything\n      phraseheard = quizhelper.cleanText(phraseheard);\n      currentphrase = quizhelper.cleanText(currentphrase);\n      if (phraseheard === currentphrase) {\n        return true;\n      }\n      return false;\n    },\n\n    process_accepted_response: function(itemdata, sentenceindex){\n      var percent = sentenceindex >= 0 ? 100 : 0;\n      //TO DO .. disable TT recorder here\n      //disable TT recorder\n\n      if(percent > 0) {\n        //turn dots into text (if they were dots)\n        if (parseInt(itemdata.show_text) === 0) {\n          for (var i = 0; i < itemdata.sentences.length; i++) {\n            var theline = $(\"#\" + itemdata.uniqueid + \"_option\" + (i + 1));\n            $(\"#\" + itemdata.uniqueid + \"_option\" + (i + 1) + ' .minilesson_sentence').text(itemdata.sentences[i].sentence);\n          }\n        }\n\n        //hightlight successgit cm\n        var  answerdisplay =  $(\"#\" + itemdata.uniqueid + \"_correctanswer\");\n        answerdisplay.text(itemdata.sentences[sentenceindex].originalsentence);\n        answerdisplay.addClass(\"minilesson_success\");\n      }\n\n      return percent;\n\n    },\n\n  };\n});"],"names":["define","$","log","def","polly","cloudpoodll","ttrecorder","anim","debug","passmark","clone","extend","this","init","index","itemdata","quizhelper","animopts","useanimatecss","register_events","init_components","next_question","percent","stepdata","hasgrade","totalitems","correctitems","grade","do_next","prepare_audio","each","sentences","sentence","fetch_polly_url","voiceoption","usevoice","then","audiourl","uniqueid","attr","self","on","e","prop","html","correctanswer","data","setTimeout","app","i","length","originalsentence","cleanText","theCallback","message","type","speechtext","capturedspeech","cleanspeechtext","spoken","matched","x","similar","similarity","spokenIsCorrect","process_accepted_response","checkByPhonetic","phonetic","language","comparePassageToTranscript","ajaxresult","result","JSON","parse","haserror","theanswer","do_animate","opts","callback","stt_guided","is_stt_guided","phraseheard","currentphrase","sentenceindex","parseInt","show_text","text","answerdisplay","addClass"],"mappings":"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"}