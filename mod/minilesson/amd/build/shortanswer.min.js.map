{"version":3,"sources":["../src/shortanswer.js"],"names":["define","$","log","def","polly","cloudpoodll","ttrecorder","debug","passmark","clone","extend","init","index","itemdata","quizhelper","register_events","init_components","next_question","percent","self","stepdata","hasgrade","totalitems","correctitems","grade","do_next","prepare_audio","each","sentences","sentence","fetch_polly_url","voiceoption","usevoice","then","audiourl","uniqueid","attr","on","prop","html","correctanswer","checked","data","setTimeout","app","i","length","cleanText","theCallback","message","type","speechtext","capturedspeech","cleanspeechtext","spoken","x","similar","similarity","spokenIsCorrect","process_accepted_response","checkByPhonetic","phonetic","language","opts","callback","ds_only","is_ds_only","phraseheard","currentphrase","sentenceindex","parseInt","show_text","text","answerdisplay","show"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log', 'mod_minilesson/definitions', 'mod_minilesson/pollyhelper','mod_minilesson/cloudpoodllloader',\n      'mod_minilesson/ttrecorder'],\n    function($, log, def, polly,cloudpoodll, ttrecorder) {\n  \"use strict\"; // jshint ;_;\n\n  /*\n  This file is to manage the quiz stage\n   */\n\n  log.debug('MiniLesson ShortAnswer: initialising');\n\n  return {\n    passmark: 90,//lower this if it often doesnt match (was 85)\n\n    //for making multiple instances\n      clone: function () {\n          return $.extend(true, {}, this);\n     },\n\n    init: function(index, itemdata, quizhelper) {\n   //   this.prepare_audio(itemdata);\n      this.register_events(index, itemdata, quizhelper);\n      this.init_components(index, itemdata, quizhelper);\n    },\n    next_question: function(percent) {\n      var self = this;\n      var stepdata = {};\n      stepdata.index = self.index;\n      stepdata.hasgrade = true;\n      stepdata.totalitems = 1;\n      stepdata.correctitems = percent>0?1:0;\n      stepdata.grade = percent;\n      self.quizhelper.do_next(stepdata);\n    },\n\n    /* NOT NEEDED */\n    prepare_audio: function(itemdata) {\n      // debugger;\n      $.each(itemdata.sentences, function(index, sentence) {\n        polly.fetch_polly_url(sentence.sentence, itemdata.voiceoption, itemdata.usevoice).then(function(audiourl) {\n          $(\"#\" + itemdata.uniqueid + \"_option\" + (index+1)).attr(\"data-src\", audiourl);\n        });\n      });\n    },\n    \n    register_events: function(index, itemdata, quizhelper) {\n      \n      var self = this;\n      self.index = index;\n      self.quizhelper = quizhelper;\n      \n      $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\").on('click', function(e) {\n        self.next_question(0);\n      });\n      \n      $(\"#\" + itemdata.uniqueid + \"_container .\" + itemdata.uniqueid + \"_option\").on('click', function(e) {\n        \n        $(\".\" + itemdata.uniqueid + \"_option\").prop(\"disabled\", true);\n        $(\".\" + itemdata.uniqueid + \"_fb\").html(\"<i style='color:red;' class='fa fa-times'></i>\");\n        $(\".\" + itemdata.uniqueid + \"_option\" + itemdata.correctanswer + \"_fb\").html(\"<i style='color:green;' class='fa fa-check'></i>\");\n        \n        var checked = $('input[name='+itemdata.uniqueid+'_options]:checked').data('index');\n        var percent = checked == itemdata.correctanswer ? 100 : 0;\n        \n        $(\".minilesson_nextbutton\").prop(\"disabled\", true);\n        setTimeout(function() {\n          $(\".minilesson_nextbutton\").prop(\"disabled\", false);\n          self.next_question(percent);\n        }, 2000);\n        \n      });\n      \n    },\n\n    init_components: function(index, itemdata, quizhelper) {\n      var app= this;\n      var sentences = itemdata.sentences;//sentence & phonetic\n      //clean the text of any junk\n      for(var i=0;i<sentences.length;i++){\n          sentences[i].sentence=quizhelper.cleanText(sentences[i].sentence);\n      }\n\n      var theCallback = async function(message) {\n\n        switch (message.type) {\n          case 'recording':\n\n            break;\n\n          case 'speech':\n            log.debug(\"speech at shortanswer\");\n            var speechtext = message.capturedspeech;\n            var cleanspeechtext = quizhelper.cleanText(speechtext);\n            var spoken = cleanspeechtext;\n\n            log.debug('speechtext:',speechtext);\n            log.debug('cleanspeechtext:',spoken);\n\n\n            //Similarity check by direct-match/acceptable-mistranscriptio\n            for(var x=0;x<sentences.length;x++){\n              //if this is the correct answer index, just move on\n              if(sentences[x].sentence===''){continue;}\n              var similar = quizhelper.similarity(spoken, sentences[x].sentence);\n              log.debug('JS similarity: ' + spoken + ':' + sentences[x].sentence + ':' + similar);\n              if (similar >= app.passmark ||\n                  app.spokenIsCorrect(quizhelper, cleanspeechtext, sentences[x].sentence)) {\n\n                //proceed to next question\n                var percent = app.process_accepted_response(itemdata, x);\n                $(\".minilesson_nextbutton\").prop(\"disabled\", true);\n\n                //proceed to next question\n                setTimeout(function() {\n                  $(\".minilesson_nextbutton\").prop(\"disabled\", false);\n                  app.next_question(percent);\n                }, 2000);\n                return;\n              }//end of if similarity\n            }//end of for x\n\n\n            //Similarity check by phonetics(ajax)\n            //this is an expensive call since it goes out to the server and possibly to the cloud\n            for(var x=0;x<sentences.length;x++) {\n              var similarity = await quizhelper.checkByPhonetic(sentences[x].sentence, spoken, sentences[x].phonetic, itemdata.language);\n\n                if (!similarity || similarity < app.passmark) {\n                  //do nothing ?? or tough luck ?\n                  //return $.Deferred().reject();\n\n                 // var percent = app.process_accepted_response(itemdata, -1);\n\n                } else {\n\n                  log.debug('PHP similarity: ' + spoken + similarity);\n\n                  var percent = app.process_accepted_response(itemdata, x);\n\n                  //proceed to next question\n                  $(\".minilesson_nextbutton\").prop(\"disabled\", true);\n                  setTimeout(function () {\n                    $(\".minilesson_nextbutton\").prop(\"disabled\", false);\n                    app.next_question(percent);\n                  }, 2000);\n                }\n\n            }//end of for x loop\n\n        } //end of switch message type\n      }; //end of callback declaration\n\n      //init TT recorder\n      var opts = {};\n      opts.uniqueid = itemdata.uniqueid;\n      log.debug('sa uniqueid:' + itemdata.uniqueid);\n      opts.callback = theCallback;\n      opts.ds_only=quizhelper.is_ds_only();\n      ttrecorder.clone().init(opts);\n\n    } ,//end of init components\n\n    spokenIsCorrect: function(quizhelper, phraseheard, currentphrase) {\n      //lets lower case everything\n      phraseheard = quizhelper.cleanText(phraseheard);\n      currentphrase = quizhelper.cleanText(currentphrase);\n      if (phraseheard === currentphrase) {\n        return true;\n      }\n      return false;\n    },\n\n    process_accepted_response: function(itemdata, sentenceindex){\n      var percent = sentenceindex >= 0 ? 100 : 0;\n      //TO DO .. disable TT recorder here\n      //disable TT recorder\n\n      if(percent > 0) {\n        //turn dots into text (if they were dots)\n        if (parseInt(itemdata.show_text) === 0) {\n          for (var i = 0; i < itemdata.sentences.length; i++) {\n            var theline = $(\"#\" + itemdata.uniqueid + \"_option\" + (i + 1));\n            $(\"#\" + itemdata.uniqueid + \"_option\" + (i + 1) + ' .minilesson_sentence').text(itemdata.sentences[i].sentence);\n          }\n        }\n\n        //TO DO: add fancy animation\n        var  answerdisplay =  $(\"#\" + itemdata.uniqueid + \"_correctanswer\");\n        answerdisplay.text(itemdata.sentences[sentenceindex].sentence);\n        answerdisplay.show();//this should also trigger any entry animation\n      }\n\n      return percent;\n\n    },\n\n  };\n});"],"file":"shortanswer.min.js"}