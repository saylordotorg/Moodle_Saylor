{"version":3,"sources":["../src/quizhelper.js"],"names":["define","$","log","def","templates","Ajax","dictation","dictationchat","multichoice","multiaudio","speechcards","listenrepeat","page","smartframe","shortanswer","debug","spliton_regexp","RegExp","nopunc_regexp","nonspaces_regexp","autoplaydelay","controls","submitbuttonclass","stepresults","init","quizcontainer","activitydata","cmid","attemptid","polly","quizdata","region","ttslanguage","courseurl","reattempturl","activityurl","backtocourse","ds_only","prepare_html","init_questions","register_events","start_quiz","quizfinished","dd","each","index","item","type","qtype_dictation","clone","qtype_dictationchat","qtype_multichoice","qtype_multiaudio","qtype_speechcards","qtype_listenrepeat","qtype_page","qtype_smartframe","qtype_shortanswer","that","fetch_polly_url","data","then","audiourl","attr","on","render_quiz_progress","current","total","array","i","push","slice","linestyles","length","html","forEach","do_next","stepdata","currentquizdataindex","currentitem","preview","report_step_grade","theoldquestion","uniqueid","hide","nextindex","nextitem","show","ttsquestionplayer","setTimeout","play","prop","window","location","href","remove","call","methodname","args","step","JSON","stringify","onSubmit","alert","mobile_user","test","navigator","userAgent","chrome_user","use_ttrecorder","is_ds_only","similarity","s1","s2","replace","longer","shorter","longerLength","editDistance","parseFloat","toLowerCase","costs","lastValue","j","newValue","charAt","Math","min","cleanText","text","lowertext","punctuationless","ret","trim","checkByPhonetic","passage","transcript","passagephonetic","language","comparePassageToTranscript","alternatives","phonetic"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log', 'mod_minilesson/definitions', 'core/templates', 'core/ajax',\n    'mod_minilesson/dictation', 'mod_minilesson/dictationchat', 'mod_minilesson/multichoice','mod_minilesson/multiaudio',\n        'mod_minilesson/speechcards', 'mod_minilesson/listenrepeat',\n        'mod_minilesson/page','mod_minilesson/smartframe','mod_minilesson/shortanswer'],\n  function($, log, def, templates, Ajax, dictation, dictationchat, multichoice, multiaudio, speechcards, listenrepeat, page, smartframe, shortanswer) {\n    \"use strict\"; // jshint ;_;\n\n    /*\n    This file is to manage the quiz stage\n     */\n\n    log.debug('MiniLesson Quiz helper: initialising');\n\n    return {\n\n      //original spliton_regexp: new RegExp(/([,.!?:;\" ])/, 'g'),\n      spliton_regexp: new RegExp(/([!\"# $%&'()。「」、*+,-.\\/:;<=>?@[\\]^_`{|}~])/, 'g'),\n      //nopunc is diff to split on because it does not match on spaces\n      nopunc_regexp: new RegExp(/[!\"#$%&'()。「」、*+,-.\\/:;<=>?@[\\]^_`{|}~]/,'g'),\n      nonspaces_regexp: new RegExp(/[^ ]/,'g'),\n      autoplaydelay: 800,\n\n      controls: {},\n      submitbuttonclass: 'mod_minilesson_quizsubmitbutton',\n      stepresults: [],\n\n      init: function(quizcontainer, activitydata, cmid, attemptid,polly) {\n        this.quizdata = activitydata.quizdata;\n        this.region = activitydata.region;\n        this.ttslanguage = activitydata.ttslanguage;\n        this.controls.quizcontainer = quizcontainer;\n        this.attemptid = attemptid;\n        this.courseurl = activitydata.courseurl;\n        this.cmid = cmid;\n        this.reattempturl = activitydata.reattempturl;\n        this.activityurl = activitydata.activityurl;\n        this.backtocourse = activitydata.backtocourse;\n        this.ds_only = activitydata.ds_only;\n        this.prepare_html();\n        this.init_questions(this.quizdata,polly);\n        this.register_events();\n        this.start_quiz();\n      },\n\n      prepare_html: function() {\n\n        // this.controls.quizcontainer.append(submitbutton);\n        this.controls.quizfinished=$(\"#mod_minilesson_quiz_finished\");\n\n      },\n\n      init_questions: function(quizdata, polly) {\n        var dd = this;\n        $.each(quizdata, function(index, item) {\n          switch (item.type) {\n            case def.qtype_dictation:\n              dictation.clone().init(index, item, dd, polly);\n              break;\n            case def.qtype_dictationchat:\n              dictationchat.clone().init(index, item, dd, polly);\n              break;\n            case def.qtype_multichoice:\n              multichoice.clone().init(index, item, dd);\n              break;\n            case def.qtype_multiaudio:\n                multiaudio.clone().init(index, item, dd);\n                break;\n            case def.qtype_speechcards:\n              //speechcards init needs to occur when it is visible. lame.\n              // so we do that in do_next function, down below\n              speechcards.clone().init(index, item, dd);\n              break;\n            case def.qtype_listenrepeat:\n              listenrepeat.clone().init(index, item, dd);\n              break;\n\n             case def.qtype_page:\n                  page.clone().init(index, item, dd);\n                  break;\n\n              case def.qtype_smartframe:\n                  smartframe.clone().init(index, item, dd);\n                  break;\n\n              case def.qtype_shortanswer:\n                  shortanswer.clone().init(index, item, dd);\n                  break;\n          }\n\n        });\n\n        //TTS in question headers\n          $(\"audio.mod_minilesson_itemttsaudio\").each(function(){\n              var that=this;\n              polly.fetch_polly_url($(this).data('text'), $(this).data('ttsoption'), $(this).data('voice')).then(function(audiourl) {\n                  $(that).attr(\"src\", audiourl);\n              });\n          });\n\n      },\n\n      register_events: function() {\n        $('.' + this.submitbuttonclass).on('click', function() {\n          //do something\n        });\n      },\n      render_quiz_progress:function(current,total){\n        var array = [];\n        for(var i=0;i<total;i++){\n          array.push(i);\n        }\n\n        if(total<6) {\n            var slice = array.slice(0, 5);\n            var linestyles = \"width: \" + (100 - 100 / slice.length) + \"%; margin-left: auto; margin-right: auto\";\n            var html = \"<div class='minilesson_quiz_progress_line' style='\" + linestyles + \"'></div>\";\n\n            slice.forEach(function (i) {\n                html += \"<div class='minilesson_quiz_progress_item \" + (i == current ? 'minilesson_quiz_progress_item_current' : '') + \" \" + (i < current ? 'minilesson_quiz_progress_item_completed' : '') + \"'>\" + (i + 1) + \"</div>\";\n            });\n        }else {\n             if(current > total-6){\n                 var slice = array.slice(total-5, total-1);\n             }else{\n                 var slice = array.slice(current, current + 4);\n             }\n\n              //if first item is visible then no line trailing left of item 1\n              if(current==0){\n                  var linestyles = \"width: 80%; margin-left: auto; margin-right: auto\";\n              }else {\n                  var linestyles = \"width: \" + (100 - 100 / (2 *slice.length)) + \"%; margin-left: 0\";\n              }\n            var html = \"<div class='minilesson_quiz_progress_line' style='\" + linestyles + \"'></div>\";\n              slice.forEach(function (i) {\n                  html += \"<div class='minilesson_quiz_progress_item \" + (i == current ? 'minilesson_quiz_progress_item_current' : '') + \" \" + (i < current ? 'minilesson_quiz_progress_item_completed' : '') + \"'>\" + (i + 1) + \"</div>\";\n              });\n              //end marker\n            html += \"<div class='minilesson_quiz_progress_finalitem'>\" + (total) + \"</div>\";\n          }\n\n        html+=\"\";\n        $(\".minilesson_quiz_progress\").html(html);\n\n      },\n\n      do_next: async function(stepdata){\n        var dd = this;\n        //get current question\n        var currentquizdataindex =   stepdata.index;\n        var currentitem = this.quizdata[currentquizdataindex];\n\n        //in preview mode do no do_next\n        if(currentitem.preview===true){return;}\n\n        //post grade\n         // log.debug(\"reporting step grade\");\n        await dd.report_step_grade(stepdata);\n         // log.debug(\"reported step grade\");\n        //hide current question\n        var theoldquestion = $(\"#\" + currentitem.uniqueid + \"_container\");\n        theoldquestion.hide();\n        //show next question or End Screen\n        if (dd.quizdata.length > currentquizdataindex+1) {\n          var nextindex = currentquizdataindex+ 1;\n          var nextitem = this.quizdata[nextindex];\n            //show the question\n            $(\"#\" + nextitem.uniqueid + \"_container\").show();\n          //any per question type init that needs to occur can go here\n          switch (nextitem.type) {\n              case def.qtype_speechcards:\n                  //speechcards.init(nextindex, nextitem, dd);\n                  break;\n              case def.qtype_dictation:\n              case def.qtype_dictationchat:\n              case def.qtype_multichoice:\n              case def.qtype_multiaudio:\n              case def.qtype_listenrepeat:\n              case def.qtype_smartframe:\n              case def.qtype_shortanswer:\n              default:\n          }//end of nextitem switch\n\n            //autoplay audio if we need to\n            var ttsquestionplayer = $(\"#\" + nextitem.uniqueid + \"_container audio.mod_minilesson_itemttsaudio\");\n            if(ttsquestionplayer.data('autoplay')==\"1\"){\n                var that=this;\n                setTimeout(function() {ttsquestionplayer[0].play();}, that.autoplaydelay);\n            }\n\n        } else {\n          //just reload and re-fetch all the data to display\n            $(\".minilesson_nextbutton\").prop(\"disabled\", true);\n            setTimeout(function () {\n               // log.debug(\"forwarding to finished page\");\n                window.location.href=dd.activityurl;\n            }, 1000);\n\n          return;\n\n          //no longer do this\n            /*\n          var results = dd.stepresults.filter(function(e){return e.hasgrade;});\n          var correctitems = 0;\n          var totalitems = 0;\n          results.forEach(function(result,i){\n            result.index=i+1;\n            result.title=dd.quizdata[i].title;\n            correctitems += result.correctitems;\n            totalitems += result.totalitems;\n          });\n          var totalpercent = Math.round((correctitems/totalitems)*100);\n          console.log(results,correctitems,totalitems,totalpercent);\n          var finishedparams ={results:results,total:totalpercent, courseurl: this.courseurl};\n          if(this.reattempturl!=''){finishedparams.reattempturl = this.reattempturl;}\n          if(this.backtocourse!=''){finishedparams.backtocourse = true;}\n          templates.render('mod_minilesson/quizfinished',finishedparams).then(\n              function(html,js){\n                  dd.controls.quizfinished.html(html);\n                  dd.controls.quizfinished.show();\n                  templates.runTemplateJS(js);\n              }\n          );\n          */\n\n        }//end of if has more questions\n\n        this.render_quiz_progress(stepdata.index+1,this.quizdata.length);\n\n          //we want to destroy the old question in the DOM also because iframe/media content might be playing\n          theoldquestion.remove();\n        \n      },\n\n      report_step_grade: async function(stepdata) {\n        var dd = this;\n\n        //store results locally\n        this.stepresults.push(stepdata);\n\n        //push results to server\n        await Ajax.call([{\n          methodname: 'mod_minilesson_report_step_grade',\n          args: {\n            cmid: dd.cmid,\n            step: JSON.stringify(stepdata),\n          }\n        }]);\n      },\n\n\n\n      start_quiz: function() {\n        $(\"#\" + this.quizdata[0].uniqueid + \"_container\").show();\n          //autoplay audio if we need to\n          var ttsquestionplayer = $(\"#\" + this.quizdata[0].uniqueid + \"_container audio.mod_minilesson_itemttsaudio\");\n          if(ttsquestionplayer.data('autoplay')==\"1\"){\n              var that=this;\n              setTimeout(function() {ttsquestionplayer[0].play();}, that.autoplaydelay);\n          }\n        this.render_quiz_progress(0,this.quizdata.length);\n      },\n\n      //this function is overridden by the calling class\n      onSubmit: function() {\n        alert('quiz submitted. Override this');\n      },\n\n        mobile_user: function() {\n\n            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {\n                return true;\n            } else {\n                return false;\n            }\n        },\n\n        chrome_user: function(){\n            if(/Chrome/i.test(navigator.userAgent)) {\n                return true;\n            }else{\n                return false;\n            }\n        },\n\n        //this will always be true these days\n        use_ttrecorder: function(){\n            return true;\n        },\n        is_ds_only: function(){\n          return this.ds_only;\n        },\n\n        //text comparison functions follow===============\n\n        similarity: function(s1, s2) {\n            //we remove spaces because JP transcript and passage might be different. And who cares about spaces anyway?\n            s1 = s1.replace(/\\s+/g, '');\n            s2 = s2.replace(/\\s+/g, '');\n\n            var longer = s1;\n            var shorter = s2;\n            if (s1.length < s2.length) {\n                longer = s2;\n                shorter = s1;\n            }\n            var longerLength = longer.length;\n            if (longerLength == 0) {\n                return 100;\n            }\n            return 100 * ((longerLength - this.editDistance(longer, shorter)) / parseFloat(longerLength));\n        },\n        editDistance: function(s1, s2) {\n            s1 = s1.toLowerCase();\n            s2 = s2.toLowerCase();\n\n            var costs = new Array();\n            for (var i = 0; i <= s1.length; i++) {\n                var lastValue = i;\n                for (var j = 0; j <= s2.length; j++) {\n                    if (i == 0)\n                        costs[j] = j;\n                    else {\n                        if (j > 0) {\n                            var newValue = costs[j - 1];\n                            if (s1.charAt(i - 1) != s2.charAt(j - 1))\n                                newValue = Math.min(Math.min(newValue, lastValue),\n                                    costs[j]) + 1;\n                            costs[j - 1] = lastValue;\n                            lastValue = newValue;\n                        }\n                    }\n                }\n                if (i > 0)\n                    costs[s2.length] = lastValue;\n            }\n            return costs[s2.length];\n        },\n\n        cleanText: function(text) {\n            var lowertext = text.toLowerCase();\n            var punctuationless = lowertext.replace(this.nopunc_regexp,\"\");\n            var ret = punctuationless.replace(/\\s+/g, \" \").trim();\n            return ret;\n        },\n\n        //this will return the promise, the result of which is an integer 100 being perfect match, 0 being no match\n        checkByPhonetic: function(passage, transcript, passagephonetic, language) {\n            return Ajax.call([{\n                'methodname': 'mod_minilesson_check_by_phonetic',\n                'args': {\n                    'spoken': transcript,\n                    'correct': passage,\n                    'language': language,\n                    'phonetic': passagephonetic,\n                    'region': this.region,\n                    'cmid': this.cmid\n                }\n            }])[0];\n\n        },\n\n       comparePassageToTranscript: function (passage,transcript,passagephonetic, language){\n          return Ajax.call([{\n               methodname: 'mod_minilesson_compare_passage_to_transcript',\n               args: {\n                   passage: passage,\n                   transcript: transcript,\n                   alternatives: '',\n                   phonetic: passagephonetic,\n                   language: language,\n                   region: this.region,\n                   cmid: this.cmid\n               }\n           }])[0];\n       }\n    }; //end of return value\n  });\n"],"file":"quizhelper.min.js"}