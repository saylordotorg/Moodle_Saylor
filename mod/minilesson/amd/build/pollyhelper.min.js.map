{"version":3,"sources":["../src/pollyhelper.js"],"names":["define","$","log","def","debug","token","region","owner","init","clean_ssml_chars","speaktext","replace","fetch_polly_url","voiceoption","voice","that","Promise","resolve","reject","xhr","XMLHttpRequest","onreadystatechange","readyState","status","payload","responseText","payloadobject","JSON","parse","returnCode","returnMessage","pollyurl","parseInt","xhrparams","encodeURIComponent","component","serverurl","cloudpoodllurl","open","setRequestHeader","send"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log', 'mod_minilesson/definitions'], function ($, log, def) {\n    \"use strict\"; // jshint ;_;\n    /*\n    This file helps you get Polly URLs at runtime\n     */\n\n    log.debug('Polly helper: initialising');\n\n    return {\n        token:  '',\n        region: '',\n        owner: '',\n\n        init: function(token, region, owner){\n            this.token =token;\n            this.region=region;\n            this.owner=owner;\n        },\n\n        clean_ssml_chars: function(speaktext){\n            //deal with SSML reserved characters\n            speaktext =  speaktext.replace(/&/g,'&amp;');\n            speaktext = speaktext.replace(/'/g,'&apos;');\n            speaktext= speaktext.replace(/\"/g,'&quot;');\n            speaktext = speaktext.replace(/</g,'&lt;');\n            speaktext =  speaktext.replace(/>/g,'&gt;');\n            return speaktext;\n        },\n\n        fetch_polly_url: function(speaktext,voiceoption, voice) {\n            var that = this;\n            return new Promise(function(resolve,reject){\n                //The REST API we are calling\n                var functionname = 'local_cpapi_fetch_polly_url';\n\n                //fetch the Posturl. We need this.\n                //set up our ajax request\n                var xhr = new XMLHttpRequest();\n\n                //set up our handler for the response\n                xhr.onreadystatechange = function (e) {\n                    if (this.readyState === 4) {\n                        if (xhr.status == 200) {\n\n                            //get a yes or forgetit or tryagain\n                            var payload = xhr.responseText;\n                            var payloadobject = JSON.parse(payload);\n                            if (payloadobject) {\n                                //returnCode > 0  indicates an error\n                                if (payloadobject.returnCode > 0) {\n                                    reject(payloadobject.returnMessage);\n                                    log.debug(payloadobject.returnMessage);\n                                    return false;\n                                    //if all good, then lets do the embed\n                                } else if (payloadobject.returnCode === 0){\n                                    var pollyurl = payloadobject.returnMessage;\n                                    resolve(pollyurl);\n                                } else {\n                                    reject('Polly Signed URL Request failed:');\n                                    log.debug('Polly Signed URL Request failed:');\n                                    log.debug(payloadobject);\n                                }\n                            } else {\n                                reject('Polly Signed URL Request something bad happened');\n                                log.debug('Polly Signed URL Request something bad happened');\n                            }\n                        } else {\n                            reject('Polly Signed URL Request Not 200 response:' + xhr.status);\n                            log.debug('Polly Signed URL Request Not 200 response:' + xhr.status);\n                        }\n                    }\n                };\n                var texttype='ssml';\n\n                switch(parseInt(voiceoption)){\n\n                    //slow\n                    case 1:\n                        //fetch slightly slower version of speech\n                        //rate = 'slow' or 'x-slow' or 'medium'\n                        speaktext =that.clean_ssml_chars(speaktext);\n                        speaktext = '<speak><break time=\"1000ms\"></break><prosody rate=\"slow\">' + speaktext + '</prosody></speak>';\n                        break;\n                    //veryslow\n                    case 2:\n                        //fetch slightly slower version of speech\n                        //rate = 'slow' or 'x-slow' or 'medium'\n                        speaktext =that.clean_ssml_chars(speaktext);\n                        speaktext = '<speak><break time=\"1000ms\"></break><prosody rate=\"x-slow\">' + speaktext + '</prosody></speak>';\n                        break;\n                    //ssml\n                    case 3:\n                        speaktext='<speak>' + speaktext + '</speak>';\n                        break;\n\n                    //normal\n                    case 0:\n                    default:\n                        //fetch slightly slower version of speech\n                        //rate = 'slow' or 'x-slow' or 'medium'\n                        speaktext =that.clean_ssml_chars(speaktext);\n                        speaktext = '<speak><break time=\"1000ms\"></break>' + speaktext + '</speak>';\n                        break;\n\n                }\n\n                //log.debug(params);\n                var xhrparams = \"wstoken=\" + that.token\n                + \"&wsfunction=\" + functionname\n                + \"&moodlewsrestformat=\" + 'json'\n                + \"&text=\" + encodeURIComponent(speaktext)\n                + '&texttype=' + texttype\n                + '&voice=' + voice\n                + '&appid=' + def.component\n                + '&owner=' + that.owner\n                + '&region=' + that.region;\n\n                var serverurl = def.cloudpoodllurl + \"/webservice/rest/server.php\";\n                xhr.open(\"POST\", serverurl, true);\n                xhr.setRequestHeader(\"Cache-Control\", \"no-cache\");\n                xhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\n                xhr.send(xhrparams);\n            });\n        }\n\n    };//end of return value\n});\n"],"file":"pollyhelper.min.js"}