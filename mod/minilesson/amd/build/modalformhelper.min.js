/**
 * Add a modal to manage question adding and editing to the page.
 *
 * @module     mod_minilesson/modalformhelper
 * @class      modalformhelper
 * @package    mod_minilesson
 * @copyright  2020 Justin Hunt <poodllsupport@moodle.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_minilesson/modalformhelper",["jquery","core/log","core/str","core/modal_factory","core/modal_events","core/fragment","core/ajax","core/yui"],(function($,log,Str,ModalFactory,ModalEvents,Fragment,Ajax,Y){var TheForm=function(selector,contextid,callback){this.contextid=contextid,this.callback=callback,this.preinit(selector)};return TheForm.prototype.modal=null,TheForm.prototype.contextid=-1,TheForm.prototype.itemid=-1,TheForm.prototype.formname="",TheForm.prototype.preinit=function(selector){$(selector);var dd=this;$("body").on("click",selector,(function(e){e.preventDefault(),dd.itemid=$(this).data("id"),dd.formname=$(this).data("qtype"),ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:dd.formtitle,body:dd.getBody({})}).then((function(modal){return dd.modal=modal,Str.get_string(dd.formname,"mod_minilesson").then((function(title){dd.formtitle=title,dd.modal.setTitle(dd.formtitle)})),dd.modal.setLarge(),dd.modal.getRoot().on(ModalEvents.hidden,function(){dd.modal.setBody(dd.getBody({}))}.bind(dd)),dd.modal.getRoot().on(ModalEvents.shown,(function(){dd.modal.getRoot().append("<style>[data-fieldtype=submit] { display: none ! important; }</style>")})),dd.modal.getRoot().on(ModalEvents.save,dd.submitForm.bind(dd)),dd.modal.getRoot().on("submit","form",dd.submitFormAjax.bind(dd)),dd.modal.show(),dd.modal}))}))},TheForm.prototype.getBody=function(formdata){void 0===formdata&&(formdata={});var params={jsonformdata:JSON.stringify(formdata),formname:this.formname,itemid:this.itemid};return Fragment.loadFragment("mod_minilesson","mform",this.contextid,params)},TheForm.prototype.handleFormSubmissionResponse=function(formData,ajaxresult){this.modal.hide(),Y.use("moodle-core-formchangechecker",(function(){M.core_formchangechecker.reset_form_dirty_state()})),log.debug(ajaxresult),log.debug(formData);var payloadobject=JSON.parse(ajaxresult);if(payloadobject)if(log.debug(payloadobject),!1===payloadobject.error){var dataobject={};dataobject.name=new URLSearchParams(formData).get("name"),dataobject.typelabel=this.formtitle,dataobject.type=this.formname,this.callback(dataobject,payloadobject.itemid)}else log.debug("that was an error: ")},TheForm.prototype.handleFormSubmissionFailure=function(data){this.modal.setBody(this.getBody(data))},TheForm.prototype.submitFormAjax=function(e){e.preventDefault();var changeEvent=document.createEvent("HTMLEvents");changeEvent.initEvent("change",!0,!0),this.modal.getRoot().find(":input").each((function(index,element){element.dispatchEvent(changeEvent)}));var invalid=$.merge(this.modal.getRoot().find('[aria-invalid="true"]'),this.modal.getRoot().find(".error"));if(invalid.length)invalid.first().focus();else{var formData=this.modal.getRoot().find("form").serialize();Ajax.call([{methodname:"mod_minilesson_submit_mform",args:{contextid:this.contextid,jsonformdata:JSON.stringify(formData),formname:this.formname},done:this.handleFormSubmissionResponse.bind(this,formData),fail:this.handleFormSubmissionFailure.bind(this,formData)}])}},TheForm.prototype.submitForm=function(e){e.preventDefault(),this.modal.getRoot().find("form").submit()},{init:function(selector,contextid,callback){return new TheForm(selector,contextid,callback)}}}));

//# sourceMappingURL=modalformhelper.min.js.map