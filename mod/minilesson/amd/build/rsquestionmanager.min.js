define(["jquery","core/log","core/templates","mod_minilesson/definitions","mod_minilesson/modalformhelper","mod_minilesson/modaldeletehelper","mod_minilesson/moveitemhelper","mod_minilesson/modalpreviewhelper","mod_minilesson/duplicateitemhelper","mod_minilesson/datatables"],function(a,b,c,d,e,f,g,h,i,j){"use strict";b.debug("RSQuestion manager: initialising");return{cmid:null,controls:null,rowIds:[],init:function init(a){var b=this;b.contextid=a.contextid;b.tableid=a.tableid;b.register_events();b.process_html();b.collate_rowids();b.hide_useless_arrows()},process_html:function process_html(){this.controls=[];this.controls.questionstable=j.getDataTable(this.tableid);this.controls.questionscontainer=a("#"+d.itemscontainer);this.controls.noquestionscontainer=a("#"+d.noitemscontainer);this.controls.movearrows=a("#"+d.movearrow)},collate_rowids:function collate_rowids(){var a=this;a.rowIds=[];a.controls.questionstable.rows().every(function(b){var c=a.controls.questionstable.cell({row:b,column:0}).data();a.rowIds[c]=b})},hide_useless_arrows:function hide_useless_arrows(){a(".mod_minilesson_item_move").attr("style","");var b=this.controls.questionstable.data().length;if(!b||1>b){return}var c=this.rowIds[b],d=this.controls.questionstable.row(c).node();a(d).find(".mod_minilesson_item_move[data-direction=\"down\"]").attr("style","visibility: hidden;");var e=this.rowIds[1],f=this.controls.questionstable.row(e).node();a(f).find(".mod_minilesson_item_move[data-direction=\"up\"]").attr("style","visibility: hidden;")},renumber_rows:function renumber_rows(a){for(var b=this.controls.questionstable,c=b.data().length,d=a,e;d<c;d++){e=this.rowIds[d+1];b.cell({row:e,column:0}).data(d)}},move_row:function move_row(a,b){var c=this.controls.questionstable,e="#"+d.itemrow+"_"+a,f=c.row(e),g=f.index(),h=parseInt(c.cell({row:g,column:0}).data()),i;if("up"==b){i=h-1}else if("down"==b){i=h+1}if(1>i){return}var j=c.data().length;if(i>j){return}var k=this.rowIds[i],l=c.cell({row:g,column:0}).data(),m=c.cell({row:k,column:0}).data();c.cell({row:g,column:0}).data(m);c.cell({row:k,column:0}).data(l);c.draw(!1);this.collate_rowids()},register_events:function register_events(){var j=this,k=[d.qtype_dictation,d.qtype_dictationchat,d.qtype_page,d.qtype_speechcards,d.qtype_listenrepeat,d.qtype_multichoice,d.qtype_multiaudio];e.init("."+d.component+"_addlink",j.contextid,function after_questionadd(b,d){b.id=d;b.name=decodeURIComponent(b.name);b.index=j.controls.questionstable.data().length+1;b.up={key:"t/up",component:"moodle",title:"up"};b.down={key:"t/down",component:"moodle",title:"down"};c.render("mod_minilesson/itemlistitem",b).then(function(b){j.controls.questionstable.row.add(a(b)[0]).page("last").draw(!1);j.collate_rowids();j.hide_useless_arrows()});j.controls.noquestionscontainer.hide();j.controls.questionscontainer.show()});e.init("."+d.itemrow+"_editlink",j.contextid,function after_questionedit(b,c){var e="#"+d.itemrow+"_"+c;j.controls.questionstable.cell(a(e+" .c1")).data(decodeURIComponent(b.name))});f.init("."+d.itemrow+"_deletelink",j.contextid,"deleteitem",function after_questiondelete(a){b.debug("after question delete");var c=j.controls.questionstable.row("#"+d.itemrow+"_"+a),e=parseInt(c.data()[0]);j.renumber_rows(e);c.remove().draw(!1);j.collate_rowids();j.hide_useless_arrows();var f=j.controls.questionstable.rows().count();if(!f){j.controls.noquestionscontainer.show();j.controls.questionscontainer.hide()}});g.init("."+d.movearrow,j.contextid,function after_questionmove(a,b){j.move_row(a,b);j.hide_useless_arrows()});h.init("."+d.itemrow+"_previewlink",j.contextid,function after_questionpreview(){b.debug("after preview");a("#mod_minilesson_quiz_cont").remove()});i.init("."+d.itemrow+"_duplicatelink",j.contextid,function after_questionduplicate(b){var d=JSON.parse(b),e={};e.id=d.newitemid;e.name=decodeURIComponent(d.newitemname);e.type=d.type;e.typelabel=decodeURIComponent(d.typelabel);e.index=j.controls.questionstable.data().length+1;e.up={key:"t/up",component:"moodle",title:"up"};e.down={key:"t/down",component:"moodle",title:"down"};c.render("mod_minilesson/itemlistitem",e).then(function(b){j.controls.questionstable.row.add(a(b)[0]).page("last").draw(!1);j.collate_rowids();j.hide_useless_arrows()});j.controls.noquestionscontainer.hide();j.controls.questionscontainer.show()})}}});
//# sourceMappingURL=rsquestionmanager.min.js.map
