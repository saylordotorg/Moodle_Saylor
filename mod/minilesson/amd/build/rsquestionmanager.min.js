define(["jquery","core/log","core/templates","mod_minilesson/definitions","mod_minilesson/modalformhelper","mod_minilesson/modaldeletehelper","mod_minilesson/moveitemhelper","mod_minilesson/modalpreviewhelper","mod_minilesson/duplicateitemhelper","mod_minilesson/datatables"],(function($,log,templates,def,mfh,mdh,mih,mph,dplh,datatables){return log.debug("RSQuestion manager: initialising"),{cmid:null,controls:null,rowIds:[],init:function(props){var dd=this;dd.contextid=props.contextid,dd.tableid=props.tableid,dd.register_events(),dd.process_html(),dd.collate_rowids(),dd.hide_useless_arrows()},process_html:function(){this.controls=[],this.controls.questionstable=datatables.getDataTable(this.tableid),this.controls.questionscontainer=$("#"+def.itemscontainer),this.controls.noquestionscontainer=$("#"+def.noitemscontainer),this.controls.movearrows=$("#"+def.movearrow)},collate_rowids:function(){var dd=this;dd.rowIds=[],dd.controls.questionstable.rows().every((function(rowindex,tableLoop,rowLoop){var itemorder=dd.controls.questionstable.cell({row:rowindex,column:0}).data();dd.rowIds[itemorder]=rowindex}))},hide_useless_arrows:function(){$(".mod_minilesson_item_move").attr("style","");var rowcount=this.controls.questionstable.data().length;if(rowcount&&!(rowcount<1)){var bottomrowindex=this.rowIds[rowcount],bottomtr=this.controls.questionstable.row(bottomrowindex).node();$(bottomtr).find('.mod_minilesson_item_move[data-direction="down"]').attr("style","visibility: hidden;");var toprowindex=this.rowIds[1],toptr=this.controls.questionstable.row(toprowindex).node();$(toptr).find('.mod_minilesson_item_move[data-direction="up"]').attr("style","visibility: hidden;")}},renumber_rows:function(fromorder){for(var thetable=this.controls.questionstable,rowcount=thetable.data().length,itemorder=fromorder;itemorder<rowcount;itemorder++){var rowindex=this.rowIds[itemorder+1];thetable.cell({row:rowindex,column:0}).data(itemorder)}},move_row:function(itemid,direction){var targetorder,thetable=this.controls.questionstable,therow="#"+def.itemrow+"_"+itemid,currentindex=thetable.row(therow).index(),currentorder=parseInt(thetable.cell({row:currentindex,column:0}).data());if(("up"==direction?targetorder=currentorder-1:"down"==direction&&(targetorder=currentorder+1),!(targetorder<1))&&!(targetorder>thetable.data().length)){var targetindex=this.rowIds[targetorder],from=thetable.cell({row:currentindex,column:0}).data(),to=thetable.cell({row:targetindex,column:0}).data();thetable.cell({row:currentindex,column:0}).data(to),thetable.cell({row:targetindex,column:0}).data(from),thetable.draw(!1),this.collate_rowids()}},register_events:function(){var dd=this;def.qtype_dictation,def.qtype_dictationchat,def.qtype_page,def.qtype_speechcards,def.qtype_listenrepeat,def.qtype_multichoice,def.qtype_multiaudio;mfh.init("."+def.component+"_addlink",dd.contextid,(function(item,itemid){item.id=itemid,item.name=decodeURIComponent(item.name),item.index=dd.controls.questionstable.data().length+1,item.up={key:"t/up",component:"moodle",title:"up"},item.down={key:"t/down",component:"moodle",title:"down"},templates.render("mod_minilesson/itemlistitem",item).then((function(html,js){dd.controls.questionstable.row.add($(html)[0]).page("last").draw(!1),dd.collate_rowids(),dd.hide_useless_arrows()})),dd.controls.noquestionscontainer.hide(),dd.controls.questionscontainer.show()})),mfh.init("."+def.itemrow+"_editlink",dd.contextid,(function(item,itemid){var therow="#"+def.itemrow+"_"+itemid;dd.controls.questionstable.cell($(therow+" .c1")).data(decodeURIComponent(item.name))})),mdh.init("."+def.itemrow+"_deletelink",dd.contextid,"deleteitem",(function(itemid){log.debug("after question delete");var therow=dd.controls.questionstable.row("#"+def.itemrow+"_"+itemid),itemorder=parseInt(therow.data()[0]);dd.renumber_rows(itemorder),therow.remove().draw(!1),dd.collate_rowids(),dd.hide_useless_arrows(),dd.controls.questionstable.rows().count()||(dd.controls.noquestionscontainer.show(),dd.controls.questionscontainer.hide())})),mih.init("."+def.movearrow,dd.contextid,(function(itemid,direction){dd.move_row(itemid,direction),dd.hide_useless_arrows()})),mph.init("."+def.itemrow+"_previewlink",dd.contextid,(function(itemid){log.debug("after preview"),$("#mod_minilesson_quiz_cont").remove()})),dplh.init("."+def.itemrow+"_duplicatelink",dd.contextid,(function($resp){var ret=JSON.parse($resp),item={};item.id=ret.newitemid,item.name=decodeURIComponent(ret.newitemname),item.type=ret.type,item.typelabel=decodeURIComponent(ret.typelabel),item.index=dd.controls.questionstable.data().length+1,item.up={key:"t/up",component:"moodle",title:"up"},item.down={key:"t/down",component:"moodle",title:"down"},templates.render("mod_minilesson/itemlistitem",item).then((function(html,js){dd.controls.questionstable.row.add($(html)[0]).page("last").draw(!1),dd.collate_rowids(),dd.hide_useless_arrows()})),dd.controls.noquestionscontainer.hide(),dd.controls.questionscontainer.show()}))}}}));

//# sourceMappingURL=rsquestionmanager.min.js.map