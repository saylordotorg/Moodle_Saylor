define(["jquery","core/log","mod_readaloud/definitions","mod_readaloud/recorderhelper","mod_readaloud/modelaudiokaraoke"],function(a,b,c,d,e){"use strict";b.debug("Model Audio helper: initialising");return{controls:{},currentmode:"modeling",breaks:[],matches:!1,goturl:!1,cd:{audioplayerclass:c.modelaudioplayerclass,wordclass:c.wordclass,spaceclass:c.spaceclass,endspaceclass:c.endspaceclass,passagecontainer:c.passagecontainer,breaksfield:c.modelaudiobreaksfield,urlfield:c.modelaudiourlfield,modeltranscriptbutton:c.modeltranscriptbutton,modeltranscript:c.modeltranscript},init:function init(c){var d="#amdopts_"+c.widgetid,e=a(d).get(0);if(e){var f=JSON.parse(e.value);a(d).remove()}else{b.debug("Read Aloud model audio Controller: No config found on page. Giving up.");return}if(f.modelaudiobreaks){this.breaks=JSON.parse(f.modelaudiobreaks)}if(f.modelaudiomatches){this.matches=JSON.parse(f.modelaudiomatches)}this.register_controls();this.register_events();this.markup_passage();this.init_recorder(f);this.init_karaoke();var g=this.controls.audioplayer.attr("src");if(null!=g&&!g.includes("poodllfile.poodll.net")){}},init_karaoke:function init_karaoke(){var a={audioplayerclass:this.cd.audioplayerclass,modeling:!0};e.init(a);e.set_breaks(this.breaks)},init_recorder:function init_recorder(a){var b=this;d.init(a,function on_recording_start(){b.goturl=!1},function on_recording_end(){},function on_audio_processing(a){if(!b.goturl){b.controls.urlfield.val(a.mediaurl);b.goturl=!0}})},register_controls:function register_controls(){this.controls.audioplayer=a("#"+this.cd.audioplayerclass);this.controls.eachword=a("."+this.cd.wordclass);this.controls.eachspace=a("."+this.cd.spaceclass);this.controls.passagecontainer=a("."+this.cd.passagecontainer);this.controls.breaksfield=a("#"+this.cd.breaksfield);this.controls.urlfield=a("#"+this.cd.urlfield);this.controls.modeltranscript=a("#"+this.cd.modeltranscript);this.controls.modeltranscriptbutton=a("#"+this.cd.modeltranscriptbutton)},register_events:function register_events(){var b=this,c=function(){if("modeling"===b.currentmode){var c=parseInt(a(this).attr("data-wordnumber")),d=a("#"+b.cd.spaceclass+"_"+c);if(d.hasClass(b.cd.endspaceclass)){b.remove_break(c);d.removeClass(b.cd.endspaceclass)}else{d.addClass(b.cd.endspaceclass);var e=b.controls.audioplayer[0],f=b.fetch_break_audiotime(c,e,b.matches);b.register_break(c,f)}}};this.controls.eachword.click(c);this.controls.eachspace.click(c);this.controls.modeltranscriptbutton.click(function(){a(this).hide();b.controls.modeltranscript.show()})},remove_break:function remove_break(a){for(var c=0;c<this.breaks.length;c++){if(this.breaks[c].wordnumber==a){this.breaks.splice(c,1);break}}this.controls.breaksfield.val(JSON.stringify(this.breaks));e.set_breaks(this.breaks);b.debug(this.breaks)},register_break:function register_break(a,c){this.breaks.push({wordnumber:a,audiotime:c});this.breaks.sort(function compare(c,a){if(c.wordnumber<a.wordnumber){return-1}if(c.wordnumber>a.wordnumber){return 1}return 0});this.controls.breaksfield.val(JSON.stringify(this.breaks));e.set_breaks(this.breaks);b.debug(this.breaks)},markup_passage:function markup_passage(){for(var b=0;b<this.breaks.length;b++){var c=this.breaks[b].wordnumber,d=a("#"+this.cd.spaceclass+"_"+c);d.addClass(this.cd.endspaceclass)}},player_get_time:function player_get_time(){var a=this.controls.audioplayer[0];return a.currentTime},fetch_break_audiotime:function fetch_break_audiotime(b,c,d){if(!1!==d&&!a(".mod_readaloud_manualbreaktiming").is(":checked")){if(d[b]){return d[b].audiostart}else{for(var e=1;6>e;e++){if(d[b+e]){return d[b+e].audiostart}}}}else{return c.currentTime}},check_modelaudio_transcript_ready:function check_modelaudio_transcript_ready(c,d){var e=this;a.ajax({url:c+".txt",method:"HEAD",cache:!1,error:function error(){b.debug("403 errors are normal here, till the file arrives back from transcriptoin");setTimeout(function(){e.check_modelaudio_transcript_ready(c,d+5e3)},d)},success:function success(a,b,f){switch(f.status){case 200:e.controls.modeltranscript.load(c+".txt");e.controls.modeltranscriptbutton.show();break;default:setTimeout(function(){e.check_modelaudio_transcript_ready(c,d+5e3)},d);}}})},do_transcription_complete:function do_transcription_complete(){}}});
//# sourceMappingURL=modelaudiohelper.min.js.map
