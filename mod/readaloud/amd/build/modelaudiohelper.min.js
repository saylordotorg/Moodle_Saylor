define(["jquery","core/log","mod_readaloud/definitions","mod_readaloud/recorderhelper","mod_readaloud/modelaudiokaraoke"],(function($,log,def,recorderhelper,karaoke){return log.debug("Model Audio helper: initialising"),{controls:{},currentmode:"modeling",breaks:[],matches:!1,goturl:!1,cd:{audioplayerclass:def.modelaudioplayerclass,wordclass:def.wordclass,spaceclass:def.spaceclass,endspaceclass:def.endspaceclass,passagecontainer:def.passagecontainer,breaksfield:def.modelaudiobreaksfield,urlfield:def.modelaudiourlfield,modeltranscriptbutton:def.modeltranscriptbutton,modeltranscript:def.modeltranscript},init:function(props){var theid="#amdopts_"+props.widgetid,configcontrol=$(theid).get(0);if(configcontrol){var opts=JSON.parse(configcontrol.value);$(theid).remove(),opts.modelaudiobreaks&&(this.breaks=JSON.parse(opts.modelaudiobreaks)),opts.modelaudiomatches&&(this.matches=JSON.parse(opts.modelaudiomatches)),this.register_controls(),this.register_events(),this.markup_passage(),this.init_recorder(opts),this.init_karaoke();var audiourl=this.controls.audioplayer.attr("src");null!=audiourl&&audiourl.includes("poodllfile.poodll.net")}else log.debug("Read Aloud model audio Controller: No config found on page. Giving up.")},init_karaoke:function(){var karaoke_opts={audioplayerclass:this.cd.audioplayerclass,modeling:!0};karaoke.init(karaoke_opts),karaoke.set_breaks(this.breaks)},init_recorder:function(opts){var that=this;recorderhelper.init(opts,(function(eventdata){that.goturl=!1}),(function(eventdata){}),(function(eventdata){that.goturl||(that.controls.urlfield.val(eventdata.mediaurl),that.goturl=!0)}))},register_controls:function(){this.controls.audioplayer=$("#"+this.cd.audioplayerclass),this.controls.eachword=$("."+this.cd.wordclass),this.controls.eachspace=$("."+this.cd.spaceclass),this.controls.passagecontainer=$("."+this.cd.passagecontainer),this.controls.breaksfield=$("#"+this.cd.breaksfield),this.controls.urlfield=$("#"+this.cd.urlfield),this.controls.modeltranscript=$("#"+this.cd.modeltranscript),this.controls.modeltranscriptbutton=$("#"+this.cd.modeltranscriptbutton)},register_events:function(){var that=this,clickhandler=function(){if("modeling"===that.currentmode){var wordnumber=parseInt($(this).attr("data-wordnumber")),nextspace=$("#"+that.cd.spaceclass+"_"+wordnumber);if(nextspace.hasClass(that.cd.endspaceclass))that.remove_break(wordnumber),nextspace.removeClass(that.cd.endspaceclass);else{nextspace.addClass(that.cd.endspaceclass);var theplayer=that.controls.audioplayer[0],audiotime=that.fetch_break_audiotime(wordnumber,theplayer,that.matches);that.register_break(wordnumber,audiotime)}}};this.controls.eachword.click(clickhandler),this.controls.eachspace.click(clickhandler),this.controls.modeltranscriptbutton.click((function(){$(this).hide(),that.controls.modeltranscript.show()}))},remove_break:function(wordnumber){for(var i=0;i<this.breaks.length;i++)if(this.breaks[i].wordnumber==wordnumber){this.breaks.splice(i,1);break}this.controls.breaksfield.val(JSON.stringify(this.breaks)),karaoke.set_breaks(this.breaks),log.debug(this.breaks)},register_break:function(wordnumber,audiotime){this.breaks.push({wordnumber:wordnumber,audiotime:audiotime});this.breaks.sort((function(a,b){return a.wordnumber<b.wordnumber?-1:a.wordnumber>b.wordnumber?1:0})),this.controls.breaksfield.val(JSON.stringify(this.breaks)),karaoke.set_breaks(this.breaks),log.debug(this.breaks)},markup_passage:function(){for(var i=0;i<this.breaks.length;i++){var wordnumber=this.breaks[i].wordnumber;$("#"+this.cd.spaceclass+"_"+wordnumber).addClass(this.cd.endspaceclass)}},player_get_time:function(){return this.controls.audioplayer[0].currentTime},fetch_break_audiotime:function(wordnumber,theplayer,matches){if(!1===matches||$(".mod_readaloud_manualbreaktiming").is(":checked"))return theplayer.currentTime;if(matches[wordnumber])return matches[wordnumber].audiostart;for(var i=1;i<6;i++)if(matches[wordnumber+i])return matches[wordnumber+i].audiostart},check_modelaudio_transcript_ready:function(audiourl,waitms){var that=this;$.ajax({url:audiourl+".txt",method:"HEAD",cache:!1,error:function(){log.debug("403 errors are normal here, till the file arrives back from transcriptoin"),setTimeout((function(){that.check_modelaudio_transcript_ready(audiourl,waitms+5e3)}),waitms)},success:function(data,textStatus,xhr){if(200===xhr.status)that.controls.modeltranscript.load(audiourl+".txt"),that.controls.modeltranscriptbutton.show();else setTimeout((function(){that.check_modelaudio_transcript_ready(audiourl,waitms+5e3)}),waitms)}})},do_transcription_complete:function(){}}}));

//# sourceMappingURL=modelaudiohelper.min.js.map