define(["jquery","core/log","mod_readaloud/definitions"],(function($,log,def){return log.debug("Model Audio Karaoke: initialising"),{controls:{},breaks:[],endwordnumber:0,currentstartbreak:!1,modeling:!1,cd:{audioplayerclass:def.audioplayerclass,wordplayerclass:def.wordplayerclass,wordclass:def.wordclass,spaceclass:def.spaceclass,endspaceclass:def.endspaceclass,passagecontainer:def.passagecontainer,activesentence:def.activesentence,stopbutton:"mod_readaloud_button_stop",playbutton:"mod_readaloud_button_play"},init:function(opts){if(opts.breaks){var breaks=JSON.parse(opts.breaks);this.set_breaks(breaks)}opts.modeling&&(this.modeling=!0),opts.audioplayerclass&&(this.cd.audioplayerclass=opts.audioplayerclass),this.register_controls(),this.endwordnumber=this.controls.eachword.length,this.register_events()},set_breaks:function(breaks){this.breaks=breaks,this.sort_breaks(),this.number_breaks()},sort_breaks:function(){this.breaks.sort((function(a,b){return a.audiotime-b.audiotime}))},number_breaks:function(){for(var i=0;i<this.breaks.length;i++)this.breaks[i].breaknumber=i+1},pause_audio:function(){this.controls.audioplayer[0].pause()},play_audio:function(){this.controls.audioplayer[0].play()},get_audio_time:function(){return this.controls.audioplayer[0].currentTime},set_audio_time:function(newtime){this.controls.audioplayer[0].currentTime=newtime},fetch_audio_url:function(){return this.controls.audioplayer.attr("src")},register_controls:function(){this.controls.audioplayer=$("#"+this.cd.audioplayerclass),this.controls.eachword=$("."+this.cd.wordclass),this.controls.eachspace=$("."+this.cd.spaceclass),this.controls.eachwordorspace=$("."+this.cd.spaceclass+",."+this.cd.wordclass),this.controls.passagecontainer=$("."+this.cd.passagecontainer),this.controls.stopbutton=$("#"+this.cd.stopbutton),this.controls.playbutton=$("#"+this.cd.playbutton)},register_events:function(){var that=this,aplayer=this.controls.audioplayer[0];this.controls.playbutton.on("click",(function(){aplayer.play()})),this.controls.stopbutton.on("click",(function(){aplayer.pause(),aplayer.currentTime=0})),this.modeling||this.controls.eachwordorspace.on("click",(function(){for(var wordnumber=parseInt($(this).attr("data-wordnumber")),nearest_start_break=!1,i=0;i<that.breaks.length&&that.breaks[i].wordnumber<wordnumber;i++)nearest_start_break=that.breaks[i];nearest_start_break&&(aplayer.pause(),aplayer.currentTime=nearest_start_break.audiotime,aplayer.play())}));var ended=function(){that.controls.eachword.removeClass(that.cd.activesentence),that.controls.eachspace.removeClass(that.cd.activesentence),that.currentstartbreak=!1};aplayer.onended=ended,aplayer.onpause=ended,aplayer.ontimeupdate=function(){for(var currentTime=aplayer.currentTime,startbreak=!1,nextbreak=!1,i=0;i<that.breaks.length;i++)if(currentTime>=that.breaks[i].audiotime&&i+1===that.breaks.length)startbreak=that.breaks[i],nextbreak={wordnumber:that.endwordnumber+1,audiotime:0};else{if(currentTime>=that.breaks[i].audiotime&&currentTime<that.breaks[i+1].audiotime){startbreak=that.breaks[i],nextbreak=that.breaks[i+1];break}0===i&&currentTime<that.breaks[i].audiotime&&currentTime>0&&(startbreak={wordnumber:0,audiotime:0,breaknumber:0},nextbreak=that.breaks[i])}var islastbreak=aplayer.ended&&0===nextbreak.audiotime;if(!1===that.currentstartbreak||startbreak.wordnumber!==that.currentstartbreak.wordnumber||islastbreak){var finishedsentence=$("."+that.cd.activesentence).text();if(that.previousstartbreak=that.currentstartbreak,that.currentstartbreak=startbreak,that.controls.eachword.removeClass(that.cd.activesentence),that.controls.eachspace.removeClass(that.cd.activesentence),!1!==startbreak&&!1!==nextbreak)for(var thewordnumber=startbreak.wordnumber+1;thewordnumber<=nextbreak.wordnumber;thewordnumber++)$("#"+that.cd.spaceclass+"_"+thewordnumber).addClass(that.cd.activesentence),$("#"+that.cd.wordclass+"_"+thewordnumber).addClass(that.cd.activesentence);that.on_reach_audio_break(finishedsentence,that.previousstartbreak,that.currentstartbreak,that.breaks)}}},on_reach_audio_break:function(sentence,oldbreak,newbreak,breaks){log.debug(sentence),log.debug(oldbreak),log.debug(newbreak)}}}));

//# sourceMappingURL=modelaudiokaraoke.min.js.map