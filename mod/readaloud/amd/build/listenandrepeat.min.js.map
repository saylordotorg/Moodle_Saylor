{"version":3,"sources":["../src/listenandrepeat.js"],"names":["define","$","log","ajax","def","cloudpoodll","ttrecorder","debug","activated","currentSentence","currentPhonetic","language","currentAudioStart","currentAudioStop","oldBreak","newBreak","mak","controls","results","phonetics","cmid","ttr","init","props","self","modelaudiokaraoke","region","stt_guided","shadow","opts","uniqueid","callback","theCallback","message","type","shadowplaycheckbox","is","playbutton","trigger","playselfbutton","hide","hiddenplayer","pause","usebrowserrec","show","getComparison","capturedspeech","comparison","gotComparison","clone","prepare_controls","register_events","register_mak","activate","deactivate","audioplayer","playing","container","landrcontainer","hiddenselfplayer","skipbutton","finishedbutton","audiourl","fetch_audio_url","attr","on_reach_audio_break","sentence","oldbreak","newbreak","breaks","trim","audiotime","currentAudioEnd","duration","length","wordnumber","startpos","endpos","slice","join","breaknumber","isfinalbreak","pause_audio","modal","html","split","map","e","i","on","paused","currentTime","play","audio","dataURI","get_audio_time","set_audio_time","play_audio","ontimeupdate","spliton","RegExp","thisClass","wordsmatched","removeClass","forEach","word","idx","matched","addClass","setTimeout","passage","transcript","passagephonetic","call","methodname","args","done","ajaxresult","payloadobject","JSON","parse","fail","err","mobile_user","test","navigator","userAgent","chrome_user"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log', 'core/ajax', 'mod_readaloud/definitions', 'mod_readaloud/cloudpoodllloader', 'mod_readaloud/ttrecorder'],\n    function($, log, ajax, def, cloudpoodll, ttrecorder) {\n  \"use strict\"; // jshint ;_;\n\n  log.debug('Readaloud listen and repeat: initialising');\n\n  return {\n\n    activated: false,\n    currentSentence: \"\",\n    currentPhonetic: \"\",\n    language: \"en-US\",\n    currentAudioStart: 0,\n    currentAudioStop: 0,\n    oldBreak: {},\n    newBreak: {},\n    mak: null,\n    controls: {},\n    results: [],\n    phonetics: [],\n    cmid: 0,\n    ttr: {},\n\n    init: function(props) {\n\n      var self = this;\n      self.cmid = props.cmid;\n      self.mak = props.modelaudiokaraoke;\n      self.language = props.language;\n      self.region = props.region;\n      self.phonetics = props.phonetics;\n      self.stt_guided = props.stt_guided;\n      self.shadow = false;//props.shadow;\n      self.ttr={};\n\n      //recorder stuff\n      var theCallback =function(message) {\n          switch (message.type) {\n            case 'recordingstarted':\n              if (self.controls.shadowplaycheckbox.is(\":checked\")) {\n                self.shadow = true;\n                log.debug('shadow is true');\n                self.controls.playbutton.trigger('click');\n              }else{\n                log.debug('shadow is false');\n                self.shadow=false;\n              }\n              //hide the self model player (though it may not be here) because we do not want it playing old stuff into mic\n              self.controls.playselfbutton.hide();\n\n              break;\n\n            case 'recordingstopped':\n                  if (self.shadow === true){\n                    self.controls.hiddenplayer[0].pause();\n                  }\n                  if(self.stt_guided || self.ttr.usebrowserrec===false){\n                    self.controls.playselfbutton.show();\n                  }\n                  break;\n\n              case 'speech':\n\n                  self.getComparison(\n                      self.cmid,\n                      self.currentSentence,\n                      message.capturedspeech,\n                      self.currentPhonetic,\n                      function(comparison) {\n                          self.gotComparison(comparison, message);\n                      }\n                  );\n                  break;\n          }\n      };\n\n        //init tt recorder\n      var opts = {};\n      opts.uniqueid = 'readaloud_ttrecorder';\n      opts.stt_guided = self.stt_guided;\n      opts.callback = theCallback;\n      opts.shadow = true;\n      self.ttr = ttrecorder.clone();\n      self.ttr.init(opts);\n\n\n      self.prepare_controls();\n      self.register_events();\n      self.register_mak();\n    },\n\n    activate: function() {\n      this.results = [];\n      this.activated = true;\n    },\n    deactivate: function() {\n      if (this.mak.controls.audioplayer[0].playing) {\n        this.mak.controls.audioplayer[0].pause();\n      }\n      this.activated = false;\n    },\n\n    prepare_controls: function() {\n      var self = this;\n      self.controls.container = $('#' + def.landrcontainer);\n      self.controls.hiddenplayer = $('#mod_readaloud_landr_hiddenplayer');\n      self.controls.hiddenselfplayer = $('#mod_readaloud_landr_hiddenselfplayer');\n      self.controls.playbutton = $('#mod_readaloud_landr_modalplay');\n      self.controls.shadowplaycheckbox = $('#mod_readaloud_landr_shadow');\n      self.controls.skipbutton = $('#mod_readaloud_landr_modalskip');\n      self.controls.finishedbutton = $(\"#mod_readaloud_landr_modalfinished\");\n      self.controls.playselfbutton = $(\"#mod_readaloud_landr_modalplayself\");\n      self.audiourl = self.mak.fetch_audio_url();\n      self.controls.hiddenplayer.attr('src', self.audiourl);\n\n    },\n\n    register_mak: function() {\n      var self = this;\n\n      self.mak.on_reach_audio_break = function(sentence, oldbreak, newbreak, breaks) {\n       // log.debug(breaks);\n        //do not get involved if we are not active\n        //model audio karaoke is used elsewhere (shadow and preview) as well\n        if (!self.activated) {\n          return;\n        }\n\n        // sentence contains the target text\n        //empty strings are none of our concern\n        if (sentence.trim() === '') {\n          return;\n        }\n\n        self.currentSentence = sentence;\n        self.oldBreak = oldbreak;\n        self.newBreak = newbreak;\n        self.currentAudioStart = oldbreak.audiotime;\n        self.currentAudioEnd = newbreak.audiotime;\n\n        if(self.currentAudioStart===self.currentAudioEnd){\n            //This is a special case where the end of the audio has been reached in MAK, and there is now no next break\n            self.currentAudioEnd=self.controls.hiddenplayer[0].duration;\n        }\n\n          if(self.phonetics.length>newbreak.wordnumber-1){\n              var startpos = oldbreak.wordnumber;\n              if(startpos<0){startpos=0;}\n              var endpos = newbreak.wordnumber;\n\n              /*\n              * break=0: wordnumber 0 start = 0, end = 9: jssplit returns 0-8\n              * break=1: wordnumber 9 start = 9, end = 18: jssplit returns 9-17\n              * break=2: wordnumber 18 start = 18, end = 99: jssplit returns 18-98\n               */\n              self.currentPhonetic = self.phonetics.slice(startpos,endpos).join(' ');\n          }else{\n              self.currentPhonetic  = '';\n          }\n\n        //pause audio while we do our thing\n        if (oldbreak.breaknumber == 0 && newbreak == false) {\n          // do nothing\n        } else {\n          // detect last line\n          if (oldbreak.breaknumber == breaks[breaks.length - 1].breaknumber) {\n            self.controls.finishedbutton.show();\n            self.controls.skipbutton.hide();\n            self.oldBreak.isfinalbreak=true;\n          } else {\n            self.controls.finishedbutton.hide();\n            self.controls.skipbutton.show();\n          }\n          self.mak.pause_audio();\n          self.controls.container.modal('show');\n          $(\"#mod_readaloud_modal_target_phrase\").html(sentence.split(/ /).map(function(e, i) {\n            return '<div class=\"mod_readaloud_modal_target_word\" data-index=\"' + i + '\">' + e + '</div>';\n          }));\n        }\n\n      };\n\n    },\n\n    register_events: function() {\n\n      var self = this;\n\n      self.controls.playbutton.on('click', function(e) {\n        if (!self.controls.hiddenplayer[0].paused) {\n          self.controls.hiddenplayer[0].pause();\n        }else {\n          self.controls.hiddenplayer[0].currentTime = self.currentAudioStart;\n          self.controls.hiddenplayer[0].play();\n        }\n      });\n\n      self.controls.playselfbutton.on('click',function(e){\n        if (!self.controls.hiddenselfplayer[0].paused) {\n          self.controls.hiddenselfplayer[0].pause();\n        }else {\n          self.controls.hiddenselfplayer.attr('src', self.ttr.audio.dataURI);\n          self.controls.hiddenselfplayer[0].play();\n        }\n      });\n\n      self.controls.skipbutton.on('click', function(e) {\n        self.controls.container.modal('hide');\n\n        //hide the self model player because when we show page again we dont want it enabled\n        self.controls.playselfbutton.hide();\n\n        //we might get here from a 100% score on final break on the modal (it calls the skip button\n        //so we check if its finished or not. Otherwise it will return to the first break and start playing\n        if(self.oldBreak.isfinalbreak) {\n          self.mak.controls.audioplayer[0].currentTime = 0;\n        }else{\n          if (self.controls.hiddenplayer[0].playing) {\n            self.controls.hiddenplayer[0].pause();\n          }\n          self.controls.hiddenplayer[0].currentTime = self.currentAudioStart;\n          //if the main page player has gone a bit forward, we can lose the first part of our next break, so we adjust that if we have to\n          //we dont want it hitting the same break repeatedly though, so we inc by .1 to get clear of that\n          log.debug('mak audio time', self.mak.get_audio_time());\n          log.debug('self current audio end', self.currentAudioEnd);\n          if(self.mak.get_audio_time() > self.currentAudioEnd+.1){\n            self.mak.set_audio_time(self.currentAudioEnd+.1);\n          }\n            self.mak.play_audio();\n        }\n      });\n\n      self.controls.finishedbutton.on('click', function() {\n        self.controls.container.modal('hide');\n        self.mak.controls.audioplayer[0].currentTime = 0;\n      });\n\n      self.controls.hiddenplayer[0].ontimeupdate = function() {\n        if (self.controls.hiddenplayer[0].currentTime >= self.currentAudioEnd) {\n          self.controls.hiddenplayer[0].pause();\n        }\n      };\n\n    },\n\n   // spliton: new RegExp('([,.!?:;\" ])', 'g'),\n      spliton: new RegExp(/([!\"# $%&'()。「」、*+,-.\\/:;<=>?@[\\]^_`{|}~])/, 'g'),\n\n    gotComparison: function(comparison, typed) {\n     if(!comparison){return;}\n      var self = this;\n      var thisClass;\n      var wordsmatched=0;\n      $(\".mod_readaloud_modal_target_word\").removeClass(\"mod_readaloud_modal_target_word_correct mod_readaloud_modal_target_word_incorrect\");\n\n      comparison.forEach(function(word, idx) {\n\n        if( word.matched) {\n            thisClass = \"mod_readaloud_modal_target_word_correct\" ;\n            wordsmatched++;\n        }else{\n            thisClass = \"mod_readaloud_modal_target_word_incorrect\";\n        }\n        $(\".mod_readaloud_modal_target_word[data-index='\" + idx + \"']\").addClass(thisClass);\n        if(comparison.length == wordsmatched){\n            setTimeout(function(){self.controls.skipbutton.trigger('click');},600);\n        }\n      });\n\n    },\n    getComparison: function(cmid, passage, transcript,passagephonetic, callback) {\n      var self = this;\n\n      ajax.call([{\n        methodname: 'mod_readaloud_compare_passage_to_transcript',\n        args: {\n          cmid: cmid,\n          passage: passage,\n          transcript: transcript,\n          passagephonetic: passagephonetic,\n          language: self.language\n        },\n        done: function(ajaxresult) {\n          var payloadobject = JSON.parse(ajaxresult);\n          if (payloadobject) {\n            callback(payloadobject);\n          } else {\n            callback(false);\n          }\n        },\n        fail: function(err) {\n          log.debug(err);\n        }\n      }]);\n\n    },\n\n      mobile_user: function() {\n\n          if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {\n              return true;\n          } else {\n              return false;\n          }\n      },\n\n      chrome_user: function(){\n          if(/Chrome/i.test(navigator.userAgent)) {\n              return true;\n          }else{\n              return false;\n          }\n      }\n  };\n});"],"file":"listenandrepeat.min.js"}