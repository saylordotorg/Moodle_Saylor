{"version":3,"sources":["../src/listenandrepeat.js"],"names":["define","$","log","ajax","def","cloudpoodll","ttrecorder","debug","activated","currentSentence","language","currentAudioStart","currentAudioStop","mak","controls","results","cmid","init","props","self","modelaudiokaraoke","region","theCallback","message","type","getComparison","capturedspeech","comparison","gotComparison","use_ttrecorder","clone","uniqueid","callback","prepare_controls","register_events","register_mak","activate","deactivate","audioplayer","playing","pause","container","landrcontainer","hiddenplayer","playbutton","skipbutton","finishedbutton","audiourl","fetch_audio_url","attr","on_reach_audio_break","sentence","oldbreak","newbreak","breaks","trim","audiotime","currentAudioEnd","breaknumber","length","show","hide","pause_audio","modal","html","split","map","e","i","on","currentTime","play","play_audio","ontimeupdate","spliton","thisClass","wordsmatched","removeClass","forEach","word","idx","matched","addClass","setTimeout","trigger","passage","transcript","call","methodname","args","done","ajaxresult","payloadobject","JSON","parse","fail","err","console","mobile_user","test","navigator","userAgent","chrome_user","ret"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log', 'core/ajax', 'mod_readaloud/definitions', 'mod_readaloud/cloudpoodllloader', 'mod_readaloud/ttrecorder'],\n    function($, log, ajax, def, cloudpoodll, ttrecorder) {\n  \"use strict\"; // jshint ;_;\n\n  log.debug('Readaloud listen and repeat: initialising');\n\n  return {\n\n    activated: false,\n    currentSentence: \"\",\n    language: \"en-US\",\n    currentAudioStart: 0,\n    currentAudioStop: 0,\n    mak: null,\n    controls: {},\n    results: [],\n    cmid: 0,\n\n    init: function(props) {\n\n      var self = this;\n      self.cmid = props.cmid;\n      self.mak = props.modelaudiokaraoke;\n      self.language = props.language;\n      self.region = props.region;\n\n      //recorder stuff\n      var recid = 'readaloud_pushrecorder';\n      var theCallback =function(message) {\n          switch (message.type) {\n              case 'recording':\n                  break;\n\n              case 'speech':\n                  self.getComparison(\n                      self.cmid,\n                      self.currentSentence,\n                      message.capturedspeech,\n                      function(comparison) {\n                          self.gotComparison(comparison, message);\n                      }\n                  );\n                  break;\n          }\n      };\n\n      if(self.use_ttrecorder()) {\n            //init tt recorder\n            var opts = {};\n            opts.uniqueid = recid;\n            opts.callback = theCallback;\n            ttrecorder.clone().init(opts);\n      }else{\n            //init cloudpoodll push recorder\n            cloudpoodll.init(recid, theCallback);\n      }\n\n\n\n      self.prepare_controls();\n      self.register_events();\n      self.register_mak();\n    },\n\n    activate: function() {\n      this.results = [];\n      this.activated = true;\n    },\n    deactivate: function() {\n      if (this.mak.controls.audioplayer[0].playing) {\n        this.mak.controls.audioplayer[0].pause();\n      }\n      this.activated = false;\n    },\n\n    prepare_controls: function() {\n      var self = this;\n      self.controls.container = $('#' + def.landrcontainer);\n      self.controls.hiddenplayer = $('#mod_readaloud_landr_hiddenplayer');\n      self.controls.playbutton = $('#mod_readaloud_landr_modalplay');\n      self.controls.skipbutton = $('#mod_readaloud_landr_modalskip');\n      self.controls.finishedbutton = $(\"#mod_readaloud_landr_modalfinished\");\n      self.audiourl = self.mak.fetch_audio_url();\n      self.controls.hiddenplayer.attr('src', self.audiourl);\n\n    },\n\n    register_mak: function() {\n      var self = this;\n\n      self.mak.on_reach_audio_break = function(sentence, oldbreak, newbreak, breaks) {\n        //do not get involved if we are not active\n        //model audio karaoke is used elsewhere (shadow and preview) as well\n        if (!self.activated) {\n          return;\n        }\n\n        // sentence contains the target text\n\n        //empty strings are none of our concern\n        if (sentence.trim() === '') {\n          return;\n        }\n\n        self.currentSentence = sentence;\n        self.currentAudioStart = oldbreak.audiotime;\n        self.currentAudioEnd = newbreak.audiotime;\n\n        log.debug(sentence);\n        log.debug(oldbreak);\n        log.debug(newbreak);\n\n        //pause audio while we do our thing\n        if (oldbreak.breaknumber == 0 && newbreak == false) {\n          // do nothing\n        } else {\n          // detect last line\n          if (newbreak.breaknumber == breaks[breaks.length - 1].breaknumber) {\n            self.controls.finishedbutton.show();\n            self.controls.skipbutton.hide();\n          } else {\n            self.controls.finishedbutton.hide();\n            self.controls.skipbutton.show();\n          }\n          self.mak.pause_audio();\n          self.controls.container.modal('show');\n          $(\"#mod_readaloud_modal_target_phrase\").html(sentence.split(/ /).map(function(e, i) {\n            return '<div class=\"mod_readaloud_modal_target_word\" data-index=\"' + i + '\">' + e + '</div>';\n          }));\n        }\n\n      }\n\n    },\n\n    register_events: function() {\n\n      var self = this;\n\n      self.controls.playbutton.on('click', function(e) {\n        self.controls.hiddenplayer[0].currentTime = self.currentAudioStart;\n        self.controls.hiddenplayer[0].play();\n      });\n\n      self.controls.skipbutton.on('click', function(e) {\n        self.controls.container.modal('hide');\n        if (self.controls.hiddenplayer[0].playing) {\n          self.controls.hiddenplayer[0].pause();\n        }\n        self.controls.hiddenplayer[0].currentTime = self.currentAudioStart;\n        self.mak.play_audio();\n      });\n\n      self.controls.finishedbutton.on('click', function() {\n        self.controls.container.modal('hide');\n        self.mak.controls.audioplayer[0].currentTime = 0;\n      });\n\n      self.controls.hiddenplayer[0].ontimeupdate = function() {\n        if (self.controls.hiddenplayer[0].currentTime >= self.currentAudioEnd) {\n          self.controls.hiddenplayer[0].pause();\n        }\n      };\n\n    },\n\n    spliton: new RegExp('([,.!?:;\" ])', 'g'),\n\n    gotComparison: function(comparison, typed) {\n     if(!comparison){return;}\n      var self = this;\n      var thisClass;\n      var wordsmatched=0;\n      $(\".mod_readaloud_modal_target_word\").removeClass(\"mod_readaloud_modal_target_word_correct mod_readaloud_modal_target_word_incorrect\");\n\n      comparison.forEach(function(word, idx) {\n\n        if( word.matched) {\n            thisClass = \"mod_readaloud_modal_target_word_correct\" ;\n            wordsmatched++;\n        }else{\n            thisClass = \"mod_readaloud_modal_target_word_incorrect\";\n        }\n        $(\".mod_readaloud_modal_target_word[data-index='\" + idx + \"']\").addClass(thisClass);\n        if(comparison.length == wordsmatched){\n            setTimeout(function(){self.controls.skipbutton.trigger('click')},600);\n        }\n      })\n\n    },\n    getComparison: function(cmid, passage, transcript, callback) {\n      var self = this;\n\n      ajax.call([{\n        methodname: 'mod_readaloud_compare_passage_to_transcript',\n        args: {\n          cmid: cmid,\n          passage: passage,\n          transcript: transcript,\n          language: self.language\n        },\n        done: function(ajaxresult) {\n          var payloadobject = JSON.parse(ajaxresult);\n          if (payloadobject) {\n            callback(payloadobject);\n          } else {\n            callback(false);\n          }\n        },\n        fail: function(err) {\n          console.log(err);\n        }\n      }]);\n\n    },\n\n      mobile_user: function() {\n\n          if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {\n              return true;\n          } else {\n              return false;\n          }\n      },\n\n      chrome_user: function(){\n          if(/Chrome/i.test(navigator.userAgent)) {\n              return true;\n          }else{\n              return false;\n          }\n      },\n\n      use_ttrecorder: function(){\n          var ret =false;\n\n\n          //check if language and region are ok\n          switch(this.region){\n              case 'tokyo':\n              case 'useast1':\n              case 'dublin':\n              case 'sydney':\n                  //ret = this.language.substr(0,2)==='en';\n                  ret =true;\n                  break;\n              default:\n                  ret = this.chrome_user();\n          }\n          return ret;\n      },\n\n\n  };\n});"],"file":"listenandrepeat.min.js"}