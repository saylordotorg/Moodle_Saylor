{"version":3,"file":"listenandrepeat.min.js","sources":["../src/listenandrepeat.js"],"sourcesContent":["define(['jquery', 'core/log', 'core/ajax', 'mod_readaloud/definitions', 'mod_readaloud/cloudpoodllloader', 'mod_readaloud/ttrecorder'],\n    function($, log, ajax, def, cloudpoodll, ttrecorder) {\n  \"use strict\"; // jshint ;_;\n\n  log.debug('Readaloud listen and repeat: initialising');\n\n  return {\n\n    activated: false,\n    currentSentence: \"\",\n    currentPhonetic: \"\",\n    language: \"en-US\",\n    currentAudioStart: 0,\n    currentAudioStop: 0,\n    oldBreak: {},\n    newBreak: {},\n    mak: null,\n    controls: {},\n    results: [],\n    phonetics: [],\n    cmid: 0,\n    ttr: {},\n\n    init: function(props) {\n\n      var self = this;\n      self.cmid = props.cmid;\n      self.mak = props.modelaudiokaraoke;\n      self.language = props.language;\n      self.region = props.region;\n      self.phonetics = props.phonetics;\n      self.ds_only = props.ds_only;\n      self.shadow = props.shadow;\n      self.ttr={};\n\n      //recorder stuff\n      var theCallback =function(message) {\n          switch (message.type) {\n            case 'recordingstarted':\n              if (self.shadow === true) {\n                self.controls.playbutton.trigger('click');\n              }\n              //hide the self model player (though it may not be here) because we do not want it playing old stuff into mic\n              self.controls.playselfbutton.hide();\n\n              break;\n\n            case 'recordingstopped':\n                  if (self.shadow === true){\n                    self.controls.hiddenplayer[0].pause();\n                  }\n                  if(self.ds_only || self.ttr.usebrowserrec===false){\n                    self.controls.playselfbutton.show();\n                  }\n                  break;\n\n              case 'speech':\n\n                  self.getComparison(\n                      self.cmid,\n                      self.currentSentence,\n                      message.capturedspeech,\n                      self.currentPhonetic,\n                      function(comparison) {\n                          self.gotComparison(comparison, message);\n                      }\n                  );\n                  break;\n          }\n      };\n\n        //init tt recorder\n      var opts = {};\n      opts.uniqueid = 'readaloud_ttrecorder';\n      opts.ds_only = self.ds_only;\n      opts.callback = theCallback;\n      opts.shadow = true;\n      self.ttr = ttrecorder.clone();\n      self.ttr.init(opts);\n\n\n      self.prepare_controls();\n      self.register_events();\n      self.register_mak();\n    },\n\n    activate: function() {\n      this.results = [];\n      this.activated = true;\n    },\n    deactivate: function() {\n      if (this.mak.controls.audioplayer[0].playing) {\n        this.mak.controls.audioplayer[0].pause();\n      }\n      this.activated = false;\n    },\n\n    prepare_controls: function() {\n      var self = this;\n      self.controls.container = $('#' + def.landrcontainer);\n      self.controls.hiddenplayer = $('#mod_readaloud_landr_hiddenplayer');\n      self.controls.hiddenselfplayer = $('#mod_readaloud_landr_hiddenselfplayer');\n      self.controls.playbutton = $('#mod_readaloud_landr_modalplay');\n      self.controls.shadowplaybutton = $('#mod_readaloud_landr_modalshadowplay');\n      self.controls.skipbutton = $('#mod_readaloud_landr_modalskip');\n      self.controls.finishedbutton = $(\"#mod_readaloud_landr_modalfinished\");\n      self.controls.playselfbutton = $(\"#mod_readaloud_landr_modalplayself\");\n      self.audiourl = self.mak.fetch_audio_url();\n      self.controls.hiddenplayer.attr('src', self.audiourl);\n\n    },\n\n    register_mak: function() {\n      var self = this;\n\n      self.mak.on_reach_audio_break = function(sentence, oldbreak, newbreak, breaks) {\n       // log.debug(breaks);\n        //do not get involved if we are not active\n        //model audio karaoke is used elsewhere (shadow and preview) as well\n        if (!self.activated) {\n          return;\n        }\n\n        // sentence contains the target text\n        //empty strings are none of our concern\n        if (sentence.trim() === '') {\n          return;\n        }\n\n        self.currentSentence = sentence;\n        self.oldBreak = oldbreak;\n        self.newBreak = newbreak;\n        self.currentAudioStart = oldbreak.audiotime;\n        self.currentAudioEnd = newbreak.audiotime;\n\n        if(self.currentAudioStart===self.currentAudioEnd){\n            //This is a special case where the end of the audio has been reached in MAK, and there is now no next break\n            self.currentAudioEnd=self.controls.hiddenplayer[0].duration;\n        }\n\n          if(self.phonetics.length>newbreak.wordnumber-1){\n              var startpos = oldbreak.wordnumber;\n              if(startpos<0){startpos=0;}\n              var endpos = newbreak.wordnumber;\n\n              /*\n              * break=0: wordnumber 0 start = 0, end = 9: jssplit returns 0-8\n              * break=1: wordnumber 9 start = 9, end = 18: jssplit returns 9-17\n              * break=2: wordnumber 18 start = 18, end = 99: jssplit returns 18-98\n               */\n              self.currentPhonetic = self.phonetics.slice(startpos,endpos).join(' ');\n          }else{\n              self.currentPhonetic  = '';\n          }\n\n        //pause audio while we do our thing\n        if (oldbreak.breaknumber == 0 && newbreak == false) {\n          // do nothing\n        } else {\n          // detect last line\n          if (oldbreak.breaknumber == breaks[breaks.length - 1].breaknumber) {\n            self.controls.finishedbutton.show();\n            self.controls.skipbutton.hide();\n            self.oldBreak.isfinalbreak=true\n          } else {\n            self.controls.finishedbutton.hide();\n            self.controls.skipbutton.show();\n          }\n          self.mak.pause_audio();\n          self.controls.container.modal('show');\n          $(\"#mod_readaloud_modal_target_phrase\").html(sentence.split(/ /).map(function(e, i) {\n            return '<div class=\"mod_readaloud_modal_target_word\" data-index=\"' + i + '\">' + e + '</div>';\n          }));\n        }\n\n      }\n\n    },\n\n    register_events: function() {\n\n      var self = this;\n\n      self.controls.playbutton.on('click', function(e) {\n        if (!self.controls.hiddenplayer[0].paused) {\n          self.controls.hiddenplayer[0].pause();\n        }else {\n          self.controls.hiddenplayer[0].currentTime = self.currentAudioStart;\n          self.controls.hiddenplayer[0].play();\n        }\n      });\n\n      self.controls.playselfbutton.on('click',function(e){\n        if (!self.controls.hiddenselfplayer[0].paused) {\n          self.controls.hiddenselfplayer[0].pause();\n        }else {\n          self.controls.hiddenselfplayer.attr('src', self.ttr.audio.dataURI);\n          self.controls.hiddenselfplayer[0].play();\n        }\n      });\n\n      self.controls.skipbutton.on('click', function(e) {\n        self.controls.container.modal('hide');\n\n        //hide the self model player because when we show page again we dont want it enabled\n        self.controls.playselfbutton.hide();\n\n        //we might get here from a 100% score on final break on the modal (it calls the skip button\n        //so we check if its finished or not. Otherwise it will return to the first break and start playing\n        if(self.oldBreak.isfinalbreak) {\n          self.mak.controls.audioplayer[0].currentTime = 0;\n        }else{\n          if (self.controls.hiddenplayer[0].playing) {\n            self.controls.hiddenplayer[0].pause();\n          }\n          self.controls.hiddenplayer[0].currentTime = self.currentAudioStart;\n          //if the main page player has gone a bit forward, we can lose the first part of our next break, so we adjust that if we have to\n          //we dont want it hitting the same break repeatedly though, so we inc by .1 to get clear of that\n          log.debug('mak audio time', self.mak.get_audio_time());\n          log.debug('self current audio end', self.currentAudioEnd);\n          if(self.mak.get_audio_time() > self.currentAudioEnd+.1){\n            self.mak.set_audio_time(self.currentAudioEnd+.1)\n          }\n            self.mak.play_audio();\n        }\n      });\n\n      self.controls.finishedbutton.on('click', function() {\n        self.controls.container.modal('hide');\n        self.mak.controls.audioplayer[0].currentTime = 0;\n      });\n\n      self.controls.hiddenplayer[0].ontimeupdate = function() {\n        if (self.controls.hiddenplayer[0].currentTime >= self.currentAudioEnd) {\n          self.controls.hiddenplayer[0].pause();\n        }\n      };\n\n    },\n\n   // spliton: new RegExp('([,.!?:;\" ])', 'g'),\n      spliton: new RegExp(/([!\"# $%&'()。「」、*+,-.\\/:;<=>?@[\\]^_`{|}~])/, 'g'),\n\n    gotComparison: function(comparison, typed) {\n     if(!comparison){return;}\n      var self = this;\n      var thisClass;\n      var wordsmatched=0;\n      $(\".mod_readaloud_modal_target_word\").removeClass(\"mod_readaloud_modal_target_word_correct mod_readaloud_modal_target_word_incorrect\");\n\n      comparison.forEach(function(word, idx) {\n\n        if( word.matched) {\n            thisClass = \"mod_readaloud_modal_target_word_correct\" ;\n            wordsmatched++;\n        }else{\n            thisClass = \"mod_readaloud_modal_target_word_incorrect\";\n        }\n        $(\".mod_readaloud_modal_target_word[data-index='\" + idx + \"']\").addClass(thisClass);\n        if(comparison.length == wordsmatched){\n            setTimeout(function(){self.controls.skipbutton.trigger('click')},600);\n        }\n      })\n\n    },\n    getComparison: function(cmid, passage, transcript,passagephonetic, callback) {\n      var self = this;\n\n      ajax.call([{\n        methodname: 'mod_readaloud_compare_passage_to_transcript',\n        args: {\n          cmid: cmid,\n          passage: passage,\n          transcript: transcript,\n          passagephonetic: passagephonetic,\n          language: self.language\n        },\n        done: function(ajaxresult) {\n          var payloadobject = JSON.parse(ajaxresult);\n          if (payloadobject) {\n            callback(payloadobject);\n          } else {\n            callback(false);\n          }\n        },\n        fail: function(err) {\n          console.log(err);\n        }\n      }]);\n\n    },\n\n      mobile_user: function() {\n\n          if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {\n              return true;\n          } else {\n              return false;\n          }\n      },\n\n      chrome_user: function(){\n          if(/Chrome/i.test(navigator.userAgent)) {\n              return true;\n          }else{\n              return false;\n          }\n      }\n  };\n});"],"names":["define","$","log","ajax","def","cloudpoodll","ttrecorder","debug","activated","currentSentence","currentPhonetic","language","currentAudioStart","currentAudioStop","oldBreak","newBreak","mak","controls","results","phonetics","cmid","ttr","init","props","self","this","modelaudiokaraoke","region","ds_only","shadow","opts","callback","message","type","playbutton","trigger","playselfbutton","hide","hiddenplayer","pause","usebrowserrec","show","getComparison","capturedspeech","comparison","gotComparison","clone","prepare_controls","register_events","register_mak","activate","deactivate","audioplayer","playing","container","landrcontainer","hiddenselfplayer","shadowplaybutton","skipbutton","finishedbutton","audiourl","fetch_audio_url","attr","on_reach_audio_break","sentence","oldbreak","newbreak","breaks","trim","audiotime","currentAudioEnd","duration","length","wordnumber","startpos","endpos","slice","join","breaknumber","isfinalbreak","pause_audio","modal","html","split","map","e","i","on","paused","currentTime","play","audio","dataURI","get_audio_time","set_audio_time","play_audio","ontimeupdate","spliton","RegExp","typed","thisClass","wordsmatched","removeClass","forEach","word","idx","matched","addClass","setTimeout","passage","transcript","passagephonetic","call","methodname","args","done","ajaxresult","payloadobject","JSON","parse","fail","err","console","mobile_user","test","navigator","userAgent","chrome_user"],"mappings":"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"}