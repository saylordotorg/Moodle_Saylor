define(["jquery","core/log","core/ajax","mod_readaloud/definitions","mod_readaloud/cloudpoodllloader","mod_readaloud/ttrecorder"],function(a,b,c,d,e,f){"use strict";b.debug("Readaloud listen and repeat: initialising");return{activated:!1,currentSentence:"",currentPhonetic:"",language:"en-US",currentAudioStart:0,currentAudioStop:0,oldBreak:{},newBreak:{},mak:null,controls:{},results:[],phonetics:[],cmid:0,ttr:{},init:function init(a){var c=this;c.cmid=a.cmid;c.mak=a.modelaudiokaraoke;c.language=a.language;c.region=a.region;c.phonetics=a.phonetics;c.stt_guided=a.stt_guided;c.shadow=!1;c.ttr={};var d={};d.uniqueid="readaloud_ttrecorder";d.stt_guided=c.stt_guided;d.callback=function theCallback(a){switch(a.type){case"recordingstarted":if(c.controls.shadowplaycheckbox.is(":checked")){c.shadow=!0;b.debug("shadow is true");c.controls.playbutton.trigger("click")}else{b.debug("shadow is false");c.shadow=!1}c.controls.playselfbutton.hide();break;case"recordingstopped":if(!0===c.shadow){c.controls.hiddenplayer[0].pause()}if(c.stt_guided||!1===c.ttr.usebrowserrec){c.controls.playselfbutton.show()}break;case"speech":c.getComparison(c.cmid,c.currentSentence,a.capturedspeech,c.currentPhonetic,function(b){c.gotComparison(b,a)});break;}};d.shadow=!0;c.ttr=f.clone();c.ttr.init(d);c.prepare_controls();c.register_events();c.register_mak()},activate:function activate(){this.results=[];this.activated=!0},deactivate:function deactivate(){if(this.mak.controls.audioplayer[0].playing){this.mak.controls.audioplayer[0].pause()}this.activated=!1},prepare_controls:function prepare_controls(){var b=this;b.controls.container=a("#"+d.landrcontainer);b.controls.hiddenplayer=a("#mod_readaloud_landr_hiddenplayer");b.controls.hiddenselfplayer=a("#mod_readaloud_landr_hiddenselfplayer");b.controls.playbutton=a("#mod_readaloud_landr_modalplay");b.controls.shadowplaycheckbox=a("#mod_readaloud_landr_shadow");b.controls.skipbutton=a("#mod_readaloud_landr_modalskip");b.controls.finishedbutton=a("#mod_readaloud_landr_modalfinished");b.controls.playselfbutton=a("#mod_readaloud_landr_modalplayself");b.audiourl=b.mak.fetch_audio_url();b.controls.hiddenplayer.attr("src",b.audiourl)},register_mak:function register_mak(){var b=this;b.mak.on_reach_audio_break=function(c,d,e,f){if(!b.activated){return}if(""===c.trim()){return}b.currentSentence=c;b.oldBreak=d;b.newBreak=e;b.currentAudioStart=d.audiotime;b.currentAudioEnd=e.audiotime;if(b.currentAudioStart===b.currentAudioEnd){b.currentAudioEnd=b.controls.hiddenplayer[0].duration}if(b.phonetics.length>e.wordnumber-1){var g=d.wordnumber;if(0>g){g=0}var h=e.wordnumber;b.currentPhonetic=b.phonetics.slice(g,h).join(" ")}else{b.currentPhonetic=""}if(!(0==d.breaknumber&&!1==e)){if(d.breaknumber==f[f.length-1].breaknumber){b.controls.finishedbutton.show();b.controls.skipbutton.hide();b.oldBreak.isfinalbreak=!0}else{b.controls.finishedbutton.hide();b.controls.skipbutton.show()}b.mak.pause_audio();b.controls.container.modal("show");a("#mod_readaloud_modal_target_phrase").html(c.split(/ /).map(function(a,b){return"<div class=\"mod_readaloud_modal_target_word\" data-index=\""+b+"\">"+a+"</div>"}))}}},register_events:function register_events(){var a=this;a.controls.playbutton.on("click",function(){if(!a.controls.hiddenplayer[0].paused){a.controls.hiddenplayer[0].pause()}else{a.controls.hiddenplayer[0].currentTime=a.currentAudioStart;a.controls.hiddenplayer[0].play()}});a.controls.playselfbutton.on("click",function(){if(!a.controls.hiddenselfplayer[0].paused){a.controls.hiddenselfplayer[0].pause()}else{a.controls.hiddenselfplayer.attr("src",a.ttr.audio.dataURI);a.controls.hiddenselfplayer[0].play()}});a.controls.skipbutton.on("click",function(){a.controls.container.modal("hide");a.controls.playselfbutton.hide();if(a.oldBreak.isfinalbreak){a.mak.controls.audioplayer[0].currentTime=0}else{if(a.controls.hiddenplayer[0].playing){a.controls.hiddenplayer[0].pause()}a.controls.hiddenplayer[0].currentTime=a.currentAudioStart;b.debug("mak audio time",a.mak.get_audio_time());b.debug("self current audio end",a.currentAudioEnd);if(a.mak.get_audio_time()>a.currentAudioEnd+.1){a.mak.set_audio_time(a.currentAudioEnd+.1)}a.mak.play_audio()}});a.controls.finishedbutton.on("click",function(){a.controls.container.modal("hide");a.mak.controls.audioplayer[0].currentTime=0});a.controls.hiddenplayer[0].ontimeupdate=function(){if(a.controls.hiddenplayer[0].currentTime>=a.currentAudioEnd){a.controls.hiddenplayer[0].pause()}}},spliton:new RegExp(/([!"# $%&'()。「」、*+,-.\/:;<=>?@[\]^_`{|}~])/,"g"),gotComparison:function gotComparison(b){if(!b){return}var c=this,d,e=0;a(".mod_readaloud_modal_target_word").removeClass("mod_readaloud_modal_target_word_correct mod_readaloud_modal_target_word_incorrect");b.forEach(function(f,g){if(f.matched){d="mod_readaloud_modal_target_word_correct";e++}else{d="mod_readaloud_modal_target_word_incorrect"}a(".mod_readaloud_modal_target_word[data-index='"+g+"']").addClass(d);if(b.length==e){setTimeout(function(){c.controls.skipbutton.trigger("click")},600)}})},getComparison:function getComparison(a,d,e,f,g){var h=this;c.call([{methodname:"mod_readaloud_compare_passage_to_transcript",args:{cmid:a,passage:d,transcript:e,passagephonetic:f,language:h.language},done:function done(a){var b=JSON.parse(a);if(b){g(b)}else{g(!1)}},fail:function fail(a){b.debug(a)}}])},mobile_user:function mobile_user(){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){return!0}else{return!1}},chrome_user:function chrome_user(){if(/Chrome/i.test(navigator.userAgent)){return!0}else{return!1}}}});
//# sourceMappingURL=listenandrepeat.min.js.map
