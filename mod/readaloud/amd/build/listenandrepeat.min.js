define("mod_readaloud/listenandrepeat",["jquery","core/log","core/ajax","mod_readaloud/definitions","mod_readaloud/cloudpoodllloader","mod_readaloud/ttrecorder"],(function($,log,ajax,def,cloudpoodll,ttrecorder){return log.debug("Readaloud listen and repeat: initialising"),{activated:!1,currentSentence:"",currentPhonetic:"",language:"en-US",currentAudioStart:0,currentAudioStop:0,oldBreak:{},newBreak:{},mak:null,controls:{},results:[],phonetics:[],cmid:0,ttr:{},init:function(props){var self=this;self.cmid=props.cmid,self.mak=props.modelaudiokaraoke,self.language=props.language,self.region=props.region,self.phonetics=props.phonetics,self.ds_only=props.ds_only,self.shadow=props.shadow,self.ttr={};var opts={uniqueid:"readaloud_ttrecorder"};opts.ds_only=self.ds_only,opts.callback=function(message){switch(message.type){case"recordingstarted":!0===self.shadow&&self.controls.playbutton.trigger("click"),self.controls.playselfbutton.hide();break;case"recordingstopped":!0===self.shadow&&self.controls.hiddenplayer[0].pause(),(self.ds_only||!1===self.ttr.usebrowserrec)&&self.controls.playselfbutton.show();break;case"speech":self.getComparison(self.cmid,self.currentSentence,message.capturedspeech,self.currentPhonetic,(function(comparison){self.gotComparison(comparison,message)}))}},opts.shadow=!0,self.ttr=ttrecorder.clone(),self.ttr.init(opts),self.prepare_controls(),self.register_events(),self.register_mak()},activate:function(){this.results=[],this.activated=!0},deactivate:function(){this.mak.controls.audioplayer[0].playing&&this.mak.controls.audioplayer[0].pause(),this.activated=!1},prepare_controls:function(){this.controls.container=$("#"+def.landrcontainer),this.controls.hiddenplayer=$("#mod_readaloud_landr_hiddenplayer"),this.controls.hiddenselfplayer=$("#mod_readaloud_landr_hiddenselfplayer"),this.controls.playbutton=$("#mod_readaloud_landr_modalplay"),this.controls.shadowplaybutton=$("#mod_readaloud_landr_modalshadowplay"),this.controls.skipbutton=$("#mod_readaloud_landr_modalskip"),this.controls.finishedbutton=$("#mod_readaloud_landr_modalfinished"),this.controls.playselfbutton=$("#mod_readaloud_landr_modalplayself"),this.audiourl=this.mak.fetch_audio_url(),this.controls.hiddenplayer.attr("src",this.audiourl)},register_mak:function(){var self=this;self.mak.on_reach_audio_break=function(sentence,oldbreak,newbreak,breaks){if(self.activated&&""!==sentence.trim()){if(self.currentSentence=sentence,self.oldBreak=oldbreak,self.newBreak=newbreak,self.currentAudioStart=oldbreak.audiotime,self.currentAudioEnd=newbreak.audiotime,self.currentAudioStart===self.currentAudioEnd&&(self.currentAudioEnd=self.controls.hiddenplayer[0].duration),self.phonetics.length>newbreak.wordnumber-1){var startpos=oldbreak.wordnumber;startpos<0&&(startpos=0);var endpos=newbreak.wordnumber;self.currentPhonetic=self.phonetics.slice(startpos,endpos).join(" ")}else self.currentPhonetic="";0==oldbreak.breaknumber&&0==newbreak||(oldbreak.breaknumber==breaks[breaks.length-1].breaknumber?(self.controls.finishedbutton.show(),self.controls.skipbutton.hide(),self.oldBreak.isfinalbreak=!0):(self.controls.finishedbutton.hide(),self.controls.skipbutton.show()),self.mak.pause_audio(),self.controls.container.modal("show"),$("#mod_readaloud_modal_target_phrase").html(sentence.split(/ /).map((function(e,i){return'<div class="mod_readaloud_modal_target_word" data-index="'+i+'">'+e+"</div>"}))))}}},register_events:function(){var self=this;self.controls.playbutton.on("click",(function(e){self.controls.hiddenplayer[0].paused?(self.controls.hiddenplayer[0].currentTime=self.currentAudioStart,self.controls.hiddenplayer[0].play()):self.controls.hiddenplayer[0].pause()})),self.controls.playselfbutton.on("click",(function(e){self.controls.hiddenselfplayer[0].paused?(self.controls.hiddenselfplayer.attr("src",self.ttr.audio.dataURI),self.controls.hiddenselfplayer[0].play()):self.controls.hiddenselfplayer[0].pause()})),self.controls.skipbutton.on("click",(function(e){self.controls.container.modal("hide"),self.controls.playselfbutton.hide(),self.oldBreak.isfinalbreak?self.mak.controls.audioplayer[0].currentTime=0:(self.controls.hiddenplayer[0].playing&&self.controls.hiddenplayer[0].pause(),self.controls.hiddenplayer[0].currentTime=self.currentAudioStart,log.debug("mak audio time",self.mak.get_audio_time()),log.debug("self current audio end",self.currentAudioEnd),self.mak.get_audio_time()>self.currentAudioEnd+.1&&self.mak.set_audio_time(self.currentAudioEnd+.1),self.mak.play_audio())})),self.controls.finishedbutton.on("click",(function(){self.controls.container.modal("hide"),self.mak.controls.audioplayer[0].currentTime=0})),self.controls.hiddenplayer[0].ontimeupdate=function(){self.controls.hiddenplayer[0].currentTime>=self.currentAudioEnd&&self.controls.hiddenplayer[0].pause()}},spliton:new RegExp(/([!"# $%&'()。「」、*+,-.\/:;<=>?@[\]^_`{|}~])/,"g"),gotComparison:function(comparison,typed){if(comparison){var thisClass,self=this,wordsmatched=0;$(".mod_readaloud_modal_target_word").removeClass("mod_readaloud_modal_target_word_correct mod_readaloud_modal_target_word_incorrect"),comparison.forEach((function(word,idx){word.matched?(thisClass="mod_readaloud_modal_target_word_correct",wordsmatched++):thisClass="mod_readaloud_modal_target_word_incorrect",$(".mod_readaloud_modal_target_word[data-index='"+idx+"']").addClass(thisClass),comparison.length==wordsmatched&&setTimeout((function(){self.controls.skipbutton.trigger("click")}),600)}))}},getComparison:function(cmid,passage,transcript,passagephonetic,callback){ajax.call([{methodname:"mod_readaloud_compare_passage_to_transcript",args:{cmid:cmid,passage:passage,transcript:transcript,passagephonetic:passagephonetic,language:this.language},done:function(ajaxresult){var payloadobject=JSON.parse(ajaxresult);callback(payloadobject||!1)},fail:function(err){console.log(err)}}])},mobile_user:function(){return!!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},chrome_user:function(){return!!/Chrome/i.test(navigator.userAgent)}}}));

//# sourceMappingURL=listenandrepeat.min.js.map