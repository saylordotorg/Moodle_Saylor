define ("mod_readaloud/listenandrepeat",["jquery","core/log","core/ajax","mod_readaloud/definitions","mod_readaloud/cloudpoodllloader","mod_readaloud/ttrecorder"],function(a,b,c,d,e,f){"use strict";b.debug("Readaloud listen and repeat: initialising");return{activated:!1,currentSentence:"",language:"en-US",currentAudioStart:0,currentAudioStop:0,mak:null,controls:{},results:[],cmid:0,init:function init(a){var b=this;b.cmid=a.cmid;b.mak=a.modelaudiokaraoke;b.language=a.language;b.region=a.region;var c=function(a){switch(a.type){case"recording":break;case"speech":b.getComparison(b.cmid,b.currentSentence,a.capturedspeech,function(c){b.gotComparison(c,a)});break;}};if(b.use_ttrecorder()){f.clone().init({uniqueid:"readaloud_pushrecorder",callback:c})}else{e.init("readaloud_pushrecorder",c)}b.prepare_controls();b.register_events();b.register_mak()},activate:function activate(){this.results=[];this.activated=!0},deactivate:function deactivate(){if(this.mak.controls.audioplayer[0].playing){this.mak.controls.audioplayer[0].pause()}this.activated=!1},prepare_controls:function prepare_controls(){var b=this;b.controls.container=a("#"+d.landrcontainer);b.controls.hiddenplayer=a("#mod_readaloud_landr_hiddenplayer");b.controls.playbutton=a("#mod_readaloud_landr_modalplay");b.controls.skipbutton=a("#mod_readaloud_landr_modalskip");b.controls.finishedbutton=a("#mod_readaloud_landr_modalfinished");b.audiourl=b.mak.fetch_audio_url();b.controls.hiddenplayer.attr("src",b.audiourl)},register_mak:function register_mak(){var c=this;c.mak.on_reach_audio_break=function(d,e,f,g){if(!c.activated){return}if(""===d.trim()){return}c.currentSentence=d;c.currentAudioStart=e.audiotime;c.currentAudioEnd=f.audiotime;b.debug(d);b.debug(e);b.debug(f);if(!(0==e.breaknumber&&!1==f)){if(f.breaknumber==g[g.length-1].breaknumber){c.controls.finishedbutton.show();c.controls.skipbutton.hide()}else{c.controls.finishedbutton.hide();c.controls.skipbutton.show()}c.mak.pause_audio();c.controls.container.modal("show");a("#mod_readaloud_modal_target_phrase").html(d.split(/ /).map(function(a,b){return"<div class=\"mod_readaloud_modal_target_word\" data-index=\""+b+"\">"+a+"</div>"}))}}},register_events:function register_events(){var a=this;a.controls.playbutton.on("click",function(){a.controls.hiddenplayer[0].currentTime=a.currentAudioStart;a.controls.hiddenplayer[0].play()});a.controls.skipbutton.on("click",function(){a.controls.container.modal("hide");if(a.controls.hiddenplayer[0].playing){a.controls.hiddenplayer[0].pause()}a.controls.hiddenplayer[0].currentTime=a.currentAudioStart;a.mak.play_audio()});a.controls.finishedbutton.on("click",function(){a.controls.container.modal("hide");a.mak.controls.audioplayer[0].currentTime=0});a.controls.hiddenplayer[0].ontimeupdate=function(){if(a.controls.hiddenplayer[0].currentTime>=a.currentAudioEnd){a.controls.hiddenplayer[0].pause()}}},spliton:/([,.!?:;" ])/g,gotComparison:function gotComparison(b){if(!b){return}var c=this,d,e=0;a(".mod_readaloud_modal_target_word").removeClass("mod_readaloud_modal_target_word_correct mod_readaloud_modal_target_word_incorrect");b.forEach(function(f,g){if(f.matched){d="mod_readaloud_modal_target_word_correct";e++}else{d="mod_readaloud_modal_target_word_incorrect"}a(".mod_readaloud_modal_target_word[data-index='"+g+"']").addClass(d);if(b.length==e){setTimeout(function(){c.controls.skipbutton.trigger("click")},600)}})},getComparison:function getComparison(a,b,d,e){var f=this;c.call([{methodname:"mod_readaloud_compare_passage_to_transcript",args:{cmid:a,passage:b,transcript:d,language:f.language},done:function done(a){var b=JSON.parse(a);if(b){e(b)}else{e(!1)}},fail:function fail(a){console.log(a)}}])},mobile_user:function mobile_user(){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){return!0}else{return!1}},chrome_user:function chrome_user(){if(/Chrome/i.test(navigator.userAgent)){return!0}else{return!1}},use_ttrecorder:function use_ttrecorder(){var a=!1;switch(this.region){case"tokyo":case"useast1":case"dublin":case"sydney":a=!0;break;default:a=this.chrome_user();}return a}}});
//# sourceMappingURL=listenandrepeat.min.js.map
