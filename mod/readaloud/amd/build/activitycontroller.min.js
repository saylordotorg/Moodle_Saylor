define("mod_readaloud/activitycontroller",["jquery","jqueryui","core/log","mod_readaloud/definitions","mod_readaloud/recorderhelper","mod_readaloud/modelaudiokaraoke","core/ajax","core/notification","mod_readaloud/smallreporthelper","mod_readaloud/listenandrepeat"],(function($,jqui,log,def,recorderhelper,modelaudiokaraoke,Ajax,notification,smallreporthelper,landr){return log.debug("Activity controller: initialising"),{cmid:null,activitydata:null,holderid:null,recorderid:null,playerid:null,sorryboxid:null,controls:null,ra_recorder:null,rec_time_start:0,enableshadow:!1,enablepreview:!1,enablelandr:!1,letsshadow:!1,passagefinished:def.passagefinished,clone:function(){return $.extend(!0,{},this)},init:function(props){var dd=this.clone(),theid="#amdopts_"+props.widgetid,configcontrol=$(theid).get(0);configcontrol?(dd.activitydata=JSON.parse(configcontrol.value),$(theid).remove(),dd.cmid=props.cmid,dd.holderid=props.widgetid+"_holder",dd.recorderid=props.widgetid+"_recorder",dd.playerid=props.widgetid+"_player",dd.sorryboxid=props.widgetid+"_sorrybox",dd.is_browser_ok()?(dd.enableshadow=dd.activitydata.enableshadow,dd.enablepreview=dd.activitydata.enablepreview,dd.enablelandr=dd.activitydata.enablelandr,dd.setupmodelaudio(),dd.setuplandr(),dd.setup_recorder(),dd.process_html(dd.activitydata),dd.register_events(),dd.enableshadow||dd.enablepreview,dd.domenulayout()):$("#"+dd.sorryboxid).show()):log.debug("Read Aloud Test Controller: No config found on page. Giving up.")},setupmodelaudio:function(){var karaoke_opts={breaks:this.activitydata.breaks,audioplayerclass:this.activitydata.audioplayerclass};modelaudiokaraoke.init(karaoke_opts)},setuplandr:function(){var landr_opts={modelaudiokaraoke:modelaudiokaraoke,cmid:this.cmid,language:this.activitydata.language,region:this.activitydata.region,phonetics:this.activitydata.phonetics,stt_guided:this.activitydata.stt_guided};landr.init(landr_opts)},process_html:function(opts){var controls={hider:$("."+opts.hider),introbox:$(".mod_intro_box"),progresscontainer:$("."+opts.progresscontainer),feedbackcontainer:$("."+opts.feedbackcontainer),errorcontainer:$("."+opts.errorcontainer),passagecontainer:$("."+opts.passagecontainer),recordingcontainer:$("."+opts.recordingcontainer),dummyrecorder:$("."+opts.dummyrecorder),recordercontainer:$("."+opts.recordercontainer),menubuttonscontainer:$("."+opts.menubuttonscontainer),menuinstructionscontainer:$("."+opts.menuinstructionscontainer),previewinstructionscontainer:$("."+opts.previewinstructionscontainer),landrinstructionscontainer:$("."+opts.landrinstructionscontainer),activityinstructionscontainer:$("."+opts.activityinstructionscontainer),recinstructionscontainerright:$("."+opts.recinstructionscontainerright),recinstructionscontainerleft:$("."+opts.recinstructionscontainerleft),allowearlyexit:$("."+opts.allowearlyexit),wheretonextcontainer:$("."+opts.wheretonextcontainer),modelaudioplayer:$("#"+opts.modelaudioplayer),startlandrbutton:$("#"+opts.startlandrbutton),startpreviewbutton:$("#"+opts.startpreviewbutton),startreadingbutton:$("#"+opts.startreadingbutton),startshadowbutton:$("#"+opts.startshadowbutton),returnmenubutton:$("#"+opts.returnmenubutton),stopandplay:$("#"+opts.stopandplay),smallreportcontainer:$("."+opts.smallreportcontainer)};this.controls=controls},is_browser_ok:function(){return navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},setup_recorder:function(){var dd=this,beginall=function(){dd.passagerecorded=!0,dd.enableshadow&&dd.letsshadow&&dd.controls.modelaudioplayer[0].play()};recorderhelper.init(dd.activitydata,(function(eventdata){dd.rec_time_start=(new Date).getTime(),dd.dopassagelayout(),dd.controls.passagecontainer.show(1e3,beginall)}),(function(eventdata){(new Date).getTime()-dd.rec_time_start<3e3||(dd.douploadlayout(),dd.enableshadow&&dd.letsshadow&&(dd.controls.modelaudioplayer[0].currentTime=0,dd.controls.modelaudioplayer[0].pause()))}),(function(eventdata){var rectime=(new Date).getTime()-dd.rec_time_start;rectime>0&&(rectime=Math.ceil(rectime/1e3)),dd.send_submission(eventdata.mediaurl,rectime),dd.dofinishedlayout()}),(function(eventdata){eventdata.capturedspeech,eventdata.speechresults}))},register_events:function(){var dd=this;dd.controls.startpreviewbutton.click((function(e){dd.dopreviewlayout()})),dd.controls.startpreviewbutton.keypress((function(e){32!=e.which&&13!=e.which||(dd.dopreviewlayout(),e.preventDefault())})),dd.controls.startlandrbutton.click((function(e){dd.dolandrlayout()})),dd.controls.startlandrbutton.keypress((function(e){32!=e.which&&13!=e.which||(dd.dolandrlayout(),e.preventDefault())})),dd.controls.startreadingbutton.click((function(e){dd.letsshadow=!1,dd.doreadinglayout()})),dd.controls.startreadingbutton.keypress((function(e){32!=e.which&&13!=e.which||(dd.letsshadow=!1,dd.doreadinglayout(),e.preventDefault())})),dd.controls.startshadowbutton.click((function(e){dd.letsshadow=!0,dd.doreadinglayout()})),dd.controls.startshadowbutton.keypress((function(e){32!=e.which&&13!=e.which||(dd.letsshadow=!0,dd.doreadinglayout(),e.preventDefault())})),dd.controls.returnmenubutton.click((function(e){dd.isandroid()&&dd.controls.landrinstructionscontainer.is(":visible")?location.reload():(dd.controls.modelaudioplayer[0].currentTime=0,dd.controls.modelaudioplayer[0].pause(),dd.domenulayout())}))},send_submission:function(filename,rectime){var shadowing=this.enableshadow&&this.letsshadow?1:0;Ajax.call([{methodname:"mod_readaloud_submit_regular_attempt",args:{cmid:this.cmid,filename:filename,rectime:rectime,shadowing:shadowing},done:function(ajaxresult){var payloadobject=JSON.parse(ajaxresult);if(payloadobject)if(!0===payloadobject.success)log.debug("attempted submission accepted");else log.debug("attempted item evaluation failure"),payloadobject.message&&log.debug("message: "+payloadobject.message)},fail:notification.exception}])},doreadinglayout:function(){var m=this;m.controls.hider.fadeOut("fast"),m.controls.activityinstructionscontainer.show(),m.controls.recordingcontainer.show(),m.controls.introbox.hide(),m.controls.menuinstructionscontainer.hide(),m.controls.menubuttonscontainer.hide(),m.controls.smallreportcontainer.hide(),m.controls.returnmenubutton.show(),m.controls.progresscontainer.hide(),m.controls.passagecontainer.removeClass("previewmode shadowmode reviewmode nothingmode"),m.controls.passagecontainer.addClass("readmode"),m.controls.passagecontainer.hide(),m.controls.feedbackcontainer.hide(),m.controls.wheretonextcontainer.hide(),m.controls.stopandplay.hide()},domenulayout:function(){var m=this;m.controls.introbox.show(),m.controls.menuinstructionscontainer.show(),m.controls.menubuttonscontainer.show(),m.controls.smallreportcontainer.show(),m.controls.activityinstructionscontainer.hide(),m.controls.returnmenubutton.hide(),m.controls.previewinstructionscontainer.hide(),m.controls.landrinstructionscontainer.hide(),landr.deactivate(),m.controls.progresscontainer.hide(),m.controls.passagecontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.feedbackcontainer.hide(),m.controls.wheretonextcontainer.hide(),m.controls.modelaudioplayer.hide(),m.controls.hider.hide(),m.controls.stopandplay.hide()},dopreviewlayout:function(){var m=this;m.controls.passagecontainer.removeClass("readmode shadowmode reviewmode nothingmode"),m.controls.passagecontainer.addClass("previewmode"),m.controls.passagecontainer.show(),m.controls.previewinstructionscontainer.show(),m.controls.landrinstructionscontainer.hide(),m.controls.introbox.hide(),m.controls.returnmenubutton.show(),m.controls.modelaudioplayer.hide(),m.controls.smallreportcontainer.hide(),m.controls.stopandplay.show(),m.controls.menubuttonscontainer.hide(),m.controls.hider.hide(),m.controls.progresscontainer.hide(),m.controls.menuinstructionscontainer.hide(),m.controls.activityinstructionscontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.feedbackcontainer.hide(),m.controls.wheretonextcontainer.hide(),m.controls.stopandplay.show()},dolandrlayout:function(){var m=this;m.controls.passagecontainer.removeClass("readmode shadowmode reviewmode nothingmode"),m.controls.passagecontainer.addClass("previewmode"),m.controls.passagecontainer.show(),m.controls.landrinstructionscontainer.show(),m.controls.previewinstructionscontainer.hide(),m.controls.introbox.hide(),m.controls.returnmenubutton.show(),m.controls.modelaudioplayer.hide(),m.controls.smallreportcontainer.hide(),m.controls.stopandplay.show(),m.controls.menubuttonscontainer.hide(),m.controls.hider.hide(),m.controls.progresscontainer.hide(),m.controls.menuinstructionscontainer.hide(),m.controls.activityinstructionscontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.feedbackcontainer.hide(),m.controls.wheretonextcontainer.hide(),m.controls.stopandplay.show(),landr.activate()},dopassagelayout:function(){this.controls.introbox.hide()},douploadlayout:function(){var m=this;m.controls.passagecontainer.addClass(m.passagefinished),m.controls.hider.fadeIn("fast"),m.controls.progresscontainer.fadeIn("fast")},dofinishedlayout:function(){var m=this;m.controls.hider.fadeOut("fast"),m.controls.progresscontainer.fadeOut("fast"),m.controls.smallreportcontainer.hide(),m.controls.activityinstructionscontainer.hide(),m.controls.passagecontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.feedbackcontainer.show(),m.controls.wheretonextcontainer.show(),m.controls.returnmenubutton.hide()},doerrorlayout:function(){var m=this;m.controls.hider.fadeOut("fast"),m.controls.progresscontainer.fadeOut("fast"),m.controls.passagecontainer.hide(),m.controls.recordingcontainer.hide(),m.controls.errorcontainer.show(),m.controls.wheretonextcontainer.show()},isandroid:function(){return!!/Android/i.test(navigator.userAgent)}}}));

//# sourceMappingURL=activitycontroller.min.js.map