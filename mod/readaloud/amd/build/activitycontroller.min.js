define ("mod_readaloud/activitycontroller",["jquery","jqueryui","core/log","mod_readaloud/definitions","mod_readaloud/recorderhelper","mod_readaloud/modelaudiokaraoke","core/ajax","core/notification","mod_readaloud/smallreporthelper","mod_readaloud/listenandrepeat"],function(a,b,c,d,e,f,g,h,i,j){"use strict";c.debug("Activity controller: initialising");return{cmid:null,activitydata:null,holderid:null,recorderid:null,playerid:null,sorryboxid:null,controls:null,ra_recorder:null,rec_time_start:0,enableshadow:!1,enablepreview:!1,enablelandr:!1,letsshadow:!1,streamingresults:!1,passagefinished:d.passagefinished,clone:function clone(){return a.extend(!0,{},this)},init:function init(b){var d=this.clone(),e="#amdopts_"+b.widgetid,f=a(e).get(0);if(f){d.activitydata=JSON.parse(f.value);a(e).remove()}else{c.debug("Read Aloud Test Controller: No config found on page. Giving up.");return}d.cmid=b.cmid;d.holderid=b.widgetid+"_holder";d.recorderid=b.widgetid+"_recorder";d.playerid=b.widgetid+"_player";d.sorryboxid=b.widgetid+"_sorrybox";if(!d.is_browser_ok()){a("#"+d.sorryboxid).show();return}d.enableshadow=d.activitydata.enableshadow;d.enablepreview=d.activitydata.enablepreview;d.enablelandr=d.activitydata.enablelandr;d.setupmodelaudio();d.setuplandr();d.setup_recorder();d.process_html(d.activitydata);d.register_events();if(d.enableshadow||d.enablepreview||!0){d.domenulayout()}else{d.doreadinglayout()}},setupmodelaudio:function setupmodelaudio(){var a={breaks:this.activitydata.breaks,audioplayerclass:this.activitydata.audioplayerclass};f.init(a)},setuplandr:function setuplandr(){var a={modelaudiokaraoke:f,cmid:this.cmid,language:this.activitydata.language,region:this.activitydata.region};j.init(a)},process_html:function process_html(b){var c={hider:a("."+b.hider),introbox:a(".mod_intro_box"),progresscontainer:a("."+b.progresscontainer),feedbackcontainer:a("."+b.feedbackcontainer),errorcontainer:a("."+b.errorcontainer),passagecontainer:a("."+b.passagecontainer),recordingcontainer:a("."+b.recordingcontainer),dummyrecorder:a("."+b.dummyrecorder),recordercontainer:a("."+b.recordercontainer),menubuttonscontainer:a("."+b.menubuttonscontainer),menuinstructionscontainer:a("."+b.menuinstructionscontainer),previewinstructionscontainer:a("."+b.previewinstructionscontainer),landrinstructionscontainer:a("."+b.landrinstructionscontainer),activityinstructionscontainer:a("."+b.activityinstructionscontainer),recinstructionscontainerright:a("."+b.recinstructionscontainerright),recinstructionscontainerleft:a("."+b.recinstructionscontainerleft),allowearlyexit:a("."+b.allowearlyexit),wheretonextcontainer:a("."+b.wheretonextcontainer),modelaudioplayer:a("#"+b.modelaudioplayer),startlandrbutton:a("#"+b.startlandrbutton),startpreviewbutton:a("#"+b.startpreviewbutton),startreadingbutton:a("#"+b.startreadingbutton),startshadowbutton:a("#"+b.startshadowbutton),returnmenubutton:a("#"+b.returnmenubutton),stopandplay:a("#"+b.stopandplay),smallreportcontainer:a("."+b.smallreportcontainer)};this.controls=c},is_browser_ok:function is_browser_ok(){return navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},setup_recorder:function setup_recorder(){var a=this,b=function(){a.passagerecorded=!0;if(a.enableshadow&&a.letsshadow){a.controls.modelaudioplayer[0].play()}};e.init(a.activitydata,function on_recording_start(){a.rec_time_start=new Date().getTime();a.dopassagelayout();a.controls.passagecontainer.show(1e3,b);if(a.activitydata.transcriber==d.transcriber_amazonstreaming){a.streamingresults=[]}},function on_recording_end(){var b=new Date().getTime();if(3e3>b-a.rec_time_start){return}a.douploadlayout();if(a.enableshadow&&a.letsshadow){a.controls.modelaudioplayer[0].currentTime=0;a.controls.modelaudioplayer[0].pause()}},function on_audio_processing(b){var c=new Date().getTime(),e=c-a.rec_time_start;if(0<e){e=Math.ceil(e/1e3)}if(a.activitydata.transcriber==d.transcriber_amazonstreaming&&a.streamingresults&&0<a.streamingresults.length){setTimeout(a.send_streaming_submission,1500,a,b.mediaurl,e)}else{a.send_submission(b.mediaurl,e);a.dofinishedlayout()}},function on_speech(b){var e=b.capturedspeech,f=b.speechresults;if(a.activitydata.transcriber==d.transcriber_amazonstreaming){a.streamingresults.push(f);c.debug(a.streamingresults)}})},register_events:function register_events(){var a=this;a.controls.startpreviewbutton.click(function(){a.dopreviewlayout()});a.controls.startpreviewbutton.keypress(function(b){if(32==b.which||13==b.which){a.dopreviewlayout();b.preventDefault()}});a.controls.startlandrbutton.click(function(){a.dolandrlayout()});a.controls.startlandrbutton.keypress(function(b){if(32==b.which||13==b.which){a.dolandrlayout();b.preventDefault()}});a.controls.startreadingbutton.click(function(){a.letsshadow=!1;a.doreadinglayout()});a.controls.startreadingbutton.keypress(function(b){if(32==b.which||13==b.which){a.letsshadow=!1;a.doreadinglayout();b.preventDefault()}});a.controls.startshadowbutton.click(function(){a.letsshadow=!0;a.doreadinglayout()});a.controls.startshadowbutton.keypress(function(b){if(32==b.which||13==b.which){a.letsshadow=!0;a.doreadinglayout();b.preventDefault()}});a.controls.returnmenubutton.click(function(){if(a.isandroid()&&a.controls.landrinstructionscontainer.is(":visible")){location.reload()}else{a.controls.modelaudioplayer[0].currentTime=0;a.controls.modelaudioplayer[0].pause();a.domenulayout()}})},send_streaming_submission:function send_streaming_submission(a,b,d){var e=a.streamingresults;g.call([{methodname:"mod_readaloud_submit_streaming_attempt",args:{cmid:a.cmid,filename:b,rectime:d,awsresults:JSON.stringify(e)},done:function done(b){var d=JSON.parse(b);if(d){switch(d.success){case!0:c.debug("attempted submission accepted");break;case!1:default:c.debug("attempted item evaluation failure");if(d.message){c.debug("message: "+d.message)}}}a.dofinishedlayout()},fail:h.exception}])},send_submission:function send_submission(a,b){var d=this;g.call([{methodname:"mod_readaloud_submit_regular_attempt",args:{cmid:d.cmid,filename:a,rectime:b},done:function done(a){var b=JSON.parse(a);if(b){switch(b.success){case!0:c.debug("attempted submission accepted");break;case!1:default:c.debug("attempted item evaluation failure");if(b.message){c.debug("message: "+b.message)}}}},fail:h.exception}])},doreadinglayout:function doreadinglayout(){var a=this;a.controls.hider.fadeOut("fast");a.controls.activityinstructionscontainer.show();a.controls.recordingcontainer.show();a.controls.introbox.hide();a.controls.menuinstructionscontainer.hide();a.controls.menubuttonscontainer.hide();a.controls.smallreportcontainer.hide();a.controls.returnmenubutton.show();a.controls.progresscontainer.hide();a.controls.passagecontainer.removeClass("previewmode shadowmode reviewmode nothingmode");a.controls.passagecontainer.addClass("readmode");a.controls.passagecontainer.hide();a.controls.feedbackcontainer.hide();a.controls.wheretonextcontainer.hide();a.controls.stopandplay.hide()},domenulayout:function domenulayout(){var a=this;a.controls.introbox.show();a.controls.menuinstructionscontainer.show();a.controls.menubuttonscontainer.show();a.controls.smallreportcontainer.show();a.controls.activityinstructionscontainer.hide();a.controls.returnmenubutton.hide();a.controls.previewinstructionscontainer.hide();a.controls.landrinstructionscontainer.hide();j.deactivate();a.controls.progresscontainer.hide();a.controls.passagecontainer.hide();a.controls.recordingcontainer.hide();a.controls.feedbackcontainer.hide();a.controls.wheretonextcontainer.hide();a.controls.modelaudioplayer.hide();a.controls.hider.hide();a.controls.stopandplay.hide()},dopreviewlayout:function dopreviewlayout(){var a=this;a.controls.passagecontainer.removeClass("readmode shadowmode reviewmode nothingmode");a.controls.passagecontainer.addClass("previewmode");a.controls.passagecontainer.show();a.controls.previewinstructionscontainer.show();a.controls.landrinstructionscontainer.hide();a.controls.introbox.hide();a.controls.returnmenubutton.show();a.controls.modelaudioplayer.hide();a.controls.smallreportcontainer.hide();a.controls.stopandplay.show();a.controls.menubuttonscontainer.hide();a.controls.hider.hide();a.controls.progresscontainer.hide();a.controls.menuinstructionscontainer.hide();a.controls.activityinstructionscontainer.hide();a.controls.recordingcontainer.hide();a.controls.feedbackcontainer.hide();a.controls.wheretonextcontainer.hide();a.controls.stopandplay.show()},dolandrlayout:function dolandrlayout(){var a=this;a.controls.passagecontainer.removeClass("readmode shadowmode reviewmode nothingmode");a.controls.passagecontainer.addClass("previewmode");a.controls.passagecontainer.show();a.controls.landrinstructionscontainer.show();a.controls.previewinstructionscontainer.hide();a.controls.introbox.hide();a.controls.returnmenubutton.show();a.controls.modelaudioplayer.hide();a.controls.smallreportcontainer.hide();a.controls.stopandplay.show();a.controls.menubuttonscontainer.hide();a.controls.hider.hide();a.controls.progresscontainer.hide();a.controls.menuinstructionscontainer.hide();a.controls.activityinstructionscontainer.hide();a.controls.recordingcontainer.hide();a.controls.feedbackcontainer.hide();a.controls.wheretonextcontainer.hide();a.controls.stopandplay.show();j.activate()},dopassagelayout:function dopassagelayout(){var a=this;a.controls.introbox.hide()},douploadlayout:function douploadlayout(){var a=this;a.controls.passagecontainer.addClass(a.passagefinished);a.controls.hider.fadeIn("fast");a.controls.progresscontainer.fadeIn("fast")},dofinishedlayout:function dofinishedlayout(){var a=this;a.controls.hider.fadeOut("fast");a.controls.progresscontainer.fadeOut("fast");a.controls.smallreportcontainer.hide();a.controls.activityinstructionscontainer.hide();a.controls.passagecontainer.hide();a.controls.recordingcontainer.hide();a.controls.feedbackcontainer.show();a.controls.wheretonextcontainer.show();a.controls.returnmenubutton.hide()},doerrorlayout:function doerrorlayout(){var a=this;a.controls.hider.fadeOut("fast");a.controls.progresscontainer.fadeOut("fast");a.controls.passagecontainer.hide();a.controls.recordingcontainer.hide();a.controls.errorcontainer.show();a.controls.wheretonextcontainer.show()},isandroid:function isandroid(){if(/Android/i.test(navigator.userAgent)){return!0}else{return!1}}}});
//# sourceMappingURL=activitycontroller.min.js.map
