define(["jquery","core/log","mod_readaloud/definitions","mod_readaloud/recorderhelper","mod_readaloud/modelaudiokaraoke","core/ajax","core/notification","mod_readaloud/smallreporthelper","mod_readaloud/listenandrepeat"],function(a,b,c,d,e,f,g,h,i){"use strict";b.debug("Activity controller: initialising");return{cmid:null,activitydata:null,holderid:null,recorderid:null,playerid:null,sorryboxid:null,controls:null,ra_recorder:null,rec_time_start:0,enableshadow:!1,enablepreview:!1,enablelandr:!1,letsshadow:!1,passagefinished:c.passagefinished,clone:function clone(){return a.extend(!0,{},this)},init:function init(c){var d=this.clone(),e="#amdopts_"+c.widgetid,f=a(e).get(0);if(f){d.activitydata=JSON.parse(f.value);a(e).remove()}else{b.debug("Read Aloud Test Controller: No config found on page. Giving up.");return}d.cmid=c.cmid;d.holderid=c.widgetid+"_holder";d.recorderid=c.widgetid+"_recorder";d.playerid=c.widgetid+"_player";d.sorryboxid=c.widgetid+"_sorrybox";if(!d.is_browser_ok()){a("#"+d.sorryboxid).show();return}d.enableshadow=d.activitydata.enableshadow;d.enablepreview=d.activitydata.enablepreview;d.enablelandr=d.activitydata.enablelandr;d.setupmodelaudio();d.setuplandr();d.setup_recorder();d.process_html(d.activitydata);d.register_events();if(d.enableshadow||d.enablepreview||!0){d.domenulayout()}else{d.doreadinglayout()}},setupmodelaudio:function setupmodelaudio(){var a={breaks:this.activitydata.breaks,audioplayerclass:this.activitydata.audioplayerclass};e.init(a)},setuplandr:function setuplandr(){var a={modelaudiokaraoke:e,cmid:this.cmid,language:this.activitydata.language,region:this.activitydata.region,phonetics:this.activitydata.phonetics,stt_guided:this.activitydata.stt_guided};i.init(a)},process_html:function process_html(b){var c={hider:a("."+b.hider),introbox:a(".mod_intro_box"),progresscontainer:a("."+b.progresscontainer),feedbackcontainer:a("."+b.feedbackcontainer),errorcontainer:a("."+b.errorcontainer),passagecontainer:a("."+b.passagecontainer),recordingcontainer:a("."+b.recordingcontainer),dummyrecorder:a("."+b.dummyrecorder),recordercontainer:a("."+b.recordercontainer),menubuttonscontainer:a("."+b.menubuttonscontainer),menuinstructionscontainer:a("."+b.menuinstructionscontainer),previewinstructionscontainer:a("."+b.previewinstructionscontainer),landrinstructionscontainer:a("."+b.landrinstructionscontainer),activityinstructionscontainer:a("."+b.activityinstructionscontainer),recinstructionscontainerright:a("."+b.recinstructionscontainerright),recinstructionscontainerleft:a("."+b.recinstructionscontainerleft),allowearlyexit:a("."+b.allowearlyexit),wheretonextcontainer:a("."+b.wheretonextcontainer),modelaudioplayer:a("#"+b.modelaudioplayer),startlandrbutton:a("#"+b.startlandrbutton),startpreviewbutton:a("#"+b.startpreviewbutton),startreadingbutton:a("#"+b.startreadingbutton),startshadowbutton:a("#"+b.startshadowbutton),returnmenubutton:a("#"+b.returnmenubutton),stopandplay:a("#"+b.stopandplay),smallreportcontainer:a("."+b.smallreportcontainer)};this.controls=c},is_browser_ok:function is_browser_ok(){return navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},setup_recorder:function setup_recorder(){var a=this,b=function(){a.passagerecorded=!0;if(a.enableshadow&&a.letsshadow){a.controls.modelaudioplayer[0].play()}};d.init(a.activitydata,function on_recording_start(){a.rec_time_start=new Date().getTime();a.dopassagelayout();a.controls.passagecontainer.show(1e3,b)},function on_recording_end(){var b=new Date().getTime();if(3e3>b-a.rec_time_start){return}a.douploadlayout();if(a.enableshadow&&a.letsshadow){a.controls.modelaudioplayer[0].currentTime=0;a.controls.modelaudioplayer[0].pause()}},function on_audio_processing(b){var c=new Date().getTime(),d=c-a.rec_time_start;if(0<d){d=Math.ceil(d/1e3)}a.send_submission(b.mediaurl,d);a.dofinishedlayout()},function on_speech(a){var b=a.capturedspeech,c=a.speechresults})},register_events:function register_events(){var a=this;a.controls.startpreviewbutton.click(function(){a.dopreviewlayout()});a.controls.startpreviewbutton.keypress(function(b){if(32==b.which||13==b.which){a.dopreviewlayout();b.preventDefault()}});a.controls.startlandrbutton.click(function(){a.dolandrlayout()});a.controls.startlandrbutton.keypress(function(b){if(32==b.which||13==b.which){a.dolandrlayout();b.preventDefault()}});a.controls.startreadingbutton.click(function(){a.letsshadow=!1;a.doreadinglayout()});a.controls.startreadingbutton.keypress(function(b){if(32==b.which||13==b.which){a.letsshadow=!1;a.doreadinglayout();b.preventDefault()}});a.controls.startshadowbutton.click(function(){a.letsshadow=!0;a.doreadinglayout()});a.controls.startshadowbutton.keypress(function(b){if(32==b.which||13==b.which){a.letsshadow=!0;a.doreadinglayout();b.preventDefault()}});a.controls.returnmenubutton.click(function(){if(a.isandroid()&&a.controls.landrinstructionscontainer.is(":visible")){location.reload()}else{a.controls.modelaudioplayer[0].currentTime=0;a.controls.modelaudioplayer[0].pause();a.domenulayout()}})},send_submission:function send_submission(a,c){var d=this,e=d.enableshadow&&d.letsshadow?1:0;f.call([{methodname:"mod_readaloud_submit_regular_attempt",args:{cmid:d.cmid,filename:a,rectime:c,shadowing:e},done:function done(a){var c=JSON.parse(a);if(c){switch(c.success){case!0:b.debug("attempted submission accepted");break;case!1:default:b.debug("attempted item evaluation failure");if(c.message){b.debug("message: "+c.message)}}}},fail:g.exception}])},doreadinglayout:function doreadinglayout(){var a=this;a.controls.hider.fadeOut("fast");a.controls.activityinstructionscontainer.show();a.controls.recordingcontainer.show();a.controls.introbox.hide();a.controls.menuinstructionscontainer.hide();a.controls.menubuttonscontainer.hide();a.controls.smallreportcontainer.hide();a.controls.returnmenubutton.show();a.controls.progresscontainer.hide();a.controls.passagecontainer.removeClass("previewmode shadowmode reviewmode nothingmode");a.controls.passagecontainer.addClass("readmode");a.controls.passagecontainer.hide();a.controls.feedbackcontainer.hide();a.controls.wheretonextcontainer.hide();a.controls.stopandplay.hide();e.modeling=!0},domenulayout:function domenulayout(){var a=this;a.controls.introbox.show();a.controls.menuinstructionscontainer.show();a.controls.menubuttonscontainer.show();a.controls.smallreportcontainer.show();a.controls.activityinstructionscontainer.hide();a.controls.returnmenubutton.hide();a.controls.previewinstructionscontainer.hide();a.controls.landrinstructionscontainer.hide();i.deactivate();a.controls.progresscontainer.hide();a.controls.passagecontainer.hide();a.controls.recordingcontainer.hide();a.controls.feedbackcontainer.hide();a.controls.wheretonextcontainer.hide();a.controls.modelaudioplayer.hide();a.controls.hider.hide();a.controls.stopandplay.hide();e.modeling=!0},dopreviewlayout:function dopreviewlayout(){var a=this;a.controls.passagecontainer.removeClass("readmode shadowmode reviewmode nothingmode");a.controls.passagecontainer.addClass("previewmode");a.controls.passagecontainer.show();a.controls.previewinstructionscontainer.show();a.controls.landrinstructionscontainer.hide();a.controls.introbox.hide();a.controls.returnmenubutton.show();a.controls.modelaudioplayer.hide();a.controls.smallreportcontainer.hide();a.controls.stopandplay.show();a.controls.menubuttonscontainer.hide();a.controls.hider.hide();a.controls.progresscontainer.hide();a.controls.menuinstructionscontainer.hide();a.controls.activityinstructionscontainer.hide();a.controls.recordingcontainer.hide();a.controls.feedbackcontainer.hide();a.controls.wheretonextcontainer.hide();a.controls.stopandplay.show();e.modeling=!1},dolandrlayout:function dolandrlayout(){var a=this;a.controls.passagecontainer.removeClass("readmode shadowmode reviewmode nothingmode");a.controls.passagecontainer.addClass("previewmode");a.controls.passagecontainer.show();a.controls.landrinstructionscontainer.show();a.controls.previewinstructionscontainer.hide();a.controls.introbox.hide();a.controls.returnmenubutton.show();a.controls.modelaudioplayer.hide();a.controls.smallreportcontainer.hide();a.controls.stopandplay.show();a.controls.menubuttonscontainer.hide();a.controls.hider.hide();a.controls.progresscontainer.hide();a.controls.menuinstructionscontainer.hide();a.controls.activityinstructionscontainer.hide();a.controls.recordingcontainer.hide();a.controls.feedbackcontainer.hide();a.controls.wheretonextcontainer.hide();a.controls.stopandplay.show();i.activate();e.modeling=!1},dopassagelayout:function dopassagelayout(){var a=this;a.controls.introbox.hide()},douploadlayout:function douploadlayout(){var a=this;a.controls.passagecontainer.addClass(a.passagefinished);a.controls.hider.fadeIn("fast");a.controls.progresscontainer.fadeIn("fast")},dofinishedlayout:function dofinishedlayout(){var a=this;a.controls.hider.fadeOut("fast");a.controls.progresscontainer.fadeOut("fast");a.controls.smallreportcontainer.hide();a.controls.activityinstructionscontainer.hide();a.controls.passagecontainer.hide();a.controls.recordingcontainer.hide();a.controls.feedbackcontainer.show();a.controls.wheretonextcontainer.show();a.controls.returnmenubutton.hide()},doerrorlayout:function doerrorlayout(){var a=this;a.controls.hider.fadeOut("fast");a.controls.progresscontainer.fadeOut("fast");a.controls.passagecontainer.hide();a.controls.recordingcontainer.hide();a.controls.errorcontainer.show();a.controls.wheretonextcontainer.show()},isandroid:function isandroid(){if(/Android/i.test(navigator.userAgent)){return!0}else{return!1}}}});
//# sourceMappingURL=activitycontroller.min.js.map
