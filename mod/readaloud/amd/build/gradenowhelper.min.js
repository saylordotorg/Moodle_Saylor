define("mod_readaloud/gradenowhelper",["jquery","core/log","mod_readaloud/definitions","mod_readaloud/popoverhelper"],(function($,log,def,popoverhelper){return log.debug("Gradenow helper: initialising"),{controls:{},currentmode:"grading",constants:{REVIEWMODE_NONE:0,REVIEWMODE_MACHINE:1,REVIEWMODE_HUMAN:2,REVIEWMODE_SCORESONLY:3,SESSIONSCORE_STRICT:1},cd:{audioplayerclass:def.audioplayerclass,wordplayerclass:def.wordplayerclass,wordclass:def.wordclass,spaceclass:def.spaceclass,badwordclass:def.badwordclass,endspaceclass:def.endspaceclass,unreadwordclass:def.unreadwordclass,unreadspaceclass:def.unreadspaceclass,wpmscoreid:def.wpmscoreid,accuracyscoreid:def.accuracyscoreid,sessionscoreid:def.sessionscoreid,errorscoreid:def.errorscoreid,formelementwpmscore:def.formelementwpmscore,formelementaccuracy:def.formelementaccuracy,formelementsessionscore:def.formelementsessionscore,formelementendword:def.formelementendword,formelementtime:def.formelementtime,formelementerrors:def.formelementerrors,modebutton:def.modebutton,spotcheckbutton:def.spotcheckbutton,transcriptcheckbutton:def.transcriptcheckbutton,gradingbutton:def.gradingbutton,clearbutton:def.clearbutton,spotcheckmode:def.spotcheckmode,aiunmatched:def.aiunmatched,passagecontainer:def.passagecontainer,maybeselfcorrectclass:def.maybeselfcorrectclass,selfcorrectclass:def.selfcorrectclass,notesclass:def.notesclass,structuralclass:def.structuralclass,meaningclass:def.meaningclass,visualclass:def.visualclass},options:{enabletts:!1,targetwpm:100,ttslanguage:"en",totalseconds:60,allowearlyexit:!1,timelimit:60,enforcemarker:!0,totalwordcount:0,wpm:0,accuracy:0,sessionscore:0,sessionscoremethod:0,endwordnumber:0,errorwords:{},activityid:null,attemptid:null,sesskey:null},init:function(config){var theid="#"+config.id,configcontrol=$(theid).get(0);if(configcontrol){var opts=JSON.parse(configcontrol.value);$(theid).remove(),this.register_controls(),this.options.activityid=opts.activityid,this.options.attemptid=opts.attemptid,this.options.sesskey=opts.sesskey,this.options.enabletts=opts.enabletts,this.options.ttslanguage=opts.ttslanguage,this.options.targetwpm=opts.targetwpm,this.options.sessionscoremethod=opts.sessionscoremethod,this.options.allowearlyexit=opts.allowearlyexit,this.options.timelimit=opts.timelimit,this.options.reviewmode=opts.reviewmode,this.options.readonly=opts.readonly,this.options.totalwordcount=$("."+this.cd.wordclass).length,opts.sessiontime>0?(""!==opts.sessionerrors?this.options.errorwords=JSON.parse(opts.sessionerrors):this.options.errorwords={},this.options.totalseconds=opts.sessiontime,this.options.endwordnumber=opts.sessionendword,this.options.sessionscore=opts.sessionscore,this.options.accuracy=opts.accuracy,this.options.wpm=opts.wpm,this.options.sessionmatches=JSON.parse(opts.sessionmatches),this.options.aidata=opts.aidata,this.options.aidata?(this.options.transcriptwords=opts.aidata.transcript.split(" "),this.options.transcriptwords=this.options.transcriptwords.filter((function(el){return""!==el}))):this.options.transcriptwords=[],this.redrawgradestate()):this.options.endwordnumber=this.options.totalwordcount,$("#"+this.cd.spaceclass+"_"+this.options.endwordnumber).addClass(this.cd.endspaceclass),this.register_events();var m=this;m.options.allowearlyexit||0==m.options.timelimit?m.options.aidata&&m.options.aidata.sessiontime?m.options.totalseconds=m.options.aidata.sessiontime:m.options.totalseconds=Math.round($("#"+m.cd.audioplayerclass).prop("duration")):m.options.totalseconds=m.options.timelimit,m.controls.formelementtime.val(m.options.totalseconds),m.processscores(),this.init_popoverhelper()}else log.debug("Gradenow helper js: No config found on page. Giving up.")},init_popoverhelper:function(){var that=this;popoverhelper.onReject=function(){var clickwordnumber=$(this).attr("data-wordnumber");if(clickwordnumber in that.options.errorwords)popoverhelper.remove();else{for(var playchain=that.fetchPlayChain(clickwordnumber),wordindex=playchain.startword;wordindex<=playchain.endword;wordindex++)if(!(wordindex in that.options.errorwords)){var theword=$("#"+that.cd.wordclass+"_"+wordindex),thespace=$("#"+that.cd.spaceclass+"_"+wordindex);wordindex==clickwordnumber&&(that.adderrorword(wordindex,theword.text()),theword.addClass(that.cd.badwordclass),theword.addClass(that.cd.spotcheckmode),wordindex!==playchain.endword&&thespace.addClass(that.cd.spotcheckmode))}that.markup_aiunmatchedspaces(),that.processscores(),popoverhelper.remove()}},popoverhelper.onAccept=function(){var clickwordnumber=$(this).attr("data-wordnumber");if(!(clickwordnumber in that.options.errorwords))popoverhelper.remove();else{for(var playchain=that.fetchPlayChain(clickwordnumber),wordindex=playchain.startword;wordindex<=playchain.endword;wordindex++)if(wordindex in that.options.errorwords&&wordindex==clickwordnumber){delete that.options.errorwords[wordindex];var theword=$("#"+that.cd.wordclass+"_"+wordindex),thespace=$("#"+that.cd.spaceclass+"_"+wordindex);theword.removeClass(that.cd.badwordclass),theword.removeClass(that.cd.spotcheckmode),thespace.removeClass(that.cd.spotcheckmode)}that.markup_aiunmatchedspaces(),that.processscores(),popoverhelper.remove()}},popoverhelper.init()},register_controls:function(){this.controls.wordplayer=$("#"+this.cd.wordplayerclass),this.controls.audioplayer=$("#"+this.cd.audioplayerclass),this.controls.eachword=$("."+this.cd.wordclass),this.controls.eachspace=$("."+this.cd.spaceclass),this.controls.endwordmarker=$("#"+this.cd.spaceclass+"_"+this.options.endwordnumber),this.controls.spotcheckword=$("."+this.cd.spotcheckmode),this.controls.wpmscorebox=$("#"+this.cd.wpmscoreid),this.controls.accuracyscorebox=$("#"+this.cd.accuracyscoreid),this.controls.sessionscorebox=$("#"+this.cd.sessionscoreid),this.controls.errorscorebox=$("#"+this.cd.errorscoreid),this.controls.formelementwpmscore=$("#"+this.cd.formelementwpmscore),this.controls.formelementsessionscore=$("#"+this.cd.formelementsessionscore),this.controls.formelementaccuracy=$("#"+this.cd.formelementaccuracy),this.controls.formelementendword=$("#"+this.cd.formelementendword),this.controls.formelementerrors=$("#"+this.cd.formelementerrors),this.controls.formelementtime=$("#"+this.cd.formelementtime),this.controls.passagecontainer=$("."+this.cd.passagecontainer),this.controls.modebutton=$("#"+this.cd.modebutton),this.controls.gradingbutton=$("#"+this.cd.gradingbutton),this.controls.spotcheckbutton=$("#"+this.cd.spotcheckbutton),this.controls.transcriptcheckbutton=$("#"+this.cd.transcriptcheckbutton),this.controls.clearbutton=$("#"+this.cd.clearbutton)},register_events:function(){var that=this;this.controls.passagecontainer.on("click","."+this.cd.spotcheckmode+", ."+this.cd.aiunmatched,(function(){if("spotcheck"===that.currentmode){var wordnumber=parseInt($(this).attr("data-wordnumber"));that.doPlaySpotCheck(wordnumber)}})),this.options.readonly||(this.controls.eachword.click((function(){var wordnumber=$(this).attr("data-wordnumber"),theword=$(this).text();if("spotcheck"!==that.currentmode)if("transcriptcheck"!==that.currentmode)that.options.enforcemarker&&Number(wordnumber)>Number(that.options.endwordnumber)||(wordnumber in that.options.errorwords?(delete that.options.errorwords[wordnumber],$(this).removeClass(that.cd.badwordclass)):(that.adderrorword(wordnumber,theword),$(this).addClass(that.cd.badwordclass)),that.processscores());else{var chunk=that.fetchTranscriptChunk(wordnumber);chunk&&popoverhelper.addTranscript(this,chunk)}else($(this).hasClass(that.cd.badwordclass)||$(this).hasClass(that.cd.aiunmatched))&&popoverhelper.addQuickGrader(this)})),this.controls.eachspace.click((function(){if("spotcheck"!==that.currentmode&&"transcriptcheck"!==that.currentmode){var wordnumber=$(this).attr("data-wordnumber"),thespace=$("#"+that.cd.spaceclass+"_"+wordnumber);wordnumber===that.options.endwordnumber?(that.options.endwordnumber=that.options.totalwordcount,thespace.removeClass(that.cd.endspaceclass),$("#"+that.cd.spaceclass+"_"+that.options.totalwordcount).addClass(that.cd.endspaceclass)):($("#"+that.cd.spaceclass+"_"+that.options.endwordnumber).removeClass(that.cd.endspaceclass),that.options.endwordnumber=wordnumber,thespace.addClass(that.cd.endspaceclass)),that.processunread(),that.processscores()}})),this.controls.clearbutton.click((function(){"spotcheck"!==that.currentmode&&"transcriptcheck"!==that.currentmode&&($("."+that.cd.badwordclass).each((function(index){var wordnumber=$(this).attr("data-wordnumber");delete that.options.errorwords[wordnumber],$(this).removeClass(that.cd.badwordclass)})),$("."+that.cd.wordclass).removeClass(that.cd.unreadwordclass),that.options.endwordnumber=that.options.totalwordcount,$("."+that.cd.spaceclass).removeClass(that.cd.endspaceclass),$("#"+that.cd.spaceclass+"_"+that.options.totalwordcount).addClass(that.cd.endspaceclass),that.processscores())})),this.controls.gradingbutton.click((function(){that.undoCurrentMode(),that.doGradingMode(),that.updateButtonStates()}))),this.controls.spotcheckbutton.click((function(){that.undoCurrentMode(),that.doSpotCheckMode(),that.updateButtonStates()})),this.controls.transcriptcheckbutton.click((function(){that.undoCurrentMode(),that.doTranscriptCheckMode(),that.updateButtonStates()}))},undoCurrentMode:function(){switch(this.currentmode){case"grading":break;case"spotcheck":this.undoSpotCheckMode();break;case"transcriptcheck":this.undoTranscriptCheckMode()}},updateButtonStates:function(){switch(this.currentmode){case"grading":this.controls.gradingbutton.prop("disabled",!0),this.controls.spotcheckbutton.prop("disabled",!1),this.controls.transcriptcheckbutton.prop("disabled",!1);break;case"spotcheck":this.controls.gradingbutton.prop("disabled",!1),this.controls.spotcheckbutton.prop("disabled",!0),this.controls.transcriptcheckbutton.prop("disabled",!1);break;case"transcriptcheck":this.controls.gradingbutton.prop("disabled",!1),this.controls.spotcheckbutton.prop("disabled",!1),this.controls.transcriptcheckbutton.prop("disabled",!0)}},doPlaySpotCheck:function(spotcheckindex){var playchain=this.fetchPlayChain(spotcheckindex),theplayer=this.controls.audioplayer[0],duration=theplayer.duration,endtime=parseFloat(playchain.audioend);!isNaN(duration)&&duration>endtime+.5&&(endtime+=.5);var starttime=parseFloat(playchain.audiostart);starttime-.5>0&&(starttime-=.5),theplayer.currentTime=starttime,$(this.controls.audioplayer).off("timeupdate"),$(this.controls.audioplayer).on("timeupdate",(function(e){theplayer.currentTime>=endtime&&($(this).off("timeupdate"),theplayer.pause())})),theplayer.play()},fetchPlayChain:function(spotcheckindex){for(var startindex=spotcheckindex,starttime=-1,wordnumber=spotcheckindex;wordnumber>0;wordnumber--){var isbad=$("#"+this.cd.wordclass+"_"+wordnumber).hasClass(this.cd.badwordclass),isunmatched=$("#"+this.cd.wordclass+"_"+wordnumber).hasClass(this.cd.aiunmatched);if(!isbad&&!isunmatched)break;startindex=wordnumber,starttime=isunmatched?-1:this.options.sessionmatches[""+wordnumber].audiostart}if(-1===starttime){starttime=0;for(wordnumber=startindex-1;wordnumber>0;wordnumber--)if(this.options.sessionmatches[""+wordnumber]){starttime=this.options.sessionmatches[""+wordnumber].audioend;break}}var endindex=spotcheckindex,endtime=-1,passageendword=this.options.totalwordcount;for(wordnumber=spotcheckindex;wordnumber<=passageendword;wordnumber++){isbad=$("#"+this.cd.wordclass+"_"+wordnumber).hasClass(this.cd.badwordclass),isunmatched=$("#"+this.cd.wordclass+"_"+wordnumber).hasClass(this.cd.aiunmatched);if(!isbad&&!isunmatched)break;endindex=wordnumber,endtime=isunmatched?-1:this.options.sessionmatches[""+wordnumber].audioend}if(-1===endtime){endtime=this.options.totalseconds;for(wordnumber=endindex+1;wordnumber<=passageendword;wordnumber++)if(this.options.sessionmatches[""+wordnumber]){endtime=this.options.sessionmatches[""+wordnumber].audiostart;break}}var playchain={};return playchain.startword=startindex,playchain.endword=parseInt(endindex),playchain.audiostart=starttime,playchain.audioend=parseInt(endtime),playchain},doSpotCheckMode:function(){this.markup_aiunmatchedwords(),$("."+this.cd.badwordclass).addClass(this.cd.spotcheckmode),this.markup_aiunmatchedspaces(),this.currentmode="spotcheck"},markup_aiunmatchedwords:function(){var that=this;if(this.options.sessionmatches){var prevmatch=0;$.each(this.options.sessionmatches,(function(index,match){var unmatchedcount=index-prevmatch-1;if(unmatchedcount>0)for(var errorword=1;errorword<unmatchedcount+1;errorword++){var wordnumber=prevmatch+errorword;$("#"+that.cd.wordclass+"_"+wordnumber).addClass(that.cd.aiunmatched)}prevmatch=parseInt(index)}));for(var errorword=prevmatch+1;errorword<=this.options.endwordnumber;errorword++)$("#"+that.cd.wordclass+"_"+errorword).addClass(that.cd.aiunmatched)}},markup_badspaces:function(){var that=this;$("."+this.cd.badwordclass+"."+this.cd.spotcheckmode).each((function(index){var wordnumber=parseInt($(this).attr("data-wordnumber"));($("#"+that.cd.wordclass+"_"+(wordnumber+1)).hasClass(that.cd.spotcheckmode)||$("#"+that.cd.wordclass+"_"+(wordnumber+1)).hasClass(that.cd.aiunmatched))&&$("#"+that.cd.spaceclass+"_"+wordnumber).addClass(that.cd.spotcheckmode)}))},markup_aiunmatchedspaces:function(){var that=this;$("."+this.cd.wordclass+"."+this.cd.aiunmatched).each((function(index){var wordnumber=parseInt($(this).attr("data-wordnumber"));($("#"+that.cd.wordclass+"_"+(wordnumber+1)).hasClass(that.cd.spotcheckmode)||$("#"+that.cd.wordclass+"_"+(wordnumber+1)).hasClass(that.cd.aiunmatched))&&$("#"+that.cd.spaceclass+"_"+wordnumber).addClass(that.cd.aiunmatched)}))},undoSpotCheckMode:function(){$("."+this.cd.badwordclass).removeClass(this.cd.spotcheckmode),$("."+this.cd.spaceclass).removeClass(this.cd.spotcheckmode),$("."+this.cd.wordclass).removeClass(this.cd.aiunmatched),$("."+this.cd.spaceclass).removeClass(this.cd.aiunmatched),$(this.controls.audioplayer).off("timeupdate"),popoverhelper.remove()},doTranscriptCheckMode:function(){var that=this;if(this.options.sessionmatches){var prevmatch=0;$.each(this.options.sessionmatches,(function(index,match){var unmatchedcount=index-prevmatch-1;if(unmatchedcount>0)for(var errorword=1;errorword<unmatchedcount+1;errorword++){var wordnumber=prevmatch+errorword;$("#"+that.cd.wordclass+"_"+wordnumber).addClass(that.cd.aiunmatched)}prevmatch=parseInt(index)}));for(var errorword=prevmatch+1;errorword<=this.options.endwordnumber;errorword++)$("#"+that.cd.wordclass+"_"+errorword).addClass(that.cd.aiunmatched)}$("."+this.cd.aiunmatched).each((function(index){var wordnumber=parseInt($(this).attr("data-wordnumber"));$("#"+that.cd.wordclass+"_"+(wordnumber+1)).hasClass(that.cd.aiunmatched)&&$("#"+that.cd.spaceclass+"_"+wordnumber).addClass(that.cd.aiunmatched)})),this.currentmode="transcriptcheck"},undoTranscriptCheckMode:function(){$("."+this.cd.wordclass).removeClass(this.cd.aiunmatched),$("."+this.cd.spaceclass).removeClass(this.cd.aiunmatched),popoverhelper.remove()},doGradingMode:function(){this.currentmode="grading"},fetchTranscriptChunk:function(checkindex){var transcriptlength=this.options.transcriptwords.length;if(0===transcriptlength)return"";for(var startindex=-1,wordnumber=checkindex;wordnumber>0;wordnumber--){if(!$("#"+this.cd.wordclass+"_"+wordnumber).hasClass(this.cd.aiunmatched)){startindex=this.options.sessionmatches[""+wordnumber].tposition+1;break}}var endindex=-1;for(wordnumber=checkindex;wordnumber<=transcriptlength;wordnumber++){if(!$("#"+this.cd.wordclass+"_"+wordnumber).hasClass(this.cd.aiunmatched)){endindex=this.options.sessionmatches[""+wordnumber].tposition-1;break}}if(-1===startindex&&(startindex=1),endindex===transcriptlength)endindex=-1;else if(0===endindex||endindex<startindex)return!1;startindex--;var ret=!1;return""!==(ret=endindex>0?this.options.transcriptwords.slice(startindex,endindex).join(" "):this.options.transcriptwords.slice(startindex).join(" ")).trim()&&ret},playword:function(){var m=this;m.controls.wordplayer.attr("src",M.cfg.wwwroot+"/mod/readaloud/tts.php?txt="+encodeURIComponent($(this).text())+"&lang="+m.options.ttslanguage+"&n="+m.options.activityid),m.controls.wordplayer[0].pause(),m.controls.wordplayer[0].load(),m.controls.wordplayer[0].play()},redrawgradestate:function(){var m=this;this.processunread(),this.options.reviewmode!==this.constants.REVIEWMODE_SCORESONLY&&$.each(m.options.errorwords,(function(index){$("#"+m.cd.wordclass+"_"+m.options.errorwords[index].wordnumber).addClass(m.cd.badwordclass)})),this.markup_maybeselfcorrects()},adderrorword:function(wordnumber,word){this.options.errorwords[wordnumber]={word:word,wordnumber:wordnumber}},processword:function(){var m=this,wordnumber=$(this).attr("data-wordnumber"),theword=$(this).text();m.options.enforcemarker&&Number(wordnumber)>Number(m.options.endwordnumber)||(wordnumber in m.options.errorwords?(delete m.options.errorwords[wordnumber],$(this).removeClass(m.cd.badwordclass)):(m.adderrorword(wordnumber,theword),$(this).addClass(m.cd.badwordclass)),m.processscores())},processspace:function(){var m=this,wordnumber=$(this).attr("data-wordnumber"),thespace=$("#"+m.cd.spaceclass+"_"+wordnumber);wordnumber===m.options.endwordnumber?(m.options.endwordnumber=m.options.totalwordcount,thespace.removeClass(m.cd.endspaceclass),$("#"+m.cd.spaceclass+"_"+m.options.totalwordcount).addClass(m.cd.endspaceclass)):($("#"+m.cd.spaceclass+"_"+m.options.endwordnumber).removeClass(m.cd.endspaceclass),m.options.endwordnumber=wordnumber,thespace.addClass(m.cd.endspaceclass)),m.processunread(),m.processscores()},markup_maybeselfcorrects:function(){var that=this;if(this.options.sessionmatches){var prevmatch=!1;$.each(this.options.sessionmatches,(function(index,match){var verymaybe=!1;prevmatch?match.tposition-prevmatch.tposition>1&&match.pposition-prevmatch.pposition==1?(!0,verymaybe=!0):(match.tposition,prevmatch.tposition):!1===prevmatch&&(match.pposition,match.tposition),verymaybe&&$("#"+that.cd.wordclass+"_"+match.pposition).addClass(that.cd.maybeselfcorrectclass),prevmatch=match}))}},processunread:function(){var m=this;m.controls.eachword.each((function(index){var wordnumber=$(this).attr("data-wordnumber"),thespace=$("#"+m.cd.spaceclass+"_"+wordnumber);Number(wordnumber)>Number(m.options.endwordnumber)?($(this).addClass(m.cd.unreadwordclass),thespace.addClass(m.cd.unreadspaceclass),m.options.enforcemarker&&wordnumber in m.options.errorwords&&(delete m.options.errorwords[wordnumber],$(this).removeClass(m.cd.badwordclass))):($(this).removeClass(m.cd.unreadwordclass),thespace.removeClass(m.cd.unreadspaceclass))}))},processscores:function(){var m=this,errorscore=Object.keys(m.options.errorwords).length;m.controls.errorscorebox.text(errorscore);var wpmscore=0,strictwpmscore=0,totalwords=m.options.endwordnumber-errorscore;m.options.totalseconds>0&&(wpmscore=Math.round(60*totalwords/m.options.totalseconds),(totalwords-=errorscore)<0&&(totalwords=0),strictwpmscore=Math.round(60*totalwords/m.options.totalseconds)),m.options.wpm=wpmscore,m.controls.wpmscorebox.text(wpmscore);var accuracyscore=0;if(m.options.endwordnumber>0&&(accuracyscore=Math.round((m.options.endwordnumber-errorscore)/m.options.endwordnumber*100)),m.options.accuracy=accuracyscore,m.controls.accuracyscorebox.text(accuracyscore),m.options.sessionscoremethod==m.constants.SESSIONSCORE_STRICT)var usewpmscore=strictwpmscore;else usewpmscore=wpmscore;usewpmscore>m.options.targetwpm&&(usewpmscore=m.options.targetwpm);var sessionscore=Math.round(usewpmscore/m.options.targetwpm*100);m.controls.sessionscorebox.text(sessionscore),m.controls.formelementwpmscore.val(wpmscore),m.controls.formelementsessionscore.val(sessionscore),m.controls.formelementaccuracy.val(accuracyscore),m.controls.formelementendword.val(m.options.endwordnumber),m.controls.formelementerrors.val(JSON.stringify(m.options.errorwords))}}}));

//# sourceMappingURL=gradenowhelper.min.js.map