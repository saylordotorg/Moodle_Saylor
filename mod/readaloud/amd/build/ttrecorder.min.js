define ("mod_readaloud/ttrecorder",["jquery","core/log","mod_readaloud/ttaudiohelper","core/notification","mod_readaloud/ttbrowserrec"],function(a,b,c,d,e){"use strict";b.debug("TT Recorder: initialising");return{waveHeight:75,audio:{stream:null,blob:null,dataURI:null,start:null,end:null,isRecording:!1,isRecognizing:!1,transcript:null},submitting:!1,owner:"",controls:{},uniqueid:null,audio_updated:null,maxTime:15e3,passagehash:null,region:null,asrurl:null,lang:null,browserrec:null,usebrowserrec:!1,currentTime:0,ds_only:!1,clone:function clone(){return a.extend(!0,{},this)},init:function init(a){var f=this;this.uniqueid=a.uniqueid;this.callback=a.callback;this.ds_only=a.ds_only?a.ds_only:!1;this.prepare_html();this.controls.recordercontainer.show();this.register_events();var g=function(a){f.update_audio({stream:a,isRecording:!0});f.currentTime=0;f.interval=setInterval(function(){if(f.currentTime<f.maxTime){f.currentTime+=10}else{f.update_audio("isRecognizing",!0);f.audiohelper.stop()}},10)},h=function(a){switch(a.name){case"PermissionDeniedError":case"NotAllowedError":d.alert("Error","Please allow access to your microphone!","OK");break;case"DevicesNotFoundError":case"NotFoundError":d.alert("Error","No microphone detected!","OK");break;default:b.debug("Error",a.name);}},i=function(a){clearInterval(f.interval);var c={blob:a,dataURI:URL.createObjectURL(a),end:new Date,isRecording:!1,length:Math.round((f.audio.end-f.audio.start)/1e3)};f.update_audio(c);f.deepSpeech2(f.audio.blob,function(a){b.debug(a);f.update_audio("isRecognizing",!1);if("success"===a.data.result&&a.data.transcript){f.gotRecognition(a.data.transcript.trim())}else{d.alert("Information","We could not recognize your speech.","OK")}})};if(e.will_work_ok()&&!this.ds_only){b.debug("using browser rec");this.browserrec=e.clone();this.browserrec.init(this.lang,this.waveHeight,this.uniqueid);this.usebrowserrec=!0;f.browserrec.onerror=h;f.browserrec.onend=function(){};f.browserrec.onstart=function(){};f.browserrec.onfinalspeechcapture=function(a){f.gotRecognition(a);f.update_audio("isRecording",!1);f.update_audio("isRecognizing",!1)}}else{b.debug("using ds rec");this.audiohelper=c.clone();this.audiohelper.init(this.waveHeight,this.uniqueid,this);f.audiohelper.onError=h;f.audiohelper.onStop=i;f.audiohelper.onStream=g}},prepare_html:function prepare_html(){this.controls.recordercontainer=a("#ttrec_container_"+this.uniqueid);this.controls.recorderbutton=a("#ttrec_"+this.uniqueid+"_recorderdiv");this.passagehash=this.controls.recorderbutton.data("passagehash");this.region=this.controls.recorderbutton.data("region");this.asrurl=this.controls.recorderbutton.data("asrurl");this.lang=this.controls.recorderbutton.data("lang");this.maxTime=this.controls.recorderbutton.data("maxtime");this.waveHeight=this.controls.recorderbutton.data("waveheight")},update_audio:function update_audio(a,c){if("string"==typeof a){b.debug("update_audio:"+a+":"+c);if(this.audio[a]!==c){this.audio[a]=c;this.audio_updated()}}else{for(var d in a){this.audio[d]=a[d];b.debug("update_audio:"+d+":"+a[d])}this.audio_updated()}},register_events:function register_events(){var a=this;this.controls.recordercontainer.click(function(){a.toggleRecording()});this.audio_updated=function(){if(a.audio.isRecognizing){a.show_recorder_pointer("none")}else{a.show_recorder_pointer("auto")}if(a.audio.isRecognizing||a.audio.isRecording){this.controls.recorderbutton.css("background","#e52")}else{this.controls.recorderbutton.css("background","green")}a.controls.recorderbutton.html(a.recordBtnContent())}},show_recorder_pointer:function show_recorder_pointer(a){if(a){this.controls.recorderbutton.css("pointer-events","none")}else{this.controls.recorderbutton.css("pointer-events","auto")}},gotRecognition:function gotRecognition(a){b.debug("transcript:"+a);this.callback({type:"speech",capturedspeech:a})},cleanWord:function cleanWord(a){return a.replace(/['!"#$%&\\'()\*+,\-\.\/:;<=>?@\[\\\]\^_`{|}~']/g,"").toLowerCase()},recordBtnContent:function recordBtnContent(){if(!this.audio.isRecognizing){if(this.audio.isRecording){return"<i class=\"fa fa-stop\">"}else{return"<i class=\"fa fa-microphone\">"}}else{return"<i class=\"fa fa-spinner fa-spin\">"}},toggleRecording:function toggleRecording(){var a=this;if(this.audio.isRecognizing){return}if(this.audio.isRecording){if(this.usebrowserrec){clearInterval(a.interval);a.update_audio("isRecording",!1);a.update_audio("isRecognizing",!0);this.browserrec.stop()}else{this.update_audio("isRecognizing",!0);this.audiohelper.stop()}}else{if(this.usebrowserrec){this.update_audio("isRecording",!0);this.browserrec.start();a.currentTime=0;this.interval=setInterval(function(){if(a.currentTime<a.maxTime){a.currentTime+=10}else{a.update_audio("isRecording",!1);a.update_audio("isRecognizing",!0);clearInterval(a.interval);a.browserrec.stop()}},10)}else{var b={stream:null,blob:null,dataURI:null,start:new Date,end:null,isRecording:!1,isRecognizing:!1,transcript:null};this.update_audio(b);this.audiohelper.start()}}},deepSpeech2:function deepSpeech2(a,b){var c=new FormData,d=this.uniqueid+Math.floor(100*Math.random())+".wav";c.append("audioFile",a,d);c.append("scorer",this.passagehash);c.append("lang",this.lang);var e=new XMLHttpRequest;e.open("POST",this.asrurl,!0);e.onUploadProgress=function(){};e.onload=function(){if(200===e.status){b(JSON.parse(e.response))}else{b({data:{result:"error"}});console.error(e.error)}};try{e.send(c)}catch(a){b({data:{result:"error"}});console.error(a)}}}});
//# sourceMappingURL=ttrecorder.min.js.map
