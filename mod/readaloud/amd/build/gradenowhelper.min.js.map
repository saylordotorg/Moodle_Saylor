{"version":3,"sources":["../src/gradenowhelper.js"],"names":["define","$","log","def","popoverhelper","debug","controls","currentmode","constants","REVIEWMODE_NONE","REVIEWMODE_MACHINE","REVIEWMODE_HUMAN","REVIEWMODE_SCORESONLY","SESSIONSCORE_STRICT","cd","audioplayerclass","wordplayerclass","wordclass","spaceclass","badwordclass","endspaceclass","unreadwordclass","unreadspaceclass","wpmscoreid","accuracyscoreid","sessionscoreid","errorscoreid","formelementwpmscore","formelementaccuracy","formelementsessionscore","formelementendword","formelementtime","formelementerrors","modebutton","spotcheckbutton","transcriptcheckbutton","gradingbutton","clearbutton","spotcheckmode","aiunmatched","passagecontainer","maybeselfcorrectclass","selfcorrectclass","notesclass","structuralclass","meaningclass","visualclass","options","enabletts","targetwpm","ttslanguage","totalseconds","allowearlyexit","timelimit","enforcemarker","totalwordcount","wpm","accuracy","sessionscore","sessionscoremethod","endwordnumber","errorwords","activityid","attemptid","sesskey","init","config","theid","configcontrol","get","opts","JSON","parse","value","remove","register_controls","reviewmode","readonly","length","sessionmatches","aidata","transcriptwords","transcript","split","filter","el","redrawgradestate","thespace","addClass","register_events","m","processloadedaudio","sessiontime","audioplayer","duration","prop","isNaN","on","Math","round","val","processscores","init_popoverhelper","that","onReject","clickwordnumber","attr","nochange","playchain","fetchPlayChain","wordindex","startword","endword","theword","adderrorword","text","markup_aiunmatchedspaces","onAccept","removeClass","wordplayer","eachword","eachspace","endwordmarker","spotcheckword","wpmscorebox","accuracyscorebox","sessionscorebox","errorscorebox","wordnumber","parseInt","doPlaySpotCheck","click","hasClass","addQuickGrader","chunk","fetchTranscriptChunk","addTranscript","processunread","each","undoCurrentMode","doGradingMode","updateButtonStates","doSpotCheckMode","doTranscriptCheckMode","undoSpotCheckMode","undoTranscriptCheckMode","spotcheckindex","theplayer","pad","endtime","parseFloat","audioend","starttime","audiostart","currentTime","off","currenttime","pause","play","startindex","isbad","isunmatched","endindex","passageendword","markup_aiunmatchedwords","prevmatch","index","unmatchedcount","errorword","markup_badspaces","checkindex","transcriptlength","tposition","ret","slice","join","trim","playword","M","cfg","wwwroot","encodeURIComponent","load","markup_maybeselfcorrects","word","processword","processspace","match","verymaybe","pposition","errorscore","Object","keys","wpmscore","strictwpmscore","totalwords","accuracyscore","usewpmscore","stringify"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log', 'mod_readaloud/definitions', 'mod_readaloud/popoverhelper'], function ($, log, def, popoverhelper) {\n    \"use strict\"; // jshint ;_;\n\n    log.debug('Gradenow helper: initialising');\n\n    return {\n        //controls\n\n        controls: {},\n        currentmode: 'grading',\n\n        constants: {\n            REVIEWMODE_NONE: 0,\n            REVIEWMODE_MACHINE: 1,\n            REVIEWMODE_HUMAN: 2,\n            REVIEWMODE_SCORESONLY: 3,\n            SESSIONSCORE_STRICT: 1\n        },\n\n        //class definitions\n        cd: {\n            audioplayerclass: def.audioplayerclass,\n            wordplayerclass: def.wordplayerclass,\n            wordclass: def.wordclass,\n            spaceclass: def.spaceclass,\n            badwordclass: def.badwordclass,\n            endspaceclass: def.endspaceclass,\n            unreadwordclass: def.unreadwordclass,\n            unreadspaceclass: def.unreadspaceclass,\n            wpmscoreid: def.wpmscoreid,\n            accuracyscoreid: def.accuracyscoreid,\n            sessionscoreid: def.sessionscoreid,\n            errorscoreid: def.errorscoreid,\n            formelementwpmscore: def.formelementwpmscore,\n            formelementaccuracy: def.formelementaccuracy,\n            formelementsessionscore: def.formelementsessionscore,\n            formelementendword: def.formelementendword,\n            formelementtime: def.formelementtime,\n            formelementerrors: def.formelementerrors,\n            modebutton: def.modebutton,\n\n            spotcheckbutton: def.spotcheckbutton,\n            transcriptcheckbutton: def.transcriptcheckbutton,\n            gradingbutton: def.gradingbutton,\n            clearbutton: def.clearbutton,\n            spotcheckmode: def.spotcheckmode,\n            aiunmatched: def.aiunmatched,\n            passagecontainer: def.passagecontainer,\n\n            maybeselfcorrectclass: def.maybeselfcorrectclass,\n            selfcorrectclass: def.selfcorrectclass,\n            notesclass: def.notesclass,\n            structuralclass: def.structuralclass,\n            meaningclass: def.meaningclass,\n            visualclass: def.visualclass,\n\n        },\n\n        options: {\n            enabletts: false,\n            targetwpm: 100,\n            ttslanguage: 'en',\n            totalseconds: 60,\n            allowearlyexit: false,\n            timelimit: 60,\n            enforcemarker: true,\n            totalwordcount: 0,\n            wpm: 0,\n            accuracy: 0,\n            sessionscore: 0,\n            sessionscoremethod: 0,\n            endwordnumber: 0,\n            errorwords: {},\n            activityid: null,\n            attemptid: null,\n            sesskey: null\n        },\n\n\n        init: function (config) {\n\n            //pick up opts from html\n            var theid = '#' + config['id'];\n            var configcontrol = $(theid).get(0);\n            if (configcontrol) {\n                var opts = JSON.parse(configcontrol.value);\n                $(theid).remove();\n            } else {\n                //if there is no config we might as well give up\n                log.debug('Gradenow helper js: No config found on page. Giving up.');\n                return;\n            }\n\n            //register the controls\n            this.register_controls();\n\n            //stash important info\n            this.options.activityid = opts['activityid'];\n            this.options.attemptid = opts['attemptid'];\n            this.options.sesskey = opts['sesskey'];\n            this.options.enabletts = opts['enabletts'];\n            this.options.ttslanguage = opts['ttslanguage'];\n            this.options.targetwpm = opts['targetwpm'];\n            this.options.sessionscoremethod = opts['sessionscoremethod'];\n            this.options.allowearlyexit = opts['allowearlyexit'];\n            this.options.timelimit = opts['timelimit'];\n            this.options.reviewmode = opts['reviewmode'];\n            this.options.readonly = opts['readonly'];\n            this.options.totalwordcount = $('.' + this.cd.wordclass).length;\n\n            if (opts['sessiontime'] > 0) {\n                if (opts['sessionerrors'] !== '') {\n                    this.options.errorwords = JSON.parse(opts['sessionerrors']);\n                } else {\n                    this.options.errorwords = {};\n                }\n                this.options.totalseconds = opts['sessiontime'];\n                this.options.endwordnumber = opts['sessionendword'];\n                this.options.sessionscore = opts['sessionscore'];\n                this.options.accuracy = opts['accuracy'];\n                this.options.wpm = opts['wpm'];\n\n                //We may have session matches and AI data, if AI is turned on\n                this.options.sessionmatches = JSON.parse(opts['sessionmatches']);\n                this.options.aidata = opts['aidata'];\n                if (this.options.aidata) {\n                    this.options.transcriptwords = opts['aidata'].transcript.split(\" \");\n\n                    //remove empty elements ... these can get in there\n                    this.options.transcriptwords = this.options.transcriptwords.filter(function (el) {\n                        return el !== '';\n                    });\n\n                } else {\n                    this.options.transcriptwords = [];\n                }\n\n                //if this has been graded, draw the gradestate\n                this.redrawgradestate();\n            } else {\n                //set up our end passage marker\n                this.options.endwordnumber = this.options.totalwordcount;\n            }\n\n            //add the endword marker\n            var thespace = $('#' + this.cd.spaceclass + '_' + this.options.endwordnumber);\n            thespace.addClass(this.cd.endspaceclass);\n\n            //register events\n            this.register_events();\n\n            //initialise our audio duration. We need this to calc. wpm\n            //but if allowearlyexit is false, actually we can skip waiting for audio.\n            //After audio loaded(if nec.) we call processscores to init score boxe\n            //TODO: really should get audio duration at recording time.\n            var m = this;\n            var processloadedaudio = function () {\n                if (m.options.allowearlyexit ||m.options.timelimit==0 ) {\n                    //using the audio player duration is actually more accurate than aidata.sessiontime\n                    //but it will give diff results to score used in autograding which when allowing earlyexit uses aiddata.sessiontime\n                    // (aidata.sessiontime is the end time of last recognised word.)\n                    //So to ensure consistency we also use the aidata.sessiontime here\n                    if (m.options.aidata && m.options.aidata.sessiontime) {\n                        m.options.totalseconds = m.options.aidata.sessiontime;\n                    } else {\n                        var audioplayer = $('#' + m.cd.audioplayerclass);\n                        var duration = audioplayer.prop('duration');\n                        //this can fail if audio is not loaded yet. Lets wait for it to load and reset stuff\n                        //its better not to need this, but calcs all fail if we do not know the recording time\n                        if(isNaN(duration)) {\n                            m.options.totalseconds = 0;\n                            audioplayer.on('durationchange', processloadedaudio);\n                        }else{\n                            m.options.totalseconds = Math.round(duration);\n                        }\n                    }\n                } else {\n                    m.options.totalseconds = m.options.timelimit;\n                }\n                //update form field\n                m.controls.formelementtime.val(m.options.totalseconds);\n                m.processscores();\n            };\n\n            //processloaded audio\n            processloadedaudio();\n\n            //init our popover helper which sets up the button events\n            this.init_popoverhelper();\n\n\n        },\n\n        //set up events related to popover helper\n        init_popoverhelper: function () {\n            var that = this;\n\n            //when the user clicks the reject popover accept button, we arrive here\n            popoverhelper.onReject = function () {\n                var clickwordnumber = $(this).attr('data-wordnumber');\n\n                //if nothing changed, just close the popover\n                var nochange = (clickwordnumber in that.options.errorwords);\n                if (nochange) {\n                    popoverhelper.remove();\n                    return;\n                }\n\n                //if a new choice was made update things\n                var playchain = that.fetchPlayChain(clickwordnumber);\n                for (var wordindex = playchain.startword; wordindex <= playchain.endword; wordindex++) {\n                    if (!(wordindex in that.options.errorwords)) {\n                        var theword = $('#' + that.cd.wordclass + '_' + wordindex);\n                        var thespace = $('#' + that.cd.spaceclass + '_' + wordindex);\n                        if(wordindex==clickwordnumber) {\n                            that.adderrorword(wordindex, theword.text());\n                            theword.addClass(that.cd.badwordclass);\n                            theword.addClass(that.cd.spotcheckmode);\n                            if (wordindex !== playchain.endword) {\n                                thespace.addClass(that.cd.spotcheckmode);\n                            }\n                        }\n                    }\n                }\n                //that.markup_badspaces();\n                that.markup_aiunmatchedspaces();\n                that.processscores();\n                popoverhelper.remove();\n            };\n\n            //when the user clicks the popover accept button, we arrive here\n            popoverhelper.onAccept = function () {\n                var clickwordnumber = $(this).attr('data-wordnumber');\n\n                //if nothing changed, just close the popover\n                var nochange = !(clickwordnumber in that.options.errorwords);\n                if (nochange) {\n                    popoverhelper.remove();\n                    return;\n                }\n                //if a new choice was made update things\n                var playchain = that.fetchPlayChain(clickwordnumber);\n                for (var wordindex = playchain.startword; wordindex <= playchain.endword; wordindex++) {\n                    if (wordindex in that.options.errorwords) {\n                        if(wordindex==clickwordnumber) {\n                            delete that.options.errorwords[wordindex];\n                            var theword = $('#' + that.cd.wordclass + '_' + wordindex);\n                            var thespace = $('#' + that.cd.spaceclass + '_' + wordindex);\n                            theword.removeClass(that.cd.badwordclass);\n                            theword.removeClass(that.cd.spotcheckmode);\n                            thespace.removeClass(that.cd.spotcheckmode);\n                        }\n                    }\n                }\n                //that.markup_badspaces();\n                that.markup_aiunmatchedspaces();\n                that.processscores();\n                popoverhelper.remove();\n            };\n\n            //init the popover now that we have set the correct callback event handling thingies\n            popoverhelper.init();\n        },\n\n        register_controls: function () {\n\n            this.controls.wordplayer = $('#' + this.cd.wordplayerclass);\n            this.controls.audioplayer = $('#' + this.cd.audioplayerclass);\n            this.controls.eachword = $('.' + this.cd.wordclass);\n            this.controls.eachspace = $('.' + this.cd.spaceclass);\n            this.controls.endwordmarker = $('#' + this.cd.spaceclass + '_' + this.options.endwordnumber);\n            this.controls.spotcheckword = $('.' + this.cd.spotcheckmode);\n\n            this.controls.wpmscorebox = $('#' + this.cd.wpmscoreid);\n            this.controls.accuracyscorebox = $('#' + this.cd.accuracyscoreid);\n            this.controls.sessionscorebox = $('#' + this.cd.sessionscoreid);\n            this.controls.errorscorebox = $('#' + this.cd.errorscoreid);\n\n            this.controls.formelementwpmscore = $(\"#\" + this.cd.formelementwpmscore);\n            this.controls.formelementsessionscore = $(\"#\" + this.cd.formelementsessionscore);\n            this.controls.formelementaccuracy = $(\"#\" + this.cd.formelementaccuracy);\n            this.controls.formelementendword = $(\"#\" + this.cd.formelementendword);\n            this.controls.formelementerrors = $(\"#\" + this.cd.formelementerrors);\n            this.controls.formelementtime = $(\"#\" + this.cd.formelementtime);\n\n            this.controls.passagecontainer = $(\".\" + this.cd.passagecontainer);\n\n            //passage action buttons\n            this.controls.modebutton = $(\"#\" + this.cd.modebutton);\n\n            this.controls.gradingbutton = $(\"#\" + this.cd.gradingbutton);\n            this.controls.spotcheckbutton = $(\"#\" + this.cd.spotcheckbutton);\n            this.controls.transcriptcheckbutton = $(\"#\" + this.cd.transcriptcheckbutton);\n            this.controls.clearbutton = $(\"#\" + this.cd.clearbutton);\n\n        },\n\n        register_events: function () {\n            var that = this;\n            //set up event handlers\n\n\n            //Play audio from and to spot check part\n            this.controls.passagecontainer.on('click', '.' + this.cd.spotcheckmode + ', .' + this.cd.aiunmatched, function () {\n                if (that.currentmode === 'spotcheck') {\n                    var wordnumber = parseInt($(this).attr('data-wordnumber'));\n                    that.doPlaySpotCheck(wordnumber);\n                }\n            });\n\n\n            //in review mode, do nuffink though ... thats for the student\n            if (this.options.readonly) {\n                //do nothing\n\n                //here we will put real options for playing the model reading and user reading etc\n            } else if (false) {\n                /*\n                if(this.enabletts && this.options.ttslanguage != 'none'){\n                    this.controls.eachword.click(this.playword);\n                }\n                */\n\n                //if we have AI data then turn on spotcheckmode\n                if (this.options.sessionmatches) {\n                    this.doSpotCheckMode();\n                }\n\n                //add listeners for click events\n                this.controls.eachword.click(\n                    function () {\n                        //if we are in spotcheck mode just return, we do not grade\n                        if (that.currentmode === 'spotcheck') {\n                            return;\n                        }\n\n                        //get the word that was clicked\n                        var wordnumber = $(this).attr('data-wordnumber');\n                        var theword = $(this).text();\n\n                        if (that.currentmode === 'transcriptcheck') {\n                            var chunk = that.fetchTranscriptChunk(wordnumber);\n                            if (chunk) {\n                                popoverhelper.addTranscript(this, chunk);\n                            }\n\n\n                        }\n                    });\n\n                //if not in review mode\n            } else {\n\n                //process word clicks\n                this.controls.eachword.click(\n                    function () {\n\n\n                        //get the word that was clicked\n                        var wordnumber = $(this).attr('data-wordnumber');\n                        var theword = $(this).text();\n\n                        //if we are in spotcheck mode lets enable quick grade popovers\n                        if (that.currentmode === 'spotcheck') {\n                            if ($(this).hasClass(that.cd.badwordclass) || $(this).hasClass(that.cd.aiunmatched)) {\n                                popoverhelper.addQuickGrader(this);\n                            }\n                            return;\n                        }\n\n                        if (that.currentmode === 'transcriptcheck') {\n                            var chunk = that.fetchTranscriptChunk(wordnumber);\n                            if (chunk) {\n                                popoverhelper.addTranscript(this, chunk);\n                            }\n                            return;\n                        }\n\n                        //this will disallow badwords after the endmarker\n                        if (that.options.enforcemarker && Number(wordnumber) > Number(that.options.endwordnumber)) {\n                            return;\n                        }\n\n                        if (wordnumber in that.options.errorwords) {\n                            delete that.options.errorwords[wordnumber];\n                            $(this).removeClass(that.cd.badwordclass);\n                        } else {\n                            that.adderrorword(wordnumber, theword);\n                            $(this).addClass(that.cd.badwordclass);\n                        }\n                        that.processscores();\n                    }\n                ); //end of each word click\n\n                //process space clicks\n                this.controls.eachspace.click(\n                    function () {\n\n                        //if we are in spotcheck or transcript check mode just return, we do not grade\n                        if (that.currentmode === 'spotcheck' || that.currentmode === 'transcriptcheck') {\n                            return;\n                        }\n\n                        //this event is entered by  click on space\n                        //it relies on attr data-wordnumber being set correctly\n                        var wordnumber = $(this).attr('data-wordnumber');\n                        var thespace = $('#' + that.cd.spaceclass + '_' + wordnumber);\n\n                        if (wordnumber === that.options.endwordnumber) {\n                            that.options.endwordnumber = that.options.totalwordcount;\n                            thespace.removeClass(that.cd.endspaceclass);\n                            $('#' + that.cd.spaceclass + '_' + that.options.totalwordcount).addClass(that.cd.endspaceclass);\n                        } else {\n                            $('#' + that.cd.spaceclass + '_' + that.options.endwordnumber).removeClass(that.cd.endspaceclass);\n                            that.options.endwordnumber = wordnumber;\n                            thespace.addClass(that.cd.endspaceclass);\n                        }\n                        that.processunread();\n                        that.processscores();\n                    }\n                );//end of each space click\n\n                //process clearbutton's click event\n                this.controls.clearbutton.click(function () {\n\n                    //if we are in spotcheck or transcript check mode just return, we do not grade\n                    if (that.currentmode === 'spotcheck' || that.currentmode === 'transcriptcheck') {\n                        return;\n                    }\n\n                    //clear all the error words\n                    $('.' + that.cd.badwordclass).each(function (index) {\n                        var wordnumber = $(this).attr('data-wordnumber');\n                        delete that.options.errorwords[wordnumber];\n                        $(this).removeClass(that.cd.badwordclass);\n                    });\n\n                    //remove unread words\n                    $('.' + that.cd.wordclass).removeClass(that.cd.unreadwordclass);\n\n                    //set endspace to last space\n                    that.options.endwordnumber = that.options.totalwordcount;\n                    $('.' + that.cd.spaceclass).removeClass(that.cd.endspaceclass);\n                    $('#' + that.cd.spaceclass + '_' + that.options.totalwordcount).addClass(that.cd.endspaceclass);\n\n                    //reprocess scores\n                    that.processscores();\n                });\n\n\n                //modebutton: turn on grading\n                this.controls.gradingbutton.click(function () {\n                    that.undoCurrentMode();\n                    that.doGradingMode();\n                    that.updateButtonStates();\n                });\n\n            }//end of if/else reviewmode\n\n            //either in or out of review mode we want these\n            //modebutton: turn on spotchecking\n            this.controls.spotcheckbutton.click(function () {\n                that.undoCurrentMode();\n                that.doSpotCheckMode();\n                that.updateButtonStates();\n            });\n\n            //modebutton: turn on transcript checking\n            this.controls.transcriptcheckbutton.click(function () {\n                that.undoCurrentMode();\n                that.doTranscriptCheckMode();\n                that.updateButtonStates();\n            });\n\n\n        },\n\n        undoCurrentMode: function () {\n            switch (this.currentmode) {\n                case 'grading':\n                    //we do not undo this, its the default\n                    break;\n                case 'spotcheck':\n                    this.undoSpotCheckMode();\n                    break;\n                case 'transcriptcheck':\n                    this.undoTranscriptCheckMode();\n                    break;\n            }\n\n        },\n\n        updateButtonStates: function () {\n            switch (this.currentmode) {\n                case 'grading':\n                    this.controls.gradingbutton.prop('disabled', true);\n                    this.controls.spotcheckbutton.prop('disabled', false);\n                    this.controls.transcriptcheckbutton.prop('disabled', false);\n                    break;\n                case 'spotcheck':\n                    this.controls.gradingbutton.prop('disabled', false);\n                    this.controls.spotcheckbutton.prop('disabled', true);\n                    this.controls.transcriptcheckbutton.prop('disabled', false);\n                    break;\n                case 'transcriptcheck':\n                    this.controls.gradingbutton.prop('disabled', false);\n                    this.controls.spotcheckbutton.prop('disabled', false);\n                    this.controls.transcriptcheckbutton.prop('disabled', true);\n                    break;\n            }\n\n        },\n\n        /*\n        * Here we fetch the playchain, start playing frm audiostart and add an event handler to stop at audioend\n         */\n        doPlaySpotCheck: function (spotcheckindex) {\n            var playchain = this.fetchPlayChain(spotcheckindex);\n            var theplayer = this.controls.audioplayer[0];\n            //we pad the play audio by 0.5 seconds beginning and end\n            var pad = 0.5;\n            var duration = theplayer.duration;\n            //determine starttime\n            var endtime = parseFloat(playchain.audioend);\n            if (!isNaN(duration) && duration > (endtime + pad)) {\n                endtime = endtime + pad;\n            }\n            //determine endtime\n            var starttime = parseFloat(playchain.audiostart);\n            if ((starttime - pad) > 0) {\n                starttime = starttime - pad;\n            }\n\n            theplayer.currentTime = starttime;\n            $(this.controls.audioplayer).off(\"timeupdate\");\n            $(this.controls.audioplayer).on(\"timeupdate\", function (e) {\n                var currenttime = theplayer.currentTime;\n                if (currenttime >= endtime) {\n                    $(this).off(\"timeupdate\");\n                    theplayer.pause();\n                }\n            });\n            theplayer.play();\n        },\n\n        /*\n        * The playchain is all the words in a string of badwords.\n        * The complexity comes because a bad word  is usually one that isunmatched by AI.\n        * So if the teacher clicks on a passage word that did not appear in the transcript, what should we play?\n        * Answer: All the words from the last known to the next known word. Hence we create a play chain\n        * For consistency, if the teacher flags matched words as bad, while we do know their precise location we still\n        * make a play chain. Its not a common situation probably.\n         */\n        fetchPlayChain: function (spotcheckindex) {\n\n            //find startword\n            var startindex = spotcheckindex;\n            var starttime = -1;\n            for (var wordnumber = spotcheckindex; wordnumber > 0; wordnumber--) {\n                var isbad = $('#' + this.cd.wordclass + '_' + wordnumber).hasClass(this.cd.badwordclass);\n                var isunmatched = $('#' + this.cd.wordclass + '_' + wordnumber).hasClass(this.cd.aiunmatched);\n                //if current wordnumber part of the playchain, set it as the startindex.\n                // And get the audiotime if its a matched word. (we only know audiotime of matched words)\n                if (isbad || isunmatched) {\n                    startindex = wordnumber;\n                    if (!isunmatched) {\n                        starttime = this.options.sessionmatches['' + wordnumber].audiostart;\n                    } else {\n                        starttime = -1;\n                    }\n                } else {\n                    break;\n                }\n            }//end of for loop --\n            //if we have no starttime then we need to get the next matched word's audioend and use that\n            if (starttime === -1) {\n                starttime = 0;\n                for (var wordnumber = startindex - 1; wordnumber > 0; wordnumber--) {\n                    if (this.options.sessionmatches['' + wordnumber]) {\n                        starttime = this.options.sessionmatches['' + wordnumber].audioend;\n                        break;\n                    }\n                }\n            }\n\n            //find endword\n            var endindex = spotcheckindex;\n            var endtime = -1;\n            var passageendword = this.options.totalwordcount;\n            for (var wordnumber = spotcheckindex; wordnumber <= passageendword; wordnumber++) {\n                var isbad = $('#' + this.cd.wordclass + '_' + wordnumber).hasClass(this.cd.badwordclass);\n                var isunmatched = $('#' + this.cd.wordclass + '_' + wordnumber).hasClass(this.cd.aiunmatched);\n                //if its part of the playchain, set it to startindex. And get time if its a matched word.\n                if (isbad || isunmatched) {\n                    endindex = wordnumber;\n                    if (!isunmatched) {\n                        endtime = this.options.sessionmatches['' + wordnumber].audioend;\n                    } else {\n                        endtime = -1;\n                    }\n                } else {\n                    break;\n                }\n            }//end of for loop --\n            //if we have no endtime then we need to get the next matched word's audiostart and use that\n            if (endtime === -1) {\n                endtime = this.options.totalseconds;\n                for (var wordnumber = endindex + 1; wordnumber <= passageendword; wordnumber++) {\n                    if (this.options.sessionmatches['' + wordnumber]) {\n                        endtime = this.options.sessionmatches['' + wordnumber].audiostart;\n                        break;\n                    }\n                }\n            }\n            var playchain = {};\n            playchain.startword = startindex;\n            playchain.endword = parseInt(endindex);\n            playchain.audiostart = starttime;\n            playchain.audioend = parseInt(endtime);\n            //console.log('audiostart:' + starttime);\n            //console.log('audioend:' + endtime);\n\n            return playchain;\n\n        },\n\n        /*\n        * Here we mark up the passage for spotcheck mode. This will make up the spaces and the words as either badwords\n        * or aiunmatched words. We need to create playchains so aiunmatched still is indeicated visibly even where its\n        * not a badword (ie has been corrected)\n         */\n        doSpotCheckMode: function () {\n            var that = this;\n\n            //mark up all ai unmatched words as aiunmatched\n            this.markup_aiunmatchedwords();\n\n            //mark up all badwords as spotcheck words\n            $('.' + this.cd.badwordclass).addClass(this.cd.spotcheckmode);\n\n            //mark up spaces between spotcheck word and spotcheck/aiunmatched word (bad spaces)\n            //this.markup_badspaces();\n\n            //mark up spaces between aiunmatched word and spotcheck/aiunmatched word (aiunmatched spaces)\n            this.markup_aiunmatchedspaces();\n\n            this.currentmode = \"spotcheck\";\n        },\n\n        //mark up all ai unmatched words as aiunmatched\n        markup_aiunmatchedwords: function () {\n            var that = this;\n            if (this.options.sessionmatches) {\n                var prevmatch = 0;\n                $.each(this.options.sessionmatches, function (index, match) {\n                    var unmatchedcount = index - prevmatch - 1;\n                    if (unmatchedcount > 0) {\n                        for (var errorword = 1; errorword < unmatchedcount + 1; errorword++) {\n                            var wordnumber = prevmatch + errorword;\n                            $('#' + that.cd.wordclass + '_' + wordnumber).addClass(that.cd.aiunmatched);\n                        }\n                    }\n                    prevmatch = parseInt(index);\n                });\n\n                //mark all words from last matched word to the end as aiunmatched\n                for (var errorword = prevmatch + 1; errorword <= this.options.endwordnumber; errorword++) {\n                    $('#' + that.cd.wordclass + '_' + errorword).addClass(that.cd.aiunmatched);\n                }\n            }\n\n        },\n\n        //mark up spaces between spotcheck word and spotcheck/aiunmatched word (bad spaces)\n        /* NO LONGER USED  */\n        markup_badspaces: function () {\n            var that = this;\n            //mark up spaces between spotcheck word and spotcheck/aiunmatched word (bad spaces)\n            $('.' + this.cd.badwordclass + '.' + this.cd.spotcheckmode).each(function (index) {\n                var wordnumber = parseInt($(this).attr('data-wordnumber'));\n                //build chains (highlight spaces) of badwords or aiunmatched\n                if ($('#' + that.cd.wordclass + '_' + (wordnumber + 1)).hasClass(that.cd.spotcheckmode) ||\n                    $('#' + that.cd.wordclass + '_' + (wordnumber + 1)).hasClass(that.cd.aiunmatched)) {\n                    $('#' + that.cd.spaceclass + '_' + wordnumber).addClass(that.cd.spotcheckmode);\n                }\n            });\n        },\n\n        markup_aiunmatchedspaces: function () {\n            var that = this;\n            $('.' + this.cd.wordclass + '.' + this.cd.aiunmatched).each(function (index) {\n                var wordnumber = parseInt($(this).attr('data-wordnumber'));\n                //build chains (highlight spaces) of badwords or aiunmatched\n                if ($('#' + that.cd.wordclass + '_' + (wordnumber + 1)).hasClass(that.cd.spotcheckmode) ||\n                    $('#' + that.cd.wordclass + '_' + (wordnumber + 1)).hasClass(that.cd.aiunmatched)) {\n                    $('#' + that.cd.spaceclass + '_' + wordnumber).addClass(that.cd.aiunmatched);\n                }\n            });\n        },\n\n\n        undoSpotCheckMode: function () {\n            $('.' + this.cd.badwordclass).removeClass(this.cd.spotcheckmode);\n            $('.' + this.cd.spaceclass).removeClass(this.cd.spotcheckmode);\n            $('.' + this.cd.wordclass).removeClass(this.cd.aiunmatched);\n            $('.' + this.cd.spaceclass).removeClass(this.cd.aiunmatched);\n            $(this.controls.audioplayer).off(\"timeupdate\");\n            popoverhelper.remove();\n        },\n\n        /*\n       * Here we mark up the passage for transcriptcheck mode.\n        */\n        doTranscriptCheckMode: function () {\n            var that = this;\n            //mark up all ai unmatched words as transcriptcheck\n            if (this.options.sessionmatches) {\n                var prevmatch = 0;\n                $.each(this.options.sessionmatches, function (index, match) {\n                    var unmatchedcount = index - prevmatch - 1;\n                    if (unmatchedcount > 0) {\n                        for (var errorword = 1; errorword < unmatchedcount + 1; errorword++) {\n                            var wordnumber = prevmatch + errorword;\n                            $('#' + that.cd.wordclass + '_' + wordnumber).addClass(that.cd.aiunmatched);\n                        }\n                    }\n                    prevmatch = parseInt(index);\n                });\n\n                //mark all words from last matched word to the end as aiunmatched\n                for (var errorword = prevmatch + 1; errorword <= this.options.endwordnumber; errorword++) {\n                    $('#' + that.cd.wordclass + '_' + errorword).addClass(that.cd.aiunmatched);\n                }\n            }\n\n            //mark up spaces between aiunmatched word and aiunmatched (bad spaces)\n            $('.' + this.cd.aiunmatched).each(function (index) {\n                var wordnumber = parseInt($(this).attr('data-wordnumber'));\n                //build chains (highlight spaces) of badwords or aiunmatched\n                if ($('#' + that.cd.wordclass + '_' + (wordnumber + 1)).hasClass(that.cd.aiunmatched)) {\n                    $('#' + that.cd.spaceclass + '_' + wordnumber).addClass(that.cd.aiunmatched);\n                }\n            });\n\n            this.currentmode = \"transcriptcheck\";\n        },\n\n        undoTranscriptCheckMode: function () {\n            $('.' + this.cd.wordclass).removeClass(this.cd.aiunmatched);\n            $('.' + this.cd.spaceclass).removeClass(this.cd.aiunmatched);\n            popoverhelper.remove();\n        },\n\n        doGradingMode: function () {\n            this.currentmode = \"grading\";\n        },\n\n        /*\n       * This will take a wordindex and find the previous and next transcript indexes that were matched and\n       * return all the transcript words in between those.\n        */\n        fetchTranscriptChunk: function (checkindex) {\n\n            var transcriptlength = this.options.transcriptwords.length;\n            if (transcriptlength === 0) {\n                return \"\";\n            }\n\n            //find startindex\n            var startindex = -1;\n            for (var wordnumber = checkindex; wordnumber > 0; wordnumber--) {\n\n                var isunmatched = $('#' + this.cd.wordclass + '_' + wordnumber).hasClass(this.cd.aiunmatched);\n                //if we matched then the subsequent transcript word is the last unmatched one in the checkindex sequence\n                if (!isunmatched) {\n                    startindex = this.options.sessionmatches['' + wordnumber].tposition + 1;\n                    break;\n                }\n            }//end of for loop\n\n            //find endindex\n            var endindex = -1;\n            for (var wordnumber = checkindex; wordnumber <= transcriptlength; wordnumber++) {\n\n                var isunmatched = $('#' + this.cd.wordclass + '_' + wordnumber).hasClass(this.cd.aiunmatched);\n                //if we matched then the previous transcript word is the last unmatched one in the checkindex sequence\n                if (!isunmatched) {\n                    endindex = this.options.sessionmatches['' + wordnumber].tposition - 1;\n                    break;\n                }\n            }//end of for loop --\n\n            //if there was no previous matched word, we set start to 1\n            if (startindex === -1) {\n                startindex = 1;\n            }\n            //if there was no subsequent matched word we flag the end as the -1\n            if (endindex === transcriptlength) {\n                endindex = -1;\n                //an edge case is where the first word is not in transcript and first match is the second or later passage\n                //word. It might not be possible for endindex to be lower than start index, but we don't want it anyway\n            } else if (endindex === 0 || endindex < startindex) {\n                return false;\n            }\n\n            //up until this point the indexes have started from 1, since the passage word numbers start from 1\n            //but the transcript array is 0 based so we adjust. array splice function does not include item and endindex\n            ///so it needs to be one more then start index. hence we do not adjust that\n            startindex--;\n\n            //finally we return the section\n            var ret = false;\n            if (endindex > 0) {\n                ret = this.options.transcriptwords.slice(startindex, endindex).join(\" \");\n            } else {\n                ret = this.options.transcriptwords.slice(startindex).join(\" \");\n            }\n            if (ret.trim() === '') {\n                return false;\n            } else {\n                return ret;\n            }\n        },\n\n\n        playword: function () {\n            var m = this;//M.mod_readaloud.gradenowhelper;\n            m.controls.wordplayer.attr('src', M.cfg.wwwroot + '/mod/readaloud/tts.php?txt=' + encodeURIComponent($(this).text())\n                + '&lang=' + m.options.ttslanguage + '&n=' + m.options.activityid);\n            m.controls.wordplayer[0].pause();\n            m.controls.wordplayer[0].load();\n            m.controls.wordplayer[0].play();\n        },\n        redrawgradestate: function () {\n            var m = this;\n            this.processunread();\n            if (this.options.reviewmode !== this.constants.REVIEWMODE_SCORESONLY) {\n                $.each(m.options.errorwords, function (index) {\n                        $('#' + m.cd.wordclass + '_' + m.options.errorwords[index].wordnumber).addClass(m.cd.badwordclass);\n                    }\n                );\n            }\n\n            this.markup_maybeselfcorrects();\n\n        },\n        adderrorword: function (wordnumber, word) {\n            this.options.errorwords[wordnumber] = {word: word, wordnumber: wordnumber};\n            //console.log(this.errorwords);\n\n        },\n        processword: function () {\n            var m = this;\n            var wordnumber = $(this).attr('data-wordnumber');\n            var theword = $(this).text();\n            //this will disallow badwords after the endmarker\n            if (m.options.enforcemarker && Number(wordnumber) > Number(m.options.endwordnumber)) {\n                return;\n            }\n\n            if (wordnumber in m.options.errorwords) {\n                delete m.options.errorwords[wordnumber];\n                $(this).removeClass(m.cd.badwordclass);\n            } else {\n                m.adderrorword(wordnumber, theword);\n                $(this).addClass(m.cd.badwordclass);\n            }\n            m.processscores();\n        },\n        //this function is never called it seems ....\n        processspace: function () {\n            //this event is entered by  click on space\n            //it relies on attr data-wordnumber being set correctly\n            var m = this;\n            var wordnumber = $(this).attr('data-wordnumber');\n            var thespace = $('#' + m.cd.spaceclass + '_' + wordnumber);\n\n            if (wordnumber === m.options.endwordnumber) {\n                m.options.endwordnumber = m.options.totalwordcount;\n                thespace.removeClass(m.cd.endspaceclass);\n                $('#' + m.cd.spaceclass + '_' + m.options.totalwordcount).addClass(m.cd.endspaceclass);\n            } else {\n                $('#' + m.cd.spaceclass + '_' + m.options.endwordnumber).removeClass(m.cd.endspaceclass);\n                m.options.endwordnumber = wordnumber;\n                thespace.addClass(m.cd.endspaceclass);\n            }\n            m.processunread();\n            m.processscores();\n        },\n\n        markup_maybeselfcorrects: function () {\n            var that = this;\n            if (this.options.sessionmatches) {\n                var prevmatch = false;\n                //loop through matches checking for insertions prior to matches\n                $.each(this.options.sessionmatches, function (index, match) {\n                    var maybe = false; // insertions exist between this match and prev match\n                    var verymaybe = false; //this word is matched and prev word is matched, but insertions exist\n\n                    if (prevmatch) {\n                        if (match.tposition - prevmatch.tposition > 1 && match.pposition - prevmatch.pposition === 1) {\n                            maybe = true;\n                            verymaybe = true;\n                        } else {\n                            if (match.tposition - prevmatch.tposition > 1) {\n                                maybe = true;\n                            }\n                        }\n                    } else if (prevmatch === false) {\n                        if (match.pposition < match.tposition) {\n                            maybe = true;\n                        }\n                    }\n                    //for now we will just work with very maybes, but we could do maybes\n                    if (verymaybe) {\n                        $('#' + that.cd.wordclass + '_' + match.pposition).addClass(that.cd.maybeselfcorrectclass);\n                    }\n                    prevmatch = match;\n                });\n            }\n        },\n\n        processunread: function () {\n            var m = this;\n            m.controls.eachword.each(function (index) {\n                var wordnumber = $(this).attr('data-wordnumber');\n                var thespace = $('#' + m.cd.spaceclass + '_' + wordnumber);\n\n                if (Number(wordnumber) > Number(m.options.endwordnumber)) {\n                    $(this).addClass(m.cd.unreadwordclass);\n                    thespace.addClass(m.cd.unreadspaceclass);\n\n                    //this will clear badwords after the endmarker\n                    if (m.options.enforcemarker && wordnumber in m.options.errorwords) {\n                        delete m.options.errorwords[wordnumber];\n                        $(this).removeClass(m.cd.badwordclass);\n                    }\n                } else {\n                    $(this).removeClass(m.cd.unreadwordclass);\n                    thespace.removeClass(m.cd.unreadspaceclass);\n                }\n            });\n        },\n        processscores: function () {\n            var m = this;\n            var errorscore = Object.keys(m.options.errorwords).length;\n            m.controls.errorscorebox.text(errorscore);\n\n            //wpm score\n            //we do not apply accuracy adjustment here, that is only for machine grades.\n            var wpmscore = 0;\n            var strictwpmscore = 0;\n            var totalwords=m.options.endwordnumber - errorscore;\n            if (m.options.totalseconds > 0) {\n\n                //regular WPM\n                wpmscore = Math.round((totalwords * 60) / m.options.totalseconds);\n\n                //strict WPM for grading\n                totalwords = totalwords - errorscore;\n                if(totalwords < 0){totalwords =0;}\n                strictwpmscore = Math.round((totalwords * 60) / m.options.totalseconds);\n            }\n            m.options.wpm = wpmscore;\n            m.controls.wpmscorebox.text(wpmscore);\n\n            //accuracy score\n            var accuracyscore = 0;\n            if (m.options.endwordnumber > 0) {\n                accuracyscore = Math.round((m.options.endwordnumber - errorscore) / m.options.endwordnumber * 100);\n            }\n            m.options.accuracy = accuracyscore;\n            m.controls.accuracyscorebox.text(accuracyscore);\n\n            //sessionscore\n            if(m.options.sessionscoremethod == m.constants.SESSIONSCORE_STRICT) {\n                var usewpmscore = strictwpmscore;\n            }else{\n                var usewpmscore = wpmscore;\n            }\n\n            if (usewpmscore > m.options.targetwpm) {\n                usewpmscore = m.options.targetwpm;\n            }\n            var sessionscore = Math.round(usewpmscore / m.options.targetwpm * 100);\n            m.controls.sessionscorebox.text(sessionscore);\n\n            //update form field\n            m.controls.formelementwpmscore.val(wpmscore);\n            m.controls.formelementsessionscore.val(sessionscore);\n            m.controls.formelementaccuracy.val(accuracyscore);\n            m.controls.formelementendword.val(m.options.endwordnumber);\n            m.controls.formelementerrors.val(JSON.stringify(m.options.errorwords));\n\n        }\n\n    };\n});"],"file":"gradenowhelper.min.js"}