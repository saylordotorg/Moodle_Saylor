define(["jquery","core/log","mod_readaloud/definitions","core/str","core/ajax","core/notification"],(function($,log,def,str,Ajax,notification){return log.debug("Click to hear: initialising"),{controls:{},ready:!1,remotetranscribe:!1,attemptid:0,checking:"... checking ...",secstillcheck:"Checking again in: ",notgradedyet:"Your reading has not been evaluated yet.",evaluated:"Your reading has been evaluated.",init:function(opts){this.attemptid=opts.attemptid,this.ready=opts.ready,this.remotetranscribe=opts.remotetranscribe,this.filename=opts.filename,this.register_controls(),this.register_events(),!this.ready&&this.remotetranscribe&&this.attemptid&&(this.check_for_results(this,15),this.check_for_audio(0))},init_strings:function(){var that=this;str.get_string("checking","mod_readaloud").done((function(s){that.checking=s})),str.get_string("secs_till_check","mod_readaloud").done((function(s){that.secstillcheck=s})),str.get_string("notgradedyet","mod_readaloud").done((function(s){that.notgradedyet=s})),str.get_string("evaluatedmessage","mod_readaloud").done((function(s){that.evaluated=s}))},register_controls:function(){this.controls.heading=$("."+def.smallreportheading),this.controls.player=$("."+def.smallreportplayer),this.controls.dummyplayer=$("."+def.smallreportdummyplayer),this.controls.rating=$("."+def.smallreportrating),this.controls.status=$("."+def.smallreportstatus),this.controls.fullreportbutton=$("."+def.fullreportbutton)},register_events:function(){},check_for_audio:function(waitms){var that=this;$.ajax({url:that.filename,method:"HEAD",cache:!1,error:function(){log.debug("403 errors are normal here, till the audio file arrives back from conversion"),setTimeout((function(){that.check_for_audio(waitms+500)}),waitms)},success:function(data,textStatus,xhr){if(200===xhr.status)that.controls.player.attr("src",that.filename),that.controls.player.show(),that.controls.dummyplayer.hide();else setTimeout((function(){that.check_for_audio(waitms+500)}),waitms)}})},check_for_results:function(that,seconds){if((seconds-=1)>0)return setTimeout(that.check_for_results,1e3,that,seconds),void that.controls.status.text(that.secstillcheck+seconds);that.controls.status.text(that.checking),Ajax.call([{methodname:"mod_readaloud_check_for_results",args:{attemptid:that.attemptid},done:function(ajaxresult){var payloadobject=JSON.parse(ajaxresult);if(payloadobject)if(!0===payloadobject.ready){log.debug("result fetched");for(var stars="",star=0;star<5;star++)stars+=payloadobject.rating>star?'<i class="fa fa-lg fa-star"></i>':'<i class="fa fa-lg fa-star-o"></i>';that.controls.heading.text(that.evaluated),that.controls.rating.html(stars),that.controls.status.hide(),that.controls.fullreportbutton.show()}else log.debug("result not fetched"),setTimeout(that.check_for_results,1e3,that,15),that.controls.status.text(that.secstillcheck+seconds)},fail:notification.exception}])}}}));

//# sourceMappingURL=smallreporthelper.min.js.map