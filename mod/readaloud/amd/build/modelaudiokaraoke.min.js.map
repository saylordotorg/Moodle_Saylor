{"version":3,"sources":["../src/modelaudiokaraoke.js"],"names":["define","$","log","def","debug","controls","breaks","endwordnumber","currentstartbreak","modeling","cd","audioplayerclass","wordplayerclass","wordclass","spaceclass","endspaceclass","passagecontainer","activesentence","stopbutton","playbutton","init","opts","JSON","parse","set_breaks","register_controls","eachword","length","register_events","sort_breaks","number_breaks","sort","a","b","audiotime","that","i","breaknumber","pause_audio","audioplayer","pause","play_audio","play","fetch_audio_url","attr","eachspace","eachwordorspace","aplayer","on","currentTime","wordnumber","parseInt","nearest_start_break","ended","removeClass","onended","onpause","ontimeupdate","startbreak","nextbreak","finishedsentence","text","previousstartbreak","thewordnumber","addClass","on_reach_audio_break","sentence","oldbreak","newbreak"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log', 'mod_readaloud/definitions'], function($, log, def) {\n  \"use strict\"; // jshint ;_;\n  /*\n  This file runs preview and shadow and L-and-R modes, highlighting text as the player reaches it.\n   */\n\n  log.debug('Model Audio Karaoke: initialising');\n\n  return {\n    controls: {},\n    breaks: [],\n    endwordnumber: 0,\n    currentstartbreak: false,\n    modeling: false,\n\n    //class definitions\n    cd: {\n      audioplayerclass: def.audioplayerclass,\n      wordplayerclass: def.wordplayerclass,\n      wordclass: def.wordclass,\n      spaceclass: def.spaceclass,\n      endspaceclass: def.endspaceclass,\n      passagecontainer: def.passagecontainer,\n      activesentence: def.activesentence,\n      stopbutton: 'mod_readaloud_button_stop',\n      playbutton: 'mod_readaloud_button_play'\n    },\n\n    //init the module\n    init: function(opts) {\n      if (opts.breaks) {\n        var breaks = JSON.parse(opts.breaks);\n        this.set_breaks(breaks);\n      }\n      if (opts.modeling) {\n        this.modeling = true;\n      }\n      if (opts.audioplayerclass) {\n        this.cd.audioplayerclass = opts.audioplayerclass;\n      }\n\n      //register the controls\n      this.register_controls();\n\n      //register the end word number\n      this.endwordnumber = this.controls.eachword.length;\n\n      //register the events\n      this.register_events();\n    },\n\n    set_breaks: function(breaks) {\n      this.breaks = breaks;\n      this.sort_breaks();\n      this.number_breaks();\n    },\n\n    sort_breaks: function() {\n      this.breaks.sort(function(a, b) {\n        return a.audiotime - b.audiotime\n      });\n    },\n\n    number_breaks: function(){\n      var that=this;\n        for (var i = 0; i < that.breaks.length; i++) {\n           that.breaks[i].breaknumber=i+1;\n        }\n    },\n\n    pause_audio: function() {\n      this.controls.audioplayer[0].pause();\n    },\n\n    play_audio: function() {\n      this.controls.audioplayer[0].play();\n    },\n\n    fetch_audio_url: function() {\n      return this.controls.audioplayer.attr('src');\n    },\n\n    //load all the controls so we do not have to do it later\n    register_controls: function() {\n      this.controls.audioplayer = $('#' + this.cd.audioplayerclass);\n      this.controls.eachword = $('.' + this.cd.wordclass);\n      this.controls.eachspace = $('.' + this.cd.spaceclass);\n      this.controls.eachwordorspace = $('.' + this.cd.spaceclass + ',.' + this.cd.wordclass);\n      this.controls.passagecontainer = $(\".\" + this.cd.passagecontainer);\n      this.controls.stopbutton = $('#' + this.cd.stopbutton);\n      this.controls.playbutton = $('#' + this.cd.playbutton);\n    },\n\n    //attach the various event handlers we need\n    register_events: function() {\n      var that = this;\n\n      // Get the audio element\n      var aplayer = this.controls.audioplayer[0];\n\n      this.controls.playbutton.on('click', function() {\n        aplayer.play();\n      });\n\n      this.controls.stopbutton.on('click', function() {\n        aplayer.pause();\n        aplayer.currentTime=0;\n      });\n\n      //if we are not modeling we want to jump to the clicked location\n      //if we are modeling the meaning of a click is to place a marker, so we do not want to jump\n      if (!this.modeling) {\n        this.controls.eachwordorspace.on('click', function() {\n          var wordnumber = parseInt($(this).attr('data-wordnumber'));\n          var nearest_start_break = false;\n          for (var i = 0; i < that.breaks.length; i++) {\n            if (that.breaks[i].wordnumber < wordnumber) {\n              nearest_start_break = that.breaks[i];\n            } else {\n              //exit the loop;\n              break;\n            }\n          }\n          if (!nearest_start_break) {\n            //start from beginning OR do nothing\n          } else {\n            aplayer.pause();\n            aplayer.currentTime = nearest_start_break.audiotime;\n            aplayer.play();\n          }\n        }); //end of eachwordorspace\n      } //end of if not modeling\n\n      //Player events (onended, onpause, ontimeupdate)\n      var ended = function() {\n        that.controls.eachword.removeClass(that.cd.activesentence);\n        that.controls.eachspace.removeClass(that.cd.activesentence);\n        that.currentstartbreak = false;\n      };\n\n      aplayer.onended = ended;\n      aplayer.onpause = ended;\n\n      aplayer.ontimeupdate = function() {\n        var currentTime = aplayer.currentTime;\n        var startbreak = false;\n        var nextbreak = false;\n        for (var i = 0; i < that.breaks.length; i++) {\n\n          //if this is the last marked break (ie flow till end)\n          if (currentTime >= that.breaks[i].audiotime && i + 1 === that.breaks.length) {\n            startbreak = that.breaks[i];\n            nextbreak = {\n              wordnumber: that.endwordnumber + 1,\n              audiotime: 0\n            };\n            //if its just between two breaks (yay)\n          } else if (currentTime >= that.breaks[i].audiotime && currentTime < that.breaks[i + 1].audiotime) {\n            startbreak = that.breaks[i];\n            nextbreak = that.breaks[i + 1];\n            break;\n            //this is the first section\n          } else if (i === 0 && currentTime < that.breaks[i].audiotime && currentTime > 0) {\n            startbreak = {\n              wordnumber: 0,\n              audiotime: 0,\n              breaknumber: 0\n            };\n            nextbreak = that.breaks[i];\n\n          }\n        }\n        //if the current break changed since last time, we do not want to do anything\n        // (on first time through we want to flag  \"changed\" so that is why a false current startbreak goes to \"changed\"\n        if (that.currentstartbreak === false || startbreak.wordnumber !== that.currentstartbreak.wordnumber) {\n          var finishedsentence = $('.' + that.cd.activesentence).text();\n          that.previousstartbreak = that.currentstartbreak;\n          that.currentstartbreak = startbreak;\n          that.controls.eachword.removeClass(that.cd.activesentence);\n          that.controls.eachspace.removeClass(that.cd.activesentence);\n          if (startbreak !== false && nextbreak !== false) {\n            for (var thewordnumber = startbreak.wordnumber + 1; thewordnumber <= nextbreak.wordnumber; thewordnumber++) {\n              $('#' + that.cd.spaceclass + '_' + thewordnumber).addClass((that.cd.activesentence));\n              $('#' + that.cd.wordclass + '_' + thewordnumber).addClass((that.cd.activesentence));\n            }\n          }\n          that.on_reach_audio_break(finishedsentence, that.previousstartbreak, that.currentstartbreak, that.breaks);\n        }\n      };\n    }, //end of register events\n\n\n    on_reach_audio_break: function(sentence, oldbreak, newbreak, breaks) {\n      log.debug(sentence);\n      log.debug(oldbreak);\n      log.debug(newbreak);\n    }\n\n  }; //end of return value\n});"],"file":"modelaudiokaraoke.min.js"}