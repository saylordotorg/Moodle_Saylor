define ("mod_readaloud/ttaudiohelper",["jquery","core/log","mod_readaloud/ttwavencoder"],function(a,b,c){"use strict";b.debug("TT Audio Helper initialising");return{encoder:null,microphone:null,isRecording:!1,audioContext:null,processor:null,uniqueid:null,config:{bufferLen:4096,numChannels:2,mimeType:"audio/wav"},clone:function clone(){return a.extend(!0,{},this)},init:function init(a,b,c){this.waveHeight=a;this.uniqueid=b;this.therecorder=c;this.prepare_html();window.AudioContext=window.AudioContext||window.webkitAudioContext},onStop:function onStop(){},onStream:function onStream(){},onError:function onError(){},prepare_html:function prepare_html(){this.canvas=a("#"+this.uniqueid+"_waveform");this.canvasCtx=this.canvas[0].getContext("2d")},start:function start(){var a=this;this.audioContext=new AudioContext;if(this.audioContext.createJavaScriptNode){this.processor=this.audioContext.createJavaScriptNode(this.config.bufferLen,this.config.numChannels,this.config.numChannels)}else if(this.audioContext.createScriptProcessor){this.processor=this.audioContext.createScriptProcessor(this.config.bufferLen,this.config.numChannels,this.config.numChannels)}else{b.debug("WebAudio API has no support on this browser.")}this.processor.connect(this.audioContext.destination);navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function gotStreamMethod(b){a.onStream(b);a.isRecording=!0;a.therecorder.update_audio("isRecording",!0);a.tracks=b.getTracks();a.microphone=a.audioContext.createMediaStreamSource(b);a.microphone.connect(a.processor);a.encoder=c.clone();a.encoder.init(a.audioContext.sampleRate,2);a.processor.onaudioprocess=function(b){a.encoder.encode(a.getBuffers(b))};a.listener=a.audioContext.createAnalyser();a.microphone.connect(a.listener);a.listener.fftSize=2048;a.bufferLength=a.listener.frequencyBinCount;a.analyserData=new Uint8Array(a.bufferLength);a.canvasCtx.clearRect(0,0,2*a.canvas.width(),2*a.waveHeight);a.interval=setInterval(function(){a.drawWave()},100)}).catch(this.onError)},stop:function stop(){clearInterval(this.interval);this.canvasCtx.clearRect(0,0,2*this.canvas.width(),2*this.waveHeight);this.isRecording=!1;this.therecorder.update_audio("isRecording",!1);this.audioContext.close();this.processor.disconnect();this.tracks.forEach(function(a){return a.stop()});this.onStop(this.encoder.finish())},getBuffers:function getBuffers(a){for(var b=[],c=0;2>c;++c){b[c]=a.inputBuffer.getChannelData(c)}return b},drawWave:function drawWave(){var a=2*this.canvas.width();this.listener.getByteTimeDomainData(this.analyserData);this.canvasCtx.fillStyle="white";this.canvasCtx.fillRect(0,0,a,2*this.waveHeight);this.canvasCtx.lineWidth=5;this.canvasCtx.strokeStyle="gray";this.canvasCtx.beginPath();for(var b=a/this.bufferLength,c=0,d=0;d<this.bufferLength;d++){var e=this.analyserData[d]/128,f=e*this.waveHeight;if(!(0==d)){this.canvasCtx.lineTo(c,f)}c+=b}this.canvasCtx.lineTo(a,this.waveHeight);this.canvasCtx.stroke()}}});
//# sourceMappingURL=ttaudiohelper.min.js.map
