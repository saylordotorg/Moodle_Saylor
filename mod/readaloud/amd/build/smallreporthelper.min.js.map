{"version":3,"sources":["../src/smallreporthelper.js"],"names":["define","$","log","def","str","Ajax","notification","debug","controls","ready","remotetranscribe","attemptid","checking","secstillcheck","notgradedyet","evaluated","init","opts","filename","register_controls","register_events","check_for_results","check_for_audio","init_strings","that","get_string","done","s","heading","smallreportheading","player","smallreportplayer","dummyplayer","smallreportdummyplayer","rating","smallreportrating","status","smallreportstatus","fullreportbutton","waitms","ajax","url","method","cache","error","setTimeout","success","data","textStatus","xhr","attr","show","hide","seconds","text","call","methodname","args","ajaxresult","payloadobject","JSON","parse","stars","star","html","fail","exception"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log','mod_readaloud/definitions','core/str','core/ajax','core/notification'], function ($, log, def, str, Ajax, notification) {\n    \"use strict\"; // jshint ;_;\n    /*\n    This file does small report\n     */\n\n    log.debug('Click to hear: initialising');\n\n    return {\n        //controls\n        controls: {},\n        ready: false,\n        remotetranscribe: false,\n        attemptid: 0,\n        checking: '... checking ...',\n        secstillcheck: 'Checking again in: ',\n        notgradedyet: 'Your reading has not been evaluated yet.',\n        evaluated: 'Your reading has been evaluated.',\n\n        //init the module\n        init: function(opts){\n            this.attemptid=opts['attemptid'];\n            this.ready=opts['ready'];\n            this.remotetranscribe=opts['remotetranscribe'];\n            this.filename=opts['filename'];\n            this.register_controls();\n            this.register_events();\n\n            if(!this.ready && this.remotetranscribe && this.attemptid){\n                //check for ai results\n                this.check_for_results(this,15);\n                //check for audio audio\n                this.check_for_audio(0);\n            }\n        },\n\n        init_strings: function(){\n          var that =this;\n          str.get_string('checking','mod_readaloud').done(function(s){that.checking=s;});\n          str.get_string('secs_till_check','mod_readaloud').done(function(s){that.secstillcheck=s;});\n          str.get_string('notgradedyet','mod_readaloud').done(function(s){that.notgradedyet=s;});\n          str.get_string('evaluatedmessage','mod_readaloud').done(function(s){that.evaluated=s;});\n        },\n\n        //load all the controls so we do not have to do it later\n        register_controls: function(){\n            this.controls.heading = $('.' + def.smallreportheading);\n            this.controls.player = $('.' + def.smallreportplayer);\n            this.controls.dummyplayer = $('.' + def.smallreportdummyplayer);\n            this.controls.rating = $('.' + def.smallreportrating);\n            this.controls.status = $('.' + def.smallreportstatus);\n            this.controls.fullreportbutton = $('.' + def.fullreportbutton);\n        },\n\n        //attach the various event handlers we need\n        register_events: function() {\n            var that = this;\n        },//end of register events\n\n        check_for_audio: function(waitms){\n            //we commence a series of ping and retries until the recorded file is available\n            var that = this;\n            $.ajax({\n                url: that.filename,\n                method: 'HEAD',\n                cache: false,\n                error: function () {\n                    //We get here if its a 404 or 403. So settimout here and wait for file to arrive\n                    //we increment the timeout period each time to prevent bottlenecks\n                    log.debug('403 errors are normal here, till the audio file arrives back from conversion');\n                    setTimeout(function () {\n                        that.check_for_audio( waitms + 500);\n                    }, waitms);\n                },\n                success: function (data, textStatus, xhr) {\n                    switch (xhr.status) {\n                        case 200:\n                            that.controls.player.attr('src',that.filename);\n                            that.controls.player.show();\n                            that.controls.dummyplayer.hide();\n                            break;\n                        default:\n                            setTimeout(function () {\n                                that.check_for_audio( waitms + 500);\n                            }, waitms);\n                    }\n\n                }\n            });\n        },\n\n        check_for_results: function (that, seconds) {\n\n            //decrement 1 s. At 15 seconds do the check\n            seconds=seconds-1;\n            if(seconds>0){\n                setTimeout(that.check_for_results,1000,that,seconds);\n                that.controls.status.text(that.secstillcheck + seconds);\n                return;\n            }\n\n            //do the check\n            that.controls.status.text(that.checking);\n            Ajax.call([{\n                methodname: 'mod_readaloud_check_for_results',\n                args: {\n                    attemptid: that.attemptid\n                },\n                done: function (ajaxresult) {\n                    var payloadobject = JSON.parse(ajaxresult);\n                    if (payloadobject) {\n                        switch (payloadobject.ready) {\n                            case true:\n                                log.debug('result fetched');\n                                var emptystar='<i class=\"fa fa-lg fa-star-o\"></i>';\n                                var solidstar='<i class=\"fa fa-lg fa-star\"></i>';\n                                var stars='';\n                                for(var star=0;star<5;star++){\n                                    stars = stars + (payloadobject.rating > star ? solidstar : emptystar);\n                                }\n                                that.controls.heading.text(that.evaluated);\n                                that.controls.rating.html(stars);\n                                that.controls.status.hide();\n                                that.controls.fullreportbutton.show();\n                                break;\n\n                            case false:\n                            default:\n                                log.debug('result not fetched');\n                                setTimeout(that.check_for_results,1000,that,15 );\n                                that.controls.status.text(that.secstillcheck + seconds);\n                        }\n                    }\n                },\n                fail: notification.exception\n            }]);\n        },\n\n    };//end of return value\n});"],"file":"smallreporthelper.min.js"}