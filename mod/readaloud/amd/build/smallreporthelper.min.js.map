{"version":3,"file":"smallreporthelper.min.js","sources":["../src/smallreporthelper.js"],"sourcesContent":["define(['jquery', 'core/log','mod_readaloud/definitions','core/str','core/ajax','core/notification'], function ($, log, def, str, Ajax, notification) {\n    \"use strict\"; // jshint ;_;\n    /*\n    This file does small report\n     */\n\n    log.debug('Click to hear: initialising');\n\n    return {\n        //controls\n        controls: {},\n        ready: false,\n        remotetranscribe: false,\n        attemptid: 0,\n        checking: '... checking ...',\n        secstillcheck: 'Checking again in: ',\n        notgradedyet: 'Your reading has not been evaluated yet.',\n        evaluated: 'Your reading has been evaluated.',\n\n        //init the module\n        init: function(opts){\n            this.attemptid=opts['attemptid'];\n            this.ready=opts['ready'];\n            this.remotetranscribe=opts['remotetranscribe'];\n            this.filename=opts['filename'];\n            this.register_controls();\n            this.register_events();\n\n            if(!this.ready && this.remotetranscribe && this.attemptid){\n                //check for ai results\n                this.check_for_results(this,15);\n                //check for audio audio\n                this.check_for_audio(0);\n            }\n        },\n\n        init_strings: function(){\n          var that =this;\n          str.get_string('checking','mod_readaloud').done(function(s){that.checking=s;});\n          str.get_string('secs_till_check','mod_readaloud').done(function(s){that.secstillcheck=s;});\n          str.get_string('notgradedyet','mod_readaloud').done(function(s){that.notgradedyet=s;});\n          str.get_string('evaluatedmessage','mod_readaloud').done(function(s){that.evaluated=s;});\n        },\n\n        //load all the controls so we do not have to do it later\n        register_controls: function(){\n            this.controls.heading = $('.' + def.smallreportheading);\n            this.controls.player = $('.' + def.smallreportplayer);\n            this.controls.dummyplayer = $('.' + def.smallreportdummyplayer);\n            this.controls.rating = $('.' + def.smallreportrating);\n            this.controls.status = $('.' + def.smallreportstatus);\n            this.controls.fullreportbutton = $('.' + def.fullreportbutton);\n        },\n\n        //attach the various event handlers we need\n        register_events: function() {\n            var that = this;\n        },//end of register events\n\n        check_for_audio: function(waitms){\n            //we commence a series of ping and retries until the recorded file is available\n            var that = this;\n            $.ajax({\n                url: that.filename,\n                method: 'HEAD',\n                cache: false,\n                error: function () {\n                    //We get here if its a 404 or 403. So settimout here and wait for file to arrive\n                    //we increment the timeout period each time to prevent bottlenecks\n                    log.debug('403 errors are normal here, till the audio file arrives back from conversion');\n                    setTimeout(function () {\n                        that.check_for_audio( waitms + 500);\n                    }, waitms);\n                },\n                success: function (data, textStatus, xhr) {\n                    switch (xhr.status) {\n                        case 200:\n                            that.controls.player.attr('src',that.filename);\n                            that.controls.player.show();\n                            that.controls.dummyplayer.hide();\n                            break;\n                        default:\n                            setTimeout(function () {\n                                that.check_for_audio( waitms + 500);\n                            }, waitms);\n                    }\n\n                }\n            });\n        },\n\n        check_for_results: function (that, seconds) {\n\n            //decrement 1 s. At 15 seconds do the check\n            seconds=seconds-1;\n            if(seconds>0){\n                setTimeout(that.check_for_results,1000,that,seconds);\n                that.controls.status.text(that.secstillcheck + seconds);\n                return;\n            }\n\n            //do the check\n            that.controls.status.text(that.checking);\n            Ajax.call([{\n                methodname: 'mod_readaloud_check_for_results',\n                args: {\n                    attemptid: that.attemptid\n                },\n                done: function (ajaxresult) {\n                    var payloadobject = JSON.parse(ajaxresult);\n                    if (payloadobject) {\n                        switch (payloadobject.ready) {\n                            case true:\n                                log.debug('result fetched');\n                                var emptystar='<i class=\"fa fa-lg fa-star-o\"></i>';\n                                var solidstar='<i class=\"fa fa-lg fa-star\"></i>';\n                                var stars='';\n                                for(var star=0;star<5;star++){\n                                    stars = stars + (payloadobject.rating > star ? solidstar : emptystar);\n                                }\n                                that.controls.heading.text(that.evaluated);\n                                that.controls.rating.html(stars);\n                                that.controls.status.hide();\n                                that.controls.fullreportbutton.show();\n                                break;\n\n                            case false:\n                            default:\n                                log.debug('result not fetched');\n                                setTimeout(that.check_for_results,1000,that,15 );\n                                that.controls.status.text(that.secstillcheck + seconds);\n                        }\n                    }\n                },\n                fail: notification.exception\n            }]);\n        },\n\n    };//end of return value\n});"],"names":["define","$","log","def","str","Ajax","notification","debug","controls","ready","remotetranscribe","attemptid","checking","secstillcheck","notgradedyet","evaluated","init","opts","filename","register_controls","register_events","this","check_for_results","check_for_audio","init_strings","that","get_string","done","s","heading","smallreportheading","player","smallreportplayer","dummyplayer","smallreportdummyplayer","rating","smallreportrating","status","smallreportstatus","fullreportbutton","waitms","ajax","url","method","cache","error","setTimeout","success","data","textStatus","xhr","attr","show","hide","seconds","text","call","methodname","args","ajaxresult","payloadobject","JSON","parse","stars","star","html","fail","exception"],"mappings":"AAAAA,yCAAO,CAAC,SAAU,WAAW,4BAA4B,WAAW,YAAY,sBAAsB,SAAUC,EAAGC,IAAKC,IAAKC,IAAKC,KAAMC,qBAMpIJ,IAAIK,MAAM,+BAEH,CAEHC,SAAU,GACVC,OAAO,EACPC,kBAAkB,EAClBC,UAAW,EACXC,SAAU,mBACVC,cAAe,sBACfC,aAAc,2CACdC,UAAW,mCAGXC,KAAM,SAASC,WACNN,UAAUM,KAAI,eACdR,MAAMQ,KAAI,WACVP,iBAAiBO,KAAI,sBACrBC,SAASD,KAAI,cACbE,yBACAC,mBAEDC,KAAKZ,OAASY,KAAKX,kBAAoBW,KAAKV,iBAEvCW,kBAAkBD,KAAK,SAEvBE,gBAAgB,KAI7BC,aAAc,eACRC,KAAMJ,KACVjB,IAAIsB,WAAW,WAAW,iBAAiBC,MAAK,SAASC,GAAGH,KAAKb,SAASgB,KAC1ExB,IAAIsB,WAAW,kBAAkB,iBAAiBC,MAAK,SAASC,GAAGH,KAAKZ,cAAce,KACtFxB,IAAIsB,WAAW,eAAe,iBAAiBC,MAAK,SAASC,GAAGH,KAAKX,aAAac,KAClFxB,IAAIsB,WAAW,mBAAmB,iBAAiBC,MAAK,SAASC,GAAGH,KAAKV,UAAUa,MAIrFT,kBAAmB,gBACVX,SAASqB,QAAU5B,EAAE,IAAME,IAAI2B,yBAC/BtB,SAASuB,OAAS9B,EAAE,IAAME,IAAI6B,wBAC9BxB,SAASyB,YAAchC,EAAE,IAAME,IAAI+B,6BACnC1B,SAAS2B,OAASlC,EAAE,IAAME,IAAIiC,wBAC9B5B,SAAS6B,OAASpC,EAAE,IAAME,IAAImC,wBAC9B9B,SAAS+B,iBAAmBtC,EAAE,IAAME,IAAIoC,mBAIjDnB,gBAAiB,aAIjBG,gBAAiB,SAASiB,YAElBf,KAAOJ,KACXpB,EAAEwC,KAAK,CACHC,IAAKjB,KAAKP,SACVyB,OAAQ,OACRC,OAAO,EACPC,MAAO,WAGH3C,IAAIK,MAAM,gFACVuC,YAAW,WACPrB,KAAKF,gBAAiBiB,OAAS,OAChCA,SAEPO,QAAS,SAAUC,KAAMC,WAAYC,QAExB,MADDA,IAAIb,OAEJZ,KAAKjB,SAASuB,OAAOoB,KAAK,MAAM1B,KAAKP,UACrCO,KAAKjB,SAASuB,OAAOqB,OACrB3B,KAAKjB,SAASyB,YAAYoB,YAG1BP,YAAW,WACPrB,KAAKF,gBAAiBiB,OAAS,OAChCA,YAOvBlB,kBAAmB,SAAUG,KAAM6B,aAG/BA,SAAgB,GACL,SACPR,WAAWrB,KAAKH,kBAAkB,IAAKG,KAAK6B,cAC5C7B,KAAKjB,SAAS6B,OAAOkB,KAAK9B,KAAKZ,cAAgByC,SAKnD7B,KAAKjB,SAAS6B,OAAOkB,KAAK9B,KAAKb,UAC/BP,KAAKmD,KAAK,CAAC,CACPC,WAAY,kCACZC,KAAM,CACF/C,UAAWc,KAAKd,WAEpBgB,KAAM,SAAUgC,gBACRC,cAAgBC,KAAKC,MAAMH,eAC3BC,kBAES,IADDA,cAAcnD,OAEdP,IAAIK,MAAM,0BAGNwD,MAAM,GACFC,KAAK,EAAEA,KAAK,EAAEA,OAClBD,OAAiBH,cAAczB,OAAS6B,KAH9B,mCADA,qCAMdvC,KAAKjB,SAASqB,QAAQ0B,KAAK9B,KAAKV,WAChCU,KAAKjB,SAAS2B,OAAO8B,KAAKF,OAC1BtC,KAAKjB,SAAS6B,OAAOgB,OACrB5B,KAAKjB,SAAS+B,iBAAiBa,YAK/BlD,IAAIK,MAAM,sBACVuC,WAAWrB,KAAKH,kBAAkB,IAAKG,KAAK,IAC5CA,KAAKjB,SAAS6B,OAAOkB,KAAK9B,KAAKZ,cAAgByC,UAI/DY,KAAM5D,aAAa6D"}