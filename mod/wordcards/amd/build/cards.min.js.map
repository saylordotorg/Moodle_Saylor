{"version":3,"file":"cards.min.js","sources":["../src/cards.js"],"sourcesContent":["/**\r\n * Cards module.\r\n *\r\n * @package mod_wordcards\r\n * @author  Frédéric Massart - FMCorz.net\r\n */\r\n\r\n// TODO Handle window resizing/rotating?\r\n// TODO Test Edge\r\n\r\ndefine([\r\n    'jquery',\r\n    'core/ajax',\r\n], function($, Ajax) {\r\n\r\n    var PAGEOFFSET = 60;\r\n    var CARDMARGIN = 4;\r\n\r\n    /**\r\n     * Randomize array element order in-place.\r\n     * Using Durstenfeld shuffle algorithm.\r\n     * @see http://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array\r\n     */\r\n    function shuffleArray(array) {\r\n        for (var i = array.length - 1; i > 0; i--) {\r\n            var j = Math.floor(Math.random() * (i + 1));\r\n            var temp = array[i];\r\n            array[i] = array[j];\r\n            array[j] = temp;\r\n        }\r\n        return array;\r\n    }\r\n\r\n    var Cards = function(selector, terms) {\r\n        this._container = $(selector);\r\n        this._terms = terms;\r\n        this._selected = null;\r\n    };\r\n    Cards.prototype._container = null;\r\n    Cards.prototype._dryRun = false;\r\n    Cards.prototype._resizeTimeout = null;\r\n    Cards.prototype._selected = null;\r\n    Cards.prototype._terms = null;\r\n\r\n    Cards.prototype.init = function() {\r\n        var pool = [];\r\n\r\n        this._terms.forEach(function(item) {\r\n            pool.push(this._makeCard(item.id, item.term));\r\n            pool.push(this._makeCard(item.id, item.definition));\r\n        }.bind(this));\r\n\r\n        shuffleArray(pool);\r\n        pool.forEach(function(item) {\r\n            // item.hide();\r\n            this._container.append(item);\r\n        }.bind(this));\r\n        this._arrangePlayground();\r\n        pool.forEach(function(item) {\r\n            item.show();\r\n        });\r\n\r\n        // Event listeners.\r\n        this._container.on('click', '.wordcard', this._handlePick.bind(this));\r\n        $(window).on('resize', function() {\r\n            if (this._resizeTimeout) {\r\n                clearTimeout(this._resizeTimeout);\r\n            }\r\n            this._resizeTimeout = setTimeout(this._arrangePlayground.bind(this), 200);\r\n        }.bind(this));\r\n    };\r\n\r\n    Cards.prototype._arrangePlayground = function() {\r\n        var width = this._container.width(),\r\n            height = $(window).height(),\r\n            perRow = 3,\r\n            cardCount = this._terms.length * 2,\r\n            cardWidth = null,\r\n            cardHeight = null,\r\n            row = 0,\r\n            col = 0,\r\n            lineHeight,\r\n            lineHeightValue,\r\n            lineHeightUnit,\r\n            suggestedHeight;\r\n\r\n        if (cardCount % 2 < cardCount % 3) {\r\n            perRow = 2;\r\n        }\r\n        lineHeight = this._container.find('.wordcard').first().css('lineHeight');\r\n        lineHeightValue = parseInt(lineHeight.replace(/([^0-9]+)/, ''));\r\n        lineHeightUnit = lineHeight.replace(/([0-9]+)/, '');\r\n        suggestedHeight = 60;\r\n        if (lineHeightUnit === 'px') {\r\n            suggestedHeight = !lineHeightValue ? suggestedHeight : ((lineHeightValue + 1) * 3);\r\n        }\r\n        suggestedHeight = 999;\r\n\r\n        cardWidth = Math.floor(width / perRow);\r\n        cardHeight = Math.min(Math.round((height - PAGEOFFSET) / Math.ceil(cardCount / perRow)), suggestedHeight);\r\n\r\n        this._container.find('.wordcard').each(function(index, item) {\r\n            $(item).css({\r\n                top: row * cardHeight,\r\n                left: col * cardWidth,\r\n                width: (col == perRow - 1) ? cardWidth : cardWidth - CARDMARGIN,\r\n                height: cardHeight - CARDMARGIN\r\n            });\r\n            col++;\r\n            if (col >= perRow) {\r\n                col = 0;\r\n                row++;\r\n            }\r\n        });\r\n\r\n        this._container.find('.wordcard-content').css('maxHeight', cardHeight - CARDMARGIN);\r\n        this._container.css({height: row * cardHeight});\r\n        this._adjustCardContent();\r\n    };\r\n\r\n    Cards.prototype._adjustCardContent = function() {\r\n        this._container.find('.wordcard-content').each(function(index, el) {\r\n            var node = $(el),\r\n                over,\r\n                txt,\r\n                loops = 0;\r\n\r\n            node.text(node.data('text'));\r\n            while (el.scrollHeight > el.offsetHeight && el.scrollHeight > 0) {\r\n                txt = node.text();\r\n                over = Math.max(0.1, (el.offsetHeight / el.scrollHeight) - 0.05);\r\n                txt = txt.substr(0, Math.round(txt.length * over)).trim();\r\n                txt += '…';\r\n                node.text(txt);\r\n\r\n                // Fail safe, because sometimes it loops forever...\r\n                if (loops++ > 4) {\r\n                    break;\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    Cards.prototype._checkComplete = function() {\r\n        if (this._container.find('.wordcard.found').length == this._terms.length * 2) {\r\n            this._trigger('complete');\r\n        }\r\n    };\r\n\r\n    Cards.prototype._handlePick = function(e) {\r\n        e.preventDefault();\r\n        var card = $(e.currentTarget);\r\n\r\n        // It's already invisible.\r\n        if (card.hasClass('found')) {\r\n            return;\r\n        }\r\n\r\n        // It's the first out of the two picks.\r\n        if (!this._selected) {\r\n            this._selected = card;\r\n            card.addClass('selected');\r\n            return;\r\n        }\r\n\r\n        // We've clicked the selected card.\r\n        if (this._selected.is(card)) {\r\n            return;\r\n        }\r\n\r\n        // It's a match!\r\n        if (card.data('id') == this._selected.data('id')) {\r\n            this._selected\r\n                .addClass('found')\r\n                .animate({'opacity': 0});\r\n            card.addClass('found')\r\n                .animate({'opacity': 0});\r\n\r\n            this._reportSuccess(this._selected.data('id'));\r\n            this._checkComplete();\r\n\r\n        // It's not a match...\r\n        } else {\r\n            var original = this._selected;\r\n            original.addClass('mismatch');\r\n            card.addClass('mismatch');\r\n\r\n            this._reportFailure(this._selected.data('id'), card.data('id'));\r\n\r\n            setTimeout(function() {\r\n                original.removeClass('mismatch');\r\n                card.removeClass('mismatch');\r\n            }, 600);\r\n        }\r\n\r\n        // Reset the selection.\r\n        this._selected.removeClass('selected');\r\n        this._selected = null;\r\n    };\r\n\r\n    Cards.prototype._makeCard = function(id, text) {\r\n        var container = $('<div class=\"wordcard\">'),\r\n            wrapper = $('<div class=\"wordcard-wrapper\">'),\r\n            content = $('<div class=\"wordcard-content\">');\r\n\r\n        content.text(text);\r\n        content.data('text', text);\r\n        wrapper.append(content);\r\n        container.append(wrapper);\r\n        container.data('id', id);\r\n\r\n        return container;\r\n    };\r\n\r\n    Cards.prototype.on = function(action, cb) {\r\n        this._container.on(action, cb);\r\n    };\r\n\r\n    Cards.prototype._reportFailure = function(term1id, term2id) {\r\n        if (this._dryRun) {\r\n            return;\r\n        }\r\n\r\n        Ajax.call([{\r\n            methodname: 'mod_wordcards_report_failed_association',\r\n            args: {\r\n                term1id: term1id,\r\n                term2id: term2id\r\n            }\r\n        }]);\r\n    };\r\n\r\n    Cards.prototype._reportSuccess = function(termid) {\r\n        if (this._dryRun) {\r\n            return;\r\n        }\r\n\r\n        Ajax.call([{\r\n            methodname: 'mod_wordcards_report_successful_association',\r\n            args: {\r\n                termid: termid\r\n            }\r\n        }]);\r\n    };\r\n\r\n    Cards.prototype.setDryRun = function(value) {\r\n        this._dryRun = value;\r\n    };\r\n\r\n    Cards.prototype._trigger = function(action) {\r\n        this._container.trigger(action);\r\n    };\r\n\r\n    return Cards;\r\n\r\n});\r\n"],"names":["define","$","Ajax","Cards","selector","terms","_container","_terms","_selected","prototype","_dryRun","_resizeTimeout","init","pool","forEach","item","push","this","_makeCard","id","term","definition","bind","array","i","length","j","Math","floor","random","temp","shuffleArray","append","_arrangePlayground","show","on","_handlePick","window","clearTimeout","setTimeout","cardWidth","cardHeight","lineHeight","lineHeightValue","suggestedHeight","width","height","perRow","cardCount","row","col","find","first","css","parseInt","replace","min","round","ceil","each","index","top","left","_adjustCardContent","el","over","txt","node","loops","text","data","scrollHeight","offsetHeight","max","substr","trim","_checkComplete","_trigger","e","preventDefault","card","currentTarget","hasClass","addClass","is","animate","_reportSuccess","original","_reportFailure","removeClass","container","wrapper","content","action","cb","term1id","term2id","call","methodname","args","termid","setDryRun","value","trigger"],"mappings":"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"}