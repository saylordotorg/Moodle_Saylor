define("mod_wordcards/speechcards",["jquery","jqueryui","core/ajax","core/log","mod_wordcards/a4e","mod_wordcards/cloudpoodllloader","mod_wordcards/ttrecorder","core/templates"],(function($,jqui,Ajax,log,a4e,cloudpoodll,ttrecorder,templates){var app={passmark:75,pointer:1,jsondata:null,props:null,dryRun:!1,controls:{},region:"useast1",init:function(props){var theid="#"+props.widgetid;this.dryRun=props.dryRun,this.nexturl=props.nexturl,this.modid=props.modid,this.region=props.region,this.isFreeMode=props.isfreemode;var definitionscontrol=$(theid).get(0);if(definitionscontrol){var jsondata=JSON.parse(definitionscontrol.value);$(theid).remove(),app.jsondata=jsondata,app.props=props,app.process(jsondata),a4e.register_events(),a4e.init_audio(props.token,props.region,props.owner),this.init_controls(),this.register_events()}else log.debug("No config found on page. Giving up.")},init_controls:function(){app.controls.close_results=$("#wordcards-close-results"),app.controls.results=$("#wordcards-results"),app.controls.vocab_list=$("#wordcards-vocab-list"),app.controls.the_list=$("#speechcards_thelist"),app.controls.gameboard=$("#wordcards-gameboard"),app.controls.time_counter=$("#wordcards-time-counter"),app.controls.prev_button=$(".wordcards-speechcards_prevbutton"),app.controls.next_button=$(".wordcards-speechcards_nextbutton"),app.controls.standalonepushrecorder=$(".speechcards_standalonerecorder"),app.controls.slider=$(".wordcards-poodllspeechcards_box")},do_next:function(){a4e.progress_dots(app.results,app.terms),app.clearStarRating(),app.is_end()?app.do_end():(app.move_card(">"),app.update_header())},do_prev:function(){app.move_card("<"),app.update_header()},move_card:function(direction){if("<"===direction)app.set_pointer(app.pointer-1),app.controls.slider.toggle("slide",{direction:"right"}),app.controls.slider.text(app.terms[app.pointer-1].term),app.controls.slider.toggle("slide",{direction:"left"}),app.update_header();else app.set_pointer(app.pointer+1),app.controls.slider.toggle("slide",{direction:"left"}),app.controls.slider.text(app.terms[app.pointer-1].term),app.controls.slider.toggle("slide",{direction:"right"}),app.update_header()},clearStarRating:function(){$("#wordcards-star-rating").html("· · ·")},register_events:function(){app.controls.prev_button.click((function(){app.do_prev()})),app.controls.next_button.click((function(){var failedword=app.terms[app.pointer-1].term;app.check(!1,failedword),app.do_next()})),$("body").on("click","#wordcards-close-results",(function(){var total_time=app.timer.count,url=app.nexturl.replace(/&amp;/g,"&")+"&localscattertime="+total_time;window.location.replace(url)})),$("body").on("click","#wordcards-try-again",(function(){location.reload()})),$("body").on("click","#wordcards-start-button",(function(){app.start()}))},process:function(jsondata){app.terms=jsondata.terms,a4e.list_vocab("#vocab-list-inner",app.terms),this.initComponents()},set_pointer:function(newpointer){app.pointer=newpointer},initCards:function(){app.controls.slider.text(app.terms[app.pointer-1].term)},initComponents:function(){var opts={uniqueid:"wordcards-speechcards_pushrecorder"};opts.stt_guided=this.props.stt_guided,opts.callback=function(message){switch(console.log(message),message.type){case"recording":break;case"speech":var speechtext=message.capturedspeech,cleanspeechtext=app.cleanText(speechtext),spoken=cleanspeechtext,correct=app.terms[app.pointer-1].term,similarity=app.similarity(spoken,correct);if(log.debug("JS similarity: "+spoken+":"+correct+":"+similarity),similarity>=app.passmark||app.wordsDoMatch(cleanspeechtext,app.terms[app.pointer-1]))return log.debug("local match::"+spoken+":"+correct),app.showStarRating(100),void app.flagCorrectAndTransition(app.terms[app.pointer-1]);app.checkByPhonetic(spoken,correct).then((function(similarity){if(!1===similarity)return $.Deferred().reject();log.debug("PHP similarity: "+spoken+":"+correct+":"+similarity),app.showStarRating(similarity),similarity>=app.passmark&&app.flagCorrectAndTransition(similarity,app.terms[app.pointer-1])}))}},ttrecorder.clone().init(opts)},showStarRating:function(similarity){var stars=[!0,!0,!0];similarity<1&&(stars=[!0,!0,!1]),similarity<app.passmark&&(stars=[!0,!1,!1]),similarity<.5&&(stars=[!1,!1,!1]),console.log(stars,similarity);var code="";stars.forEach((function(star){code+=!0===star?'<i class="fa fa-star"></i>':'<i class="fa fa-star-o"></i>'})),console.log(code),$("#wordcards-star-rating").html(code)},flagCorrectAndTransition:function(term){app.check(!0,term),app.is_end()?(app.update_header(),setTimeout((function(){app.do_end()}),700)):setTimeout((function(){app.do_next()}),700)},checkByPhonetic:function(spoken,correct){return Ajax.call([{methodname:"mod_wordcards_check_by_phonetic",args:{spoken:spoken,correct:correct,language:app.props.language}}])[0]},wordsDoMatch:function(wordheard,currentterm){if(wordheard=app.cleanText(wordheard),currentterm.term=app.cleanText(currentterm.term),wordheard==currentterm.term)return!0;if(!currentterm.alternates)return!1;var awords=currentterm.alternates.split(","),matched=!1;return $.each(awords,(function(i,word){if(app.cleanText(word.toLowerCase())==wordheard)return matched=!0,!1})),matched},cleanText:function(text){return text.toLowerCase().replace(/['!"#$%&\\'()\*+,\-\.\/:;<=>?@\[\\\]\^_`{|}~']/g,"").replace(/\s+/g," ").trim()},start:function(){app.results=[],a4e.shuffle(app.terms),app.controls.vocab_list.hide(),app.controls.gameboard.show(),app.controls.time_counter.text("00:00"),app.clearStarRating(),a4e.progress_dots(app.results,app.terms),app.timer={interval:setInterval((function(){app.timer.update()}),1e3),count:0,update:function(){app.timer.count++,app.controls.time_counter.text(a4e.pretty_print_secs(app.timer.count))}},app.update_header(),this.initCards()},quit:function(){clearInterval(app.timer.interval),app.controls.gameboard.hide(),app.controls.vocab_list.show()},do_end:function(){clearInterval(app.timer.interval),$("#wordcards-gameboard, #wordcards-quit-button, #wordcards-start-button").hide(),$("#wordcards-results").show();var tdata=[];tdata.nexturl=this.nexturl,tdata.results=app.results,tdata.total=app.terms.length,tdata.totalcorrect=a4e.calc_total_points(app.results);var total_time=app.timer.count;tdata.prettytime=0==total_time?"00:00":a4e.pretty_print_secs(total_time),templates.render("mod_wordcards/feedback",tdata).then((function(html,js){$("#results-inner").html(html),require(["mod_wordcards/mywords"],(function(mywords){mywords.initFromFeedbackPage()}))}));var data={results:app.results,activity:"speechcards"};console.log(data),app.isFreeMode||Ajax.call([{methodname:"mod_wordcards_report_step_grade",args:{modid:app.modid,correct:tdata.totalcorrect}}])},is_end:function(){return!(app.pointer<app.terms.length)},update_header:function(){app.results.filter((function(e){return e.points>0})).length,app.terms.length,app.results.filter((function(e){return 0==e.points})).length,app.terms.length},check:function(correct,spokenwords){var points=1;points=1==correct?1:0,$(".a4e-distractor").css("pointer-events","none");var result={pointer:app.pointer,question:app.terms[app.pointer-1].definition,selected:spokenwords,correct:app.terms[app.pointer-1].term,points:points,id:app.terms[app.pointer-1].id};$.each(app.results,(function(result){app.pointer,result.pointer})),app.results.push(result),correct?this.reportSuccess(app.terms[app.pointer-1].id):this.reportFailure(app.terms[app.pointer-1].id,0)},reportFailure:function(term1id,term2id){this.dryRun||Ajax.call([{methodname:"mod_wordcards_report_failed_association",args:{term1id:term1id,term2id:term2id,isfreemode:app.isFreeMode}}])},reportSuccess:function(termid){this.dryRun||Ajax.call([{methodname:"mod_wordcards_report_successful_association",args:{termid:termid,isfreemode:app.isFreeMode}}])},similarity:function(s1,s2){var longer=s1,shorter=s2;s1.length<s2.length&&(longer=s2,shorter=s1);var longerLength=longer.length;return 0==longerLength?1:(longerLength-app.editDistance(longer,shorter))/parseFloat(longerLength)},editDistance:function(s1,s2){s1=s1.toLowerCase(),s2=s2.toLowerCase();for(var costs=new Array,i=0;i<=s1.length;i++){for(var lastValue=i,j=0;j<=s2.length;j++)if(0==i)costs[j]=j;else if(j>0){var newValue=costs[j-1];s1.charAt(i-1)!=s2.charAt(j-1)&&(newValue=Math.min(Math.min(newValue,lastValue),costs[j])+1),costs[j-1]=lastValue,lastValue=newValue}i>0&&(costs[s2.length]=lastValue)}return costs[s2.length]},mobile_user:function(){return!!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},chrome_user:function(){return!!/Chrome/i.test(navigator.userAgent)}};return app}));

//# sourceMappingURL=speechcards.min.js.map