define ("mod_wordcards/speechcards",["jquery","jqueryui","core/ajax","core/log","mod_wordcards/a4e","mod_wordcards/cloudpoodllloader","mod_wordcards/ttrecorder","core/templates"],function(a,b,c,d,e,f,g,h){var j={passmark:75,pointer:1,jsondata:null,props:null,dryRun:!1,controls:{},region:"useast1",init:function init(b){var c="#"+b.widgetid;this.dryRun=b.dryRun;this.nexturl=b.nexturl;this.modid=b.modid;this.region=b.region;var f=a(c).get(0);if(f){var g=JSON.parse(f.value);a(c).remove()}else{d.debug("No config found on page. Giving up.");return}j.jsondata=g;j.props=b;j.process(g);e.register_events();e.init_audio(b.token,b.region,b.owner);this.init_controls();this.register_events()},init_controls:function init_controls(){j.controls.close_results=a("#wordcards-close-results");j.controls.results=a("#wordcards-results");j.controls.vocab_list=a("#wordcards-vocab-list");j.controls.the_list=a("#speechcards_thelist");j.controls.gameboard=a("#wordcards-gameboard");j.controls.time_counter=a("#wordcards-time-counter");j.controls.prev_button=a(".wordcards-speechcards_prevbutton");j.controls.next_button=a(".wordcards-speechcards_nextbutton");j.controls.standalonepushrecorder=a(".speechcards_standalonerecorder");j.controls.slider=a(".wordcards-poodllspeechcards_box")},do_next:function do_next(){e.progress_dots(j.results,j.terms);j.clearStarRating();if(!j.is_end()){j.move_card(">");j.update_header()}else{j.do_end()}},do_prev:function do_prev(){j.move_card("<");j.update_header()},move_card:function move_card(a){switch(a){case"<":j.set_pointer(j.pointer-1);j.controls.slider.toggle("slide",{direction:"right"});j.controls.slider.text(j.terms[j.pointer-1].term);j.controls.slider.toggle("slide",{direction:"left"});j.update_header();break;case">":default:j.set_pointer(j.pointer+1);j.controls.slider.toggle("slide",{direction:"left"});j.controls.slider.text(j.terms[j.pointer-1].term);j.controls.slider.toggle("slide",{direction:"right"});j.update_header();}},clearStarRating:function clearStarRating(){a("#wordcards-star-rating").html("\xB7 \xB7 \xB7")},register_events:function register_events(){j.controls.prev_button.click(function(){j.do_prev()});j.controls.next_button.click(function(){var a=j.terms[j.pointer-1].term;j.check(!1,a);j.do_next()});a("body").on("click","#wordcards-close-results",function(){var a=j.timer.count,b=j.nexturl.replace(/&amp;/g,"&")+"&localscattertime="+a;window.location.replace(b)});a("body").on("click","#wordcards-try-again",function(){location.reload()});a("body").on("click","#wordcards-start-button",function(){j.start()})},process:function process(a){j.terms=a.terms;j.has_images=a.has_images;e.list_vocab("#vocab-list-inner",j.terms);this.initComponents()},set_pointer:function set_pointer(a){j.pointer=a},initCards:function initCards(){j.controls.slider.text(j.terms[j.pointer-1].term)},initComponents:function initComponents(){var b=this,c=function(b){console.log(b);switch(b.type){case"recording":break;case"speech":var c=b.capturedspeech,e=j.cleanText(c),f=e,g=j.terms[j.pointer-1].term,h=j.similarity(f,g);d.debug("JS similarity: "+f+":"+g+":"+h);if(h>=j.passmark||j.wordsDoMatch(e,j.terms[j.pointer-1])){d.debug("local match::"+f+":"+g);j.showStarRating(100);j.flagCorrectAndTransition(j.terms[j.pointer-1]);return}j.checkByPhonetic(f,g).then(function(b){if(!1===b){return a.Deferred().reject()}else{d.debug("PHP similarity: "+f+":"+g+":"+b);j.showStarRating(b);if(b>=j.passmark){j.flagCorrectAndTransition(b,j.terms[j.pointer-1])}}});}},e="wordcards-speechcards_pushrecorder";if(this.use_ttrecorder()){g.clone().init({uniqueid:e,callback:c})}else{f.init(e,c)}},showStarRating:function showStarRating(b){var c=[!0,!0,!0];if(1>b){c=[!0,!0,!1]}if(b<j.passmark){c=[!0,!1,!1]}if(.5>b){c=[!1,!1,!1]}console.log(c,b);var d="";c.forEach(function(a){if(!0===a){d+="<i class=\"fa fa-star\"></i>"}else{d+="<i class=\"fa fa-star-o\"></i>"}});console.log(d);a("#wordcards-star-rating").html(d)},flagCorrectAndTransition:function flagCorrectAndTransition(a){j.check(!0,a);if(j.is_end()){j.update_header();setTimeout(function(){j.do_end()},700)}else{setTimeout(function(){j.do_next()},700)}},checkByPhonetic:function checkByPhonetic(a,b){return c.call([{methodname:"mod_wordcards_check_by_phonetic",args:{spoken:a,correct:b,language:j.props.language}}])[0]},wordsDoMatch:function wordsDoMatch(b,c){b=j.cleanText(b);c.term=j.cleanText(c.term);if(b==c.term){return!0}if(!c.alternates){return!1}var d=c.alternates.split(","),e=!1;a.each(d,function(a,c){if(j.cleanText(c.toLowerCase())==b){e=!0;return!1}});return e},cleanText:function cleanText(a){var b=a.toLowerCase(),c=b.replace(/['!"#$%&\\'()\*+,\-\.\/:;<=>?@\[\\\]\^_`{|}~']/g,""),d=c.replace(/\s+/g," ").trim();return d},start:function start(){j.results=[];e.shuffle(j.terms);j.controls.vocab_list.hide();j.controls.gameboard.show();j.controls.time_counter.text("00:00");j.clearStarRating();e.progress_dots(j.results,j.terms);j.timer={interval:setInterval(function(){j.timer.update()},1e3),count:0,update:function update(){j.timer.count++;j.controls.time_counter.text(e.pretty_print_secs(j.timer.count))}};j.update_header();this.initCards()},quit:function quit(){clearInterval(j.timer.interval);j.controls.gameboard.hide();j.controls.vocab_list.show()},do_end:function do_end(){clearInterval(j.timer.interval);a("#wordcards-gameboard, #wordcards-quit-button, #wordcards-start-button").hide();a("#wordcards-results").show();var b=[];b.results=j.results;b.total=j.terms.length;b.totalcorrect=e.calc_total_points(j.results);var d=j.timer.count;if(0==d){b.prettytime="00:00"}else{b.prettytime=e.pretty_print_secs(d)}h.render("mod_wordcards/feedback",b).then(function(b){a("#results-inner").html(b)});var f={results:j.results,activity:"speechcards"};console.log(f);c.call([{methodname:"mod_wordcards_report_step_grade",args:{modid:j.modid,correct:b.totalcorrect}}])},is_end:function is_end(){if(j.pointer<j.terms.length){return!1}else{return!0}},update_header:function update_header(){({correct:100*(j.results.filter(function(a){return 0<a.points}).length/j.terms.length),incorrect:100*(j.results.filter(function(a){return 0==a.points}).length/j.terms.length)})},check:function check(b,c){var d=1;if(!0==b){d=1}else{d=0}a(".a4e-distractor").css("pointer-events","none");var e={pointer:j.pointer,question:j.terms[j.pointer-1].definition,selected:c,correct:j.terms[j.pointer-1].term,points:d};a.each(j.results,function(a){if(j.pointer===a.pointer){}});j.results.push(e);if(b){this.reportSuccess(j.terms[j.pointer-1].id)}else{this.reportFailure(j.terms[j.pointer-1].id,0)}},reportFailure:function reportFailure(a,b){if(this.dryRun){return}c.call([{methodname:"mod_wordcards_report_failed_association",args:{term1id:a,term2id:b}}])},reportSuccess:function reportSuccess(a){if(this.dryRun){return}c.call([{methodname:"mod_wordcards_report_successful_association",args:{termid:a}}])},similarity:function similarity(a,b){var c=a,d=b;if(a.length<b.length){c=b;d=a}var e=c.length;if(0==e){return 1}return(e-j.editDistance(c,d))/parseFloat(e)},editDistance:function editDistance(a,b){a=a.toLowerCase();b=b.toLowerCase();for(var c=[],d=0,e;d<=a.length;d++){e=d;for(var f=0;f<=b.length;f++){if(0==d)c[f]=f;else{if(0<f){var g=c[f-1];if(a.charAt(d-1)!=b.charAt(f-1))g=Math.min(Math.min(g,e),c[f])+1;c[f-1]=e;e=g}}}if(0<d)c[b.length]=e}return c[b.length]},mobile_user:function mobile_user(){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){return!0}else{return!1}},chrome_user:function chrome_user(){if(/Chrome/i.test(navigator.userAgent)){return!0}else{return!1}},use_ttrecorder:function use_ttrecorder(){var a=!1;switch(this.region){case"tokyo":case"useast1":case"dublin":case"sydney":a=!0;break;default:a=this.chrome_user();}return a}};return j});
//# sourceMappingURL=speechcards.min.js.map
