define(["jquery","core/log","mod_solo/popoverhelper"],(function($,log,popoverhelper){return log.debug("Passage Markup: initialising"),{controls:{},currentmode:"grading",constants:{REVIEWMODE_NOERRORS:0,REVIEWMODE_SHOWERRORS:1},cd:{passagecontainer:"mod_solo_grading_passagecont",summarytranscript:"mod_solo_summarytranscript",summarytranscriptplaceholder:"mod_solo_summarytranscriptplaceholder",audioplayerclass:"mod_solo_passageaudioplayer",wordplayerclass:"mod_solo_hidden_player",wordclass:"mod_solo_grading_passageword",spaceclass:"mod_solo_grading_passagespace",badwordclass:"mod_solo_grading_badword",endspaceclass:"mod_solo_grading_endspace",unreadwordclass:"mod_solo_grading_unreadword",unreadspaceclass:"mod_solo_grading_unreadspace",aiunmatched:"mod_solo_aiunmatched",turnclass:"summarytranscriptpart"},options:{endwordnumber:0,errorwords:{},activityid:null,attemptid:null,sesskey:null,turns:[],reviewmode:1},init:function(config){var theid="#"+config.id,configcontrol=$(theid).get(0);if(configcontrol){var opts=JSON.parse(configcontrol.value);$(theid).remove(),this.register_controls(),this.options.activityid=opts.activityid,this.options.attemptid=opts.attemptid,this.options.sesskey=opts.sesskey,this.options.turns=opts.turns,this.options.totalwordcount=$("."+this.cd.wordclass).length,opts.sessiontime>0?(""!==opts.sessionerrors?this.options.errorwords=JSON.parse(opts.sessionerrors):this.options.errorwords={},this.options.totalseconds=opts.sessiontime,this.options.endwordnumber=opts.sessionendword,this.options.sessionscore=opts.sessionscore,opts.sessionmatches?this.options.sessionmatches=JSON.parse(opts.sessionmatches):this.options.sessionmatches=[],this.options.aidata=opts.aidata,this.options.aidata?(this.options.transcriptwords=opts.aidata.transcript.split(" "),this.options.transcriptwords=this.options.transcriptwords.filter((function(el){return""!==el}))):this.options.transcriptwords=[],this.markup_badwords(),this.markup_aiunmatchedwords(),this.markup_aiunmatchedspaces(),this.markup_turns(),$("."+this.cd.passagecontainer).removeClass(this.cd.summarytranscriptplaceholder).addClass(this.cd.summarytranscript)):this.options.endwordnumber=this.options.totalwordcount,$("#"+this.cd.spaceclass+"_"+this.options.endwordnumber).addClass(this.cd.endspaceclass),this.register_events(),this.init_popoverhelper()}else log.debug("Passage Markup js: No config found on page. Giving up.")},init_popoverhelper:function(){popoverhelper.init()},register_controls:function(){this.controls.wordplayer=$("#"+this.cd.wordplayerclass),this.controls.audioplayer=$("#"+this.cd.audioplayerclass),this.controls.eachword=$("."+this.cd.wordclass),this.controls.eachspace=$("."+this.cd.spaceclass),this.controls.endwordmarker=$("#"+this.cd.spaceclass+"_"+this.options.endwordnumber),this.controls.passagecontainer=$("."+this.cd.passagecontainer)},register_events:function(){var that=this;this.controls.passagecontainer.on("click","."+this.cd.wordclass,(function(){var wordnumber=parseInt($(this).attr("data-wordnumber"));if(popoverhelper.isShowing(this)||that.doPlaySpotCheck(wordnumber),$(this).hasClass(that.cd.aiunmatched)){var chunk=that.fetchTranscriptChunk(wordnumber);chunk&&popoverhelper.addTranscript(this,chunk)}}))},doPlaySpotCheck:function(spotcheckindex){var playchain=this.fetchWordPlayChain(spotcheckindex);log.debug(playchain);var theplayer=this.controls.audioplayer[0],duration=theplayer.duration,endtime=parseFloat(playchain.audioend);!isNaN(duration)&&duration>endtime+.5&&(endtime+=.5);var starttime=parseFloat(playchain.audiostart);starttime-.5>0&&(starttime-=.5),theplayer.currentTime=starttime,$(this.controls.audioplayer).off("timeupdate"),$(this.controls.audioplayer).on("timeupdate",(function(e){theplayer.currentTime>=endtime&&($(this).off("timeupdate"),theplayer.pause())})),theplayer.play()},fetchTurnEndWord:function(currentwordindex){var turnend=$("#"+this.cd.wordclass+"_"+currentwordindex).siblings("."+this.cd.wordclass).last().attr("data-wordnumber");return(!turnend||turnend<currentwordindex)&&(turnend=currentwordindex),turnend},fetchTurnStartWord:function(currentwordindex){var turnstart=$("#"+this.cd.wordclass+"_"+currentwordindex).siblings("."+this.cd.wordclass).first().attr("data-wordnumber");return(!turnstart||turnstart>currentwordindex)&&(turnstart=currentwordindex),turnstart},fetchWordPlayChain:function(wordnumber){var isbad=$("#"+this.cd.wordclass+"_"+wordnumber).hasClass(this.cd.badwordclass),isunmatched=$("#"+this.cd.wordclass+"_"+wordnumber).hasClass(this.cd.aiunmatched);if(isbad||isunmatched)return this.fetchBadWordPlayChain(wordnumber);var starttime=this.options.sessionmatches[""+wordnumber].audiostart,endtime=this.options.sessionmatches[""+wordnumber].audioend,playchain={};return playchain.startword=wordnumber,playchain.endword=wordnumber,playchain.audiostart=starttime,playchain.audioend=endtime,playchain},fetchBadWordPlayChain:function(spotcheckindex){for(var audiostartword=0,audioendword=0,startindex=spotcheckindex,starttime=-1,wordnumber=spotcheckindex;wordnumber>0;wordnumber--){var isbad=$("#"+this.cd.wordclass+"_"+wordnumber).hasClass(this.cd.badwordclass),isunmatched=$("#"+this.cd.wordclass+"_"+wordnumber).hasClass(this.cd.aiunmatched);if(!isbad&&!isunmatched)break;startindex=wordnumber,isunmatched?starttime=-1:(starttime=this.options.sessionmatches[""+wordnumber].audiostart,audiostartword=wordnumber)}if(-1===starttime){starttime=0;for(wordnumber=startindex-1;wordnumber>0;wordnumber--)if(this.options.sessionmatches[""+wordnumber]){starttime=this.options.sessionmatches[""+wordnumber].audioend,audiostartword=wordnumber;break}}var endindex=spotcheckindex,endtime=-1,passageendword=this.options.totalwordcount;for(wordnumber=spotcheckindex;wordnumber<=passageendword;wordnumber++){isbad=$("#"+this.cd.wordclass+"_"+wordnumber).hasClass(this.cd.badwordclass),isunmatched=$("#"+this.cd.wordclass+"_"+wordnumber).hasClass(this.cd.aiunmatched);if(!isbad&&!isunmatched)break;endindex=wordnumber,isunmatched?endtime=-1:(endtime=this.options.sessionmatches[""+wordnumber].audioend,audioendword=wordnumber)}if(-1===endtime){endtime=this.options.totalseconds;for(wordnumber=endindex+1;wordnumber<=passageendword;wordnumber++)if(this.options.sessionmatches[""+wordnumber]){endtime=this.options.sessionmatches[""+wordnumber].audiostart,audioendword=wordnumber;break}}var playchain={};playchain.startword=startindex,playchain.endword=parseInt(endindex),playchain.audiostart=starttime,playchain.audioend=parseInt(endtime);var turnstart=this.fetchTurnStartWord(spotcheckindex),turnend=this.fetchTurnEndWord(spotcheckindex),beforelimit=0,afterlimit=0,startadjust=0,endadjust=0;return audiostartword>0&&audiostartword<turnstart&&(beforelimit=spotcheckindex-turnstart+1),audioendword>turnend&&(afterlimit=turnend-spotcheckindex+1),beforelimit&&afterlimit||(beforelimit?(startadjust=.5*beforelimit,playchain.audiostart=playchain.audioend-startadjust,console.log("startadjust:"+startadjust)):afterlimit&&(endadjust=.7*afterlimit,playchain.audioend=playchain.audiostart+endadjust,console.log("endadjust:"+startadjust))),console.log(playchain),playchain},doSpotCheckMode:function(){this.markup_aiunmatchedwords(),$("."+this.cd.badwordclass).addClass(this.cd.spotcheckmode),this.markup_aiunmatchedspaces(),this.currentmode="spotcheck"},markup_aiunmatchedwords:function(){var that=this;if(this.options.sessionmatches){var prevmatch=0;$.each(this.options.sessionmatches,(function(index,match){var unmatchedcount=index-prevmatch-1;if(unmatchedcount>0)for(var errorword=1;errorword<unmatchedcount+1;errorword++){var wordnumber=prevmatch+errorword;$("#"+that.cd.wordclass+"_"+wordnumber).addClass(that.cd.aiunmatched)}prevmatch=parseInt(index)}));for(var errorword=prevmatch+1;errorword<=this.options.endwordnumber;errorword++)$("#"+that.cd.wordclass+"_"+errorword).addClass(that.cd.aiunmatched)}},markup_aiunmatchedspaces:function(){var that=this;$("."+this.cd.wordclass+"."+this.cd.aiunmatched).each((function(index){var wordnumber=parseInt($(this).attr("data-wordnumber"));($("#"+that.cd.wordclass+"_"+(wordnumber+1)).hasClass(that.cd.spotcheckmode)||$("#"+that.cd.wordclass+"_"+(wordnumber+1)).hasClass(that.cd.aiunmatched))&&$("#"+that.cd.spaceclass+"_"+wordnumber).addClass(that.cd.aiunmatched)}))},undoSpotCheckMode:function(){$("."+this.cd.badwordclass).removeClass(this.cd.spotcheckmode),$("."+this.cd.spaceclass).removeClass(this.cd.spotcheckmode),$("."+this.cd.wordclass).removeClass(this.cd.aiunmatched),$("."+this.cd.spaceclass).removeClass(this.cd.aiunmatched),$(this.controls.audioplayer).off("timeupdate"),popoverhelper.remove()},doTranscriptCheckMode:function(){var that=this;if(this.options.sessionmatches){var prevmatch=0;$.each(this.options.sessionmatches,(function(index,match){var unmatchedcount=index-prevmatch-1;if(unmatchedcount>0)for(var errorword=1;errorword<unmatchedcount+1;errorword++){var wordnumber=prevmatch+errorword;$("#"+that.cd.wordclass+"_"+wordnumber).addClass(that.cd.aiunmatched)}prevmatch=parseInt(index)}));for(var errorword=prevmatch+1;errorword<=this.options.endwordnumber;errorword++)$("#"+that.cd.wordclass+"_"+errorword).addClass(that.cd.aiunmatched)}$("."+this.cd.aiunmatched).each((function(index){var wordnumber=parseInt($(this).attr("data-wordnumber"));$("#"+that.cd.wordclass+"_"+(wordnumber+1)).hasClass(that.cd.aiunmatched)&&$("#"+that.cd.spaceclass+"_"+wordnumber).addClass(that.cd.aiunmatched)})),this.currentmode="transcriptcheck"},undoTranscriptCheckMode:function(){$("."+this.cd.wordclass).removeClass(this.cd.aiunmatched),$("."+this.cd.spaceclass).removeClass(this.cd.aiunmatched)},fetchTranscriptChunk:function(checkindex){var transcriptlength=this.options.transcriptwords.length;if(0===transcriptlength)return"";for(var startindex=-1,startpassageindex=-1,wordnumber=checkindex;wordnumber>0;wordnumber--){var isunmatched=$("#"+this.cd.wordclass+"_"+wordnumber).hasClass(this.cd.aiunmatched),isunreadword=$("#"+this.cd.wordclass+"_"+wordnumber).hasClass(this.cd.unreadwordclass);if(!isunmatched&&!isunreadword){startindex=this.options.sessionmatches[""+wordnumber].tposition+1;startpassageindex=wordnumber;break}}var endindex=-1,endpassageindex=-1;for(wordnumber=checkindex;wordnumber<=transcriptlength;wordnumber++){if(!(isunmatched=$("#"+this.cd.wordclass+"_"+wordnumber).hasClass(this.cd.aiunmatched))){endindex=this.options.sessionmatches[""+wordnumber].tposition-1,endpassageindex=wordnumber;break}}if(-1===startindex&&(startindex=1),endindex===transcriptlength)endindex=-1;else if(0===endindex||endindex<startindex)return!1;var turnstart=this.fetchTurnStartWord(checkindex),turnend=this.fetchTurnEndWord(checkindex),beforelimit=0,afterlimit=0;if(startpassageindex<turnstart)beforelimit=checkindex-turnstart+1;if(endpassageindex>turnend||-1==endpassageindex)afterlimit=turnend-checkindex+1;if(beforelimit&&afterlimit)return!1;if(beforelimit){if((startindex=endindex-beforelimit)<1)return!1}else if(afterlimit&&(endindex=startindex+afterlimit)>+transcriptlength)return!1;startindex--;var ret=!1;return""!==(ret=endindex>0?this.options.transcriptwords.slice(startindex,endindex).join(" "):this.options.transcriptwords.slice(startindex).join(" ")).trim()&&ret},markup_badwords:function(){var m=this;this.processunread(),this.options.reviewmode==this.constants.REVIEWMODE_SHOWERRORS&&$.each(m.options.errorwords,(function(index){$("#"+m.cd.wordclass+"_"+m.options.errorwords[index].wordnumber).addClass(m.cd.badwordclass)}))},markup_turns:function(){var m=this,turnspan='<span class="'+m.cd.turnclass+'"></span>';$.each(m.options.turns,(function(index){for(var startelement=$("#"+m.cd.wordclass+"_"+m.options.turns[index].start),newturnspan=$(turnspan).insertBefore(startelement),i=m.options.turns[index].start;i<=m.options.turns[index].end;i++)newturnspan.append($("#"+m.cd.wordclass+"_"+i)),newturnspan.append($("#"+m.cd.spaceclass+"_"+i))}))},processspace:function(){var m=this,wordnumber=$(this).attr("data-wordnumber"),thespace=$("#"+m.cd.spaceclass+"_"+wordnumber);wordnumber===m.options.endwordnumber?(m.options.endwordnumber=m.options.totalwordcount,thespace.removeClass(m.cd.endspaceclass),$("#"+m.cd.spaceclass+"_"+m.options.totalwordcount).addClass(m.cd.endspaceclass)):($("#"+m.cd.spaceclass+"_"+m.options.endwordnumber).removeClass(m.cd.endspaceclass),m.options.endwordnumber=wordnumber,thespace.addClass(m.cd.endspaceclass)),m.processunread(),m.processscores()},processunread:function(){var m=this;m.controls.eachword.each((function(index){var wordnumber=$(this).attr("data-wordnumber"),thespace=$("#"+m.cd.spaceclass+"_"+wordnumber);Number(wordnumber)>Number(m.options.endwordnumber)?($(this).addClass(m.cd.unreadwordclass),thespace.addClass(m.cd.unreadspaceclass),m.options.enforcemarker&&wordnumber in m.options.errorwords&&(delete m.options.errorwords[wordnumber],$(this).removeClass(m.cd.badwordclass))):($(this).removeClass(m.cd.unreadwordclass),thespace.removeClass(m.cd.unreadspaceclass))}))}}}));

//# sourceMappingURL=passagemarkup.min.js.map