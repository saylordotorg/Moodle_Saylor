define ("mod_solo/passagemarkup",["jquery","core/log","mod_solo/popoverhelper"],function(a,b,c){"use strict";b.debug("Passage Markup: initialising");return{controls:{},currentmode:"grading",constants:{REVIEWMODE_NOERRORS:0,REVIEWMODE_SHOWERRORS:1},cd:{passagecontainer:"mod_solo_grading_passagecont",summarytranscript:"mod_solo_summarytranscript",summarytranscriptplaceholder:"mod_solo_summarytranscriptplaceholder",audioplayerclass:"mod_solo_passageaudioplayer",wordplayerclass:"mod_solo_hidden_player",wordclass:"mod_solo_grading_passageword",spaceclass:"mod_solo_grading_passagespace",badwordclass:"mod_solo_grading_badword",endspaceclass:"mod_solo_grading_endspace",unreadwordclass:"mod_solo_grading_unreadword",unreadspaceclass:"mod_solo_grading_unreadspace",aiunmatched:"mod_solo_aiunmatched",turnclass:"summarytranscriptpart"},options:{endwordnumber:0,errorwords:{},activityid:null,attemptid:null,sesskey:null,turns:[],reviewmode:1},init:function init(c){var d="#"+c.id,e=a(d).get(0);if(e){var f=JSON.parse(e.value);a(d).remove()}else{b.debug("Passage Markup js: No config found on page. Giving up.");return}this.register_controls();this.options.activityid=f.activityid;this.options.attemptid=f.attemptid;this.options.sesskey=f.sesskey;this.options.turns=f.turns;this.options.totalwordcount=a("."+this.cd.wordclass).length;if(0<f.sessiontime){if(""!==f.sessionerrors){this.options.errorwords=JSON.parse(f.sessionerrors)}else{this.options.errorwords={}}this.options.totalseconds=f.sessiontime;this.options.endwordnumber=f.sessionendword;this.options.sessionscore=f.sessionscore;if(f.sessionmatches){this.options.sessionmatches=JSON.parse(f.sessionmatches)}else{this.options.sessionmatches=[]}this.options.aidata=f.aidata;if(this.options.aidata){this.options.transcriptwords=f.aidata.transcript.split(" ");this.options.transcriptwords=this.options.transcriptwords.filter(function(a){return""!==a})}else{this.options.transcriptwords=[]}this.markup_badwords();this.markup_aiunmatchedwords();this.markup_aiunmatchedspaces();this.markup_turns();a("."+this.cd.passagecontainer).removeClass(this.cd.summarytranscriptplaceholder).addClass(this.cd.summarytranscript)}else{this.options.endwordnumber=this.options.totalwordcount}var g=a("#"+this.cd.spaceclass+"_"+this.options.endwordnumber);g.addClass(this.cd.endspaceclass);this.register_events();this.init_popoverhelper()},init_popoverhelper:function init_popoverhelper(){this;c.init()},register_controls:function register_controls(){this.controls.wordplayer=a("#"+this.cd.wordplayerclass);this.controls.audioplayer=a("#"+this.cd.audioplayerclass);this.controls.eachword=a("."+this.cd.wordclass);this.controls.eachspace=a("."+this.cd.spaceclass);this.controls.endwordmarker=a("#"+this.cd.spaceclass+"_"+this.options.endwordnumber);this.controls.passagecontainer=a("."+this.cd.passagecontainer)},register_events:function register_events(){var b=this;this.controls.passagecontainer.on("click","."+this.cd.wordclass,function(){var d=parseInt(a(this).attr("data-wordnumber"));if(!c.isShowing(this)){b.doPlaySpotCheck(d)}if(a(this).hasClass(b.cd.aiunmatched)){var e=b.fetchTranscriptChunk(d);if(e){c.addTranscript(this,e)}}})},doPlaySpotCheck:function doPlaySpotCheck(c){var d=this.fetchWordPlayChain(c);b.debug(d);var e=this.controls.audioplayer[0],f=.5,g=e.duration,h=parseFloat(d.audioend);if(!isNaN(g)&&g>h+f){h=h+f}var i=parseFloat(d.audiostart);if(0<i-f){i=i-f}e.currentTime=i;a(this.controls.audioplayer).off("timeupdate");a(this.controls.audioplayer).on("timeupdate",function(){var b=e.currentTime;if(b>=h){a(this).off("timeupdate");e.pause()}});e.play()},fetchTurnEndWord:function fetchTurnEndWord(b){var c=a("#"+this.cd.wordclass+"_"+b),d=c.siblings("."+this.cd.wordclass).last(),e=d.attr("data-wordnumber");if(!e||e<b){e=b}return e},fetchTurnStartWord:function fetchTurnStartWord(b){var c=a("#"+this.cd.wordclass+"_"+b),d=c.siblings("."+this.cd.wordclass).first(),e=d.attr("data-wordnumber");if(!e||e>b){e=b}return e},fetchWordPlayChain:function fetchWordPlayChain(b){var c=a("#"+this.cd.wordclass+"_"+b).hasClass(this.cd.badwordclass),d=a("#"+this.cd.wordclass+"_"+b).hasClass(this.cd.aiunmatched);if(c||d){return this.fetchBadWordPlayChain(b)}else{var e=this.options.sessionmatches[""+b].audiostart,f=this.options.sessionmatches[""+b].audioend,g={};g.startword=b;g.endword=b;g.audiostart=e;g.audioend=f;return g}},fetchBadWordPlayChain:function fetchBadWordPlayChain(b){for(var c=0,d=0,e=b,f=-1,g=b;0<g;g--){var h=a("#"+this.cd.wordclass+"_"+g).hasClass(this.cd.badwordclass),i=a("#"+this.cd.wordclass+"_"+g).hasClass(this.cd.aiunmatched);if(h||i){e=g;if(!i){f=this.options.sessionmatches[""+g].audiostart;c=g}else{f=-1}}else{break}}if(-1===f){f=0;for(var g=e-1;0<g;g--){if(this.options.sessionmatches[""+g]){f=this.options.sessionmatches[""+g].audioend;c=g;break}}}for(var j=b,k=-1,l=this.options.totalwordcount,g=b;g<=l;g++){var h=a("#"+this.cd.wordclass+"_"+g).hasClass(this.cd.badwordclass),i=a("#"+this.cd.wordclass+"_"+g).hasClass(this.cd.aiunmatched);if(h||i){j=g;if(!i){k=this.options.sessionmatches[""+g].audioend;d=g}else{k=-1}}else{break}}if(-1===k){k=this.options.totalseconds;for(var g=j+1;g<=l;g++){if(this.options.sessionmatches[""+g]){k=this.options.sessionmatches[""+g].audiostart;d=g;break}}}var m={startword:e,endword:parseInt(j),audiostart:f,audioend:parseInt(k)},n=this.fetchTurnStartWord(b),o=this.fetchTurnEndWord(b),p=0,q=0,r=0,s=0;if(0<c&&c<n){p=b-n+1}if(d>o){q=o-b+1}if(!(p&&q)){if(p){r=.5*p;m.audiostart=m.audioend-r;console.log("startadjust:"+r)}else if(q){s=.7*q;m.audioend=m.audiostart+s;console.log("endadjust:"+r)}}console.log(m);return m},doSpotCheckMode:function doSpotCheckMode(){this;this.markup_aiunmatchedwords();a("."+this.cd.badwordclass).addClass(this.cd.spotcheckmode);this.markup_aiunmatchedspaces();this.currentmode="spotcheck"},markup_aiunmatchedwords:function markup_aiunmatchedwords(){var b=this;if(this.options.sessionmatches){var c=0;a.each(this.options.sessionmatches,function(d){var e=d-c-1;if(0<e){for(var f=1,g;f<e+1;f++){g=c+f;a("#"+b.cd.wordclass+"_"+g).addClass(b.cd.aiunmatched)}}c=parseInt(d)});for(var d=c+1;d<=this.options.endwordnumber;d++){a("#"+b.cd.wordclass+"_"+d).addClass(b.cd.aiunmatched)}}},markup_aiunmatchedspaces:function markup_aiunmatchedspaces(){var b=this;a("."+this.cd.wordclass+"."+this.cd.aiunmatched).each(function(){var c=parseInt(a(this).attr("data-wordnumber"));if(a("#"+b.cd.wordclass+"_"+(c+1)).hasClass(b.cd.spotcheckmode)||a("#"+b.cd.wordclass+"_"+(c+1)).hasClass(b.cd.aiunmatched)){a("#"+b.cd.spaceclass+"_"+c).addClass(b.cd.aiunmatched)}})},undoSpotCheckMode:function undoSpotCheckMode(){a("."+this.cd.badwordclass).removeClass(this.cd.spotcheckmode);a("."+this.cd.spaceclass).removeClass(this.cd.spotcheckmode);a("."+this.cd.wordclass).removeClass(this.cd.aiunmatched);a("."+this.cd.spaceclass).removeClass(this.cd.aiunmatched);a(this.controls.audioplayer).off("timeupdate");c.remove()},doTranscriptCheckMode:function doTranscriptCheckMode(){var b=this;if(this.options.sessionmatches){var c=0;a.each(this.options.sessionmatches,function(d){var e=d-c-1;if(0<e){for(var f=1,g;f<e+1;f++){g=c+f;a("#"+b.cd.wordclass+"_"+g).addClass(b.cd.aiunmatched)}}c=parseInt(d)});for(var d=c+1;d<=this.options.endwordnumber;d++){a("#"+b.cd.wordclass+"_"+d).addClass(b.cd.aiunmatched)}}a("."+this.cd.aiunmatched).each(function(){var c=parseInt(a(this).attr("data-wordnumber"));if(a("#"+b.cd.wordclass+"_"+(c+1)).hasClass(b.cd.aiunmatched)){a("#"+b.cd.spaceclass+"_"+c).addClass(b.cd.aiunmatched)}});this.currentmode="transcriptcheck"},undoTranscriptCheckMode:function undoTranscriptCheckMode(){a("."+this.cd.wordclass).removeClass(this.cd.aiunmatched);a("."+this.cd.spaceclass).removeClass(this.cd.aiunmatched)},fetchTranscriptChunk:function fetchTranscriptChunk(b){var c=this.options.transcriptwords.length;if(0===c){return""}for(var d=-1,e=-1,f=b;0<f;f--){var g=a("#"+this.cd.wordclass+"_"+f).hasClass(this.cd.aiunmatched),h=a("#"+this.cd.wordclass+"_"+f).hasClass(this.cd.unreadwordclass);if(!g&&!h){d=this.options.sessionmatches[""+f].tposition+1;var e=f;break}}for(var i=-1,j=-1,f=b,g;f<=c;f++){g=a("#"+this.cd.wordclass+"_"+f).hasClass(this.cd.aiunmatched);if(!g){i=this.options.sessionmatches[""+f].tposition-1;j=f;break}}if(-1===d){d=1}if(i===c){i=-1}else if(0===i||i<d){return!1}var k=this.fetchTurnStartWord(b),l=this.fetchTurnEndWord(b),m=0,n=0;if(e<k){var m=b-k+1}if(j>l||-1==j){var n=l-b+1}if(m&&n){return!1}if(m){d=i-m;if(1>d){return!1}}else if(n){i=d+n;if(i>+c){return!1}}d--;var o=!1;if(0<i){o=this.options.transcriptwords.slice(d,i).join(" ")}else{o=this.options.transcriptwords.slice(d).join(" ")}if(""===o.trim()){return!1}else{return o}},markup_badwords:function markup_badwords(){var b=this;this.processunread();if(this.options.reviewmode==this.constants.REVIEWMODE_SHOWERRORS){a.each(b.options.errorwords,function(c){a("#"+b.cd.wordclass+"_"+b.options.errorwords[c].wordnumber).addClass(b.cd.badwordclass)})}},markup_turns:function markup_turns(){var b=this,c="<span class=\""+b.cd.turnclass+"\"></span>";a.each(b.options.turns,function(d){var e=a("#"+b.cd.wordclass+"_"+b.options.turns[d].start),f=a(c).insertBefore(e);for(var g=b.options.turns[d].start;g<=b.options.turns[d].end;g++){f.append(a("#"+b.cd.wordclass+"_"+g));f.append(a("#"+b.cd.spaceclass+"_"+g))}})},processspace:function processspace(){var b=this,c=a(this).attr("data-wordnumber"),d=a("#"+b.cd.spaceclass+"_"+c);if(c===b.options.endwordnumber){b.options.endwordnumber=b.options.totalwordcount;d.removeClass(b.cd.endspaceclass);a("#"+b.cd.spaceclass+"_"+b.options.totalwordcount).addClass(b.cd.endspaceclass)}else{a("#"+b.cd.spaceclass+"_"+b.options.endwordnumber).removeClass(b.cd.endspaceclass);b.options.endwordnumber=c;d.addClass(b.cd.endspaceclass)}b.processunread();b.processscores()},processunread:function processunread(){var b=this;b.controls.eachword.each(function(){var c=a(this).attr("data-wordnumber"),d=a("#"+b.cd.spaceclass+"_"+c);if(+c>+b.options.endwordnumber){a(this).addClass(b.cd.unreadwordclass);d.addClass(b.cd.unreadspaceclass);if(b.options.enforcemarker&&c in b.options.errorwords){delete b.options.errorwords[c];a(this).removeClass(b.cd.badwordclass)}}else{a(this).removeClass(b.cd.unreadwordclass);d.removeClass(b.cd.unreadspaceclass)}})}}});
//# sourceMappingURL=passagemarkup.min.js.map
