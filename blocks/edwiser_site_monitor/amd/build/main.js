define(["jquery","core/ajax","core/notification","core/modal_factory","core/chartjs"],function(e,t,s,i){var a=".usage-progress-bar",r=".edwiser_site_monitor #edwiser_site_monitor_plugins .edwiser-server-monitor-loader",o=".edwiser_site_monitor #edwiser_site_monitor_contactus .edwiser-server-monitor-loader",n=".edwiser_site_monitor #edwiser_site_monitor_last_24_hours_usage .edwiser-server-monitor-loader",l=".block_edwiser_site_monitor.block",d=".edwiser_site_monitor .server-plugins-list",c="progress-status";return{init:function(){var _="",g=null,u=fetchtinglastusage=fetchtingplugins=sendingemail=!1;function m(e,t){return(t*e/100).toFixed(2)+"G/"+t.toFixed(2)+"G"}e(a).bind(c,function(t,s){let i="bg-danger";s<30?i="bg-success":s<80&&(i="bg-warning"),e(this).removeClass("bg-success bg-warning bg-danger").addClass(i)});var f=function(){u||(u=!0,t.call([{methodname:"block_edwiser_site_monitor_get_live_status",args:{}}])[0].done(function(t){e(l).find("#esm_cpu_usage_bar").css("width",t.cpu+"%").trigger(c,[t.cpu]),e(l).find("#esm_memory_usage_bar").css("width",t.memory+"%").trigger(c,[t.memory]),e(l).find("#esm_storage_usage_bar").css("width",t.storage+"%").trigger(c,[t.storage]),e(l).find("#esm_cpu_usage_label").text(t.cpu+"%"),e(l).find("#esm_memory_usage_label").text(t.memory+"% ("+m(t.memory,totalmemory)+")"),e(l).find("#esm_storage_usage_label").text(t.storage+"% ("+m(t.storage,totalstorage)+")"),e(l).find("#esm_live_users_label").text(t.liveusers),u=!1}).fail(function(e){alert(e.message),u=!1}))},h=function(){if(!fetchtinglastusage){fetchtinglastusage=!0,e(n).addClass("show");var s=e(l).find("#esm_usage_date_selector").val()||0;t.call([{methodname:"block_edwiser_site_monitor_get_last_24_hours_usage",args:{timestamp:s}}])[0].done(function(t){if(fetchtinglastusage=!1,e(n).removeClass("show"),null!=g)return g.data.labels=JSON.parse(t.time),g.data.datasets[0].data=JSON.parse(t.cpu),g.data.datasets[1].data=JSON.parse(t.memory),g.data.datasets[2].data=JSON.parse(t.storage),void g.update();let s={type:"line",data:{labels:JSON.parse(t.time),datasets:[{label:M.util.get_string("cpuusage","block_edwiser_site_monitor"),data:JSON.parse(t.cpu),borderColor:"#ff4c52",borderWidth:1,fill:!1,pointRadius:0,hoverPointRadius:1},{label:M.util.get_string("memoryusage","block_edwiser_site_monitor"),data:JSON.parse(t.memory),borderColor:"#11c26d",borderWidth:1,fill:!1,pointRadius:0,hoverPointRadius:1},{label:M.util.get_string("storageusage","block_edwiser_site_monitor"),data:JSON.parse(t.storage),borderColor:"#667afa",borderWidth:1,fill:!1,pointRadius:0,hoverPointRadius:1}]},options:{scales:{yAxes:[{position:"right",ticks:{beginAtZero:!1},gridLines:{display:!1},scaleLabel:{display:!0,labelString:M.util.get_string("yaxistitle","block_edwiser_site_monitor")}}],xAxes:[{gridLines:{display:!1},scaleLabel:{display:!0,labelString:M.util.get_string("xaxistitle","block_edwiser_site_monitor")}}]},tooltips:{position:"nearest",mode:"index",intersect:!1,callbacks:{label:function(e,t){var s=t.datasets[e.datasetIndex].label||"";switch(s&&(s+=": "),s+=e.yLabel+"%",e.datasetIndex){case 1:s+=" ("+m(e.yLabel,totalmemory)+")";break;case 2:s+=" ("+m(e.yLabel,totalstorage)+")"}return s}}}}};g=new Chart(e("#esm_usage_chart")[0].getContext("2d"),s)}).fail(function(t){e(n).removeClass("show"),alert(t.message),fetchtinglastusage=!1})}},p=function(){fetchtingplugins||(fetchtingplugins=!0,e(r).addClass("show"),t.call([{methodname:"block_edwiser_site_monitor_get_plugins_update",args:{}}])[0].done(function(t){e(r).removeClass("show"),e(d).html(t.plugins),e(l).find(".edwiser_site_monitor .lasttimefetched").text(t.lasttimefetched),fetchtingplugins=!1}).fail(function(t){e(r).removeClass("show"),s.exception(t),fetchtingplugins=!1}))},b=function(a){sendingemail||(sendingemail=!0,e(o).addClass("show"),t.call(a)[0].done(function(t){e(o).removeClass("show");var s=e("#create-modal");i.create({title:t.header,body:t.message},s).done(function(e){e.header.addClass(t.status?"bg-success":"bg-danger"),e.header.children().addClass("text-white"),e.show()}),t.status&&(e(l).find("#contactus_form button").prop("disabled",!0),e(l).find("#contactus_form_succes").addClass("show")),sendingemail=!1}).fail(function(t){e(o).removeClass("show"),s.exception(t),sendingemail=!1}))};e(document).ready(function(){_=setInterval(function(){f()},1e3*refreshrate),e("#esm_usage_date_selector").change(function(){h()}),e(".edwiser_site_monitor .nav-link").click(function(){e(this).removeClass("active").parents(".nav-item").siblings().removeClass("active"),e(this).parents(l).find(".tab-pane").removeClass("show active");var t=e(this).data("container");switch(e(this).parents(".nav-item").addClass("active"),e(this).parents(l).find("#"+t).addClass("show active"),e(this).data("container")){case"edwiser_site_monitor_view_live_status":_=setInterval(function(){f()},1e3*refreshrate);break;case"edwiser_site_monitor_last_24_hours_usage":h(),clearInterval(_);break;case"edwiser_site_monitor_plugins":""==e.trim(e(d).text())&&e(l).find(".edwiser_site_monitor .refresh-plugin-list").trigger("click");case"edwiser_site_monitor_recommendation":case"edwiser_site_monitor_contactus":clearInterval(_)}}),e("body").on("click",l+" .refresh-plugin-list",function(){p()}).on("click",l+" .edwiser-plugin-filter",function(t){t.preventDefault(),e(this).parent(".server-plugins-list").removeClass("all edwiser other update").addClass(e(this).data("filter")),e(l).find("#plugins-control-panel").removeClass("all edwiser other update").addClass(e(this).data("filter")),e(l).find(".edwiser-plugins-current-list").text(e(this).data("heading")),e(l).find(".edwiser-plugin-filter").removeClass("active"),e(this).addClass("active")}).on("click",".showchangelog",function(t){t.preventDefault();var s=e("#create-modal");i.create({title:M.util.get_string("changelog","block_edwiser_site_monitor"),body:e(this).data("log").changelog},s).done(function(e){e.show()})}),e("#contactus_form").submit(function(t){t.preventDefault();var s=e(this).serializeArray(),i={methodname:"block_edwiser_site_monitor_send_contactus_email",args:{}};e.each(s,function(e,t){i.args[t.name]=t.value}),b([i])})})}}});