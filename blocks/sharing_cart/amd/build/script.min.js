/**
 *  Sharing Cart
 *
 *  @package    block_sharing_cart
 *  @copyright  2017 (C) VERSION2, INC.
 *  @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_sharing_cart/script",["jquery","core/modal_factory","core/modal_events"],(function($,ModalFactory,ModalEvents){return{init:function(addMethod){$(document).ready((function(){let isDragging=!1;function str(identifier){return M.str.block_sharing_cart[identifier]||M.str.moodle[identifier]}function get_action_url(name,args){var url=M.cfg.wwwroot+"/blocks/sharing_cart/"+name+".php";if(args){var q=[];for(var k in args)q.push(k+"="+encodeURIComponent(args[k]));url+="?"+q.join("&")}return url}function remove_basket(){if("drag_and_drop"===addMethod&&!isDragging){const footerIconContainer=document.getElementById("page-footer").querySelector('div[data-region="footer-container-popover"]'),sharingCartBasket=document.querySelector("button.sharing_cart_basket");sharingCartBasket&&(null==footerIconContainer||footerIconContainer.removeChild(sharingCartBasket),sharingCartBasket.classList.remove("shake_basket"))}}function confirm_modal(obj){obj.checkbox&&(obj.body+='<div class="modal-checbox-wrapper"><input type="checkbox" id="modal-checkbox" class="modal-checkbox"><label for="modal-checkbox">'+str("modal_checkbox")+"</label></div>"),ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:obj.title,body:obj.body}).done((function(modal){let is_submitted=!1;modal.setSaveButtonText(obj.save_button),modal.getRoot().on(ModalEvents.save,(function(e){var response={checkbox:$(e.target).find(".modal-checkbox").is(":checked")};obj.next(response),is_submitted=!0})),modal.getRoot().on(ModalEvents.cancel,(function(){remove_basket()})),modal.getRoot().on(ModalEvents.hidden,(function(){$("body").removeClass("modal-open"),is_submitted||remove_basket()})),modal.show()}))}function in_place_edit_section_name($section){var sectionName="",$inPlaceEditable=$section.find("h3.sectionname .inplaceeditable");return $inPlaceEditable.length&&(sectionName=$inPlaceEditable.data("value")),sectionName}function on_backup_modal(post_data,title_str,body_str,isSection){$.post(get_action_url("rest"),post_data,(function(response){!function(response){var checkbox=!1;"1"===response&&(checkbox=!0),confirm_modal({title:title_str,body:body_str,save_button:str("modal_confirm_backup"),checkbox:checkbox,next:function(data){!0===isSection?function(sectionId,sectionNumber,courseId,userdata){var $commands=$("span.inplaceeditable[data-itemtype=sectionname][data-itemid="+sectionId+"]"),$section=$commands.closest("li.section.main"),sectionName=$section.attr("aria-label")||$section.find(".sectionname").text().trim();null===sectionName&&(sectionName=String($("#region-main .section_action_menu[data-sectionid='"+sectionId+"']").parent().parent().find("h3.sectionname").text()));var inPlaceEditSectionName=in_place_edit_section_name($section);sectionName=""!==inPlaceEditSectionName?inPlaceEditSectionName:sectionName;var $spinner=add_spinner(),$node_spinner=add_node_spinner($commands);$.post(get_action_url("rest"),{action:"backup_section",sectionid:sectionId,sectionnumber:sectionNumber,courseid:courseId,sectionname:sectionName,userdata:userdata,sesskey:M.cfg.sesskey},(function(){reload_tree()})).fail((function(response){show_error(response)})).always((function(){$spinner.hide(),$node_spinner.hide(),remove_basket()}))}(post_data.sectionid,post_data.sectionnumber,post_data.courseid,data.checkbox):function(cmid,userdata){var $commands=$("#module-"+cmid+" .actions");$commands.length||($commands=$('[data-owner="#module-'+cmid+'"]'));var $spinner=add_spinner(),$node_spinner=add_node_spinner($commands);$.post(get_action_url("rest"),{action:"backup",cmid:cmid,userdata:userdata,sesskey:M.cfg.sesskey,courseid:course.id},(function(){reload_tree()})).fail((function(response){show_error(response)})).always((function(){$node_spinner.hide(),$spinner.hide(),remove_basket()}))}(post_data.cmid,data.checkbox),function(){if("drag_and_drop"===addMethod){const sharingCartBasket=document.querySelector("button.sharing_cart_basket");null==sharingCartBasket||sharingCartBasket.classList.add("shake_basket")}}()}})}(response)}),"text").fail((function(response){show_error(response)}))}var icon={backup:{css:"editing_backup",iconClass:"fa fa-frown-o"},movedir:{css:"editing_right",iconClass:"fa fa-arrow-right"},move:{css:"editing_move_",iconClass:"fa fa-arrows-v"},edit:{css:"editing_update",iconClass:"fa fa-pencil"},cancel:{css:"editing_cancel",iconClass:"fa fa-ban"},delete:{css:"editing_update",iconClass:"fa fa-trash"},restore:{css:"editing_restore",iconClass:"fa fa-clone"},"dir-open":{iconClass:"fa fa-folder-open-o"},"dir-closed":{iconClass:"fa fa-folder-o"}},$block=$(".block_sharing_cart"),course=new function(){var body=$("body");this.id=body.attr("class").match(/course-(\d+)/)[1],this.is_frontpage=body.hasClass("pagelayout-frontpage")};function show_error(response){try{var ex=JSON.parse(response.responseText);new M.core.exception({name:str("pluginname")+" - "+str("error"),message:ex.message})}catch(e){new M.core.exception({name:str("pluginname")+" - "+str("error"),message:response.responseText})}}function create_command(name){var iconElement=$("<i/>").attr("alt",str(name)).attr("class",icon[name].iconClass);return $('<a href="javascript:void(0)"/>').addClass(icon[name].css).attr("title",str(name)).append(iconElement)}function add_spinner(){var $spinner=$('<div class="block_spinner"><i class="fa fa-shopping-basket sharing_cart_basket shake_basket fa-2x"></i></div>');return $("section.block_sharing_cart").append($spinner),$spinner}function add_node_spinner($node){var $node_spinner=$('<i class="fa fa-circle-o-notch fa-spin node_spinner"></i>');return $node.append($node_spinner),$node_spinner}function reload_tree(){$.post(get_action_url("rest"),{action:"render_tree",courseid:course.id},(function(response){$block.find(".tree").replaceWith($(response)),$.init_item_tree()}),"html").fail((function(response){show_error(response)}))}$(document).on("click","a.restore",(function(){add_spinner()}));var directories=new function(){var param,readCookie,KEY="block_sharing_cart-dirs",opens=(param=KEY,readCookie=document.cookie.match("(^|;)\\s*"+param+"\\s*=\\s*([^;]+)"),readCookie?readCookie.pop():"").split(",").map((function(v){return parseInt(v)}));function save(){var expires=new Date;expires.setDate(expires.getDate()+30),function(name,value,expireTimeInMillisecond){var d=new Date;d.setTime(d.getTime()+expireTimeInMillisecond);var expires="expires="+d.toUTCString();document.cookie=name+"="+value+";"+expires}(KEY,opens.join(","),expires)}function open($dir,visible){var iconElement=icon[visible?"dir-open":"dir-closed"].iconClass;$dir.find("> div i.icon").attr("class","icon "+iconElement),$dir.find("> ul.list")[visible?"show":"hide"]()}this.init=function(){var i=0;$block.find("li.directory").each((function(index,dir){var $dir=$(dir);$dir.attr("id","block_sharing_cart-dir-"+i),i>=opens.length?opens.push(0):opens[i]&&open($dir,!0),$dir.find("> div div.toggle-wrapper").css("cursor","pointer").on("click",(function(e){!function(e){var $dir=$(e.target).closest("li.directory"),i=$dir.attr("id").match(/(\d+)$/)[1],v="none"===$dir.find("> ul.list").css("display");open($dir,v),opens[i]=v?1:0,save()}(e)})),i++}))},this.reset=function(){opens=[],this.init(),save()}},move_targets=new function(){var $cancel=null,targets=[];this.hide=function(){if(null!==$cancel){var $commands=$cancel.closest(".commands");$cancel.remove(),$cancel=null,$commands.closest("li.activity").css("opacity",1),$commands.find("a").each((function(){$(this).show()})),$.each(targets,(function(index,$target){$target.remove()})),targets=[]}},this.show=function(item_id){this.hide();var $current=$block.find("#block_sharing_cart-item-"+item_id),$next=$current.next(),$list=$current.closest("ul"),next_id=0;function create_target(item_id,area_to){var $anchor=$('<a href="javascript:void(0)"/>').addClass("move-"+item_id+"-to-"+area_to).attr("title",str("movehere")).append($("<p>"+str("clicktomove")+"</p>").attr("alt",str("movehere"))),$target=$('<li class="activity move-to"/>').append($anchor);return $anchor.on("click",(function(e){!function(e){var m=$(e.target).closest("a").attr("class").match(/move-(\d+)-to-(\d+)/),item_id=m[1],area_to=m[2],$spinner=add_spinner();$.post(get_action_url("rest"),{action:"move",item_id:item_id,area_to:area_to,sesskey:M.cfg.sesskey},(function(){reload_tree()})).fail((function(response){show_error(response)})).always((function(){$spinner.hide()}))}(e)})),$target}if($next.length&&(next_id=$next.attr("id").match(/item-(\d+)$/)[1]),$list.find("> li.activity").each((function(index,item){var $item=$(item),to=$item.attr("id").match(/item-(\d+)$/)[1];if(to===item_id){($cancel=create_command("cancel")).on("click",(function(){move_targets.hide()}));var $commands=$item.find(".commands");$commands.find("a").each((function(){$(this).hide()})),$commands.append($cancel),$item.css("opacity",.5)}else if(to!==next_id){var $target=create_target(item_id,to);$item.before($target),targets.push($target)}}),this),$next){var $target=create_target(item_id,0);$list.append($target),targets.push($target)}}},restore_targets=new function(){this.is_directory=null;var $clipboard=null,targets=[];function create_target(id,section){var href="",inSection=$("#copy-section-form").data("in-section");href=restore_targets.is_directory?get_action_url("restore",{directory:!0,path:id,course:course.id,section:section,in_section:inSection,sesskey:M.cfg.sesskey}):get_action_url("restore",{directory:!1,id:id,course:course.id,section:section,in_section:inSection,sesskey:M.cfg.sesskey});var $target=$("<a/>").attr("class","restore").attr("href",href).attr("title",str("copyhere")).append($('<img class="move_target"/>').attr("alt",str("copyhere")).attr("src",M.util.image_url("dropzone_arrow","block_sharing_cart")));return targets.push($target),$target}this.hide=function(){null!==$clipboard&&($clipboard.remove(),$clipboard=null,$.each(targets,(function(index,$target){$target.remove()})),targets=[])},this.show=function(id){this.hide();var $view=$("<span/>");if(this.is_directory)$view.html(id).css("display","inline"),$view.prepend($("<i/>").addClass("icon").attr("alt",id));else{var $item=$block.find("#block_sharing_cart-item-"+id);($view=$($item.find("div")[0].cloneNode(!0)).css("display","inline")).attr("class",$view.attr("class").replace(/mod-indent-\d+/,"")),$view.find(".commands").remove()}var $cancel=create_command("cancel");if($cancel.on("click",this.hide),($clipboard=$('<div class="clipboard"/>')).append(str("clipboard")+": ").append($view).append($cancel),course.is_frontpage){var $sitetopic=$(".sitetopic"),$mainmenu=$(".block_site_main_menu");$sitetopic?$sitetopic.find("*").before($clipboard):$mainmenu&&$mainmenu.find(".content").before($clipboard),$mainmenu&&$mainmenu.find(".footer").before(create_target(id,0)),$sitetopic&&$sitetopic.find("ul.section").append(create_target(id,1))}else{var $container=$(".course-content");$container.prepend($clipboard),$container.find(M.course.format.get_section_wrapper(null)).each((function(index,sectionDOM){var $section=$(sectionDOM),section=$section.attr("id").match(/(\d+)$/)[1];$section.find("ul.section").first().append(create_target(id,section))}),this)}}};function init_footer_basket(){let currentDragging;const activities=document.querySelectorAll(".activity.activity-wrapper"),sections=document.querySelectorAll(".course-section-header"),sharingCartBlock=document.querySelector('section[data-block="sharing_cart"]');!function(){var _document$getElements;const courseSectionHeader=null!==(_document$getElements=document.getElementsByClassName("course-section-header")[0])&&void 0!==_document$getElements?_document$getElements:null;courseSectionHeader instanceof HTMLElement&&(courseSectionHeader.classList.add("draggable"),courseSectionHeader.setAttribute("draggable",!0))}();const footerIconContainer=document.getElementById("page-footer").querySelector('div[data-region="footer-container-popover"]');var basket=document.createElement("i");basket.setAttribute("class","fa fa-shopping-basket");var basketButton=document.createElement("button");basketButton.setAttribute("class","btn btn-icon bg-secondary icon-no-margin btn-footer-popover sharing_cart_basket"),basketButton.setAttribute("style","z-index: 1001;"),basketButton.append(basket);var dropAreaText=document.createElement("p");dropAreaText.setAttribute("class","font-weight-bold text-white"),dropAreaText.innerText=str("drop_here");var dropArea=document.createElement("div");function drag_event_listeners(draggable){draggable.addEventListener("dragstart",(e=>{basketButton.classList.remove("shake_basket"),null==footerIconContainer||footerIconContainer.prepend(basketButton),sharingCartBlock.children[0].classList.add("dragging_item"),sharingCartBlock.append(dropArea),currentDragging=e.target,isDragging=!0})),draggable.addEventListener("dragend",(()=>{currentDragging instanceof HTMLElement&&(null==footerIconContainer||footerIconContainer.removeChild(basketButton)),sharingCartBlock.children[0].classList.remove("dragging_item"),sharingCartBlock.removeChild(dropArea),isDragging=!1}))}dropArea.setAttribute("class","h-100 w-100 position-absolute d-flex justify-content-center align-items-center"),dropArea.append(dropAreaText),sections.forEach((section=>{drag_event_listeners(section)})),activities.forEach((activity=>{drag_event_listeners(activity)})),[basketButton,sharingCartBlock].forEach((dropzone=>{dropzone.addEventListener("dragover",(e=>{e.preventDefault(),dropzone.classList.add("drag_over")})),dropzone.addEventListener("dragenter",(e=>{e.preventDefault(),dropzone.classList.add("drag_over")})),dropzone.addEventListener("dragleave",(()=>{dropzone.classList.remove("drag_over")})),dropzone.addEventListener("drop",(()=>{currentDragging instanceof HTMLElement&&currentDragging.querySelector(".add-to-sharing-cart").click(),dropzone.classList.remove("drag_over"),currentDragging=void 0,isDragging=!1}))}))}$.get_plugin_name=function(){var $blockheader=$block.find("h2");return $blockheader.length||($blockheader=$block.find("h3")).length?$blockheader.html():""},$.on_backup=function(e,activityName){on_backup_modal({action:"is_userdata_copyable",cmid:function($backup){var $activity=$backup.closest("li.activity");if($activity.length)return $activity.attr("id").match(/(\d+)$/)[1];var $commands=$backup.closest(".commands"),dataowner=$commands.attr("data-owner");return dataowner.length?dataowner.match(/(\d+)$/)[1]:$commands.find("a.editing_delete").attr("href").match(/delete=(\d+)/)[1]}($(e.target))},activityName,str("confirm_backup"),!1)},$.on_movedir=function(e){var $commands=$(e.target).closest(".commands"),$current_dir=$commands.closest("li.directory"),current_path=$current_dir.length?$current_dir.attr("directory-path"):"/",item_id=$(e.target).closest("li.activity").attr("id").match(/(\d+)$/)[1],dirs=[];$block.find("li.directory").each((function(){dirs.push($(this).attr("directory-path"))}));var $form=$("<form/>");function submit(){var folder_to=$form.find('[name="to"]').val(),$spinner=add_spinner();$.post(get_action_url("rest"),{action:"movedir",item_id:item_id,folder_to:folder_to,sesskey:M.cfg.sesskey},(function(){reload_tree(),directories.reset()})).fail((function(response){show_error(response)})).always((function(){$spinner.hide()}))}if($form.attr("action","javascript:void(0)"),$form.submit(submit),0===dirs.length){var $input=$('<input class="form-control" type="text" name="to"/>').val(current_path);setTimeout((function(){$input.focus()}),1),$form.append($input)}else{dirs.unshift("/");for(var $select=$('<select class="custom-select" name="to"/>'),i=0;i<dirs.length;i++)$select.append($("<option/>").val(dirs[i]).append(dirs[i]));$select.val(current_path),$select.change(submit),$form.append($select);var $edit=create_command("edit");$edit.on("click",(function(){var $input=$('<input type="text" name="to"/>').val(current_path);$select.remove(),$edit.replaceWith($input),$input.focus()})),$form.append($edit)}var $cancel=create_command("cancel");$cancel.on("click",(function(){$form.remove(),$commands.find("a").show()})),$form.append($cancel),$commands.find("a").each((function(){$(this).hide()})),$commands.append($form)},$.on_move=function(e){var id=$(e.target).closest("li.activity").attr("id").match(/(\d+)$/)[1];move_targets.show(id)},$.on_delete=function(e){var modalBody,item,$item=$(e.target).closest("li"),liText=$item[0].innerText,isDirectory=!1,description_text="";$item.hasClass("directory")?(isDirectory=!0,item=str("folder_string"),description_text=str("delete_folder")):item=str("activity_string"),modalBody='<p class="delete-item">'+item+" "+liText+description_text+"</p>",confirm_modal({title:str("confirm_delete"),body:modalBody,save_button:str("modal_confirm_delete"),checkbox:!1,next:function(){var data={};!0===isDirectory?data={action:"delete_directory",path:$item.attr("directory-path"),sesskey:M.cfg.sesskey}:$item.hasClass("activity")&&(data={action:"delete",id:$item.attr("id").match(/(\d+)$/)[1],sesskey:M.cfg.sesskey});var $spinner=add_spinner();$.post(get_action_url("rest"),data,(function(){reload_tree()})).fail((function(response){show_error(response)})).always((function(){$spinner.hide()})),e.stopPropagation()}})},$.on_restore=function(e){var $item=$(e.target).closest("li"),id=null;$item.hasClass("directory")?(id=$item.attr("directory-path"),restore_targets.is_directory=!0):$item.hasClass("activity")&&(id=$item.attr("id").match(/(\d+)$/)[1],restore_targets.is_directory=!1),restore_targets.show(id)},$.on_section_backup=function(sectionId,sectionNumber,courseId,sectionName){on_backup_modal({action:"is_userdata_copyable_section",sectionid:sectionId,sectionnumber:sectionNumber,courseid:courseId},sectionName,'<p class="alert alert-danger mt-3">'+str("backup_heavy_load_warning_message")+"</p>"+str("confirm_backup_section"),!0)},$.init_bulk_delete=function(isspeciallayout){var bulkdelete=$block.find(".editing_bulkdelete");bulkdelete.length&&(isspeciallayout?(bulkdelete.attr("role","menuitem").addClass("dropdown-item menu-action"),bulkdelete.append($("<span class='menu-action-text'/>").append(bulkdelete.attr("title"))),$block.find(".menubar .dropdown .dropdown-menu").append(bulkdelete)):$block.find(".header .commands").append(bulkdelete))},$.init_help_icon=function(isspeciallayout){var helpicon=$block.find(".header-commands > .help-icon");isspeciallayout?$block.find(".header-commands").parent().css("display","block"):$block.find(".header .commands").append(helpicon)},$.init_block_header=function(){var isspeciallayout=$block.find(".menubar .dropdown .dropdown-menu").length;$.init_bulk_delete(isspeciallayout),$.init_help_icon(isspeciallayout)},$.init_item_tree=function(){function add_actions(item,actions){var $commands=$(item).find(".commands").first();$.each(actions,(function(index,action){var $command=create_command(action);$command.on("click",(function(e){$["on_"+action](e)})),$commands.append($command)}),this)}var activity_actions=["movedir","move","delete"];course&&activity_actions.push("restore");var directory_actions=["delete","restore"];$block.find("li.activity").each((function(index,item){1!=$(item).attr("data-disable-copy")?add_actions(item,activity_actions):add_actions(item,["movedir","move","delete"])})),$block.find("li.directory").each((function(index,item){add_actions(item,directory_actions)})),directories.init()},$.init_activity_commands=function(){function create_backup_icon(){var $backupIcon=$('<a href="javascript:void(0)" class="add-to-sharing-cart" />').append($('<i class="fa fa-shopping-basket icon"></i>')).attr("title",str("backup"));return"click_to_add"!==addMethod&&$backupIcon.addClass("d-none"),$backupIcon}function add_activity_backup_control($activity){var activityClass=$activity[0].className,modtype=activityClass.substr(activityClass.indexOf("modtype_")+8),activityName=str("activity_string");"label"!==modtype&&(activityName=$(".activity#"+$activity[0].id).find(".mod-indent-outer .activityinstance span.instancename").html());var $backupIcon=create_backup_icon();$backupIcon.on("click",(function(e){$.on_backup(e,activityName)}));var $actionMenuItem=$activity.find(".action-menu.section-cm-edit-actions").parent(".actions");$actionMenuItem.find(".add-to-sharing-cart").length||$actionMenuItem.append($backupIcon)}$(document).ajaxComplete((function(event,xhr,settings){var url=settings.url,lastslashindex=url.lastIndexOf("="),result=url.substring(lastslashindex+1);if("core_course_edit_module"===result||"core_course_get_module"===result){var data=JSON.parse(settings.data),action=data[0].args.action;if("delete"===action)return;setTimeout((function(){var activity_id=data[0].args.id,activity=$("#module-"+activity_id);(add_activity_backup_control(activity),"duplicate"===action)&&add_activity_backup_control(activity.next())}),1)}})),$("body.editing .course-content li.section").each((function(){!function($section){var sectionId=$section.find(".section_action_menu").data("sectionid"),sectionNumber=parseInt(String($section.attr("id")).match(/\d+/)[0]),sectionName=$section.attr("aria-label")||$section.find(".sectionname").text().trim(),isFlexibleCourseFormat=$("body[id$=flexsections]").length;isFlexibleCourseFormat&&null==sectionId&&(sectionId=$section.data("section-id"));var courseId=parseInt(String($("body").attr("class")).match(/course-([0-9]*)( |$)/)[1]),$backupIcon=create_backup_icon();$backupIcon.on("click",(function(){var inPlaceEditSectionName=in_place_edit_section_name($section);sectionName=""!==inPlaceEditSectionName?inPlaceEditSectionName:sectionName,$.on_section_backup(sectionId,sectionNumber,courseId,sectionName)}));var $sectionTitle=$section.find("h3.sectionname").first().find("a").last(),$inPlaceEditable=$section.find("h3.sectionname .inplaceeditable").first();$inPlaceEditable.length&&($sectionTitle=$inPlaceEditable),isFlexibleCourseFormat&&0===sectionNumber?($sectionTitle=$section.find("> .controls")).prepend($backupIcon):$backupIcon.insertAfter($sectionTitle);var $activities=$section.find("li.activity");$($activities).each((function(){add_activity_backup_control($(this))}))}($(this))}))},$.init=function(){M.str.block_sharing_cart.pluginname=this.get_plugin_name(),$.init_block_header(),$.init_item_tree(),$.init_activity_commands(),"drag_and_drop"===addMethod&&init_footer_basket()};var $spinner=$("<i/>").addClass("spinner fa fa-3x fa-circle-o-notch fa-spin");$("div#sharing-cart-spinner-modal div.spinner-container").prepend($spinner),$.init()})),$(".copy_section").on("click",(function(){var $section_selected=$(".section-dropdown option:selected"),sectionId=$section_selected.data("section-id"),sectionNumber=$section_selected.data("section-number"),courseId=$section_selected.data("course-id"),sectionName=$section_selected.data("section-name");$.on_section_backup(sectionId,sectionNumber,courseId,sectionName)}))}}}));

//# sourceMappingURL=script.min.js.map