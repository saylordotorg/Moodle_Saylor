define("block_sharing_cart/script",["jquery","core/modal_factory","core/modal_events"],function(t,e,n){return{init:function(){t(document).ready(function(){function i(t){return M.str.block_sharing_cart[t]||M.str.moodle[t]}function a(t,e){var n=M.cfg.wwwroot+"/blocks/sharing_cart/"+t+".php";if(e){var i=[];for(var a in e)i.push(a+"="+encodeURIComponent(e[a]));n+="?"+i.join("&")}return n}function o(a){a.checkbox&&(a.body+='<div class="modal-checbox-wrapper"><input type="checkbox" id="modal-checkbox" class="modal-checkbox"><label for="modal-checkbox">'+i("modal_checkbox")+"</label></div>"),e.create({type:e.types.SAVE_CANCEL,title:a.title,body:a.body}).done(function(e){e.setSaveButtonText(a.save_button),e.getRoot().on(n.save,function(e){var n={checkbox:t(e.target).find(".modal-checkbox").is(":checked")};a.next(n)}),e.getRoot().on(n.hidden,function(){t("body").removeClass("modal-open")}),e.show()})}function c(t){var e="",n=t.find("h3.sectionname .inplaceeditable");return n.length&&(e=n.data("value")),e}function s(e,n,s,r){t.post(a("rest"),e,function(d){!function(d){var u=!1;"1"===d&&(u=!0),o({title:n,body:s,save_button:i("modal_confirm_backup"),checkbox:u,next:function(n){!0===r?function(e,n,i,o){var s=t("span.inplaceeditable[data-itemtype=sectionname][data-itemid="+e+"]"),r=s.closest("li.section.main"),d=r.attr("aria-label")||r.find(".sectionname").text().trim();null===d&&(d=String(t("#region-main .section_action_menu[data-sectionid='"+e+"']").parent().parent().find("h3.sectionname").text()));var l=c(r);d=""!==l?l:d;var u=p(),v=h(s);t.post(a("rest"),{action:"backup_section",sectionid:e,sectionnumber:n,courseid:i,sectionname:d,userdata:o,sesskey:M.cfg.sesskey},function(){m()}).fail(function(t){f(t)}).always(function(){u.hide(),v.hide()})}(e.sectionid,e.sectionnumber,e.courseid,n.checkbox):function(e,n){var i=t("#module-"+e+" .actions");i.length||(i=t('[data-owner="#module-'+e+'"]'));var o=p(),c=h(i);t.post(a("rest"),{action:"backup",cmid:e,userdata:n,sesskey:M.cfg.sesskey,courseid:l.id},function(){m()}).fail(function(t){f(t)}).always(function(){c.hide(),o.hide()})}(e.cmid,n.checkbox)}})}(d)},"text").fail(function(t){f(t)})}var r={backup:{css:"editing_backup",iconClass:"fa fa-frown-o"},movedir:{css:"editing_right",iconClass:"fa fa-arrow-right"},move:{css:"editing_move_",iconClass:"fa fa-arrows-v"},edit:{css:"editing_update",iconClass:"fa fa-pencil"},cancel:{css:"editing_cancel",iconClass:"fa fa-ban"},delete:{css:"editing_update",iconClass:"fa fa-trash"},restore:{css:"editing_restore",iconClass:"fa fa-clone"},"dir-open":{iconClass:"fa fa-folder-open-o"},"dir-closed":{iconClass:"fa fa-folder-o"}},d=t(".block_sharing_cart"),l=new function(){var e=t("body");this.id=e.attr("class").match(/course-(\d+)/)[1],this.is_frontpage=e.hasClass("pagelayout-frontpage")};function f(t){try{var e=JSON.parse(t.responseText);new M.core.exception({name:i("pluginname")+" - "+i("error"),message:e.message})}catch(e){new M.core.exception({name:i("pluginname")+" - "+i("error"),message:t.responseText})}}function u(e){var n=t("<i/>").attr("alt",i(e)).attr("class",r[e].iconClass);return t('<a href="javascript:void(0)"/>').addClass(r[e].css).attr("title",i(e)).append(n)}function p(){var e=t('<div class="block_spinner"><i class="fa fa-circle-o-notch fa-spin fa-2x"></i></div>');return t("section.block_sharing_cart").append(e),e}function h(e){var n=t('<i class="fa fa-circle-o-notch fa-spin node_spinner"></i>');return e.append(n),n}function m(){t.post(a("rest"),{action:"render_tree",courseid:l.id},function(e){d.find(".tree").replaceWith(t(e)),t.init_item_tree()},"html").fail(function(t){f(t)})}t(document).on("click","a.restore",function(){p()});var v=new function(){var e,n,i="block_sharing_cart-dirs",a=(e=i,n=document.cookie.match("(^|;)\\s*"+e+"\\s*=\\s*([^;]+)"),n?n.pop():"").split(",").map(function(t){return parseInt(t)});function o(){var t=new Date;t.setDate(t.getDate()+30),function(t,e,n){var i=new Date;i.setTime(i.getTime()+n);var a="expires="+i.toUTCString();document.cookie=t+"="+e+";"+a}(i,a.join(","),t)}function c(t,e){var n=r[e?"dir-open":"dir-closed"].iconClass;t.find("> div i.icon").attr("class","icon "+n),t.find("> ul.list")[e?"show":"hide"]()}this.init=function(){var e=0;d.find("li.directory").each(function(n,i){var s=t(i);s.attr("id","block_sharing_cart-dir-"+e),e>=a.length?a.push(0):a[e]&&c(s,!0),s.find("> div div.toggle-wrapper").css("cursor","pointer").on("click",function(e){!function(e){var n=t(e.target).closest("li.directory"),i=n.attr("id").match(/(\d+)$/)[1],s="none"===n.find("> ul.list").css("display");c(n,s),a[i]=s?1:0,o()}(e)}),e++})},this.reset=function(){a=[],this.init(),o()}},_=new function(){var e=null,n=[];this.hide=function(){if(null!==e){var i=e.closest(".commands");e.remove(),e=null,i.closest("li.activity").css("opacity",1),i.find("a").each(function(){t(this).show()}),t.each(n,function(t,e){e.remove()}),n=[]}},this.show=function(o){this.hide();var c=d.find("#block_sharing_cart-item-"+o),s=c.next(),r=c.closest("ul"),l=0;function h(e,n){var o=t('<a href="javascript:void(0)"/>').addClass("move-"+e+"-to-"+n).attr("title",i("movehere")).append(t("<p>"+i("clicktomove")+"</p>").attr("alt",i("movehere"))),c=t('<li class="activity move-to"/>').append(o);return o.on("click",function(e){!function(e){var n=t(e.target).closest("a").attr("class").match(/move-(\d+)-to-(\d+)/),i=n[1],o=n[2],c=p();t.post(a("rest"),{action:"move",item_id:i,area_to:o,sesskey:M.cfg.sesskey},function(){m()}).fail(function(t){f(t)}).always(function(){c.hide()})}(e)}),c}if(s.length&&(l=s.attr("id").match(/item-(\d+)$/)[1]),r.find("> li.activity").each(function(i,a){var c=t(a),s=c.attr("id").match(/item-(\d+)$/)[1];if(s===o){(e=u("cancel")).on("click",function(){_.hide()});var r=c.find(".commands");r.find("a").each(function(){t(this).hide()}),r.append(e),c.css("opacity",.5)}else if(s!==l){var d=h(o,s);c.before(d),n.push(d)}},this),s){var v=h(o,0);r.append(v),n.push(v)}}},g=new function(){this.is_directory=null;var e=null,n=[];function o(e,o){var c="",s=t("#copy-section-form").data("in-section");c=g.is_directory?a("restore",{directory:!0,path:e,course:l.id,section:o,in_section:s,sesskey:M.cfg.sesskey}):a("restore",{directory:!1,id:e,course:l.id,section:o,in_section:s,sesskey:M.cfg.sesskey});var r=t("<a/>").attr("class","restore").attr("href",c).attr("title",i("copyhere")).append(t('<img class="move_target"/>').attr("alt",i("copyhere")).attr("src",M.util.image_url("dropzone_arrow","block_sharing_cart")));return n.push(r),r}this.hide=function(){null!==e&&(e.remove(),e=null,t.each(n,function(t,e){e.remove()}),n=[])},this.show=function(n){this.hide();var a=t("<span/>");if(this.is_directory)a.html(n).css("display","inline"),a.prepend(t("<i/>").addClass("icon").attr("alt",n));else{var c=d.find("#block_sharing_cart-item-"+n);(a=t(c.find("div")[0].cloneNode(!0)).css("display","inline")).attr("class",a.attr("class").replace(/mod-indent-\d+/,"")),a.find(".commands").remove()}var s=u("cancel");if(s.on("click",this.hide),(e=t('<div class="clipboard"/>')).append(i("clipboard")+": ").append(a).append(s),l.is_frontpage){var r=t(".sitetopic"),f=t(".block_site_main_menu");r?r.find("*").before(e):f&&f.find(".content").before(e),f&&f.find(".footer").before(o(n,0)),r&&r.find("ul.section").append(o(n,1))}else{var p=t(".course-content");p.prepend(e),p.find(M.course.format.get_section_wrapper(null)).each(function(e,i){var a=t(i),c=a.attr("id").match(/(\d+)$/)[1];a.find("ul.section").first().append(o(n,c))},this)}}};t.get_plugin_name=function(){var t=d.find("h2");return t.length?t.html():(t=d.find("h3")).length?t.html():""},t.on_backup=function(e,n){s({action:"is_userdata_copyable",cmid:function(t){var e=t.closest("li.activity");if(e.length)return e.attr("id").match(/(\d+)$/)[1];var n=t.closest(".commands"),i=n.attr("data-owner");return i.length?i.match(/(\d+)$/)[1]:n.find("a.editing_delete").attr("href").match(/delete=(\d+)/)[1]}(t(e.target))},n,i("confirm_backup"),!1)},t.on_movedir=function(e){var n=t(e.target).closest(".commands"),i=n.closest("li.directory"),o=i.length?i.attr("directory-path"):"/",c=t(e.target).closest("li.activity").attr("id").match(/(\d+)$/)[1],s=[];d.find("li.directory").each(function(){s.push(t(this).attr("directory-path"))});var r=t("<form/>");function l(){var e=r.find('[name="to"]').val(),n=p();t.post(a("rest"),{action:"movedir",item_id:c,folder_to:e,sesskey:M.cfg.sesskey},function(){m(),v.reset()}).fail(function(t){f(t)}).always(function(){n.hide()})}if(r.attr("action","javascript:void(0)"),r.submit(l),0===s.length){var h=t('<input class="form-control" type="text" name="to"/>').val(o);setTimeout(function(){h.focus()},1),r.append(h)}else{s.unshift("/");for(var _=t('<select class="custom-select" name="to"/>'),g=0;g<s.length;g++)_.append(t("<option/>").val(s[g]).append(s[g]));_.val(o),_.change(l),r.append(_);var y=u("edit");y.on("click",function(){var e=t('<input type="text" name="to"/>').val(o);_.remove(),y.replaceWith(e),e.focus()}),r.append(y)}var b=u("cancel");b.on("click",function(){r.remove(),n.find("a").show()}),r.append(b),n.find("a").each(function(){t(this).hide()}),n.append(r)},t.on_move=function(e){var n=t(e.target).closest("li.activity").attr("id").match(/(\d+)$/)[1];_.show(n)},t.on_delete=function(e){var n,c,s=t(e.target).closest("li"),r=s[0].innerText,d=!1,l="";s.hasClass("directory")?(d=!0,c=i("folder_string"),l=i("delete_folder")):c=i("activity_string"),n='<p class="delete-item">'+c+" "+r+l+"</p>",o({title:i("confirm_delete"),body:n,save_button:i("modal_confirm_delete"),checkbox:!1,next:function(){var n={};!0===d?n={action:"delete_directory",path:s.attr("directory-path"),sesskey:M.cfg.sesskey}:s.hasClass("activity")&&(n={action:"delete",id:s.attr("id").match(/(\d+)$/)[1],sesskey:M.cfg.sesskey});var i=p();t.post(a("rest"),n,function(){m()}).fail(function(t){f(t)}).always(function(){i.hide()}),e.stopPropagation()}})},t.on_restore=function(e){var n=t(e.target).closest("li"),i=null;n.hasClass("directory")?(i=n.attr("directory-path"),g.is_directory=!0):n.hasClass("activity")&&(i=n.attr("id").match(/(\d+)$/)[1],g.is_directory=!1),g.show(i)},t.on_section_backup=function(t,e,n,a){s({action:"is_userdata_copyable_section",sectionid:t,sectionnumber:e,courseid:n},a,'<p class="alert alert-danger mt-3">'+i("backup_heavy_load_warning_message")+"</p>"+i("confirm_backup_section"),!0)},t.init_bulk_delete=function(e){var n=d.find(".editing_bulkdelete");n.length&&(e?(n.attr("role","menuitem").addClass("dropdown-item menu-action"),n.append(t("<span class='menu-action-text'/>").append(n.attr("title"))),d.find(".menubar .dropdown .dropdown-menu").append(n)):d.find(".header .commands").append(n))},t.init_help_icon=function(t){var e=d.find(".header-commands > .help-icon");t?d.find(".header-commands").parent().css("display","block"):d.find(".header .commands").append(e)},t.init_block_header=function(){var e=d.find(".menubar .dropdown .dropdown-menu").length;t.init_bulk_delete(e),t.init_help_icon(e)},t.init_item_tree=function(){function e(e,n){var i=t(e).find(".commands").first();t.each(n,function(e,n){var a=u(n);a.on("click",function(e){t["on_"+n](e)}),i.append(a)},this)}var n=["movedir","move","delete"];l&&n.push("restore");var i=["delete","restore"];d.find("li.activity").each(function(i,a){1!=t(a).attr("data-disable-copy")?e(a,n):e(a,["movedir","move","delete"])}),d.find("li.directory").each(function(t,n){e(n,i)}),v.init()},t.init_activity_commands=function(){function e(){return t('<a href="javascript:void(0)" class="add-to-sharing-cart" />').append(t('<i class="fa fa-shopping-basket icon"></i>')).attr("title",i("backup"))}function n(n){var a=n[0].className,o=a.substr(a.indexOf("modtype_")+8),c=i("activity_string");"label"!==o&&(c=t(".activity#"+n[0].id).find(".mod-indent-outer .activityinstance span.instancename").html());var s=e();s.on("click",function(e){t.on_backup(e,c)});var r=n.find(".action-menu.section-cm-edit-actions").parent(".actions");r.find(".add-to-sharing-cart").length||r.append(s)}t(document).ajaxComplete(function(e,i,a){var o=a.url,c=o.lastIndexOf("="),s=o.substring(c+1);if("core_course_edit_module"===s||"core_course_get_module"===s){var r=JSON.parse(a.data),d=r[0].args.action;if("delete"===d)return;setTimeout(function(){var e=r[0].args.id,i=t("#module-"+e);(n(i),"duplicate"===d)&&n(i.next())},1)}}),t("body.editing .course-content li.section").each(function(){!function(i){var a=i.find(".section_action_menu").data("sectionid"),o=parseInt(String(i.attr("id")).match(/\d+/)[0]),s=i.attr("aria-label")||i.find(".sectionname").text().trim(),r=t("body[id$=flexsections]").length;!r||void 0!==a&&null!==a||(a=i.data("section-id"));var d=parseInt(String(t("body").attr("class")).match(/course-([0-9]*)( |$)/)[1]),l=e();l.on("click",function(){var e=c(i);s=""!==e?e:s,t.on_section_backup(a,o,d,s)});var f=i.find("h3.sectionname").first().find("a").last(),u=i.find("h3.sectionname .inplaceeditable").first();u.length&&(f=u),r&&0===o?(f=i.find("> .controls")).prepend(l):l.insertAfter(f);var p=i.find("li.activity");t(p).each(function(){n(t(this))})}(t(this))})},t.init=function(){M.str.block_sharing_cart.pluginname=this.get_plugin_name(),t.init_block_header(),t.init_item_tree(),t.init_activity_commands()};var y=t("<i/>").addClass("spinner fa fa-3x fa-circle-o-notch fa-spin");t("div#sharing-cart-spinner-modal div.spinner-container").prepend(y),t.init()}),t(".copy_section").on("click",function(){var e=t(".section-dropdown option:selected"),n=e.data("section-id"),i=e.data("section-number"),a=e.data("course-id"),o=e.data("section-name");t.on_section_backup(n,i,a,o)})}}});
//# sourceMappingURL=script.min.js.map