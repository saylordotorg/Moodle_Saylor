YUI.add("moodle-block_workflow-comments",function(l,e){var t="blocks_workflow_comments",r="/blocks/workflow/ajax.php",a="stateid",d="editorid",o="editorname",n="block_workflow",i="block_workflow_comments",s="block_workflow_editcommentbutton",c="block_workflow_finishstepbutton",h="block-workflow-panel",u="content",m="loading-lightbox",f="wfk-submit",g="hidden",w=new M.core.dialogue({headerContent:"",bodyContent:l.one("."+h),visible:!1,modal:!0,width:"auto",zIndex:100}),p=function(){p.superclass.constructor.apply(this,arguments)};l.extend(p,l.Base,{_formSubmitEvent:null,_escCloseEvent:null,_closeButtonEvent:null,_loadingNode:null,initializer:function(){w.hide();var e=l.one("."+h);e&&(this._loadingNode=e.one("."+m),this.attachEvents())},show:function(i,e){var t,c,o,n;i.halt(),e?(w.set("headerContent",M.str.block_workflow.finishstep),l.one("."+h).one("."+f+" input").set("value",M.str.block_workflow.finishstep),this._formSubmitEvent=l.one("."+f+" input").on("click",this.finishstep,this)):(w.set("headerContent",M.str.block_workflow.editcomments),l.one("."+h).one("."+f+" input").set("value",M.str.moodle.savechanges),this._formSubmitEvent=l.one("."+f+" input").on("click",this.save,this)),w.show(),this._escCloseEvent=l.on("key",this.hide,document.body,"down:27",this),l.Event.purgeElement(l.one(".moodle-dialogue-hd .closebutton"),!0),this._closeButtonEvent=l.on("click",this.hide,l.one(".moodle-dialogue-hd .closebutton"),this),t={sesskey:M.cfg.sesskey,action:"getcomment",stateid:this.get(a)},"undefined"!=typeof tinyMCE&&(c=tinyMCE.get(this.get(d)),o=tinymce.DOM.get(this.get(d)+"_ifr"),30===(n=tinymce.DOM.getSize(o)).h&&c.theme.resizeTo(n.w,90)),l.io(M.cfg.wwwroot+r,{method:"POST",data:build_querystring(t),on:{start:this.displayLoading,complete:function(e,t){var o,n,s;try{if((o=l.JSON.parse(t.responseText)).error)return new M.core.ajaxException(o)}catch(i){new M.core.exception(i)}"undefined"!=typeof tinyMCE?c.setContent(o.response.comment):(n=this.get(d),(s=l.one(document.getElementById(n+"editable")))&&s.setHTML(o.response.comment),l.one(document.getElementById(n)).set("value",o.response.comment))},end:this.removeLoading},context:this})},hide:function(){w.hide(),this._escCloseEvent&&(this._escCloseEvent.detach(),this._escCloseEvent=null),this._closeButtonEvent&&(this._closeButtonEvent.detach(),this._closeButtonEvent=null),this._formSubmitEvent&&(this._formSubmitEvent.detach(),this._formSubmitEvent=null)},save:function(){var e,s,t;e="undefined"!=typeof tinyMCE?tinyMCE.get(this.get(d)).getContent():l.one(document.getElementById(this.get(d))).get("value"),s=l.one("."+n+" ."+i),t={sesskey:M.cfg.sesskey,action:"savecomment",stateid:this.get(a),text:e,format:document.getElementsByName(this.get(o)+"[format]")[0].value},l.io(M.cfg.wwwroot+r,{method:"POST",data:build_querystring(t),on:{start:this.displayLoading,complete:function(e,t){var o;try{if((o=l.JSON.parse(t.responseText)).error)return new M.core.ajaxException(o)}catch(n){new M.core.exception(n)}o.response.blockcomments?s.setContent(o.response.blockcomments):s.setContent(M.str.block_workflow.nocomments)},end:this.removeLoading},context:this}),this.hide()},finishstep:function(){var e,i,t;e="undefined"!=typeof tinyMCE?tinyMCE.get(this.get(d)).getContent():l.one(document.getElementById(this.get(d))).get("value"),i=l.one("."+n+" ."+u),t={sesskey:M.cfg.sesskey,action:"finishstep",stateid:this.get(a),text:e,format:document.getElementsByName(this.get(o)+"[format]")[0].value},l.io(M.cfg.wwwroot+r,{method:"POST",data:build_querystring(t),on:{start:this.displayLoading,complete:function(e,t){var o,n;try{if((o=l.JSON.parse(t.responseText)).error)return new M.core.ajaxException(o)}catch(s){new M.core.exception(s)}o.response.blockcontent&&(i.setContent(o.response.blockcontent),o.response.stateid&&(this.set(a,o.response.stateid),this.attachEvents(),M.blocks_workflow.init_todolist({stateid:o.response.stateid})),o.response.listworkflows&&(n=i.one(".singleselect form select").getAttribute("id"),require(["jquery"],function(e){e("#"+n).change(function(){typeof e(this).find(":selected").attr("data-ignore")==typeof undefined&&e("#"+n).closest("form").submit()})})))},end:this.removeLoading},context:this}),this.hide()},displayLoading:function(){this._loadingNode.removeClass(g)},removeLoading:function(){this._loadingNode.addClass(g)},attachEvents:function(){var e,t=l.one("."+s+" button, ."+s+" input[type=submit]");t&&t.on("click",this.show,this,!1),(e=l.one("."+c+" button, ."+c+" input[type=submit]"))&&e.on("click",this.show,this,!0)}},{NAME:t,ATTRS:{stateid:{value:null},editorid:{value:null},editorname:{validator:l.Lang.isString,value:null}}}),M.blocks_workflow=M.blocks_workflow||{},M.blocks_workflow.init_comments=function(e){return new p(e)}},"@VERSION@",{requires:["base","overlay","moodle-core-formautosubmit","moodle-core-notification"]});