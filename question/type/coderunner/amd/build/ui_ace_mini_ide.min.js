define ("qtype_coderunner/ui_ace_mini_ide",["jquery","core/ajax"],function(a,b){function c(b,c,d,e){var f=a(document.getElementById(b)),g=a(document.getElementById(b+"_wrapper")),h=f[0]===document.activeElement,i=e.lang,j=a("<button type=\"button\" class=\"qtype-coderunner-ide-button\">Run code</button>"),k=a("<div class=\"qtype-coderunner-ide-buttons\"></div>"),l,m,n=this;try{window.ace.require("ace/ext/language_tools");this.modelist=window.ace.require("ace/ext/modelist");this.textarea=f;this.enabled=!1;this.contents_changed=!1;this.capturingTab=!1;this.clickInProgress=!1;this.language=i;this.editNode=a("<div></div>");this.editor=window.ace.edit(this.editNode.get(0));if(f.prop("readonly")){this.editor.setReadOnly(!0)}this.editor.setOptions({enableBasicAutocompletion:!0,newLineMode:"unix"});this.editor.$blockScrolling=1/0;this.workArea=a("<div></div>");this.workArea.append(this.editNode);this.button=j;k.append(j);this.workArea.append(k);this.ide_response=a("<textarea rows=\"5\" class=\"edit_code\" style=\"width:100%\"></textarea>");m=a("<div></div>");m.append(this.ide_response);this.workArea.append(m);this.editNode.css({resize:"none",height:d/2,width:"100%"});l=this.editor.getSession();l.setValue(this.textarea.val());if(e.theme){this.editor.setTheme("ace/theme/"+e.theme)}this.setLanguage(i);this.setEventHandlers();this.setMiniIdeHandlers();this.captureTab();this.editor.renderer.on("afterRender",function(){var a=g.find(".ace_gutter");if(a.hasClass("moodle-has-zindex")){return}a.addClass("moodle-has-zindex");if(h){n.editor.focus();n.editor.navigateFileEnd()}n.aceLabel=g.find(".answerprompt");n.aceLabel.attr("for","ace_"+b);n.aceTextarea=g.find(".ace_text-input");n.aceTextarea.attr("id","ace_"+b)});this.fail=!1}catch(a){alert(a);this.fail=!0}}c.prototype.failed=function(){return this.fail};c.prototype.failMessage=function(){return"ace_ui_notready"};c.prototype.sync=function(){};c.prototype.syncIntervalSecs=function(){return 0};c.prototype.setLanguage=function(a){var b=this.editor.getSession(),c=this.findMode(a);if(c){b.setMode(c.mode)}this.language=a};c.prototype.getElement=function(){return this.workArea};c.prototype.captureTab=function(){this.capturingTab=!0;this.editor.commands.bindKeys({Tab:"indent","Shift-Tab":"outdent"})};c.prototype.releaseTab=function(){this.capturingTab=!1;this.editor.commands.bindKeys({Tab:null,"Shift-Tab":null})};c.prototype.setEventHandlers=function(){var a=this;this.editor.getSession().on("change",function(){a.textarea.val(a.editor.getSession().getValue());a.contents_changed=!0});this.editor.on("blur",function(){if(a.contents_changed){a.textarea.trigger("change")}});this.editor.on("mousedown",function(){a.clickInProgress=!0});this.editor.on("focus",function(){if(a.clickInProgress){a.captureTab()}else{a.releaseTab()}});this.editor.on("click",function(){a.clickInProgress=!1});this.editor.container.addEventListener("keydown",function(b){if(b.which===void 0||0!==b.which){if(b.keyCode===77&&b.ctrlKey&&!b.altKey){if(a.capturingTab){a.releaseTab()}else{a.captureTab()}b.preventDefault()}else if(b.keyCode===27){a.releaseTab()}else if(!(b.shiftKey||b.ctrlKey||b.altKey||b.keyCode==9)){a.captureTab()}}},!0)};c.prototype.setMiniIdeHandlers=function(){var a=this;this.button.on("click",function(){var c=a.textarea.val();b.call([{methodname:"qtype_coderunner_run_in_sandbox",args:{sourcecode:c,language:a.language,stdin:""},done:function done(b){var c=JSON.parse(b),d=c.cmpinfo+c.output+c.stderr;a.ide_response.val(d)},fail:function fail(a){alert("We're dead, Fred: "+a)}}])})};c.prototype.destroy=function(){var b;if(!this.fail){b=this.editor.isFocused();this.textarea.val(this.editor.getSession().getValue());this.editor.destroy();a(this.workArea).remove();if(b){this.textarea.focus();this.textarea[0].selectionStart=this.textarea[0].value.length}}};c.prototype.hasFocus=function(){return this.editor.isFocused()};c.prototype.findMode=function(a){var b,c,d,e=[],f={octave:"matlab",nodejs:"javascript","c#":"cs"};if("string"!=typeof a){return}if(a.toLowerCase()in f){a=f[a.toLowerCase()]}e=[a,a.replace(/\d+$/,"")];for(var g=0;g<e.length;g++){b=e[g];c="input."+b;d=this.modelist.modesByName[b]||this.modelist.modesByName[b.toLowerCase()]||this.modelist.getModeForPath(c)||this.modelist.getModeForPath(c.toLowerCase());if(d&&"text"!==d.name){return d}}};c.prototype.resize=function(a,b){this.workArea.outerHeight(b);this.workArea.outerWidth(a);this.editNode.css({resize:"none",height:b/2,width:"100%"});this.ide_response.css({resize:"none",height:b/2,width:"100%"});this.editor.resize()};return{Constructor:c}});
//# sourceMappingURL=ui_ace_mini_ide.min.js.map
