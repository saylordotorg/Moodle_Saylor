define ("qtype_coderunner/userinterfacewrapper",["jquery"],function(a){function b(b,c){var d,e,f=this;this.GUTTER=14;this.MIN_WRAPPER_HEIGHT=50;this.DEFAULT_SYNC_INTERVAL_SECS=5;this.taId=c;this.loadFailId=c+"_loadfailerr";this.textArea=a(document.getElementById(c));e=this.textArea.attr("data-params");if(e){this.uiParams=JSON.parse(e)}else{this.uiParams={}}this.uiParams.lang=this.textArea.attr("data-lang");this.readOnly=this.textArea.prop("readonly");this.isLoading=!1;this.loadFailed=!1;this.retries=0;d=Math.max(parseInt(this.textArea.css("height")),this.MIN_WRAPPER_HEIGHT);this.wrapperNode=a("<div id='"+this.taId+"_wrapper' class='ui_wrapper'></div>");this.textArea.after(this.wrapperNode);this.wrapperNode.hide();this.wrapperNode.css({resize:"vertical",overflow:"hidden",minHeight:d,width:"100%",border:"1px solid darkgrey"});this.textArea.data("current-ui-wrapper",this);this.uiInstance=null;this.loadUi(b,this.uiParams);a(document).mousemove(function(){f.checkForResize()});a(window).resize(function(){f.checkForResize()});this.textArea.closest("form").submit(function(){if(null!==f.uiInstance){f.uiInstance.sync()}});a(document.body).on("keydown",function(a){if(a.keyCode===77&&a.ctrlKey&&a.altKey){if(null!==f.uiInstance||f.loadFailed){f.stop()}else{f.restart()}}})}b.prototype.loadUi=function(b,c){var f=this;function d(b,c){require(["core/str"],function(d){var e=d.get_string(b,"qtype_coderunner"),f=d.get_string("ui_fallback","qtype_coderunner");a.when(e,f).done(function(a,b){c.html(a+"<br>"+b)})})}function e(){if(c.hasOwnProperty("sync_interval_secs")){return parseInt(c.sync_interval_secs)}else{return f.DEFAULT_SYNC_INTERVAL_SECS}}if(this.isLoading){this.retries+=1;if(20<this.retries){alert("Failed to load "+b+" UI component. If this error persists, please report it to the forum on coderunner.org.nz");this.retries=0;this.loading=0}else{setTimeout(function(){f.loadUi(b,c)},200)}return}this.retries=0;this.params=c;this.stop();this.uiname=b;if(""===this.uiname||"none"===this.uiname||sessionStorage.getItem("disableUis")){this.uiInstance=null}else{this.isLoading=!0;require(["qtype_coderunner/ui_"+this.uiname],function(b){var g,i,j,k,l,m;k=f.wrapperNode.innerHeight()-f.GUTTER;l=f.wrapperNode.innerWidth();g=new b.Constructor(f.taId,l,k,c);if(g.failed()){f.loadFailed=!0;f.wrapperNode.hide();g.destroy();f.uiInstance=null;f.textArea.addClass("uiloadfailed");i="<div id=\""+f.loadFailId+"\"class=\"uiloadfailed\"></div>";j=a(i);j.insertBefore(f.textArea);d(g.failMessage(),j)}else{f.hLast=0;f.wLast=0;f.textArea.hide();f.wrapperNode.show();f.wrapperNode.append(g.getElement());f.uiInstance=g;f.loadFailed=!1;f.checkForResize();m=Object.getPrototypeOf(g);m.syncIntervalSecs=m.syncIntervalSecs||e;f.startSyncTimer(g)}f.isLoading=!1})}};b.prototype.startSyncTimer=function(a){var b=a.syncIntervalSecs();if(b){this.uiInstance.timer=setInterval(function(){a.sync()},1e3*b)}else{this.uiInstance.timer=null}};b.prototype.stopSyncTimer=function(a){if(a.timer){clearTimeout(a.timer)}};b.prototype.stop=function(){if(null!==this.uiInstance){this.stopSyncTimer(this.uiInstance);this.textArea.show();if(this.uiInstance.hasFocus()){this.textArea.focus();this.textArea[0].selectionStart=this.textArea[0].value.length}this.uiInstance.destroy();this.uiInstance=null;this.wrapperNode.hide()}this.loadFailed=!1;this.textArea.removeClass("uiloadfailed");a(document.getElementById(this.loadFailId)).remove()};b.prototype.restart=function(){if(null===this.uiInstance){this.loadUi(this.uiname,this.params)}};b.prototype.checkForResize=function(){var b,c,d,e,f,g;if(this.uiInstance){b=this.wrapperNode.innerHeight();d=this.wrapperNode.innerWidth();if(b!=this.hLast||d!=this.wLast){f=this.wrapperNode.offset().left;g=a(window).innerWidth()-f-25;c=b-this.GUTTER;e=Math.min(g,d);this.uiInstance.resize(e,c);this.hLast=this.wrapperNode.innerHeight();this.wLast=this.wrapperNode.innerWidth()}}};return{newUiWrapper:function(a,c){if(a){return new b(a,c)}else{return null}},InterfaceWrapper:b}});
//# sourceMappingURL=userinterfacewrapper.min.js.map
