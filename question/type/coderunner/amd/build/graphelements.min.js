define ("qtype_coderunner/graphelements",["qtype_coderunner/graphutil"],function(a){function b(a,b,c){this.parent=a;this.x=b;this.y=c;this.mouseOffsetX=0;this.mouseOffsetY=0;this.isAcceptState=!1;this.textBox=new i("",this);this.caretPosition=0}b.prototype.setMouseStart=function(a,b){this.mouseOffsetX=this.x-a;this.mouseOffsetY=this.y-b};b.prototype.setAnchorPoint=function(a,b){this.x=a+this.mouseOffsetX;this.y=b+this.mouseOffsetY};b.prototype.trackMouse=function(a,b){this.x=this.mouseOffsetX+a;this.y=this.mouseOffsetY+b};b.prototype.draw=function(a){a.beginPath();a.arc(this.x,this.y,this.parent.nodeRadius(),0,2*Math.PI,!1);a.stroke();this.textBox.draw(this.x,this.y,null,this);if(this.isAcceptState){a.beginPath();a.arc(this.x,this.y,this.parent.nodeRadius()-6,0,2*Math.PI,!1);a.stroke()}};b.prototype.closestPointOnCircle=function(a,b){var c=a-this.x,d=b-this.y,e=Math.sqrt(c*c+d*d);return{x:this.x+c*this.parent.nodeRadius()/e,y:this.y+d*this.parent.nodeRadius()/e}};b.prototype.containsPoint=function(a,b){return(a-this.x)*(a-this.x)+(b-this.y)*(b-this.y)<this.parent.nodeRadius()*this.parent.nodeRadius()};b.prototype.neighbours=function(a){for(var b=[],d,e=0;e<a.length;e++){d=a[e];if(d instanceof c){if(d.nodeA===this&&!b.includes(d.nodeB)){b.push(d.nodeB)}else if(d.nodeB===this&&!b.includes(d.nodeA)){b.push(d.nodeA)}}}return b};b.prototype.traverseGraph=function(a,b){var c,d;if(!b.includes(this)){b.push(this);c=this.neighbours(a);for(var e=0;e<c.length;e++){d=c[e];if(!b.includes(d)){d.traverseGraph(a,b)}}}return b};function c(c,d,a){this.parent=c;this.nodeA=d;this.nodeB=a;this.textBox=new i("",this);this.lineAngleAdjust=0;this.caretPosition=0;this.parallelPart=.5;this.perpendicularPart=0}c.prototype.getAnchorPoint=function(){var a=this.nodeB.x-this.nodeA.x,b=this.nodeB.y-this.nodeA.y,c=Math.sqrt(a*a+b*b);return{x:this.nodeA.x+a*this.parallelPart-b*this.perpendicularPart/c,y:this.nodeA.y+b*this.parallelPart+a*this.perpendicularPart/c}};c.prototype.setAnchorPoint=function(a,b){var c=this.nodeB.x-this.nodeA.x,d=this.nodeB.y-this.nodeA.y,e=Math.sqrt(c*c+d*d);this.parallelPart=(c*(a-this.nodeA.x)+d*(b-this.nodeA.y))/(e*e);this.perpendicularPart=(c*(b-this.nodeA.y)-d*(a-this.nodeA.x))/e;if(0<this.parallelPart&&1>this.parallelPart&&Math.abs(this.perpendicularPart)<this.parent.SNAP_TO_PADDING){this.lineAngleAdjust=(0>this.perpendicularPart)*Math.PI;this.perpendicularPart=0}};c.prototype.getEndPointsAndCircle=function(){if(0===this.perpendicularPart){var b=(this.nodeA.x+this.nodeB.x)/2,c=(this.nodeA.y+this.nodeB.y)/2,d=this.nodeA.closestPointOnCircle(b,c),e=this.nodeB.closestPointOnCircle(b,c);return{hasCircle:!1,startX:d.x,startY:d.y,endX:e.x,endY:e.y}}var f=this.getAnchorPoint(),g=a.circleFromThreePoints(this.nodeA.x,this.nodeA.y,this.nodeB.x,this.nodeB.y,f.x,f.y),h=0<this.perpendicularPart,i=h?1:-1,j=i*this.parent.nodeRadius()/g.radius,k=Math.atan2(this.nodeA.y-g.y,this.nodeA.x-g.x)-j,l=Math.atan2(this.nodeB.y-g.y,this.nodeB.x-g.x)+j,m=g.x+g.radius*Math.cos(k),n=g.y+g.radius*Math.sin(k),o=g.x+g.radius*Math.cos(l),p=g.y+g.radius*Math.sin(l);return{hasCircle:!0,startX:m,startY:n,endX:o,endY:p,startAngle:k,endAngle:l,circleX:g.x,circleY:g.y,circleRadius:g.radius,reverseScale:i,isReversed:h}};c.prototype.draw=function(a){var b=this.getEndPointsAndCircle(),c,d,e,f;a.beginPath();if(b.hasCircle){a.arc(b.circleX,b.circleY,b.circleRadius,b.startAngle,b.endAngle,b.isReversed)}else{a.moveTo(b.startX,b.startY);a.lineTo(b.endX,b.endY)}a.stroke();if(b.hasCircle){this.parent.arrowIfReqd(a,b.endX,b.endY,b.endAngle-b.reverseScale*(Math.PI/2))}else{this.parent.arrowIfReqd(a,b.endX,b.endY,Math.atan2(b.endY-b.startY,b.endX-b.startX))}f=this.textBox.relDist;if(b.hasCircle){var g=b.startAngle,h=b.endAngle;if(h<g){h+=2*Math.PI}e=(1-f)*g+f*h;if(b.isReversed){e+=(1-f)*(2*Math.PI)}c=b.circleX+b.circleRadius*Math.cos(e);d=b.circleY+b.circleRadius*Math.sin(e);this.textBox.draw(c,d,e,this)}else{c=(1-f)*b.startX+f*b.endX;d=(1-f)*b.startY+f*b.endY;e=Math.atan2(b.endX-b.startX,b.startY-b.endY);this.textBox.draw(c,d,e+this.lineAngleAdjust,this)}};c.prototype.containsPoint=function(a,b){var c=this.getEndPointsAndCircle(),d,e,f;if(c.hasCircle){d=a-c.circleX;e=b-c.circleY;f=Math.sqrt(d*d+e*e)-c.circleRadius;if(Math.abs(f)<this.parent.HIT_TARGET_PADDING){var g=Math.atan2(e,d),h=c.startAngle,i=c.endAngle;if(c.isReversed){var j=h;h=i;i=j}if(i<h){i+=2*Math.PI}if(g<h){g+=2*Math.PI}else if(g>i){g-=2*Math.PI}return g>h&&g<i}}else{d=c.endX-c.startX;e=c.endY-c.startY;var k=Math.sqrt(d*d+e*e),l=(d*(a-c.startX)+e*(b-c.startY))/(k*k);f=(d*(b-c.startY)-e*(a-c.startX))/k;return 0<l&&1>l&&Math.abs(f)<this.parent.HIT_TARGET_PADDING}return!1};function d(a,b,c){this.parent=a;this.node=b;this.anchorAngle=0;this.mouseOffsetAngle=0;this.textBox=new i("",this);if(c){this.setAnchorPoint(c.x,c.y)}}d.prototype.setMouseStart=function(a,b){this.mouseStartX=a;this.mouseStartY=b};d.prototype.setAnchorPoint=function(a,b){this.anchorAngle=Math.atan2(b-this.node.y,a-this.node.x)+this.mouseOffsetAngle;var c=Math.round(this.anchorAngle/(Math.PI/2))*(Math.PI/2);if(.1>Math.abs(this.anchorAngle-c)){this.anchorAngle=c}if(this.anchorAngle<-Math.PI){this.anchorAngle+=2*Math.PI}if(this.anchorAngle>Math.PI){this.anchorAngle-=2*Math.PI}};d.prototype.getEndPointsAndCircle=function(){var a=this.node.x+1.5*this.parent.nodeRadius()*Math.cos(this.anchorAngle),b=this.node.y+1.5*this.parent.nodeRadius()*Math.sin(this.anchorAngle),c=.75*this.parent.nodeRadius(),d=this.anchorAngle-.8*Math.PI,e=this.anchorAngle+.8*Math.PI,f=a+c*Math.cos(d),g=b+c*Math.sin(d),h=a+c*Math.cos(e),i=b+c*Math.sin(e);return{hasCircle:!0,startX:f,startY:g,endX:h,endY:i,startAngle:d,endAngle:e,circleX:a,circleY:b,circleRadius:c}};d.prototype.draw=function(a){var b=this.getEndPointsAndCircle();a.beginPath();a.arc(b.circleX,b.circleY,b.circleRadius,b.startAngle,b.endAngle,!1);a.stroke();var c=this.textBox.relDist,d=b.startAngle*(1-c)+b.endAngle*c,e=b.circleX+b.circleRadius*Math.cos(d),f=b.circleY+b.circleRadius*Math.sin(d);this.textBox.draw(e,f,d,this);this.parent.arrowIfReqd(a,b.endX,b.endY,b.endAngle+.4*Math.PI)};d.prototype.containsPoint=function(a,b){var c=this.getEndPointsAndCircle(),d=a-c.circleX,e=b-c.circleY,f=Math.sqrt(d*d+e*e)-c.circleRadius;return Math.abs(f)<this.parent.HIT_TARGET_PADDING};function e(a,b,c){this.parent=a;this.node=b;this.deltaX=0;this.deltaY=0;if(c){this.setAnchorPoint(c.x,c.y)}}e.prototype.setAnchorPoint=function(a,b){this.deltaX=a-this.node.x;this.deltaY=b-this.node.y;if(Math.abs(this.deltaX)<this.parent.SNAP_TO_PADDING){this.deltaX=0}if(Math.abs(this.deltaY)<this.parent.SNAP_TO_PADDING){this.deltaY=0}};e.prototype.getEndPoints=function(){var a=this.node.x+this.deltaX,b=this.node.y+this.deltaY,c=this.node.closestPointOnCircle(a,b);return{startX:a,startY:b,endX:c.x,endY:c.y}};e.prototype.draw=function(a){var b=this.getEndPoints();a.beginPath();a.moveTo(b.startX,b.startY);a.lineTo(b.endX,b.endY);a.stroke();this.parent.arrowIfReqd(a,b.endX,b.endY,Math.atan2(-this.deltaY,-this.deltaX))};e.prototype.containsPoint=function(a,b){var c=this.getEndPoints(),d=c.endX-c.startX,e=c.endY-c.startY,f=Math.sqrt(d*d+e*e),g=(d*(a-c.startX)+e*(b-c.startY))/(f*f),h=(d*(b-c.startY)-e*(a-c.startX))/f;return 0<g&&1>g&&Math.abs(h)<this.parent.HIT_TARGET_PADDING};function f(a,b,c){this.parent=a;this.from=b;this.to=c}f.prototype.draw=function(a){a.beginPath();a.moveTo(this.to.x,this.to.y);a.lineTo(this.from.x,this.from.y);a.stroke();this.parent.arrowIfReqd(a,this.to.x,this.to.y,Math.atan2(this.to.y-this.from.y,this.to.x-this.from.x))};function g(a,b,c,d){this.BUTTON_WIDTH=60;this.BUTTON_HEIGHT=25;this.TEXT_OFFSET_X=30;this.TEXT_OFFSET_Y=17;this.topX=b;this.topY=c;this.parent=a;this.text=d;this.highLighted=!1}g.prototype.containsPoint=function(b,c){return a.isInside({x:b,y:c},{x:this.topX,y:this.topY,width:this.BUTTON_WIDTH,height:this.BUTTON_HEIGHT})};g.prototype.draw=function(a){if(this.highLighted){a.fillStyle="#FFFFFF"}else{a.fillStyle="#F0F0F0"}a.fillRect(this.topX,this.topY,this.BUTTON_WIDTH,this.BUTTON_HEIGHT);a.lineWidth=.5;a.strokeStyle="#000000";a.strokeRect(this.topX,this.topY,this.BUTTON_WIDTH,this.BUTTON_HEIGHT);a.font="12pt Arial";a.fillStyle="#000000";a.textAlign="center";a.fillText(this.text,this.topX+this.TEXT_OFFSET_X,this.topY+this.TEXT_OFFSET_Y);a.textAlign="left"};g.prototype.onClick=function(){};function h(a,b,c){g.call(this,a,b,c,"Help");this.helpOpen=!1;this.LINE_HEIGHT=18;this.HELP_INDENT=5}h.prototype=new g;h.prototype.draw=function(a){var b,c,d,e;g.prototype.draw.call(this,a);if(this.helpOpen){e=this.parent.helpText;a.font="12pt Arial";b=e.split("\n");d=this.topY+this.BUTTON_HEIGHT;for(c=0;c<b.length;c+=1){d+=this.LINE_HEIGHT;a.fillText(b[c],this.topX+this.HELP_INDENT,d)}}};h.prototype.onClick=function(){this.helpOpen=!this.helpOpen;this.parent.draw()};function i(a,b){this.text=a;this.parent=b;this.caretPosition=a.length;this.relDist=.5;this.offset=b.parent.textOffset();this.dragged=!1;this.boundingBox={}}i.prototype.insertChar=function(a){this.text=this.text.slice(0,this.caretPosition)+a+this.text.slice(this.caretPosition);this.caretRight()};i.prototype.deleteChar=function(){if(0<this.caretPosition){this.text=this.text.slice(0,this.caretPosition-1)+this.text.slice(this.caretPosition);this.caretLeft()}};i.prototype.caretLeft=function(){if(0<this.caretPosition){this.caretPosition--}};i.prototype.caretRight=function(){if(this.caretPosition<this.text.length){this.caretPosition++}};i.prototype.containsPoint=function(b,c){return a.isInside({x:b,y:c},this.boundingBox)};i.prototype.setMouseStart=function(a,b){this.mouseOffsetX=this.position.x-a;this.mouseOffsetY=this.position.y-b};i.prototype.setAnchorPoint=function(b,c){b+=this.mouseOffsetX||0;c+=this.mouseOffsetY||0;var d=this.parent.getEndPointsAndCircle(),e,f;if(d.hasCircle){var g=Math.atan2(c-d.circleY,b-d.circleX);if(g<d.startAngle){g+=2*Math.PI}if(d.endAngle<d.startAngle){d.endAngle+=2*Math.PI}if(d.isReversed){e=(g-d.startAngle-2*Math.PI)/(d.endAngle-d.startAngle-2*Math.PI)}else{e=(g-d.startAngle)/(d.endAngle-d.startAngle)}f=a.vectorMagnitude({x:b-d.circleX,y:c-d.circleY})-d.circleRadius}else{var h={x:b-d.startX,y:c-d.startY},i={x:d.endX-d.startX,y:d.endY-d.startY},j=a.scalarProjection(h,i);e=j/a.vectorMagnitude(i);f=Math.sqrt(Math.pow(a.vectorMagnitude(h),2)-Math.pow(j,2));var k=a.isCCW(h,i),l=0!=this.parent.lineAngleAdjust;if(!k&&l||k&&!l){f*=-1}}if(0<e&&1>e){this.relDist=e;this.offset=Math.round(f);this.dragged=!0}};i.prototype.draw=function(b,d,e,f){var g=f.parent,h=g.getCanvas().getContext("2d");h.font=g.fontSize()+"px Arial";var c=a.convertLatexShortcuts(this.text.slice(0,this.caretPosition)),i=a.convertLatexShortcuts(this.text.slice(this.caretPosition)),j=h.measureText(c+i).width,k=Math.round(g.fontSize()/2);if(null!==e){var l=Math.cos(e),m=Math.sin(e);b+=this.offset*l;d+=this.offset*m;if(!this.dragged){var n=j/2*(0<l?1:-1),o=k/2*(0<m?1:-1),p=m*Math.pow(Math.abs(m),40)*n-l*Math.pow(Math.abs(l),10)*o;b+=n-m*p;d+=o+l*p}this.position={x:Math.round(b),y:Math.round(d)}}b-=j/2;b=Math.round(b);d=Math.round(d);if("advancedFillText"in h){h.advancedFillText(this.text,this.text,b+j/2,d,e)}else{var q=h.fillStyle;h.fillStyle="rgba(255, 255, 255, 0.7)";h.fillRect(b,d-k,j,2*k);h.fillStyle=q;k=Math.round(g.fontSize()/3);h.fillText(c,b,d+k);var r=b+h.measureText(c).width;h.fillText(i,r,d+k);k=Math.round(g.fontSize()/2);if(f==g.selectedObject&&g.caretVisible&&g.hasFocus()&&document.hasFocus()){h.beginPath();h.moveTo(r,d-k);h.lineTo(r,d+k);h.stroke()}}this.boundingBox={x:b,y:d-k,height:2*k,width:j}};return{Node:b,Link:c,SelfLink:d,TemporaryLink:f,StartLink:e,Button:g,HelpBox:h,TextBox:i}});
//# sourceMappingURL=graphelements.min.js.map
