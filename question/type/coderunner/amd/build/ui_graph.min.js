define ("qtype_coderunner/ui_graph",["jquery","qtype_coderunner/graphutil","qtype_coderunner/graphelements"],function(a,b,c){function d(b,c,d,e){this.HANDLE_SIZE=10;this.parent=b;this.canvas=a(document.createElement("canvas"));this.canvas.attr({id:c,class:"coderunner_graphcanvas",tabindex:1});this.canvas.css({"background-color":"white"});this.canvas.on("mousedown",function(a){return b.mousedown(a)});this.canvas.on("mouseup",function(a){return b.mouseup(a)});this.canvas.on("dblclick",function(a){return b.dblclick(a)});this.canvas.on("keydown",function(a){return b.keydown(a)});this.canvas.on("mousemove",function(a){return b.mousemove(a)});this.canvas.on("keypress",function(a){return b.keypress(a)});this.resize=function(a,b){this.canvas.attr("width",a);this.canvas.attr("height",b)};this.resize(d,e)}function e(b,e,f,g){var h=this;this.SNAP_TO_PADDING=6;this.DUPLICATE_LINK_OFFSET=16;this.HIT_TARGET_PADDING=6;this.DEFAULT_NODE_RADIUS=26;this.DEFAULT_FONT_SIZE=20;this.DEFAULT_TEXT_OFFSET=5;this.DEFAULT_LINK_LABEL_REL_DIST=.5;this.MAX_VERSIONS=30;this.canvasId="graphcanvas_"+b;this.textArea=a(document.getElementById(b));this.helpText="";this.readOnly=this.textArea.prop("readonly");this.uiParams=g;this.graphCanvas=new d(this,this.canvasId,e,f);this.caretVisible=!0;this.caretTimer=0;this.originalClick=null;this.nodes=[];this.links=[];this.selectedObject=null;this.currentLink=null;this.movingObject=!1;this.fail=!1;this.failString=null;this.versions=[];this.versionIndex=-1;this.helpBox=new c.HelpBox(this,0,0);this.clearButton=new c.Button(this,60,0,"Clear");this.clearButton.onClick=function(){if(confirm("Are you sure you want to clear the diagram?")){this.parent.clear()}};this.buttons=[this.helpBox,this.clearButton];if("locknodes"in g){g.locknodepositions=g.locknodes}if("lockedges"in g){g.lockedgepositions=g.lockedges}if("helpmenutext"in g){this.helpText=g.helpmenutext}else{require(["core/str"],function(b){var c=b.get_string("graphhelp","qtype_coderunner");a.when(c).done(function(a){h.helpText=a})})}this.reload();if(!this.fail){this.draw()}}e.prototype.failed=function(){return this.fail};e.prototype.failMessage=function(){return this.failString};e.prototype.getElement=function(){return this.getCanvas()};e.prototype.hasFocus=function(){return document.activeElement==this.getCanvas()};e.prototype.getCanvas=function(){var a=this.graphCanvas.canvas[0];return a};e.prototype.nodeRadius=function(){return this.uiParams.noderadius?this.uiParams.noderadius:this.DEFAULT_NODE_RADIUS};e.prototype.fontSize=function(){return this.uiParams.fontsize?this.uiParams.fontsize:this.DEFAULT_FONT_SIZE};e.prototype.isFsm=function(){return this.uiParams.isfsm!==void 0?this.uiParams.isfsm:!0};e.prototype.textOffset=function(){return this.uiParams.textoffset?this.uiParams.textoffset:this.DEFAULT_TEXT_OFFSET};e.prototype.arrowIfReqd=function(a,c,d,e){if(this.uiParams.isdirected===void 0||this.uiParams.isdirected){b.drawArrow(a,c,d,e)}};e.prototype.sync=function(){};e.prototype.syncIntervalSecs=function(){return 0};e.prototype.keypress=function(a){var c=b.crossBrowserKey(a);if(this.readOnly){return}if(32<=c&&126>=c&&!a.metaKey&&!a.altKey&&!a.ctrlKey&&37!==c&&39!==c&&null!==this.selectedObject&&this.canEditText()){if(this.selectedObject.justMoved){this.saveVersion()}this.selectedObject.justMoved=!1;this.selectedObject.textBox.insertChar(String.fromCharCode(c));this.resetCaret();this.draw();return!1}else if(8===c||32===c||9===c){return!1}};e.prototype.mousedown=function(a){var d=b.crossBrowserRelativeMousePos(a);if(this.readOnly){return}this.selectedObject=this.selectObject(d.x,d.y);this.movingObject=!1;this.movingGraph=!1;this.movingText=!1;this.originalClick=d;this.saveVersion();if(this.selectedObject!==this.helpBox){this.helpBox.helpOpen=!1}if(null!==this.selectedObject){if(this.selectedObject instanceof c.Button){this.selectedObject.onClick()}else if(a.shiftKey&&this.selectedObject instanceof c.Node){if(!this.uiParams.lockedgeset){this.currentLink=new c.SelfLink(this,this.selectedObject,d)}}else if(a.altKey&&this.selectedObject instanceof c.Node){if(!this.uiParams.locknodepositions){this.movingGraph=!0;this.movingNodes=this.selectedObject.traverseGraph(this.links,[]);for(var e=0;e<this.movingNodes.length;e++){this.movingNodes[e].setMouseStart(d.x,d.y)}}}else if(this.selectedObject instanceof c.TextBox){if(!this.uiParams.lockedgelabels){this.movingText=!0;this.selectedObject.setMouseStart(d.x,d.y);this.selectedObject=this.selectedObject.parent}}else if(!(this.uiParams.locknodepositions&&this.selectedObject instanceof c.Node)&&!(this.uiParams.lockedgepositions&&this.selectedObject instanceof c.Link)){this.movingObject=!0;if(this.selectedObject.setMouseStart){this.selectedObject.setMouseStart(d.x,d.y)}}this.selectedObject.justMoved=!0;this.resetCaret()}else if(a.shiftKey&&this.isFsm()){this.currentLink=new c.TemporaryLink(this,d,d)}this.draw();if(this.hasFocus()){return!1}else{this.resetCaret();return!0}};e.prototype.canEditText=function(){var a=this.selectedObject instanceof c.Node,b=this.selectedObject instanceof c.Link||this.selectedObject instanceof c.SelfLink;return"textBox"in this.selectedObject&&(a&&!this.uiParams.locknodelabels||b&&!this.uiParams.lockedgelabels)};e.prototype.keydown=function(a){var c=b.crossBrowserKey(a),d,e=!1;if(this.readOnly){return}if(8===c){if(null!==this.selectedObject&&this.canEditText()){this.selectedObject.textBox.deleteChar();this.resetCaret();this.draw()}return!1}else if(46===c&&null!==this.selectedObject){this.saveVersion();for(d=0;d<this.nodes.length;d++){if(this.nodes[d]===this.selectedObject&&!this.uiParams.locknodeset){this.nodes.splice(d--,1);e=!0}}for(d=0;d<this.links.length;d++){if(this.links[d]===this.selectedObject&&!this.uiParams.lockedgeset||e&&(this.links[d].node===this.selectedObject||this.links[d].nodeA===this.selectedObject||this.links[d].nodeB===this.selectedObject)){this.links.splice(d--,1)}}this.selectedObject=null;this.draw()}else if(13===c){if(null!==this.selectedObject){this.selectedObject=null;this.draw()}}else if(37===c){if(null!==this.selectedObject&&this.canEditText()){this.selectedObject.textBox.caretLeft();this.resetCaret();this.draw()}}else if(39===c){if(null!==this.selectedObject&&this.canEditText()){this.selectedObject.textBox.caretRight();this.resetCaret();this.draw()}}else if(90==a.keyCode&&a.ctrlKey&&a.shiftKey||89==a.keyCode&&a.ctrlKey){this.redo()}else if(90==a.keyCode&&a.ctrlKey){this.undo()}};e.prototype.dblclick=function(a){var d=b.crossBrowserRelativeMousePos(a);if(this.readOnly||this.uiParams.locknodeset){return}this.selectedObject=this.selectObject(d.x,d.y);this.saveVersion();if(null===this.selectedObject){this.selectedObject=new c.Node(this,d.x,d.y);this.nodes.push(this.selectedObject);this.selectedObject.justMoved=!0;this.resetCaret();this.draw()}else{if(this.selectedObject instanceof c.Node&&this.isFsm()){this.selectedObject.isAcceptState=!this.selectedObject.isAcceptState;this.draw()}}};e.prototype.resize=function(a,b){this.graphCanvas.resize(a,b);this.draw()};e.prototype.mousemove=function(a){var d=b.crossBrowserRelativeMousePos(a),e;if(this.readOnly){return}for(h=0;h<this.buttons.length;h++){if(this.buttons[h].containsPoint(d.x,d.y)){this.buttons[h].highLighted=!0}else{this.buttons[h].highLighted=!1}this.draw()}if(null!==this.currentLink){var f=this.selectObject(d.x,d.y);if(!(f instanceof c.Node)){f=null}if(null===this.selectedObject){if(null!==f){this.currentLink=new c.StartLink(this,f,this.originalClick)}else{this.currentLink=new c.TemporaryLink(this,this.originalClick,d)}}else{if(f===this.selectedObject){this.currentLink=new c.SelfLink(this,this.selectedObject,d)}else if(null!==f){this.currentLink=new c.Link(this,this.selectedObject,f)}else{e=this.selectedObject.closestPointOnCircle(d.x,d.y);this.currentLink=new c.TemporaryLink(this,e,d)}}this.draw()}if(this.movingGraph){for(var g=this.movingNodes,h=0;h<g.length;h++){g[h].trackMouse(d.x,d.y);this.snapNode(g[h])}this.draw()}else if(this.movingText){this.selectedObject.textBox.setAnchorPoint(d.x,d.y);this.draw()}else if(this.movingObject){this.selectedObject.setAnchorPoint(d.x,d.y);if(this.selectedObject instanceof c.Node){this.snapNode(this.selectedObject)}this.draw()}};e.prototype.mouseup=function(){if(this.readOnly){return}this.movingObject=!1;this.movingGraph=!1;this.movingText=!1;if(null!==this.currentLink){if(!(this.currentLink instanceof c.TemporaryLink)){this.selectedObject=this.currentLink;this.addLink(this.currentLink);this.resetCaret()}this.currentLink=null;this.draw()}};e.prototype.selectObject=function(a,b){for(c=0;c<this.buttons.length;c++){if(this.buttons[c].containsPoint(a,b)){return this.buttons[c]}}var c;for(c=0;c<this.nodes.length;c++){if(this.nodes[c].containsPoint(a,b)){return this.nodes[c]}}for(c=0;c<this.links.length;c++){if(this.links[c].containsPoint(a,b)){return this.links[c]}else if("textBox"in this.links[c]&&this.links[c].textBox.containsPoint(a,b)){return this.links[c].textBox}}return null};e.prototype.snapNode=function(a){for(var b=0;b<this.nodes.length;b++){if(this.nodes[b]===a){continue}if(Math.abs(a.x-this.nodes[b].x)<this.SNAP_TO_PADDING){a.x=this.nodes[b].x}if(Math.abs(a.y-this.nodes[b].y)<this.SNAP_TO_PADDING){a.y=this.nodes[b].y}}};e.prototype.addLink=function(a){for(var b=null,c=0,d;c<this.links.length;c++){d=this.links[c];if(d.nodeA===a.nodeA&&d.nodeB===a.nodeB){if(null===b||d.perpendicularPart>b){b=d.perpendicularPart}}if(d.nodeA===a.nodeB&&d.nodeB===a.nodeA){if(null===b||-d.perpendicularPart>b){b=-d.perpendicularPart}}}if(null!==b){a.perpendicularPart=b+this.DUPLICATE_LINK_OFFSET}this.links.push(a)};e.prototype.reload=function(){var b=a(this.textArea).val();if(b){try{var d=JSON.parse(b),e;for(e=0;e<d.nodes.length;e++){var f=d.nodes[e],g=d.nodeGeometry[e],h=new c.Node(this,g[0],g[1]);h.isAcceptState=f[1];h.textBox=new c.TextBox(f[0].toString(),h);this.nodes.push(h)}for(e=0;e<d.edges.length;e++){var j=d.edges[e],k=d.edgeGeometry[e],l=null;if(j[0]===j[1]){l=new c.SelfLink(this,this.nodes[j[0]]);l.anchorAngle=k.anchorAngle;l.textBox=new c.TextBox(j[2].toString(),l);if(3<j.length){l.textBox.setAnchorPoint(j[3].x,j[3].y)}}else if(-1===j[0]){l=new c.StartLink(this,this.nodes[j[1]]);l.deltaX=k.deltaX;l.deltaY=k.deltaY}else{l=new c.Link(this,this.nodes[j[0]],this.nodes[j[1]]);l.parallelPart=k.parallelPart;l.perpendicularPart=k.perpendicularPart;l.lineAngleAdjust=k.lineAngleAdjust;l.textBox=new c.TextBox(j[2].toString(),l);if(3<j.length){l.textBox.setAnchorPoint(j[3].x,j[3].y)}}if(null!==l){this.links.push(l)}}}catch(a){this.fail=!0;this.failString="graph_ui_invalidserialisation"}}};e.prototype.save=function(){var a={edgeGeometry:[],nodeGeometry:[],nodes:[],edges:[]},b;if(!JSON||""===this.textArea.val().trim()&&0===this.nodes.length){return}for(b=0;b<this.nodes.length;b++){var d=this.nodes[b],e=[d.textBox.text,d.isAcceptState],f=[d.x,d.y];a.nodeGeometry.push(f);a.nodes.push(e)}for(b=0;b<this.links.length;b++){var g=this.links[b],h=null,j=null;if(g instanceof c.SelfLink){j={anchorAngle:g.anchorAngle};h=[this.nodes.indexOf(g.node),this.nodes.indexOf(g.node),g.textBox.text];if(g.textBox.dragged){h.push(g.textBox.position)}}else if(g instanceof c.StartLink){j={deltaX:g.deltaX,deltaY:g.deltaY};h=[-1,this.nodes.indexOf(g.node),""]}else if(g instanceof c.Link){j={lineAngleAdjust:g.lineAngleAdjust,parallelPart:g.parallelPart,perpendicularPart:g.perpendicularPart};h=[this.nodes.indexOf(g.nodeA),this.nodes.indexOf(g.nodeB),g.textBox.text];if(g.textBox.dragged){h.push(g.textBox.position)}}if(null!==h&&null!==j){a.edges.push(h);a.edgeGeometry.push(j)}}this.textArea.val(JSON.stringify(a))};e.prototype.saveVersion=function(){var a=this.textArea.val();if(0==this.versions.length||0!=a.localeCompare(this.versions[this.versionIndex])){this.versionIndex++;while(this.versionIndex<this.versions.length){this.versions.pop()}this.versions.push(a);if(this.versions.length>this.MAX_VERSIONS){this.versions.shift();this.versionIndex--}}};e.prototype.undo=function(){this.saveVersion();if(0<this.versionIndex){this.versionIndex--;this.textArea.val(this.versions[this.versionIndex]);this.nodes=[];this.links=[];this.reload();this.draw()}};e.prototype.redo=function(){if(this.versionIndex<this.versions.length-1){this.versionIndex++;this.textArea.val(this.versions[this.versionIndex]);this.nodes=[];this.links=[];this.reload();this.draw()}};e.prototype.clear=function(){this.saveVersion();this.nodes=[];this.links=[];this.save();this.draw()};e.prototype.destroy=function(){clearInterval(this.caretTimer);this.graphCanvas.canvas.off();this.graphCanvas.canvas.remove()};e.prototype.resetCaret=function(){var a=this;clearInterval(this.caretTimer);this.caretTimer=setInterval(function(){a.caretVisible=!a.caretVisible;a.draw()},500);this.caretVisible=!0};e.prototype.draw=function(){var a=this.getCanvas(),b=a.getContext("2d"),c;b.clearRect(0,0,this.getCanvas().width,this.getCanvas().height);b.save();b.translate(.5,.5);for(c=0;c<this.buttons.length;c++){this.buttons[c].draw(b)}if(!this.helpBox.helpOpen){for(c=0;c<this.nodes.length;c++){b.lineWidth=1;b.fillStyle=b.strokeStyle=this.nodes[c]===this.selectedObject?"blue":"black";this.nodes[c].draw(b)}for(c=0;c<this.links.length;c++){b.lineWidth=1;b.fillStyle=b.strokeStyle=this.links[c]===this.selectedObject||this.links[c].textBox===this.selectedObject?"blue":"black";this.links[c].draw(b)}if(null!==this.currentLink){b.lineWidth=1;b.fillStyle=b.strokeStyle="black";this.currentLink.draw(b)}}b.restore();this.save()};return{Constructor:e}});
//# sourceMappingURL=ui_graph.min.js.map
