define ("qtype_coderunner/ui_ace_gapfiller",["jquery"],function(a){var d,f=/[ !"#$%&'()*+,`\-./0-9:;<=>?@A-Z\[\]\\^_a-z{}|~]/;function b(b,c,e,g){this.textArea=a(document.getElementById(b));var h=a(document.getElementById(b+"_wrapper")),i=this.textArea[0]===document.activeElement,j=g.lang,k=this,l="";this.uiParams=g;this.gaps=[];this.source=g.ui_source||"globalextra";this.nextGapIndex=0;if("globalextra"!==this.source&&"test0"!==this.source){alert("Invalid source for code in ui_ace_gapfiller");this.source="globalextra"}if("globalextra"==this.source){l=this.textArea.attr("data-globalextra")}else{l=this.textArea.attr("data-test0")}try{window.ace.require("ace/ext/language_tools");d=window.ace.require("ace/range").Range;this.modelist=window.ace.require("ace/ext/modelist");this.enabled=!1;this.contents_changed=!1;this.capturingTab=!1;this.clickInProgress=!1;this.editNode=a("<div></div>");this.editNode.css({resize:"none",height:e,width:"100%"});this.editor=window.ace.edit(this.editNode.get(0));if(this.textArea.prop("readonly")){this.editor.setReadOnly(!0)}this.editor.setOptions({displayIndentGuides:!1,dragEnabled:!1,enableBasicAutocompletion:!0,newLineMode:"unix"});this.editor.$blockScrolling=1/0;if(g.theme){this.editor.setTheme("ace/theme/"+g.theme)}this.setLanguage(j);this.setEventHandlers(this.textArea);this.captureTab();this.editor.renderer.on("afterRender",function(){var a=h.find(".ace_gutter");if(a.hasClass("moodle-has-zindex")){return}a.addClass("moodle-has-zindex");if(i){k.editor.focus();k.editor.navigateFileEnd()}k.aceLabel=h.find(".answerprompt");k.aceLabel.attr("for","ace_"+b);k.aceTextarea=h.find(".ace_text-input");k.aceTextarea.attr("id","ace_"+b)});this.createGaps(l);this.editor.commands.on("exec",function(a){var b=k.editor.selection.getCursor(),c=a.command.name,e=k.editor.getSelectionRange(),g=k.findCursorGap(b);if(c.startsWith("go")){if(null!==g&&"gotoright"===c&&b.column===g.range.start.column+g.textSize){k.editor.moveCursorTo(b.row,g.range.end.column+1)}else{return}}if(null===g){if("selectall"===c){k.editor.selection.selectAll()}}else if("indent"===c){var h=k.gaps[(g.index+1)%k.gaps.length];k.editor.moveCursorTo(h.range.start.row,h.range.start.column+h.textSize);k.editor.selection.clearSelection()}else if("selectall"===c){k.editor.selection.setSelectionRange(new d(g.range.start.row,g.range.start.column,g.range.start.row,g.range.end.column),!1)}else if(k.editor.selection.isEmpty()){if("insertstring"===c){var i=a.args;if(f.test(i)){g.insertChar(k.gaps,b,i)}}else if("backspace"===c){if(b.column>g.range.start.column&&0<g.textSize){g.deleteChar(k.gaps,{row:b.row,column:b.column-1})}}else if("del"===c){if(b.column<g.range.start.column+g.textSize&&0<g.textSize){g.deleteChar(k.gaps,b)}}k.editor.selection.clearSelection()}else if(!k.editor.selection.isEmpty()&&g.cursorInGap(e.start)&&g.cursorInGap(e.end)){if("insertstring"===c||"backspace"===c||"del"===c||"paste"===c||"cut"===c){g.deleteRange(k.gaps,e.start.column,e.end.column);k.editor.selection.clearSelection()}if("insertstring"===c){var j=a.args;if(f.test(j)){g.insertChar(k.gaps,e.start,j)}}}if(null!==g&&"paste"===c){g.insertText(k.gaps,e.start.column,a.args.text)}a.preventDefault();a.stopPropagation()});k.editor.selection.on("changeCursor",function(){var a=k.editor.selection.getCursor(),b=k.findCursorGap(a);if(null!==b){if(a.column>b.range.start.column+b.textSize){k.editor.moveCursorTo(b.range.start.row,b.range.start.column+b.textSize)}}});this.gapToSelect=null;this.editor.on("tripleclick",function(a){var b=k.editor.selection.getCursor(),c=k.findCursorGap(b);if(null!==c){k.editor.selection.setSelectionRange(new d(c.range.start.row,c.range.start.column,c.range.start.row,c.range.end.column),!1);k.gapToSelect=c;a.preventDefault();a.stopPropagation()}});this.editor.on("click",function(a){if(k.gapToSelect){k.editor.moveCursorTo(k.gapToSelect.range.start.row,k.gapToSelect.range.start.column+k.gapToSelect.textSize);k.gapToSelect=null;a.preventDefault();a.stopPropagation()}});this.fail=!1;this.reload()}catch(a){this.fail=!0}}b.prototype.createGaps=function(a){this.gaps=[];function b(a){for(var b,d="{[(*+\\",e="",f=0;f<a.length;f++){b=a[f];for(var g=0;g<d.length;g++){if(b===d[g]){b="\\"+b}}e+=b}return e}for(var d=a.split(/\r?\n/),e=b("{["),f=b("]}"),g=new RegExp(e+" *((?:\\d+)|(?:\\d+- *\\d+)) *"+f),h="",k=0,l;k<d.length;k++){l=d[k].split(g);h+=l[0];for(var m=l[0].length,n=1;n<l.length;n+=2){var o=l[n].split("-"),p=parseInt(o[0]),q=1<o.length?parseInt(o[1]):1/0,r=new c(this.editor,k,m,p,q);r.index=this.nextGapIndex;this.nextGapIndex+=1;this.gaps.push(r);m+=p;h+=" ".repeat(p);if(n+1<l.length){h+=l[n+1];m+=l[n+1].length}}if(k<d.length-1){h+="\n"}}this.editor.session.setValue(h)};b.prototype.findCursorGap=function(a){for(var b=0,c;b<this.gaps.length;b++){c=this.gaps[b];if(c.cursorInGap(a)){return c}}return null};b.prototype.failed=function(){return this.fail};b.prototype.failMessage=function(){return"ace_ui_notready"};b.prototype.sync=function(){for(var a=[],b=!0,c=0;c<this.gaps.length;c++){var d=this.gaps[c],e=d.getText();a.push(e);if(""!==e){b=!1}}if(b){this.textArea.val("")}else{this.textArea.val(JSON.stringify(a))}};b.prototype.reload=function(){var a=this.textArea.val();if(a){try{for(var b=JSON.parse(a),c=0,d;c<this.gaps.length;c++){d=c<b.length?b[c]:"???";this.gaps[c].insertText(this.gaps,this.gaps[c].range.start.column,d)}}catch(a){}}};b.prototype.setLanguage=function(a){var b=this.editor.getSession(),c=this.findMode(a);if(c){b.setMode(c.mode)}};b.prototype.getElement=function(){return this.editNode};b.prototype.captureTab=function(){this.capturingTab=!0;this.editor.commands.bindKeys({Tab:"indent","Shift-Tab":"outdent"})};b.prototype.releaseTab=function(){this.capturingTab=!1;this.editor.commands.bindKeys({Tab:null,"Shift-Tab":null})};b.prototype.setEventHandlers=function(){var a=this;this.editor.getSession().on("change",function(){a.contents_changed=!0});this.editor.on("blur",function(){if(a.contents_changed){a.textArea.trigger("change")}});this.editor.on("mousedown",function(){a.clickInProgress=!0});this.editor.on("focus",function(){if(a.clickInProgress){a.captureTab()}else{a.releaseTab()}});this.editor.on("click",function(){a.clickInProgress=!1});this.editor.container.addEventListener("keydown",function(b){if(b.which===void 0||0!==b.which){if(b.keyCode===77&&b.ctrlKey&&!b.altKey){if(a.capturingTab){a.releaseTab()}else{a.captureTab()}b.preventDefault()}else if(b.keyCode===27){a.releaseTab()}else if(!(b.shiftKey||b.ctrlKey||b.altKey||b.keyCode==9)){a.captureTab()}}},!0)};b.prototype.destroy=function(){this.sync();var b;if(!this.fail){b=this.editor.isFocused();this.editor.destroy();a(this.editNode).remove();if(b){this.textArea.focus();this.textArea[0].selectionStart=this.textArea[0].value.length}}};b.prototype.hasFocus=function(){return this.editor.isFocused()};b.prototype.findMode=function(a){var b,c,d,e=[],f={octave:"matlab",nodejs:"javascript","c#":"cs"};if("string"!=typeof a){return}if(a.toLowerCase()in f){a=f[a.toLowerCase()]}e=[a,a.replace(/\d+$/,"")];for(var g=0;g<e.length;g++){b=e[g];c="input."+b;d=this.modelist.modesByName[b]||this.modelist.modesByName[b.toLowerCase()]||this.modelist.getModeForPath(c)||this.modelist.getModeForPath(c.toLowerCase());if(d&&"text"!==d.name){return d}}};b.prototype.resize=function(a,b){this.editNode.outerHeight(b);this.editNode.outerWidth(a);this.editor.resize()};function c(a,b,c,e){var f=4<arguments.length&&arguments[4]!==void 0?arguments[4]:1/0;this.editor=a;this.minWidth=e;this.maxWidth=f;this.range=new d(b,c,b,c+e);this.textSize=0;this.editor.session.addMarker(this.range,"ace-gap-outline","text",!0);this.editor.session.addMarker(this.range,"ace-gap-background","text",!1)}c.prototype.cursorInGap=function(a){return a.row>=this.range.start.row&&a.column>=this.range.start.column&&a.row<=this.range.end.row&&a.column<=this.range.end.column};c.prototype.getWidth=function(){return this.range.end.column-this.range.start.column};c.prototype.changeWidth=function(a,b){this.range.end.column+=b;for(var c=0,d;c<a.length;c++){d=a[c];if(d.range.start.row===this.range.start.row&&d.range.start.column>this.range.end.column){d.range.start.column+=b;d.range.end.column+=b}}this.editor.$onChangeBackMarker();this.editor.$onChangeFrontMarker()};c.prototype.insertChar=function(a,b,c){if(this.textSize===this.getWidth()&&this.getWidth()<this.maxWidth){this.changeWidth(a,1);this.textSize+=1;this.editor.session.insert(b,c)}else if(this.textSize<this.maxWidth){this.editor.session.remove(new d(b.row,this.range.end.column-1,b.row,this.range.end.column));this.textSize+=1;this.editor.session.insert(b,c)}};c.prototype.deleteChar=function(a,b){this.textSize-=1;this.editor.session.remove(new d(b.row,b.column,b.row,b.column+1));if(this.textSize>=this.minWidth){this.changeWidth(a,-1)}else{this.editor.session.insert({row:b.row,column:this.range.end.column-1}," ")}};c.prototype.deleteRange=function(a,b,c){for(var d=b;d<c;d++){if(b<this.range.start.column+this.textSize){this.deleteChar(a,{row:this.range.start.row,column:b})}}};c.prototype.insertText=function(a,b,c){for(var d=0;d<c.length;d++){if(b+d<this.range.start.column+this.maxWidth){this.insertChar(a,{row:this.range.start.row,column:b+d},c[d])}}};c.prototype.getText=function(){return this.editor.session.getTextRange(new d(this.range.start.row,this.range.start.column,this.range.end.row,this.range.start.column+this.textSize))};return{Constructor:b}});
//# sourceMappingURL=ui_ace_gapfiller.min.js.map
