define ("qtype_pmatch/rulecreator",["jquery"],function(a){var b={store:{},init:function init(){a("textarea[name^=\"answer\"]").each(function(){var c=a(this).attr("id").replace("id_answer_","");b.store["id_"+c]=[];if(""!==a(this).val()){a(this).parent().parent().next().addClass("rc-hidden")}else{a(this).parent().parent().next().addClass("rcw")}var d=a(this).parent().parent().next().find("div.rule-creator");d.attr("id","rc_"+c);a(this).parent().parent().next().find("a.rule-creator-btn").attr("id","rc_btn_"+c);d.find("div[class=\"rc-notice\"]").attr("id","rc_notice_"+c);d.find("label[for=\"term\"]").attr("for","rc_term_"+c);d.find("input[name=\"term\"]").attr("id","rc_term_"+c);d.find("input[name=\"termadd\"]").attr("id","rc_termadd_"+c).click(function(){b.termAdd(c);return!1});d.find("input[name=\"termexclude\"]").attr("id","rc_termexclude_"+c).click(function(){b.termExclude(c);return!1});d.find("input[name=\"termor\"]").attr("id","rc_termor_"+c).click(function(){b.termOr(c);return!1});d.find("label[for=\"template\"]").attr("for","rc_template_"+c);d.find("input[name=\"template\"]").attr("id","rc_template_"+c);d.find("input[name=\"templateadd\"]").attr("id","rc_templateadd_"+c).click(function(){b.templateAdd(c);return!1});d.find("input[name=\"templateexclude\"]").attr("id","rc_templateexclude_"+c).click(function(){b.templateExclude(c);return!1});d.find("label[for=\"precedesadd\"]").attr("for","rc_precedes1_"+c);d.find("select[name=\"precedes1\"]").attr("id","rc_precedes1_"+c);d.find("select[name=\"precedes2\"]").attr("id","rc_precedes2_"+c);d.find("input[name=\"precedesadd\"]").attr("id","rc_precedesadd_"+c).click(function(){b.precedesAdd(c);return!1});d.find("label[for=\"cprecedesadd\"]").attr("for","rc_cprecedes1_"+c);d.find("select[name=\"cprecedes1\"]").attr("id","rc_cprecedes1_"+c);d.find("select[name=\"cprecedes2\"]").attr("id","rc_cprecedes2_"+c);d.find("input[name=\"cprecedesadd\"]").attr("id","rc_cprecedesadd_"+c).click(function(){b.cprecedesAdd(c);return!1});d.find("div.rc-result").attr("id","rc_result_"+c);d.find("input[name=\"add\"]").attr("id","rc_add_"+c).click(function(){b.addToAnswer(c);return!1});d.find("input[name=\"clear\"]").attr("id","rc_clear_"+c).click(function(){b.clear(c);return!1})});a(".rule-creator-btn").click(function(b){var c=a(b.target).closest(".fitem.rcw"),d=a(b.target).closest(".rule-creator-btn").find("img.icon"),e=d.attr("src");c.find(".rule-creator").slideToggle();if(e===void 0){return!1}if(0<e.indexOf("collapsed")){e=e.slice(0,-9)+"expanded"}else{e=e.slice(0,-8)+"collapsed"}d.attr("src",e);return!1})},termAdd:function termAdd(b){var c=this.getTerm(b,"term");if(!c){a("#rc_term_"+b).focus();return}var d=this.addToStore(b,c,"and","term");this.addToPrecedes(b,d,c);this.displayResult(b);a("#rc_term_"+b).val("")},termExclude:function termExclude(b){var c=this.getTerm(b,"term");if(!c){a("#rc_term_"+b).focus();return}this.addToStore(b,c,"not","term");this.disablePrecedes(b,!0);this.displayResult(b);a("#rc_term_"+b).val("")},termOr:function termOr(b){var c=this.getTerm(b,"term");if(!c){a("#rc_term_"+b).focus();return}var d=this.addToStore(b,c,"or","term");this.addToPrecedes(b,d,c);this.displayResult(b);a("#rc_term_"+b).val("")},templateAdd:function templateAdd(b){var c=this.getTerm(b,"template");if(!c){a("#rc_template_"+b).focus();return}var d=this.addToStore(b,c,"and","template");this.addToPrecedes(b,d,c);this.displayResult(b);a("#rc_template_"+b).val("")},templateExclude:function templateExclude(b){var c=this.getTerm(b,"template");if(!c){a("#rc_template_"+b).focus();return}this.addToStore(b,c,"not","template");this.disablePrecedes(b,!0);this.displayResult(b);a("#rc_template_"+b).val("")},precedesAdd:function precedesAdd(a){var b=this.getPrecedesChoices(a,"precedes");if(!b){return}this.addToStore(a,b,"and","precedes");this.removeFromPrecedes(a,b);this.displayResult(a)},cprecedesAdd:function cprecedesAdd(a){var b=this.getPrecedesChoices(a,"cprecedes");if(!b){return}this.addToStore(a,b,"and","cprecedes");this.removeFromPrecedes(a,b);this.displayResult(a)},addToAnswer:function addToAnswer(b){var c=a("#rc_result_"+b).text();if(null===c||""===c){return}a("#id_answer_"+b).val(c);this.clear();a("#rc_btn_"+b).click();a("#id_fraction_"+b).val("1.0").change();a("#id_answer_"+b).focus()},clear:function clear(b){this.store["id_"+b]=[];a("#rc_term_"+b).val("");a("#rc_template_"+b).val("");a("#rc_result_"+b).text("");this.resetPrecedes(b)},getTerm:function getTerm(b,c){if(4<this.getStoreLength(b)){a("#rc_notice_"+b).text(M.util.get_string("rulecreationtoomanyterms","qtype_pmatch"));return!1}var d=a("#rc_"+c+"_"+b).val();if(d===void 0||null===d||""===d){return!1}d=d.trim();if(""===d){return!1}if(-1<d.indexOf(" ")){return!1}if(-1<d.indexOf("_")){d=d.replace(/_/g,"\\_")}if("term"===c){return d}else{if("*"===d.slice(-1)){return d}else{return d+"*"}}},getPrecedesChoices:function getPrecedesChoices(b,c){var d=a("#rc_"+c+"1_"+b).val();if("0"===d){a("#rc_"+c+"1_"+b).focus();return!1}var e=a("#rc_"+c+"2_"+b).val();if("0"===e){a("#rc_"+c+"2_"+b).focus();return!1}if(d===e){a("#rc_"+c+"2_"+b).focus();return!1}return[d,e]},addToPrecedes:function addToPrecedes(b,c,d){a("#rc_precedes1_"+b).append(a("<option>",{value:c}).text(d));a("#rc_precedes2_"+b).append(a("<option>",{value:c}).text(d));a("#rc_cprecedes1_"+b).append(a("<option>",{value:c}).text(d));a("#rc_cprecedes2_"+b).append(a("<option>",{value:c}).text(d))},disablePrecedes:function disablePrecedes(b,c){a("#rc_precedes1_"+b).prop("disabled",c);a("#rc_precedes2_"+b).prop("disabled",c);a("#rc_cprecedes1_"+b).prop("disabled",c);a("#rc_cprecedes2_"+b).prop("disabled",c)},resetPrecedes:function resetPrecedes(b){this.disablePrecedes(b,!1);a("#rc_precedes1_"+b).find("option[value!=\"0\"]").remove();a("#rc_precedes2_"+b).find("option[value!=\"0\"]").remove();a("#rc_cprecedes1_"+b).find("option[value!=\"0\"]").remove();a("#rc_cprecedes2_"+b).find("option[value!=\"0\"]").remove()},removeFromPrecedes:function removeFromPrecedes(b,c){var d;for(d=0;2>d;d++){a("#rc_precedes1_"+b+" option[value=\""+c[d]+"\"]").remove();a("#rc_precedes2_"+b+" option[value=\""+c[d]+"\"]").remove();a("#rc_cprecedes1_"+b+" option[value=\""+c[d]+"\"]").remove();a("#rc_cprecedes2_"+b+" option[value=\""+c[d]+"\"]").remove()}},addToStore:function addToStore(a,b,c,d){var e="id_"+a,f=this.store[e].length+1;this.store[e].push({termid:f,term:b,op:c,type:d});return f},getStoreLength:function getStoreLength(a){return this.store["id_"+a].length},getStoredResult:function getStoredResult(b){var c="",d=[],e=this.store["id_"+b].slice(0),f=e.length,g=0,h=0,j=0,k=[],l=0;if(0===f){return c}for(g=0;g<f;g++){var m="";if("term"===e[g].type){if("and"===e[g].op){m="match_w("+e[g].term+")"}if("or"===e[g].op){m="match_w("+e[g].term+")";if(0<g){k.push(g)}}if("not"===e[g].op){m="not(match_w("+e[g].term+"))"}}if("template"===e[g].type){if("and"===e[g].op){m="match_wm("+e[g].term+")"}if("not"===e[g].op){m="match_wm("+e[g].term+")"}}if("precedes"===e[g].type){h=e[g].term[0]-1;j=e[g].term[1]-1;m=" match_w("+e[h].term+" "+e[j].term+")"}if("cprecedes"===e[g].type){h=e[g].term[0]-1;j=e[g].term[1]-1;m=" match_w("+e[h].term+"_"+e[j].term+")"}d.push(m)}f=d.length;if(0===f){return""}if(1===f){return d[0]}l=k.length;if(0===l){c="match_all(\n  "+d[0];for(g=1;g<f;g++){c=c+" "+d[g]}c=c+"\n)";return c}if(f===l+1){c="match_any(\n  "+d[0];for(g=1;g<f;g++){c=c+" "+d[g]}c=c+"\n)";return c}if(1===l){if(1===k[0]){if(2===f){c="match_any(\n  "+d[0]+" "+d[1]+"\n)"}else{c="match_all(\n  match_any(\n    "+d[0]+" "+d[1]+"\n  )\n ";for(g=2;g<f;g++){c=c+" "+d[g]}c=c+"\n)"}}else{c="match_all(\n    "+d[0];for(g=1;g<k[0];g++){c=c+" "+d[g]}c="match_any(\n  "+c+"\n  )\n  "+d[k[0]]+"\n)";if(f>k[0]+1){c="match_all(\n"+c+"\n";for(g=k[0]+1;g<f;g++){c=c+" "+d[g]}c=c+"\n)"}}}else if(2===l){if(1===k[0]){c="match_any(\n  "+d[0]+" "+d[1];if(2===k[1]){c="match_all(\n"+c+" "+d[2]+"\n)\n";for(g=3;g<f;g++){c=c+" "+d[g]}c=c+"\n)"}else{c="match_all(\n"+c+"\n)\n";for(g=2;g<k[1];g++){c=c+" "+d[g]}c="match_any(\n"+c+"\n)\n "+d[k[1]];if(f>k[1]+1){c="\nmatch_all(\n"+c;for(g=k[1]+1;g<f;g++){c=c+" "+d[g]}c=c+"\n)"}c=c+"\n)"}}else{c="match_all(\n"+d[0];for(g=1;g<k[0];g++){c=c+" "+d[g]}c="match_any(\n"+c+"\n)\n  "+d[k[0]];if(k[1]===k[0]+1){c=c+" "+d[k[1]]+"\n)\n";if(f>k[1]+1){c="match_all(\n"+c;for(g=k[1]+1;g<f;g++){c=c+" "+d[g]}c=c+"\n)"}}else{c="match_all(\n"+c+"\n)\n";for(g=k[0]+1;g<k[1];g++){c=c+" "+d[g]}c="match_any(\n"+c+"\n)\n"+d[k[1]]+"\n)\n";if(f>k[1]+1){c="match_all(\n"+c;for(g=k[1]+1;g<f;g++){c=c+" "+d[g]}c=c+"\n)\n"}}}}else{a("#rc_notice_"+b).text(M.util.get_string("rulecreationtoomanyors","qtype_pmatch"));return""}return c.trim()},displayResult:function displayResult(b){var c=this.getStoredResult(b);a("#rc_result_"+b).text(c)}};return b});
//# sourceMappingURL=rulecreator.min.js.map
