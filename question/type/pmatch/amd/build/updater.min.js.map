{"version":3,"sources":["../src/updater.js"],"names":["define","$","Notification","t","baseUrl","sessKey","qid","headerCheckboxChecked","REPLACESTRING","init","base","attr","body","replace","val","document","on","id","data","update","e","keyCode","which","preventDefault","trigger","click","M","util","get_string","each","checked","prop","exception","alert","message","handleUpdated","bindInplaceEditEvent","hasClass","require","target","ajaxReturn","ajaxreturn","value","oldvalue","jsonDecode","parseJSON","row","parent","currentRow","html","replaceWith","summary","text","ef","rid","expectedfraction","sesskey","post","result","status","prev","gf","tr","removeClass","addClass","rowclass","find","c","counts","window","console","log"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This class provides functionality for the testquestion response updater.\n *\n * @module    qtype_pmatch\n * @class     updater\n * @package   question\n * @copyright 2016 The Open University\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/notification'], function($, Notification) {\n    /**\n     * @alias qtype_pmatch/updater\n     */\n    var t = {\n        baseUrl: '',\n        sessKey: '',\n        qid: '',\n        headerCheckboxChecked: true,\n        /**\n         *  The string need to be replaced to get correct row.\n         */\n        REPLACESTRING: /qtype-pmatch-testquestion_r/g,\n        /**\n         * Initialise the updater.\n         */\n        init: function() {\n            var base = $('#attemptsform').attr('action');\n            var body = $('body');\n            t.baseUrl = base.replace('testquestion.php', 'api/updater.php');\n            t.sessKey = $('#attemptsform input[name=\"sesskey\"]').val();\n            t.qid = $('#attemptsform input[name=\"id\"]').val();\n            $(document).on('click', '.updater-ef', function() {\n                var id = $(this).data('id');\n                t.update(id);\n                return false;\n            });\n            // Prevent the form submit when user press enter on checkbox.\n            $(document).on('keypress', '#tablecontainer :checkbox', function(e) {\n                if ((e.keyCode ? e.keyCode : e.which) == 13) {\n                    e.preventDefault();\n                    $(this).trigger('click');\n                }\n            });\n            $('#tqheadercheckbox').click(function() {\n                if (t.headerCheckboxChecked) {\n                    $(this).attr('title', M.util.get_string('deselectall', 'moodle'));\n                    t.headerCheckboxChecked = false;\n                } else {\n                    $(this).attr('title', M.util.get_string('selectall', 'moodle'));\n                    t.headerCheckboxChecked = true;\n                }\n                $('#tablecontainer :checkbox').each(function() {\n                    this.checked = !t.headerCheckboxChecked;\n                });\n                $(this).prop('checked', false);\n            });\n\n            body.on('updatefailed', '[data-inplaceeditable]', function(e) {\n                var exception = e.exception;\n                e.preventDefault();\n                Notification.alert(M.util.get_string('error:title', 'qtype_pmatch'),\n                    exception.message, M.util.get_string('ok', 'moodle'));\n            });\n            body.on('updated', '[data-inplaceeditable]', function(e) {\n                t.handleUpdated(e, this);\n            });\n            t.bindInplaceEditEvent();\n        },\n        /**\n         * If there is no row in table, bind core/inplace_editable to the page.\n         */\n        bindInplaceEditEvent: function() {\n            if ($('#qtype-pmatch-testquestion_r0').hasClass('emptyrow')) {\n                require(['core/inplace_editable']);\n            }\n        },\n        /**\n         * Handle updated inplace-editable data returned.\n         * @param {object} e the event handlers.\n         * @param {object} target the DOM element.\n         */\n        handleUpdated: function(e, target) {\n            var ajaxReturn = e.ajaxreturn;\n            if (ajaxReturn.value !== e.oldvalue) {\n                var jsonDecode = $.parseJSON(ajaxReturn.value);\n                var row = $(target).parent().parent();\n                var currentRow = row.attr('id');\n                var html = jsonDecode.html;\n                $(row).replaceWith(html.replace(t.REPLACESTRING, currentRow));\n                $('#testquestion_gradesummary').html(jsonDecode.summary);\n            }\n        },\n        update: function(id) {\n            var val = $('#updater-ef_' + id).text();\n            var ef = 0;\n            if (val === '1') {\n                ef = 0;\n            } else {\n                ef = 1;\n            }\n            // Send update.\n            var data = {qid: t.qid, rid: id, expectedfraction: ef, sesskey: t.sessKey};\n            $.post(t.baseUrl, data, function(result) {\n                if (result.status === 'success') {\n                    // Update the ui.\n                    $('#updater-ef_' + id).text(result.ef);\n                    $('#updater-ef_' + id).parent().prev().text(result.gf);\n                    var tr = $('#updater-ef_' + id).parent().parent();\n                    tr.removeClass();\n                    tr.addClass(result.rowclass);\n                    tr.find('td[class=\"c3\"]').text(result.gf);\n                    // Update the grade summary.\n                    var c = M.util.get_string('testquestionresultssummary', 'qtype_pmatch', result.counts);\n                    $('#testquestion_gradesummary').html(c);\n                } else {\n                    // Developer debugging - failure states are in api/updater.php.\n                    window.console.log(\n                        'Testquestion response updater has experienced an issue.\\n' + result.data);\n                    // If spinner is added - remove it here $('#updater-ef_' + id).text(val);.\n                }\n            });\n        }\n    };\n\n    return t;\n});\n"],"file":"updater.min.js"}