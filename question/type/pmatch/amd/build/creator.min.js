/**
 * This class provides functionality for the testquestion response creator.
 *
 * @module    qtype_pmatch
 * @class     creator
 * @copyright 2018 The Open University
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("qtype_pmatch/creator",["jquery","core/str","core/ajax","core/templates","core/key_codes","core/notification","core/checkbox-toggleall"],(function($,Str,Ajax,Templates,KeyCodes,Notification,CheckboxToggleAll){const t={newRowId:"",idxLastRow:0,questionId:"",init:function(){t.questionId=$('#attemptsform input[name="id"]').val(),t.table=$("#responses"),t.idxLastRow=t.table.find("tbody tr").length-1,t.disableControlButtonAndSelectionBox(),$("#newresponsebutton").click((function(e){e.preventDefault(),t.idxLastRow++,t.newRowId="qtype-pmatch-new-response_"+t.idxLastRow,Templates.render("qtype_pmatch/newresponse",{newrowid:t.newRowId}).then((function(html){return t.table.append(html),$("html, body").animate({scrollTop:$("#"+t.newRowId).offset().top},800),$(".new-expectedfraction").focus(),null})).catch(Notification.exception),t.disableControlButtons(!0)}));let timeoutCheckResponse=null;$(document).on("keyup paste",".new-response",(function(){const response=$(this).val().trim();timeoutCheckResponse&&(M.util.js_complete("checkresponse"),clearTimeout(timeoutCheckResponse)),M.util.js_pending("checkresponse"),timeoutCheckResponse=setTimeout((function(){""===response?t.handleSaveNewResponseButton(!1,""):t.checkResponse(response),M.util.js_complete("checkresponse")}),500)})),$(document).on("keydown",".new-response",(function(e){return e.keyCode!==KeyCodes.enter||(t.saveNewResponse(),!1)})),$(document).on("keydown",".new-expectedfraction, .new-response, .savenewresponse, .cancelnewresponse",(function(e){e.keyCode===KeyCodes.escape&&t.cancelNewResponse()})),$(document).on("click",".savenewresponse",(function(){return t.saveNewResponse()})),$(document).on("click",".cancelnewresponse",(function(){t.cancelNewResponse()}))},saveNewResponse:function(){const response=$(".new-response").val().trim();if(""!==response){const mark=$(".new-expectedfraction").is(":checked")?1:0;Ajax.call([{methodname:"qtype_pmatch_create_response",args:{questionid:t.questionId,expectedfraction:mark,response:response,curentrow:t.idxLastRow}}],!0)[0].then((function(result){if("error"===result.status)t.handleSaveNewResponseButton(!1,result.message);else{t.disableControlButtons(!1),$("#"+t.newRowId).detach(),t.table.append($(result.html));const resultssummary=M.util.get_string("testquestionresultssummary","qtype_pmatch",result.counts);$("#testquestion_gradesummary").html(resultssummary)}return null})).catch((function(response){t.handleSaveNewResponseButton(!1,response.message)})),t.disableControlButtonAndSelectionBox(),t.resetFormState()}},cancelNewResponse:function(){$("#"+t.newRowId).remove(),t.disableControlButtons(!1),t.disableControlButtonAndSelectionBox(),t.resetFormState(),t.idxLastRow--},checkResponse:function(response){Ajax.call([{methodname:"qtype_pmatch_check_response",args:{questionid:t.questionId,response:response}}],!0)[0].then((function(result){let isCorrectResponse=!1;return"success"===result.status&&(result.message="",isCorrectResponse=!0),t.handleSaveNewResponseButton(isCorrectResponse,result.message),null})).catch((function(response){t.handleSaveNewResponseButton(!1,response.message)}))},handleSaveNewResponseButton:function(isCorrectResponse,message){isCorrectResponse?$(".savenewresponse").removeAttr("disabled"):$(".savenewresponse").attr("disabled","true"),$(".response.error").html(message)},disableControlButtons:function(disable){disable?($("#newresponsebutton").attr("disabled","true"),$("#uploadbutton").attr("disabled","true"),$("#deleteresponsesbutton").attr("disabled","true"),$("#testresponsesbutton").attr("disabled","true")):($("#newresponsebutton").removeAttr("disabled"),$("#uploadbutton").removeAttr("disabled"),CheckboxToggleAll.updateSlavesFromMasterState($(document.body),"responses"))},resetFormState:function(){M.core_formchangechecker.reset_form_dirty_state()},disableControlButtonAndSelectionBox:function(){const checkbox=$("#tqheadercheckbox");$("#responses").find("tbody tr:not(.emptyrow)").length<=0?(checkbox.attr("disabled",!0),$("#deleteresponsesbutton").attr("disabled","true"),$("#testresponsesbutton").attr("disabled","true")):(checkbox.removeAttr("disabled"),CheckboxToggleAll.updateSlavesFromMasterState($(document.body),"responses"))}};return t}));

//# sourceMappingURL=creator.min.js.map