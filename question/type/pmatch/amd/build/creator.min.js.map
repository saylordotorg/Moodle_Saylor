{"version":3,"sources":["../src/creator.js"],"names":["define","$","Str","Ajax","Templates","KeyCodes","t","newRowId","idxLastRow","questionId","init","val","table","find","length","disableControlButtonAndSelectionBox","click","e","preventDefault","render","newrowid","done","html","append","animate","scrollTop","offset","top","focus","M","core_formchangechecker","set_form_changed","disableControlButtons","timeoutCheckResponse","document","on","response","trim","util","js_complete","clearTimeout","js_pending","setTimeout","handleSaveNewResponseButton","checkResponse","keyCode","enter","saveNewResponse","escape","cancelNewResponse","mark","is","promises","call","methodname","args","questionid","expectedfraction","curentrow","result","status","message","detach","resultssummary","get_string","counts","fail","resetFormState","remove","isCorrectResponse","removeAttr","attr","disable","get_form_dirty_state","reset_form_dirty_state","checkbox"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle. If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This class provides functionality for the testquestion response creator.\n *\n * @module    qtype_pmatch\n * @class     creator\n * @package   question\n * @copyright 2018 The Open University\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/str', 'core/ajax', 'core/templates', 'core/key_codes'], function($, Str, Ajax, Templates, KeyCodes) {\n    /**\n     * @alias qtype_pmatch/creator\n     */\n    var t = {\n        /**\n         * The id of row will append to Table Response.\n         */\n        newRowId: '',\n        /**\n         * Index of last one in the Table Response.\n         */\n        idxLastRow: 0,\n        /**\n         * The Id of editing question.\n         */\n        questionId: '',\n        /**\n         * Initialise the creator.\n         */\n        init: function() {\n            t.questionId = $('#attemptsform input[name=\"id\"]').val();\n            t.table = $('#responses');\n            t.idxLastRow = t.table.find('tbody tr').length - 1;\n            t.disableControlButtonAndSelectionBox();\n            $('#newresponsebutton').click(function(e) {\n                e.preventDefault();\n                t.idxLastRow++;\n                t.newRowId = 'qtype-pmatch-new-response_' + t.idxLastRow;\n                Templates.render('qtype_pmatch/newresponse', {newrowid: t.newRowId})\n                    .done(function(html) {\n                        t.table.append(html);\n                        $('html, body').animate({\n                            scrollTop: $('#' + t.newRowId).offset().top\n                        }, 800);\n                        $('.new-expectedfraction').focus();\n                        M.core_formchangechecker.set_form_changed();\n                    });\n                t.disableControlButtons(true);\n            });\n\n            var timeoutCheckResponse = null;\n\n            // Check response when key up or paste content.\n            $(document).on('keyup paste', '.new-response', function() {\n                var response = $(this).val().trim();\n\n                if (timeoutCheckResponse) {\n                    M.util.js_complete('checkresponse');\n                    clearTimeout(timeoutCheckResponse);\n                }\n                M.util.js_pending('checkresponse');\n                timeoutCheckResponse = setTimeout(function() {\n                    if (response === '') {\n                        t.handleSaveNewResponseButton(false, '');\n                    } else {\n                        t.checkResponse(response);\n                    }\n                    M.util.js_complete('checkresponse');\n                }, 500);\n            });\n\n            $(document).on('keydown', '.new-response', function(e) {\n                if (e.keyCode == KeyCodes.enter) {\n                    t.saveNewResponse();\n                    return false;\n                }\n            });\n\n            $(document).on('keydown', '.new-expectedfraction, .new-response, .savenewresponse, .cancelnewresponse', function(e) {\n                if (e.keyCode == KeyCodes.escape) {\n                    t.cancelNewResponse();\n                }\n            });\n\n            $(document).on('click', '.savenewresponse', function() {\n                return t.saveNewResponse();\n            });\n            $(document).on('click', '.cancelnewresponse', function() {\n                t.cancelNewResponse();\n            });\n        },\n\n        /**\n         * Submit to save a new response.\n         */\n        saveNewResponse: function() {\n            var response = $('.new-response').val().trim();\n            if (response !== '') {\n                var mark = $('.new-expectedfraction').is(':checked') ? 1 : 0;\n                var promises = Ajax.call([{\n                    methodname: 'qtype_pmatch_create_response',\n                    args: {questionid: t.questionId, expectedfraction: mark, response: response, curentrow: t.idxLastRow}\n                }], true);\n                promises[0]\n                    .done(function(result) {\n                        if (result.status === 'error') {\n                            t.handleSaveNewResponseButton(false, result.message);\n                        } else {\n                            t.disableControlButtons(false);\n                            $('#' + t.newRowId).detach();\n                            t.table.append($(result.html));\n                            var resultssummary = M.util.get_string('testquestionresultssummary', 'qtype_pmatch', result.counts);\n                            $('#testquestion_gradesummary').html(resultssummary);\n                        }\n                    })\n                    .fail(function(response) {\n                        t.handleSaveNewResponseButton(false, response.message);\n                    });\n                t.disableControlButtonAndSelectionBox();\n                t.resetFormState();\n            }\n        },\n\n        /**\n         * Cancel to input a new response.\n         */\n        cancelNewResponse: function() {\n            $('#' + t.newRowId).remove();\n            t.disableControlButtons(false);\n            t.disableControlButtonAndSelectionBox();\n            t.resetFormState();\n            t.idxLastRow--;\n        },\n\n        /**\n         * Function check correct a response.\n         *\n         * @method checkResponse\n         * @param {String} response The response to check.\n         */\n        checkResponse: function(response) {\n            var promises = Ajax.call([{\n                methodname: 'qtype_pmatch_check_response',\n                args: {questionid: t.questionId, response: response}\n            }], true);\n            promises[0]\n                .done(function(result) {\n                    var isCorrectResponse = false;\n                    if (result.status == 'success') {\n                        result.message = '';\n                        isCorrectResponse = true;\n                    }\n                    t.handleSaveNewResponseButton(isCorrectResponse, result.message);\n                })\n                .fail(function(response) {\n                    t.handleSaveNewResponseButton(false, response.message);\n                });\n        },\n\n        /**\n         * Disable or enable for save button when and update the error message.\n         *\n         * @method handleSaveNewResponseButton\n         * @param {Boolean} isCorrectResponse Response input is correct or not.\n         * @param {String} message The message for the error.\n         */\n        handleSaveNewResponseButton: function(isCorrectResponse, message) {\n            if (isCorrectResponse) {\n                $('.savenewresponse').removeAttr('disabled');\n            } else {\n                $('.savenewresponse').attr('disabled', 'true');\n            }\n            $('.response.error').html(message);\n        },\n\n        /**\n         * Function disable or enable the outside table buttons when create new response.\n         *\n         * @method disableControlButtons\n         * @param {Bool} disable true if disable else enable the buttons.\n         */\n        disableControlButtons: function(disable) {\n            if (disable) {\n                $('#newresponsebutton').attr('disabled', 'true');\n                $('#deleteresponsesbutton').attr('disabled', 'true');\n                $('#testresponsesbutton').attr('disabled', 'true');\n            } else {\n                $('#newresponsebutton').removeAttr('disabled');\n                $('#deleteresponsesbutton').removeAttr('disabled');\n                $('#testresponsesbutton').removeAttr('disabled');\n            }\n        },\n\n        /**\n         * Notify user when the form Add new response has changed.\n         */\n        resetFormState: function() {\n            if (M.core_formchangechecker.get_form_dirty_state()) {\n                M.core_formchangechecker.reset_form_dirty_state();\n            }\n        },\n\n        /**\n         * Function disable or enable selection box,delete response button,test response button.\n         *\n         * @method disableControlButtons\n         */\n        disableControlButtonAndSelectionBox: function() {\n            var checkbox = $('#tqheadercheckbox');\n            var table = $('#responses');\n            if (table.find('tbody tr:not(.emptyrow)').length <= 0) {\n                checkbox.attr('disabled', true);\n                $('#deleteresponsesbutton').attr('disabled', 'true');\n                $('#testresponsesbutton').attr('disabled', 'true');\n            } else {\n                checkbox.removeAttr('disabled');\n                $('#deleteresponsesbutton').removeAttr('disabled');\n                $('#testresponsesbutton').removeAttr('disabled');\n            }\n        }\n    };\n    return t;\n});\n"],"file":"creator.min.js"}