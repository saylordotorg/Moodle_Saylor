/**
 * JavaScript code for the gapfill question type.
 *
 * @copyright  2017 Marcus Green
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("qtype_gapfill/questionedit",["jquery","qtype_gapfill/Item"],(function($,Item){return{init:function(){$("#id_answerdisplay").change((function(){var selected=$(this).val();"gapfill"==selected&&($("#id_fixedgapsize").prop("disabled",!1),$("#id_optionsaftertext").prop("disabled",!0).prop("checked",!1),$("#id_singleuse").prop("disabled",!0).prop("checked",!1),$("#id_disableregex").prop("disabled",!1)),"dragdrop"==selected&&($("#id_optionsaftertext").prop("disabled",!1),$("#id_singleuse").prop("disabled",!1),$("#id_fixedgapsize").prop("disabled",!1),$("#id_disableregex").prop("disabled",!1)),"dropdown"==selected&&($("#id_fixedgapsize").prop("disabled",!0).prop("checked",!1),$("#id_optionsaftertext").prop("disabled",!0).prop("checked",!1),$("#id_singleuse").prop("disabled",!0).prop("checked",!1),$("#id_disableregex").prop("disabled",!0).prop("checked",!1))})),$("#id_itemsettings_button").on("click",(function(){if($(".editor_atto").length<1)return $("#id_error_itemsettings_button").css({display:"inline",color:"red"}),void($("#id_error_itemsettings_button")[0].innerHTML=M.util.get_string("itemsettingserror","qtype_gapfill"));if($("#questiontext .atto_html_button").attr("disabled","true"),$("#id_questiontexteditable").get(0).isContentEditable){$("#id_questiontexteditable").attr("contenteditable","false"),$("#fitem_id_questiontext").find("button").attr("disabled","true");var settingformheight=$("#id_questiontexteditable").css("height"),settingformwidth=$("#id_questiontexteditable").css("width");$("#id_questiontexteditable").css("display","none"),$("#id_itemsettings_canvas").css(function(source){var style,name,product={};if(source.length){var dom=source.get(0);if(window.getComputedStyle){var pattern=/-([a-z])/g,uc=function(a,b){return b.toUpperCase()},camelize=function(string){return string.replace(pattern,uc)};if(style=window.getComputedStyle(dom,null))for(var camel,value,i=0,l=style.length;i<l;i++)camel=camelize(name=style[i]),value=style.getPropertyValue(name),product[camel]=value;else if(style=dom.currentStyle)for(name in style)product[name]=style[name];else(style=dom.style)&&(product=function(style,product,name){for(name in style)"function"!=typeof style[name]&&(product[name]=style[name]);return product}(style,product,name));return product}}return!1}($("#id_questiontexteditable")));var ed=$("#id_questiontexteditable").closest(".editor_atto_content_wrap");$("#id_itemsettings_canvas").appendTo(ed).css("position","relative"),$("#id_itemsettings_canvas").css({display:"block",background:"lightgrey"}),$("#id_itemsettings_canvas").html($("#id_questiontexteditable").prop("innerHTML")),$("#id_itemsettings_canvas").css({height:settingformheight,width:settingformwidth}),$("#id_itemsettings_canvas").css({height:"100%",width:"100%"}),$("#id_itemsettings_button").html(M.util.get_string("editquestiontext","qtype_gapfill")),$("#id_itemsettings_canvas").height($("#id_questiontexteditable").height()),wrapContent($("#id_itemsettings_canvas")[0])}else $("#id_questiontexteditable").css({display:"block",backgroundColor:"white"}),$("#id_questiontexteditable").attr("contenteditable","true"),$("#id_itemsettings_canvas").css("display","none"),$("#fitem_id_questiontext").find("button").removeAttr("disabled"),$("#id_settings_popup").css("display","none"),$("#id_itemsettings_button").html(M.util.get_string("additemsettings","qtype_gapfill")),$("[class^=atto_]").removeAttr("disabled")})),$("#id_itemsettings_canvas").on("click",(function(e){if(!$("#id_questiontexteditable").get(0).isContentEditable&&e.target.id.match(/^id[0-9]+_/)){var delimitchars=$("#id_delimitchars").val(),item=new Item(e.target.innerHTML,delimitchars),itemsettings=item.getItemSettings(e.target);null===itemsettings||0===itemsettings.length?($("#id_correcteditable").html(""),$("#id_incorrecteditable").html("")):($("#id_correcteditable").html(itemsettings.correctfeedback),$("#id_incorrecteditable").html(itemsettings.incorrectfeedback)),$("label[for*='id_correct']").text(M.util.get_string("correct","qtype_gapfill")),$("label[for*='id_incorrect']").text(M.util.get_string("incorrect","qtype_gapfill")),$("#id_itemsettings_popup .atto_image_button").attr("disabled","true"),$("#id_itemsettings_popup .atto_media_button").attr("disabled","true"),$("#id_itemsettings_popup .atto_managefiles_button").attr("disabled","true");var title=M.util.get_string("additemsettings","qtype_gapfill");title+=": "+$("<div/>").html(item.stripdelim()).text(),require(["jquery","jqueryui"],(function($){$("#id_itemsettings_popup").dialog({position:{my:"right",at:"right",of:"#id_itemsettings_canvas"},height:500,width:"70%",modal:!1,title:title,buttons:[{text:"OK",id:"SaveItemFeedback",click:function(){var JSONstr=item.updateJson(e);$("[class^=atto_]").removeAttr("disabled"),$("[name='itemsettings']").val(JSONstr),$(".ui-dialog-content").dialog("close"),$("#id_questiontexteditable").attr("contenteditable","true"),$("#id_itemsettings_button").click()}}]})}))}}));var wrapContent=function(el){var node,frag,text,count=0,gaps=[],nodes=function(obj){for(var arr=[],i=0,iLen=obj.length;i<iLen;i++)arr.push(obj[i]);return arr}((el=el&&el.parentNode?el:document.body).childNodes);"id_questiontextfeedback"===el.id&&count>0&&(count=0);for(var sp,delimitchars=$("#id_delimitchars").val(),l=delimitchars.substring(0,1),r=delimitchars.substring(1,2),regex=new RegExp("(\\"+l+".*?\\"+r+")","g"),span=document.createElement("span"),skip={script:"",button:"",input:"",select:"",textarea:"",option:""},i=0,iLen=nodes.length;i<iLen;i++)if(1!==(node=nodes[i]).nodeType||node.tagName.toLowerCase()in skip){if(3===node.nodeType){var textsplit=new RegExp("(\\"+l+".*?\\"+r+")","g");if(text=node.data.split(textsplit)){frag=document.createDocumentFragment();for(var j=0,jLen=text.length;j<jLen;j++)doGap(text,span,j)}node.parentNode.replaceChild(frag,node)}}else wrapContent(node);function doGap(text,span,j){if(gaps=[],regex.test(text[j])){sp=span.cloneNode(!1),count++,sp.className="item";var item=new Item(text[j],$("#id_delimitchars").val());if(item.gaptext>""){for(var instance=0,k=0;k<gaps.length;++k)gaps[k]===item.text&&instance++;item.id="id"+count+"_"+instance,sp.id=item.id;var is=item.getItemSettings(item);item.striptags(is.correctfeedback)>""&&(sp.className="hascorrect"),item.striptags(is.incorrectfeedback)>""&&(sp.className=sp.className+" hasnocorrect"),gaps.push(item.gaptext)}sp.appendChild(document.createTextNode(text[j])),frag.appendChild(sp)}else frag.appendChild(document.createTextNode(text[j]))}}}}}));

//# sourceMappingURL=questionedit.min.js.map