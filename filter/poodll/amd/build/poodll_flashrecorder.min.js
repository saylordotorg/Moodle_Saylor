define(["jquery","core/log","filter_poodll/utils_amd","filter_poodll/uploader","filter_poodll/lzloader"],function(a,b,c,d,e){"use strict";return b.debug("PoodLL Flash Recorder: initialising"),{instanceprops:[],fetch_instance_props:function(a){return this.instanceprops[a]},init_instance_props:function(a){var b={};b.savebutton=null,b.audiodatacontrol=null,b.config=null,b.uploader=null,this.instanceprops[a]=b},supports_current_browser:function(a){var d=c.is_ios(),e=c.is_android();return!(d||!a.flashonandroid&&e)&&("audio"==a.mediatype&&(b.debug("PoodLL Flash Recorder: supports this browser"),!0))},embed:function(b,f){1==f.flashmp3_cloudbypass&&(f.posturl=f.cloudbypassurl,f.filename=!1,f.s3filename=!1,f.using_s3=!1),this.init_instance_props(f.widgetid);var g=this.fetch_instance_props(f.widgetid);g.ie=c.is_ie(),g.ie&&(f.flashmp3audio_widgetjson=f.flashmp3audio_widgetjson.replace("sendmethod=post","sendmethod=ajax")),g.config=f;var h=a.parseJSON(f.flashmp3audio_widgetjson);e.embed.swf(h);var i="";g.ie&&(i=' style="display: none" ');var j=f.widgetid+"_savebutton",k='<button id="'+j+'" type="button" class="poodll_save-recording"'+i+">"+M.util.get_string("recui_save","filter_poodll")+"</button>";a(b).append(k);var l=f.widgetid+"_adc",m='<input type="hidden" name="audiodatacontrol" id="'+l+'" value="" />';a(b).prepend(m),g.uploader=d.clone(),g.uploader.init(b,f),e.embed[f.widgetid].setCanvasAttribute("audiodatacontrol",l),g.savebutton=a("#"+j),g.audiodatacontrol=a("#"+l),this.registerevents(f.widgetid)},registerevents:function(a){var b=this.fetch_instance_props(a);b.audioblob=!1,b.savebutton.click(function(){var a=atob(b.audiodatacontrol.val()),c=a&&a.length>0;if(!c&&!b.audioblob)return b.uploader.Output(M.util.get_string("recui_nothingtosaveerror","filter_poodll")),!1;if(!b.audioblob&&c){for(var d=[],f=0;f<a.length;f++)d.push(a.charCodeAt(f));b.audioblob=new Blob([new Uint8Array(d)],{type:"audio/mpeg3"})}b.uploader.uploadBlob(b.audioblob,"audio/mpeg3");var g="poodllapi.mp3_disable()";return e.embed[b.config.widgetid].callMethod(g),b.audiodatacontrol.val(""),!1})}}});