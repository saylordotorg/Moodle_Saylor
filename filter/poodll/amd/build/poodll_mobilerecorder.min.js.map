{"version":3,"sources":["../src/poodll_mobilerecorder.js"],"names":["define","$","log","utils","uploader","uploadrec","debug","instanceprops","fetch_instance_props","widgetid","init_instance_props","config","linkid","supports_current_browser","mediatype","supports","is_ios","embed","element","ip","clone","init","insert_upload_button","showmobile","insert_audio_button","insert_video_button","register_events","mobilerecorder","on","confirm_s3_arrival","Output","M","util","get_string","empty","controls","encodeURIComponent","quicktimesignedurl","mobilequality","mobilecamera","timelimit","prepend","posturl","xhr","XMLHttpRequest","wwwroot","params","filename","open","setRequestHeader","length","addEventListener","response","indexOf","pokeFilename","postprocess_s3_upload","doCallback","setTimeout","send"],"mappings":"AACAA,OAAM,uCAAC,CAAC,QAAD,CAAW,UAAX,CAAuB,yBAAvB,CAAkD,wBAAlD,CAA4E,qCAA5E,CAAD,CAAsH,SAAUC,CAAV,CAAaC,CAAb,CAAkBC,CAAlB,CAAyBC,CAAzB,CAAmCC,CAAnC,CAA8C,CAEtK,aAEAH,CAAG,CAACI,KAAJ,CAAU,sCAAV,EAEA,MAAO,CAEHC,aAAa,CAAE,EAFZ,CAIHC,oBAAoB,CAAE,8BAAUC,CAAV,CAAoB,CACtC,MAAO,MAAKF,aAAL,CAAmBE,CAAnB,CACV,CANE,CAQHC,mBAAmB,CAAE,6BAAUD,CAAV,CAAoB,CAKrC,KAAKF,aAAL,CAAmBE,CAAnB,EAJY,CACNE,MADM,CACG,IADH,CAENP,QAFM,CAEK,IAFL,CAGNQ,MAHM,CAGG,IAHH,CAKf,CAdE,CAiBHC,wBAAwB,CAAE,kCAAUF,CAAV,CAAkB,CACxC,GAAwB,OAApB,EAAAA,CAAM,CAACG,SAAP,EAAmD,OAApB,EAAAH,CAAM,CAACG,SAA1C,CAAgE,CAC5D,QACH,CACD,GAAIC,CAAAA,CAAQ,CAAGZ,CAAK,CAACa,MAAN,EAAf,CACA,MAAOD,CAAAA,CACV,CAvBE,CA2BHE,KAAK,CAAE,eAAUC,CAAV,CAAmBP,CAAnB,CAA2B,CAC9B,KAAKD,mBAAL,CAAyBC,CAAM,CAACF,QAAhC,EACA,GAAIU,CAAAA,CAAE,CAAG,KAAKX,oBAAL,CAA0BG,CAAM,CAACF,QAAjC,CAAT,CAEAU,CAAE,CAACR,MAAH,CAAYA,CAAZ,CAGAQ,CAAE,CAACf,QAAH,CAAcA,CAAQ,CAACgB,KAAT,EAAd,CACAD,CAAE,CAACf,QAAH,CAAYiB,IAAZ,CAAiBH,CAAjB,CAA0BP,CAA1B,EAEAQ,CAAE,CAACP,MAAH,CAAY,qCAAuCD,CAAM,CAACF,QAA1D,CACA,OAAQE,CAAM,CAACG,SAAf,EACI,IAAK,OAAL,CACI,KAAKQ,oBAAL,CAA0BJ,CAA1B,CAAmCP,CAAM,CAACF,QAA1C,EACA,GAAyB,CAArB,EAAAE,CAAM,CAACY,UAAX,CAA4B,CACxB,KAAKC,mBAAL,CAAyBN,CAAzB,CAAkCP,CAAM,CAACF,QAAzC,CACH,CACD,MACJ,IAAK,OAAL,CACI,KAAKa,oBAAL,CAA0BJ,CAA1B,CAAmCP,CAAM,CAACF,QAA1C,EACA,GAAyB,CAArB,EAAAE,CAAM,CAACY,UAAX,CAA4B,CACxB,KAAKE,mBAAL,CAAyBP,CAAzB,CAAkCP,CAAM,CAACF,QAAzC,CACH,CACD,MAZR,CAgBA,KAAKiB,eAAL,CAAqBR,CAArB,CAA8BP,CAAM,CAACF,QAArC,EACA,QACH,CAxDE,CA2DHiB,eAAe,CAAE,yBAAUR,CAAV,CAAmBT,CAAnB,CAA6B,IACtCU,CAAAA,CAAE,CAAG,KAAKX,oBAAL,CAA0BC,CAA1B,CADiC,CAEtCE,CAAM,CAAGQ,CAAE,CAACR,MAF0B,CAGtCgB,CAAc,CAAG,IAHqB,CAK1C1B,CAAC,CAAC,IAAMkB,CAAE,CAACP,MAAV,CAAD,CAAmBgB,EAAnB,CAAsB,sBAAtB,CAA8C,UAAa,CAKnDD,CAAc,CAACE,kBAAf,CAAkCpB,CAAlC,EAEAU,CAAE,CAACf,QAAH,CAAY0B,MAAZ,CAAmBC,CAAC,CAACC,IAAF,CAAOC,UAAP,CAAkB,4BAAlB,CAAgD,eAAhD,CAAnB,CASH,CAhBL,EAmBAhC,CAAC,CAAC,IAAMkB,CAAE,CAACP,MAAT,CAAkB,cAAnB,CAAD,CAAoCgB,EAApC,CAAuC,sBAAvC,CAA+D,UAAa,CACpE3B,CAAC,CAACiB,CAAD,CAAD,CAAWgB,KAAX,GACA7B,CAAS,CAACY,KAAV,CAAgBC,CAAhB,CAAyBP,CAAzB,CACH,CAHL,CAKH,CAxFE,CA0FHc,mBAAmB,CAAE,6BAAUP,CAAV,CAAmBT,CAAnB,CAA6B,IAC1CU,CAAAA,CAAE,CAAG,KAAKX,oBAAL,CAA0BC,CAA1B,CADqC,CAE1C0B,CAAQ,CAAG,uDAAsDhB,CAAE,CAACP,MAAzD,CACX,2CADW,CACiCwB,kBAAkB,CAACjB,CAAE,CAACR,MAAH,CAAU0B,kBAAX,CADnD,CAEX,QAFW,CAEAlB,CAAE,CAACR,MAAH,CAAUG,SAFV,CAEsB,WAFtB,CAEoCK,CAAE,CAACR,MAAH,CAAU2B,aAF9C,CAGX,UAHW,CAGEnB,CAAE,CAACR,MAAH,CAAU4B,YAHZ,CAIX,aAJW,CAIKpB,CAAE,CAACR,MAAH,CAAU6B,SAJf,CAI2B,KAJ3B,CAKXT,CAAC,CAACC,IAAF,CAAOC,UAAP,CAAkB,uBAAlB,CAA2C,eAA3C,CALW,CAKmD,MAPpB,CAQ9ChC,CAAC,CAACiB,CAAD,CAAD,CAAWuB,OAAX,CAAmBN,CAAnB,CACH,CAnGE,CAoGHX,mBAAmB,CAAE,6BAAUN,CAAV,CAAmBT,CAAnB,CAA6B,IAC1CU,CAAAA,CAAE,CAAG,KAAKX,oBAAL,CAA0BC,CAA1B,CADqC,CAE1C0B,CAAQ,CAAG,wDAAuDhB,CAAE,CAACP,MAA1D,CACX,2CADW,CACiCwB,kBAAkB,CAACjB,CAAE,CAACR,MAAH,CAAU+B,OAAX,CADnD,CAEX,QAFW,CAEAvB,CAAE,CAACR,MAAH,CAAUG,SAFV,CAEsB,WAFtB,CAEoCK,CAAE,CAACR,MAAH,CAAU2B,aAF9C,CAGX,UAHW,CAGEnB,CAAE,CAACR,MAAH,CAAU4B,YAHZ,CAIX,aAJW,CAIKpB,CAAE,CAACR,MAAH,CAAU6B,SAJf,CAI2B,KAJ3B,CAKXT,CAAC,CAACC,IAAF,CAAOC,UAAP,CAAkB,uBAAlB,CAA2C,eAA3C,CALW,CAKmD,MAPpB,CAQ9ChC,CAAC,CAACiB,CAAD,CAAD,CAAWuB,OAAX,CAAmBN,CAAnB,CACH,CA7GE,CA+GHb,oBAAoB,CAAE,8BAAUJ,CAAV,CAAmBT,CAAnB,CAA6B,IAC3CU,CAAAA,CAAE,CAAG,KAAKX,oBAAL,CAA0BC,CAA1B,CADsC,CAE3C0B,CAAQ,CAAG,oDAAmDhB,CAAE,CAACP,MAAtD,8BAEXmB,CAAC,CAACC,IAAF,CAAOC,UAAP,CAAkB,mBAAlB,CAAuC,eAAvC,CAFW,CAE+C,MAJf,CAK/ChC,CAAC,CAACiB,CAAD,CAAD,CAAWuB,OAAX,CAAmBN,CAAnB,CACH,CArHE,CAuHHN,kBAAkB,CAAE,4BAAUpB,CAAV,CAAoB,IAChCU,CAAAA,CAAE,CAAG,KAAKX,oBAAL,CAA0BC,CAA1B,CAD2B,CAEhCkC,CAAG,CAAG,GAAIC,CAAAA,cAFsB,CAGhCjC,CAAM,CAAGQ,CAAE,CAACR,MAHoB,CAMhC+B,CAAO,CAAG/B,CAAM,CAACkC,OAAP,CAAiB,kCANK,CAOhCC,CAAM,CAAG,yBAPuB,CAQpCA,CAAM,EAAI,cAAgBnC,CAAM,CAACG,SAAjC,CACAgC,CAAM,EAAI,aAAenC,CAAM,CAACoC,QAAhC,CACAJ,CAAG,CAACK,IAAJ,CAAS,MAAT,CAAiBN,CAAjB,KACAC,CAAG,CAACM,gBAAJ,CAAqB,cAArB,CAAqC,mCAArC,EACAN,CAAG,CAACM,gBAAJ,CAAqB,eAArB,CAAsC,UAAtC,EACAN,CAAG,CAACM,gBAAJ,CAAqB,gBAArB,CAAuCH,CAAM,CAACI,MAA9C,EACAP,CAAG,CAACM,gBAAJ,CAAqB,YAArB,CAAmC,OAAnC,EAEAN,CAAG,CAACQ,gBAAJ,CAAqB,MAArB,CAA6B,UAAY,CACrC,GAAIR,CAAG,CAACS,QAAJ,EAAwD,CAAxC,CAAAT,CAAG,CAACS,QAAJ,CAAaC,OAAb,CAAqB1C,CAAM,CAACoC,QAA5B,CAApB,CAA+D,CAC3D5B,CAAE,CAACf,QAAH,CAAYkD,YAAZ,CAAyB3C,CAAM,CAACoC,QAAhC,CAA0C5B,CAAE,CAACf,QAA7C,EACAe,CAAE,CAACf,QAAH,CAAYmD,qBAAZ,CAAkCpC,CAAE,CAACf,QAArC,EACAe,CAAE,CAACf,QAAH,CAAY0B,MAAZ,CAAmBC,CAAC,CAACC,IAAF,CAAOC,UAAP,CAAkB,qBAAlB,CAAyC,eAAzC,CAAnB,EACAd,CAAE,CAACf,QAAH,CAAYoD,UAAZ,CAAuBrC,CAAE,CAACf,QAA1B,CAAoCO,CAAM,CAACoC,QAA3C,CACH,CALD,IAKO,CAEHU,UAAU,CAAC,UAAY,CACnBd,CAAG,CAACK,IAAJ,CAAS,MAAT,CAAiBN,CAAjB,KACAC,CAAG,CAACM,gBAAJ,CAAqB,cAArB,CAAqC,mCAArC,EACAN,CAAG,CAACM,gBAAJ,CAAqB,eAArB,CAAsC,UAAtC,EACAN,CAAG,CAACM,gBAAJ,CAAqB,gBAArB,CAAuCH,CAAM,CAACI,MAA9C,EACAP,CAAG,CAACM,gBAAJ,CAAqB,YAArB,CAAmC,OAAnC,EACAN,CAAG,CAACe,IAAJ,CAASZ,CAAT,CACH,CAPS,CAOP,GAPO,CAQb,CACJ,CAjBD,EAmBAH,CAAG,CAACe,IAAJ,CAASZ,CAAT,CACH,CA3JE,CA6JV,CAnKK,CAAN","sourcesContent":["/* jshint ignore:start */\ndefine(['jquery', 'core/log', 'filter_poodll/utils_amd', 'filter_poodll/uploader', 'filter_poodll/poodll_uploadrecorder',], function ($, log, utils, uploader, uploadrec) {\n\n    \"use strict\"; // jshint ;_;\n\n    log.debug('PoodLL Mobile Recorder: initialising');\n\n    return {\n\n        instanceprops: [],\n\n        fetch_instance_props: function (widgetid) {\n            return this.instanceprops[widgetid];\n        },\n\n        init_instance_props: function (widgetid) {\n            var props = {};\n            props.config = null;\n            props.uploader = null;\n            props.linkid = null;\n            this.instanceprops[widgetid] = props\n        },\n\n        // This recorder supports the current browser\n        supports_current_browser: function (config) {\n            if (config.mediatype != 'audio' && config.mediatype != 'video') {\n                return false;\n            }\n            var supports = utils.is_ios();\n            return supports;//or false\n        },\n\n        // Perform the embed of this recorder on the page\n        //into the element passed in. with config\n        embed: function (element, config) {\n            this.init_instance_props(config.widgetid);\n            var ip = this.fetch_instance_props(config.widgetid);\n            //set config\n            ip.config = config;\n\n            //set uploader\n            ip.uploader = uploader.clone();\n            ip.uploader.init(element, config);\n\n            ip.linkid = 'filter_poodll_mobilerecorder_link_' + config.widgetid;\n            switch (config.mediatype) {\n                case 'audio':\n                    this.insert_upload_button(element, config.widgetid);\n                    if (config.showmobile == 1) {\n                        this.insert_audio_button(element, config.widgetid);\n                    }\n                    break;\n                case 'video':\n                    this.insert_upload_button(element, config.widgetid);\n                    if (config.showmobile == 1) {\n                        this.insert_video_button(element, config.widgetid);\n                    }\n                    break;\n\n            }\n\n            this.register_events(element, config.widgetid);\n            return true;//or false\n        },\n\n        // handle audio/video/image file uploads for Mobile\n        register_events: function (element, widgetid) {\n            var ip = this.fetch_instance_props(widgetid);\n            var config = ip.config;\n            var mobilerecorder = this;\n            //launch the app from the link\n            $('#' + ip.linkid).on('mousedown touchstart', function (e) {\n                    //to make sure both \"confirm\" and \"openapp\"\n                    //happened. I had to do this\n                    // e.preventDefault();\n                    //  e.stopPropagation();\n                    mobilerecorder.confirm_s3_arrival(widgetid);\n                    // window.location=$(this).attr('href');\n                    ip.uploader.Output(M.util.get_string('recui_awaitingconfirmation', 'filter_poodll'));\n                    return;\n\n                    //but I wanted to just do this\n                    /*\n                    mobilerecorder.confirm_s3_arrival();\n                    uploader.Output(\"awaiting confirmation\");\n                    return true;\n                    */\n                }\n            );\n            //launch the upload dialog (if no app or whatever)\n            $('#' + ip.linkid + '_uploadafile').on('mousedown touchstart', function (e) {\n                    $(element).empty();\n                    uploadrec.embed(element, config);\n                }\n            );\n        },\n\n        insert_video_button: function (element, widgetid) {\n            var ip = this.fetch_instance_props(widgetid);\n            var controls = '<a class =\"filter_poodll_mobilerecorderlink\" id=\"' + ip.linkid +\n                '\" href=\"poodllrecorder://?presignedurl=' + encodeURIComponent(ip.config.quicktimesignedurl) +\n                '&type=' + ip.config.mediatype + '&quality=' + ip.config.mobilequality +\n                '&camera=' + ip.config.mobilecamera +\n                '&timelimit=' + ip.config.timelimit + '\">' +\n                M.util.get_string('recui_openrecorderapp', 'filter_poodll') + '</a>';\n            $(element).prepend(controls);\n        },\n        insert_audio_button: function (element, widgetid) {\n            var ip = this.fetch_instance_props(widgetid);\n            var controls = '<a class =\"filter_poodll_mobilerecorderlink\"  id=\"' + ip.linkid +\n                '\" href=\"poodllrecorder://?presignedurl=' + encodeURIComponent(ip.config.posturl) +\n                '&type=' + ip.config.mediatype + '&quality=' + ip.config.mobilequality +\n                '&camera=' + ip.config.mobilecamera +\n                '&timelimit=' + ip.config.timelimit + '\">' +\n                M.util.get_string('recui_openrecorderapp', 'filter_poodll') + '</a>';\n            $(element).prepend(controls);\n        },\n\n        insert_upload_button: function (element, widgetid) {\n            var ip = this.fetch_instance_props(widgetid);\n            var controls = '<a class =\"filter_poodll_uploadafilelink\" id=\"' + ip.linkid + '_uploadafile' +\n                '\" href=\"#\">' +\n                M.util.get_string('recui_uploadafile', 'filter_poodll') + '</a>';\n            $(element).prepend(controls);\n        },\n\n        confirm_s3_arrival: function (widgetid) {\n            var ip = this.fetch_instance_props(widgetid);\n            var xhr = new XMLHttpRequest();\n            var config = ip.config;\n\n\n            var posturl = config.wwwroot + '/filter/poodll/poodllfilelib.php';\n            var params = \"datatype=confirmarrival\";\n            params += \"&mediatype=\" + config.mediatype;\n            params += \"&filename=\" + config.filename;\n            xhr.open(\"POST\", posturl, true);\n            xhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\n            xhr.setRequestHeader(\"Cache-Control\", \"no-cache\");\n            xhr.setRequestHeader(\"Content-length\", params.length);\n            xhr.setRequestHeader(\"Connection\", \"close\");\n\n            xhr.addEventListener(\"load\", function () {\n                if (xhr.response && xhr.response.indexOf(config.filename) > 0) {\n                    ip.uploader.pokeFilename(config.filename, ip.uploader);\n                    ip.uploader.postprocess_s3_upload(ip.uploader);\n                    ip.uploader.Output(M.util.get_string('recui_uploadsuccess', 'filter_poodll'));\n                    ip.uploader.doCallback(ip.uploader, config.filename);\n                } else {\n                    // setTimeout(mobilerecorder.confirm_s3_arrival,2000);\n                    setTimeout(function () {\n                        xhr.open(\"POST\", posturl, true);\n                        xhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\n                        xhr.setRequestHeader(\"Cache-Control\", \"no-cache\");\n                        xhr.setRequestHeader(\"Content-length\", params.length);\n                        xhr.setRequestHeader(\"Connection\", \"close\");\n                        xhr.send(params);\n                    }, 2000);\n                }\n            });\n\n            xhr.send(params);\n        }\n    }//end of returned object\n});//total end\n"],"file":"poodll_mobilerecorder.min.js"}