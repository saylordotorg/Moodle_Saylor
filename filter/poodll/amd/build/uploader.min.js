define(["jquery","core/log","filter_poodll/upskin_plain"],(function($,log,upskin_plain){return log.debug("Universal Uploader: initialising"),{config:null,clone:function(){return $.extend(!0,{},this)},init:function(element,config,upskin){this.config=config,upskin?this.upskin=upskin:(this.upskin=upskin_plain.clone(),this.upskin.init(config,element,!1,!1)),this.upskin.initControls(),this.registerEvents()},registerEvents:function(){var that=this;this.config.hermes&&this.config.hermes.on("fetch_upload_url",(function(e){that.fetchNewUploadDetails()}))},fetchNewUploadDetails:function(){var xhr=new XMLHttpRequest,that=this;xhr.onreadystatechange=function(e){if(4===this.readyState)if(200==xhr.status){var payload=xhr.responseText,payloadobject=JSON.parse(payload);if(payloadobject){if(payloadobject.returnCode>0){var messageObject={};return messageObject.id=that.config.id,messageObject.type="error",messageObject.code=payloadobject.returnCode,messageObject.message=payloadobject.returnMessage,void that.config.hermes.postMessage(messageObject)}that.config.allowedURL=payloadobject.allowedURL,that.config.posturl=payloadobject.postURL,that.config.filename=payloadobject.filename,that.config.s3filename=payloadobject.s3filename,that.config.s3root=payloadobject.s3root,that.config.cloudfilename=payloadobject.shortfilename,that.config.cloudroot=payloadobject.shortroot}else log.debug("error:"+payloadobject.message)}else log.debug("Not 200 response:"+xhr.status)};var xhrparams="wstoken="+this.config.wstoken+"&wsfunction=local_cpapi_fetch_upload_details&moodlewsrestformat="+this.config.moodlewsrestformat+"&mediatype="+this.config.mediatype+"&parent="+this.config.parent+"&appid="+this.config.appid+"&owner="+this.config.owner+"&region="+this.config.region+"&expiredays="+this.config.expiredays+"&transcode="+this.config.transcode+"&transcoder="+this.config.transcoder+"&transcribe="+this.config.transcribe+"&subtitle="+this.config.subtitle+"&transcribelanguage="+this.config.language+"&transcribevocab="+this.config.transcribevocab+"&notificationurl="+this.config.notificationurl+"&sourcemimetype="+this.config.sourcemimetype,serverurl=M.cfg.wwwroot+"/webservice/rest/server.php";xhr.open("POST",serverurl,!0),xhr.setRequestHeader("Cache-Control","no-cache"),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.send(xhrparams)},uploadBlob:function(blob,filetype){this.uploadFile(blob,filetype)},extractFilename:function(returntext){var start=returntext.indexOf("success<filename>");if(start<1)return!1;var end=returntext.indexOf("</filename>");return returntext.substring(start+"success<filename>".length,end)},fetchFileExtension:function(filetype){var ext="";switch(filetype.indexOf(";")>0&&(filetype=filetype.split(";")[0]),filetype){case"image/jpeg":ext="jpg";break;case"image/png":ext="png";break;case"audio/wav":ext="wav";break;case"audio/ogg":case"video/ogg":ext="ogg";break;case"audio/mpeg3":case"audio/mp3":case"audio/x-mpeg-3":ext="mp3";break;case"audio/webm":case"video/x-matroska":case"video/webm":ext="webm";break;case"audio/wma":ext="wma";break;case"audio/mp4":case"audio/m4a":case"audio/x-m4a":ext="m4a";break;case"audio/3gpp":case"video/mpeg3":ext="3gpp";break;case"video/m4v":ext="m4v";break;case"video/mp4":ext="mp4";break;case"video/mov":case"video/quicktime":ext="mov";break;case"video/wmv":ext="wmv"}return""===ext&&(ext=filetype.indexOf("video")>-1?"mp4":"mp3"),ext},pokeFilename:function(filename,uploader){var upc="";return void 0!==uploader.config.updatecontrol&&""!==uploader.config.updatecontrol&&(upc=$('[id="'+uploader.config.updatecontrol+'"]')),upc.length<1&&(upc=$('[id="'+uploader.config.updatecontrol+'"]',window.parent.document)),upc.length>0?(upc.get(0).value=filename,upc.trigger("change"),!0):(log.debug("upload failed #2"),uploader.upskin.showMessage(M.util.get_string("recui_uploaderror","filter_poodll"),"recui_uploaderror"),!1)},alertRecorderSuccess:function(widgetid){this.config.hasOwnProperty("onuploadsuccess")&&this.config.onuploadsuccess(widgetid)},alertRecorderFailure:function(widgetid){this.config.hasOwnProperty("onuploadfailure")&&this.config.onuploadfailure(widgetid)},completeAfterProcessing:function(uploader,filename,waitms){this.upskin.showMessage(M.util.get_string("recui_awaitingconversion","filter_poodll"),"recui_awaitingconversion"),uploader.config.iframeembed&&(filename=uploader.config.s3root+uploader.config.s3filename);var messageObject={type:"awaitingprocessing"};messageObject.mediaurl=filename,messageObject.mediafilename=uploader.config.s3filename,messageObject.sourcefilename=uploader.config.sourcefilename,messageObject.sourcemimetype=uploader.config.sourcemimetype,messageObject.s3root=uploader.config.s3root,messageObject.id=uploader.config.id,messageObject.updatecontrol=uploader.config.updatecontrol,uploader.config.transcribe&&(messageObject.transcripturl=filename+".txt",messageObject.transcriptfilename=uploader.config.s3filename+".txt"),uploader.config.hermes.postMessage(messageObject);var that=this;$.ajax({url:uploader.config.s3root+uploader.config.s3filename,method:"HEAD",cache:!1,error:function(){log.debug("403 errors are normal here, till the file arrives back from conversion"),setTimeout((function(){that.completeAfterProcessing(uploader,filename,waitms+500)}),waitms)},success:function(data,textStatus,xhr){if(200===xhr.status)that.doUploadCompleteCallback(uploader,filename);else setTimeout((function(){that.completeAfterProcessing(uploader,filename,waitms+500)}),waitms)}})},doUploadCompleteCallback:function(uploader,filename){uploader.config.iframeembed&&(filename=uploader.config.s3root+uploader.config.s3filename);var callbackObject=new Array;if(callbackObject[0]=uploader.config.widgetid,callbackObject[1]="filesubmitted",callbackObject[2]=filename,callbackObject[3]=uploader.config.updatecontrol,callbackObject[4]=uploader.config.s3filename,this.upskin.showMessage(M.util.get_string("recui_uploadsuccess","filter_poodll"),"recui_uploadsuccess"),uploader.config.iframeembed){var messageObject={type:"filesubmitted"};messageObject.mediaurl=uploader.config.s3root+uploader.config.s3filename,messageObject.mediafilename=uploader.config.s3filename,messageObject.sourcefilename=uploader.config.sourcefilename,messageObject.sourcemimetype=uploader.config.sourcemimetype,messageObject.s3root=uploader.config.s3root,messageObject.id=uploader.config.id,messageObject.updatecontrol=uploader.config.updatecontrol,uploader.config.transcribe&&(messageObject.transcripturl=uploader.config.s3root+uploader.config.s3filename+".txt",messageObject.transcriptfilename=uploader.config.s3filename+".txt"),uploader.config.hermes.postMessage(messageObject)}else uploader.config.callbackjs&&""!=uploader.config.callbackjs?"function"==typeof uploader.config.callbackjs?uploader.config.callbackjs(callbackObject):this.executeFunctionByName(uploader.config.callbackjs,window,callbackObject):uploader.pokeFilename(filename,uploader)},postProcessUpload:function(e,uploader){var xhr=e.currentTarget;if(4==xhr.readyState)if(uploader.upskin.deactivateProgressSession(),$(window).off("beforeunload",this.preventPrematureLeaving),200==xhr.status){var filename=uploader.config.filename;if(filename||(filename=uploader.extractFilename(xhr.responseText)),!filename)return log.debug("upload failed #1"),void log.debug(xhr);uploader.config.iframeembed?this.completeAfterProcessing(uploader,filename,1e3):this.doUploadCompleteCallback(uploader,filename),this.alertRecorderSuccess(uploader.config.widgetid)}else log.debug("upload failed #3"),log.debug(xhr),uploader.upskin.showMessage(M.util.get_string("recui_uploaderror","filter_poodll"),"recui_uploaderror"),this.alertRecorderFailure(uploader.config.widgetid)},preventPrematureLeaving:function(){return M.util.get_string("recui_waitwaitstilluploading","filter_poodll")},uploadFile:function(filedata,sourcemimetype){var xhr=new XMLHttpRequest,config=this.config,uploader=this,sourceext=this.fetchFileExtension(sourcemimetype);void 0===config.iframeembed&&(config.iframeembed=!1);var using_s3=config.using_s3;if(this.upskin.initProgressSession(xhr),$(window).on("beforeunload",this.preventPrematureLeaving),this.upskin.showMessage(M.util.get_string("recui_uploading","filter_poodll"),"recui_uploading"),uploader.config.sourcemimetype=sourcemimetype,uploader.config.sourcefilename=uploader.config.s3filename,xhr.onreadystatechange=function(e){using_s3&&4===this.readyState&&(config.iframeembed?uploader.update_filenames(uploader,sourceext):uploader.postprocess_s3_upload(uploader)),uploader.postProcessUpload(e,uploader)},using_s3)xhr.open("put",config.posturl,!0),xhr.setRequestHeader("Content-Type","application/octet-stream"),xhr.send(filedata);else if(filedata instanceof Blob){log.debug("filedata is blob");var reader=new window.FileReader;reader.readAsDataURL(filedata),reader.onloadend=function(){var base64filedata=reader.result,params="datatype=uploadfile";params+="&paramone="+encodeURIComponent(base64filedata),params+="&paramtwo="+sourceext,params+="&paramthree="+config.mediatype,params+="&requestid="+config.widgetid,params+="&contextid="+config.p2,params+="&component="+config.p3,params+="&filearea="+config.p4,params+="&itemid="+config.p5,xhr.open("POST",config.posturl,!0),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.setRequestHeader("Cache-Control","no-cache"),xhr.send(params)}}else{log.debug("filedata is not blob");var params="datatype=uploadfile";params+="&paramone="+encodeURIComponent(filedata),params+="&paramtwo="+sourceext,params+="&paramthree="+config.mediatype,params+="&requestid="+config.widgetid,params+="&contextid="+config.p2,params+="&component="+config.p3,params+="&filearea="+config.p4,params+="&itemid="+config.p5,xhr.open("POST",config.posturl,!0),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.setRequestHeader("Cache-Control","no-cache"),xhr.send(params)}},uploadMultiPartFile:function(filedata,sourcemimetype){var xhr=new XMLHttpRequest,config=this.config,uploader=this,sourceext=this.fetchFileExtension(sourcemimetype);void 0===config.iframeembed&&(config.iframeembed=!1);var using_s3=config.using_s3;this.upskin.initProgressSession(xhr),$(window).on("beforeunload",this.preventPrematureLeaving),this.upskin.showMessage(M.util.get_string("recui_uploading","filter_poodll"),"recui_uploading"),uploader.config.sourcemimetype=sourcemimetype,uploader.config.sourcefilename=uploader.config.s3filename,xhr.onreadystatechange=function(e){using_s3&&4===this.readyState&&(config.iframeembed?uploader.update_filenames(uploader,sourceext):uploader.postprocess_s3_upload(uploader)),uploader.postProcessUpload(e,uploader)},using_s3&&(xhr.open("put",config.posturl,!0),xhr.setRequestHeader("Content-Type","application/octet-stream"),xhr.send(filedata))},update_filenames:function(uploader,sourceext){var config=uploader.config;switch(config.mediatype){case"audio":uploader.config.sourcefilename=config.s3filename.replace(".mp3","."+sourceext),config.transcode||(uploader.config.s3filename=uploader.config.sourcefilename,uploader.config.cloudfilename=uploader.config.s3filename);break;case"video":uploader.config.sourcefilename=config.s3filename.replace(".mp4","."+sourceext),config.transcode||(uploader.config.s3filename=uploader.config.sourcefilename)}},postprocess_s3_upload:function(uploader){var config=uploader.config,formData=new FormData;formData.append("datatype","handles3upload"),formData.append("contextid",config.p2),formData.append("component",config.p3),formData.append("filearea",config.p4),formData.append("itemid",config.p5),formData.append("filename",config.filename),formData.append("mediatype",config.mediatype),navigator.sendBeacon||(navigator.sendBeacon=function(url,thedata){window.fetch(url,{method:"POST",body:thedata,credentials:"include"})}),navigator.sendBeacon(M.cfg.wwwroot+"/filter/poodll/poodllfilelib.php",formData)},executeFunctionByName:function(functionName,context,args){for(var namespaces=functionName.split("."),func=namespaces.pop(),i=0;i<namespaces.length;i++)context=context[namespaces[i]];return context[func].call(this,args)},dataURItoBlob:function(dataURI,mimetype){for(var byteString=atob(dataURI.split(",")[1]),ab=new ArrayBuffer(byteString.length),ia=new Uint8Array(ab),i=0;i<byteString.length;i++)ia[i]=byteString.charCodeAt(i);return new Blob([ab],{type:mimetype})},Output:function(msg){this.upskin.showMessage(msg,"recorderskinmsg")}}}));

//# sourceMappingURL=uploader.min.js.map