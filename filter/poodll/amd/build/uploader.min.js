define ("filter_poodll/uploader",["jquery","core/log","filter_poodll/upskin_plain"],function(a,b,c){"use strict";b.debug("Universal Uploader: initialising");return{config:null,clone:function clone(){return a.extend(!0,{},this)},init:function init(a,b,d){this.config=b;if(d){this.upskin=d}else{this.upskin=c.clone();this.upskin.init(b,a,!1,!1)}this.upskin.initControls();this.registerEvents()},registerEvents:function registerEvents(){var a=this;if(this.config.hermes){this.config.hermes.on("fetch_upload_url",function(){a.fetchNewUploadDetails()})}},fetchNewUploadDetails:function fetchNewUploadDetails(){var a=new XMLHttpRequest,c=this;a.onreadystatechange=function(){if(4===this.readyState){if(200==a.status){var d=a.responseText,e=JSON.parse(d);if(e){if(0<e.returnCode){var f={id:c.config.id,type:"error",code:e.returnCode,message:e.returnMessage};c.config.hermes.postMessage(f)}else{c.config.allowedURL=e.allowedURL;c.config.posturl=e.postURL;c.config.filename=e.filename;c.config.s3filename=e.s3filename;c.config.s3root=e.s3root;c.config.cloudfilename=e.shortfilename;c.config.cloudroot=e.shortroot}}else{b.debug("error:"+e.message)}}else{b.debug("Not 200 response:"+a.status)}}};var d="wstoken="+this.config.wstoken+"&wsfunction="+"local_cpapi_fetch_upload_details"+"&moodlewsrestformat="+this.config.moodlewsrestformat+"&mediatype="+this.config.mediatype+"&parent="+this.config.parent+"&appid="+this.config.appid+"&owner="+this.config.owner+"&region="+this.config.region+"&expiredays="+this.config.expiredays+"&transcode="+this.config.transcode+"&transcoder="+this.config.transcoder+"&transcribe="+this.config.transcribe+"&subtitle="+this.config.subtitle+"&transcribelanguage="+this.config.language+"&transcribevocab="+this.config.transcribevocab+"&notificationurl="+this.config.notificationurl+"&sourcemimetype="+this.config.sourcemimetype,e=M.cfg.wwwroot+"/webservice/rest/server.php";a.open("POST",e,!0);a.setRequestHeader("Cache-Control","no-cache");a.setRequestHeader("Content-Type","application/x-www-form-urlencoded");a.send(d)},uploadBlob:function uploadBlob(a,b){this.uploadFile(a,b)},extractFilename:function extractFilename(a){var b=a.indexOf("success<filename>");if(1>b){return!1}var c=a.indexOf("</filename>"),d=a.substring(b+"success<filename>".length,c);return d},fetchFileExtension:function fetchFileExtension(a){var b="mp3";if(0<a.indexOf(";")){a=a.split(";")[0]}switch(a){case"image/jpeg":b="jpg";break;case"image/png":b="png";break;case"audio/wav":b="wav";break;case"audio/ogg":b="ogg";break;case"audio/mpeg3":b="mp3";break;case"audio/mp3":b="mp3";break;case"audio/webm":b="webm";break;case"audio/wma":b="wma";break;case"audio/x-mpeg-3":b="mp3";break;case"audio/mp4":case"audio/m4a":case"audio/x-m4a":b="m4a";break;case"audio/3gpp":b="3gpp";break;case"video/mpeg3":b="3gpp";break;case"video/m4v":b="m4v";break;case"video/mp4":b="mp4";break;case"video/mov":case"video/quicktime":b="mov";break;case"video/webm":b="webm";break;case"video/wmv":b="wmv";break;case"video/ogg":b="ogg";break;}return b},pokeFilename:function pokeFilename(c,d){var e="";if("undefined"!=typeof d.config.updatecontrol&&""!==d.config.updatecontrol){e=a("[id=\""+d.config.updatecontrol+"\"]")}if(1>e.length){e=a("[id=\""+d.config.updatecontrol+"\"]",window.parent.document)}if(0<e.length){e.get(0).value=c}else{b.debug("upload failed #2");d.upskin.showMessage(M.util.get_string("recui_uploaderror","filter_poodll"),"recui_uploaderror");return!1}e.trigger("change");return!0},alertRecorderSuccess:function alertRecorderSuccess(a){if(this.config.hasOwnProperty("onuploadsuccess")){this.config.onuploadsuccess(a)}},alertRecorderFailure:function alertRecorderFailure(a){if(this.config.hasOwnProperty("onuploadfailure")){this.config.onuploadfailure(a)}},completeAfterProcessing:function completeAfterProcessing(c,d,e){this.upskin.showMessage(M.util.get_string("recui_awaitingconversion","filter_poodll"),"recui_awaitingconversion");if(c.config.iframeembed){d=c.config.s3root+c.config.s3filename}var f={type:"awaitingprocessing",mediaurl:d,mediafilename:c.config.s3filename,sourcefilename:c.config.sourcefilename,sourcemimetype:c.config.sourcemimetype,s3root:c.config.s3root,id:c.config.id,updatecontrol:c.config.updatecontrol};if(c.config.transcribe){f.transcripturl=d+".txt";f.transcriptfilename=c.config.s3filename+".txt"}c.config.hermes.postMessage(f);var g=this;a.ajax({url:c.config.s3root+c.config.s3filename,method:"HEAD",cache:!1,error:function error(){b.debug("403 errors are normal here, till the file arrives back from conversion");setTimeout(function(){g.completeAfterProcessing(c,d,e+500)},e)},success:function success(a,b,f){switch(f.status){case 200:g.doUploadCompleteCallback(c,d);break;default:setTimeout(function(){g.completeAfterProcessing(c,d,e+500)},e);}}})},doUploadCompleteCallback:function doUploadCompleteCallback(a,b){if(a.config.iframeembed){b=a.config.s3root+a.config.s3filename}var c=[];c[0]=a.config.widgetid;c[1]="filesubmitted";c[2]=b;c[3]=a.config.updatecontrol;c[4]=a.config.s3filename;this.upskin.showMessage(M.util.get_string("recui_uploadsuccess","filter_poodll"),"recui_uploadsuccess");if(!a.config.iframeembed){if(a.config.callbackjs&&""!=a.config.callbackjs){if("function"==typeof a.config.callbackjs){a.config.callbackjs(c)}else{this.executeFunctionByName(a.config.callbackjs,window,c)}}else{a.pokeFilename(b,a)}}else{var d={type:"filesubmitted",mediaurl:a.config.s3root+a.config.s3filename,mediafilename:a.config.s3filename,sourcefilename:a.config.sourcefilename,sourcemimetype:a.config.sourcemimetype,s3root:a.config.s3root,id:a.config.id,updatecontrol:a.config.updatecontrol};if(a.config.transcribe){d.transcripturl=a.config.s3root+a.config.s3filename+".txt";d.transcriptfilename=a.config.s3filename+".txt"}a.config.hermes.postMessage(d)}},postProcessUpload:function postProcessUpload(c,d){var e=c.currentTarget;if(4==e.readyState){d.upskin.deactivateProgressSession();a(window).off("beforeunload",this.preventPrematureLeaving);if(200==e.status){var f=d.config.filename;if(!f){f=d.extractFilename(e.responseText)}if(!f){b.debug("upload failed #1");b.debug(e);return}if(d.config.iframeembed){this.completeAfterProcessing(d,f,1e3)}else{this.doUploadCompleteCallback(d,f)}this.alertRecorderSuccess(d.config.widgetid)}else{b.debug("upload failed #3");b.debug(e);d.upskin.showMessage(M.util.get_string("recui_uploaderror","filter_poodll"),"recui_uploaderror");this.alertRecorderFailure(d.config.widgetid)}}},preventPrematureLeaving:function preventPrematureLeaving(){return M.util.get_string("recui_waitwaitstilluploading","filter_poodll")},uploadFile:function uploadFile(c,d){var e=new XMLHttpRequest,f=this.config,g=this,h=this.fetchFileExtension(d);if("undefined"==typeof f.iframeembed){f.iframeembed=!1}var i=f.using_s3;this.upskin.initProgressSession(e);a(window).on("beforeunload",this.preventPrematureLeaving);this.upskin.showMessage(M.util.get_string("recui_uploading","filter_poodll"),"recui_uploading");g.config.sourcemimetype=d;g.config.sourcefilename=g.config.s3filename;e.onreadystatechange=function(a){if(i&&4===this.readyState){if(f.iframeembed){g.update_filenames(g,h)}else{g.postprocess_s3_upload(g)}}g.postProcessUpload(a,g)};if(i){e.open("put",f.posturl,!0);e.setRequestHeader("Content-Type","application/octet-stream");e.send(c)}else{if(!(c instanceof Blob)){b.debug("filedata is not blob");var j="datatype=uploadfile";j+="&paramone="+encodeURIComponent(c);j+="&paramtwo="+h;j+="&paramthree="+f.mediatype;j+="&requestid="+f.widgetid;j+="&contextid="+f.p2;j+="&component="+f.p3;j+="&filearea="+f.p4;j+="&itemid="+f.p5;e.open("POST",f.posturl,!0);e.setRequestHeader("Content-Type","application/x-www-form-urlencoded");e.setRequestHeader("Cache-Control","no-cache");e.send(j)}else{b.debug("filedata is blob");var k=new window.FileReader;k.readAsDataURL(c);k.onloadend=function(){var a=k.result,b="datatype=uploadfile";b+="&paramone="+encodeURIComponent(a);b+="&paramtwo="+h;b+="&paramthree="+f.mediatype;b+="&requestid="+f.widgetid;b+="&contextid="+f.p2;b+="&component="+f.p3;b+="&filearea="+f.p4;b+="&itemid="+f.p5;e.open("POST",f.posturl,!0);e.setRequestHeader("Content-Type","application/x-www-form-urlencoded");e.setRequestHeader("Cache-Control","no-cache");e.send(b)}}}},uploadMultiPartFile:function uploadMultiPartFile(b,c){var d=new XMLHttpRequest,e=this.config,f=this,g=this.fetchFileExtension(c);if("undefined"==typeof e.iframeembed){e.iframeembed=!1}var h=e.using_s3;this.upskin.initProgressSession(d);a(window).on("beforeunload",this.preventPrematureLeaving);this.upskin.showMessage(M.util.get_string("recui_uploading","filter_poodll"),"recui_uploading");f.config.sourcemimetype=c;f.config.sourcefilename=f.config.s3filename;d.onreadystatechange=function(a){if(h&&4===this.readyState){if(e.iframeembed){f.update_filenames(f,g)}else{f.postprocess_s3_upload(f)}}f.postProcessUpload(a,f)};if(h){d.open("put",e.posturl,!0);d.setRequestHeader("Content-Type","application/octet-stream");d.send(b)}},update_filenames:function update_filenames(a,b){var c=a.config;switch(c.mediatype){case"audio":a.config.sourcefilename=c.s3filename.replace(".mp3","."+b);if(!c.transcode){a.config.s3filename=a.config.sourcefilename;a.config.cloudfilename=a.config.s3filename}break;case"video":a.config.sourcefilename=c.s3filename.replace(".mp4","."+b);if(!c.transcode){a.config.s3filename=a.config.sourcefilename}break;}},postprocess_s3_upload:function postprocess_s3_upload(a){var b=a.config,c=new FormData;c.append("datatype","handles3upload");c.append("contextid",b.p2);c.append("component",b.p3);c.append("filearea",b.p4);c.append("itemid",b.p5);c.append("filename",b.filename);c.append("mediatype",b.mediatype);if(!navigator.sendBeacon){navigator.sendBeacon=function(a,b){window.fetch(a,{method:"POST",body:b,credentials:"include"})}}navigator.sendBeacon(M.cfg.wwwroot+"/filter/poodll/poodllfilelib.php",c)},executeFunctionByName:function executeFunctionByName(a,b,c){for(var d=a.split("."),e=d.pop(),f=0;f<d.length;f++){b=b[d[f]]}return b[e].call(this,c)},dataURItoBlob:function dataURItoBlob(a,b){for(var c=atob(a.split(",")[1]),d=new ArrayBuffer(c.length),e=new Uint8Array(d),f=0;f<c.length;f++){e[f]=c.charCodeAt(f)}return new Blob([d],{type:b})},Output:function Output(a){this.upskin.showMessage(a,"recorderskinmsg")}}});
//# sourceMappingURL=uploader.min.js.map
