define(["jquery","core/log","filter_poodll/utils_amd","filter_poodll/upskin_radial","filter_poodll/upskin_bar","filter_poodll/anim_hwave_mic","filter_poodll/dlg_devicesettings"],function(a,b,c,d,e,f,g){"use strict";return b.debug("PoodLL Push Skin: initialising"),{instanceprops:null,pmr:null,devsettings:null,therecanim:null,buttonmode:null,strings:null,clone:function(){return a.extend(!0,{},this)},init:function(a,b){this.instanceprops=a,this.pmr=b,this.devsettings=g.clone(),this.devsettings.init(b,a),this.strings=this.pmr.fetch_strings(),this.strings.recui_pushtospeak=M.util.get_string("recui_pushtospeak","filter_poodll")},fetch_instanceprops:function(){return this.instanceprops},onUploadSuccess:function(a){this.set_visual_mode("allfinished",a)},onUploadFailure:function(a){},fetch_status_bar:function(a){var b='<div class="poodll_status_'+a+'" width="320" height="50">00:00:00</div>';return b},fetch_preview_audio:function(a){var b='<audio class="poodll_preview_'+a+' hide"></audio>';return b},fetch_preview_video:function(a){return this.fetch_preview_audio(a)},fetch_resource_audio:function(a){var b='<audio class="poodll_resourceplayer_'+a+' hide" ></audio>';return b},fetch_resource_video:function(a){return this.fetch_resource_audio(a)},onfinalspeechcapture:function(a,b){this.just_stop()},onMediaError:function(a){console.error("media error",a)},onMediaSuccess_video:function(a){this.fetch_instanceprops();this.set_visual_mode("startbuttonrecording",a)},onMediaSuccess_audio:function(a){var b=this.fetch_instanceprops(a);b.controlbar.preview.attr("src",null),b.uploader.Output(""),this.therecanim.start(),b.timer.reset(),b.timer.start(),this.update_status(a),this.set_visual_mode("startbuttonrecording",a)},handle_timer_update:function(a){var b=this.fetch_instanceprops();b.controlbar.status.html(b.timer.fetch_display_time()),0==b.timer.seconds&&b.timer.initseconds>0&&this.stop_and_upload(a)},update_status:function(a){var b=this.fetch_instanceprops();b.controlbar.status.html(b.timer.fetch_display_time())},fetch_uploader_skin:function(a,b){var c=this.fetch_instanceprops(),d=e.clone();return d.init(c.config,b,c.controlbar.playcanvas,c.controlbar.status),d},set_button_style:function(b){var c=["testbuttonready","testbuttonrecording","startbuttonready","startbuttoncountdown","startbuttonrecording","uploading","allfinished"];a.each(c,function(b,c){a(".poodll_mediarecorderbox_push").removeClass("poodll_mediarecorder_push_"+c),a(".poodll_mediarecorderbox_push").removeClass("push_canclick")}),a(".poodll_mediarecorderbox_push").addClass("poodll_mediarecorder_push_"+b),"testbuttonready"!=b&&"startbuttonready"!=b||a(".poodll_mediarecorderbox_push").addClass("push_canclick")},set_visual_mode:function(a){var b=this,c=this.fetch_instanceprops();this.buttonmode=a;var d={};d.type="recorderstatus",d.status=a,c.config.hermes.postMessage(d);var e='<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i>';switch(a){case"startbuttonready":c.controlbar.thecaption.text(b.strings.recui_pushtospeak),c.controlbar.thecaption.show(),c.controlbar.playcanvas.hide(),c.controlbar.status.hide(),c.controlbar.settingsicon.hide(),b.set_button_style(a);break;case"startbuttonrecording":c.controlbar.thecaption.hide(),c.controlbar.playcanvas.show(),b.set_button_style(a),c.controlbar.status.hide();break;case"uploading":c.controlbar.thecaption.html(e),c.controlbar.thecaption.show(),c.controlbar.playcanvas.hide(),b.set_button_style(a),c.controlbar.status.hide();break;case"allfinished":c.controlbar.thecaption.text("Finished"),c.controlbar.thecaption.show(),c.controlbar.playcanvas.hide(),c.controlbar.status.hide(),b.set_button_style(a)}},insert_controlbar_video:function(a,b,c,d){return this.prepare_controlbar_audio(a,b,c,d)},insert_controlbar_audio:function(a,b,c,d){var e=this.prepare_controlbar(a,b,c,d,"audio");return e},prepare_controlbar:function(b,c,d,e,f){var g=this.fetch_instanceprops(),h=g.config.media_skin_style,i="poodll_mediarecorder_audio",j=this.fetch_status_bar("push"),k='<div class="poodll_mediarecorderholder_push '+i+'" id="holder_'+c+'">';k+='<div class="poodll_mediarecorderbox_push" id="'+c+'">',k+=this.devsettings.fetch_dialogue_box(),k+=g.downloaddialog.fetch_dialogue_box(),k+=g.errordialog.fetch_dialogue_box(),k+='<div class="style-holder '+h+'">',k+=d,k+='<div class="settingsicon" id="settingsicon_'+c+'"><button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal"><i class="fa fa-cogs" aria-hidden="true"></i></button></div>',k+='<canvas id="'+c+'_playcanvas" class="poodll_mediarecorder_playcanvas_push" width="180" height="50"></canvas>',k+='<span id="'+c+'_caption" class="poodll_mediarecorder_caption_push"></span>',k+=j,k+="</div></div></div>",a(b).prepend(k);var l={settingsdialog:a("#"+c+" .poodll_dialogue_box_settings"),downloaddialog:a("#"+c+" .poodll_dialogue_box_download"),errorsdialog:a("#"+c+" .poodll_dialogue_box_errors"),settingsicon:a("#"+c+" .settingsicon"),status:a("#"+c+" .poodll_status_push"),preview:a("#"+c+" .poodll_preview_push"),bigbutton:a("#"+c+".poodll_mediarecorderbox_push"),playcanvas:a("#"+c+"_playcanvas"),thecaption:a("#"+c+"_caption"),themicicon:a("#"+c+"_micicon"),stopbutton:a("#"+c+" .poodll_mediarecorder_bogusstopbutton_push"),startbutton:a("#"+c+" .poodll_mediarecorder_bogusstartbutton_push")};return g.downloaddialog.set_dialogue_box(l.downloaddialog),g.errordialog.set_dialogue_box(l.errorsdialog),this.devsettings.set_dialogue_box(l.settingsdialog),l},register_controlbar_events_video:function(a,b){return this.register_controlbar_events_audio(a,b)},register_controlbar_events_audio:function(c,d){var e=this,g=this.pmr,h=this.fetch_instanceprops();h.config.recanim="hwave_mic";var i=f.clone();e.therecanim=i,i.init(h.audioanalyser,h.controlbar.playcanvas.get(0)),this.set_visual_mode("startbuttonready"),h.controlbar.bigbutton.click(function(f){b.debug(f.target);var i=!1;if((f.target===e||a(f.target).hasClass("style-holder")||a(f.target).hasClass("poodll_mediarecorderbox_push")||a(f.target).hasClass("poodll_mediarecorder_caption_push")||a(f.target).hasClass("poodll_mediarecorder_playcanvas_push"))&&(i=!0),i)switch(e.buttonmode){case"startbuttonready":var j={};j.type="recorderstatus",j.status="startbuttonrecording",h.config.hermes.postMessage(j),h.timer.disable(),g.do_start_audio(h,c),e.set_visual_mode("startbuttonrecording");break;case"startbuttonrecording":e.just_stop(d);break;case"oldstartbuttonready":var k=function(){var a=(new Date).getTime(),b=a-l;if(b>m)h.timer.enable(),g.do_start_audio(h,c);else{var d=!1;if(n<0&&b>0?d=m/1e3:n<1e3&&b>1e3?d=m/1e3-1:n<2e3&&b>2e3&&(d=m/1e3-2),d){var e={};e.type="countdownstatus",e.status=d,h.config.hermes.postMessage(e)}n=b,setTimeout(k,100)}};h.config.hermes.enable(),e.set_visual_mode("startbuttoncountdown");var l=(new Date).getTime(),m=3e3,n=-1;setTimeout(k,100);break;case"stopbutton":e.stop_and_upload()}}),h.controlbar.settingsicon.click(function(a){b.debug("we no proapagato"),a.stopPropagation(),e.uploaded?h.downloaddialog.open():e.devsettings.open()}),window.onbeforeunload=function(){}},just_stop:function(){var a=this.pmr,b=this.fetch_instanceprops(),c=this.therecanim;b.mediaRecorder&&a.do_stop_audio(b),c.clear(),b.config.hermes.enable(),this.set_visual_mode("startbuttonready")},stop_and_upload:function(a){var b=this,c=this.pmr,d=this.fetch_instanceprops(),e=b.therecanim;c.do_stop_audio(d),e.clear(),d.timer.stop(),b.update_status(a);var f=function(){d.blobs&&d.blobs.length>0?(c.do_save_audio(d),d.uploaded=!0):setTimeout(f,200)};setTimeout(f,200),b.set_visual_mode("uploading")},enable_button:function(b){a(b).attr("disabled",!1),a(b).removeClass("pmr_disabled")},disable_button:function(b){a(b).attr("disabled",!0),a(b).addClass("pmr_disabled")}}});