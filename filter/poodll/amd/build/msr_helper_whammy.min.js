define(["jquery","core/log","filter_poodll/utils_amd","filter_poodll/poodll_whammy"],function(a,b,c,d){"use strict";return b.debug("PoodLL Whammy Recorder Helper: initialising"),{requestDataInvoked:!1,isOnStartedDrawingNonBlankFramesInvoked:!1,isStopDrawing:!1,canvas:null,context:null,video:!1,lastTime:!1,whammy:!1,isPaused:!1,width:!1,height:!1,speed:.8,quality:100,mediaStream:null,msr:null,audioctx:null,clone:function(){return a.extend(!0,{},this)},init:function(a,c,d){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.mediaStream=c,this.msr=a,this.audioctx=d,b.debug("initing whammy helper")},record:function(a){b.debug("recordingin whammy helper"),this.width||(this.width=320),this.height||(this.height=240),this.video&&this.video instanceof HTMLVideoElement&&(this.width||(this.width=this.video.videoWidth||this.video.clientWidth||320),this.height||(this.height=this.video.videoHeight||this.video.clientHeight||240)),this.video||(this.video={width:this.width,height:this.height}),this.canvas&&this.canvas.width&&this.canvas.height||(this.canvas={width:this.width,height:this.height}),this.video&&this.video instanceof HTMLVideoElement?this.isHTMLObject=!0:(this.video=document.createElement("video"),this.video.srcObject=this.mediaStream),this.video.muted=!0,this.video.play(),this.lastTime=(new Date).getTime(),this.whammy=d.Video,this.whammy.init(this.speed,this.quality),this.drawFrames(this)},clearOldRecordedFrames:function(){this.whammy.frames=[]},requestData:function(){var a=this;if(!this.isPaused){if(!this.whammy.frames.length)return void(this.requestDataInvoked=!1);this.requestDataInvoked=!0;var d=this.whammy.frames.slice(0);this.whammy.frames=this.dropBlackFrames(d,-1),this.whammy.compile(function(d){a.msr.ondataavailable(d),b.debug("video recorded blob size:"+c.bytesToSize(d.size))}),this.whammy.frames=[],this.requestDataInvoked=!1}},drawFrames:function(a){if(a.isPaused)return a.lastTime=(new Date).getTime(),void setTimeout(function(){a.drawFrames(a)},500);if(!a.isStopDrawing){if(a.requestDataInvoked)return setTimeout(function(){a.drawFrames(a)},100);var b=(new Date).getTime()-a.lastTime;if(!b)return a.drawFrames(a);a.lastTime=(new Date).getTime(),!a.isHTMLObject&&a.video.paused&&a.video.play(),a.context.drawImage(a.video,0,0,a.canvas.width,a.canvas.height),a.isStopDrawing||a.whammy.frames.push({duration:b,image:a.canvas.toDataURL("image/webp")}),a.isOnStartedDrawingNonBlankFramesInvoked||a.isBlankFrame(a.whammy.frames[a.whammy.frames.length-1])||(a.isOnStartedDrawingNonBlankFramesInvoked=!0,a.msr.onStartedDrawingNonBlankFrames()),setTimeout(function(){a.drawFrames(a)},10)}},stop:function(){this.isStopDrawing=!0,this.requestData()},isBlankFrame:function(a,b,c){var d=document.createElement("canvas");d.width=this.canvas.width,d.height=this.canvas.height;var e,f,g,h=d.getContext("2d"),i={r:0,g:0,b:0},j=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2)),k=b&&b>=0&&b<=1?b:0,l=c&&c>=0&&c<=1?c:0,m=new Image;m.src=a.image,h.drawImage(m,0,0,this.canvas.width,this.canvas.height);var n=h.getImageData(0,0,this.canvas.width,this.canvas.height);e=0,f=n.data.length,g=n.data.length/4;for(var o=0;o<f;o+=4){var p={r:n.data[o],g:n.data[o+1],b:n.data[o+2]},q=Math.sqrt(Math.pow(p.r-i.r,2)+Math.pow(p.g-i.g,2)+Math.pow(p.b-i.b,2));q<=j*k&&e++}return!(g-e<=g*l)},dropBlackFrames:function(a,b,c,d){var e=document.createElement("canvas");e.width=this.canvas.width,e.height=this.canvas.height;for(var f=e.getContext("2d"),g=[],h=b===-1,i=b&&b>0&&b<=a.length?b:a.length,j={r:0,g:0,b:0},k=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2)),l=c&&c>=0&&c<=1?c:0,m=d&&d>=0&&d<=1?d:0,n=!1,o=0;o<i;o++){var p,q,r;if(!n){var s=new Image;s.src=a[o].image,f.drawImage(s,0,0,this.canvas.width,this.canvas.height);var t=f.getImageData(0,0,this.canvas.width,this.canvas.height);p=0,q=t.data.length,r=t.data.length/4;for(var u=0;u<q;u+=4){var v={r:t.data[u],g:t.data[u+1],b:t.data[u+2]},w=Math.sqrt(Math.pow(v.r-j.r,2)+Math.pow(v.g-j.g,2)+Math.pow(v.b-j.b,2));w<=k*l&&p++}}!n&&r-p<=r*m||(h&&(n=!0),g.push(a[o]))}return g=g.concat(a.slice(i)),g.length<=0&&g.push(a[a.length-1]),g},pause:function(){this.isPaused=!0},resume:function(){this.isPaused=!1}}});