define(["jquery","core/log","filter_poodll/utils_amd","filter_poodll/upskin_radial","filter_poodll/upskin_bar","filter_poodll/anim_hwave_mic","filter_poodll/dlg_devicesettings"],function(a,b,c,d,e,f,g){"use strict";return b.debug("PoodLL Read Seed Skin: initialising"),{instanceprops:null,pmr:null,devsettings:null,therecanim:null,buttonmode:null,clone:function(){return a.extend(!0,{},this)},init:function(a,b){this.instanceprops=a,this.pmr=b,this.devsettings=g.clone(),this.devsettings.init(b,a)},fetch_instanceprops:function(){return this.instanceprops},onUploadSuccess:function(a){this.set_visual_mode("allfinished",a)},onUploadFailure:function(a){},fetch_status_bar:function(a){var b='<div class="poodll_status_'+a+'" width="320" height="50">00:00:00</div>';return b},fetch_preview_audio:function(a){var b='<audio class="poodll_preview_'+a+' hide" playsInline muted></audio>';return b},fetch_preview_video:function(a){return this.fetch_preview_audio(a)},fetch_resource_audio:function(a){var b='<audio class="poodll_resourceplayer_'+a+' hide" ></audio>';return b},fetch_resource_video:function(a){return this.fetch_resource_audio(a)},onMediaError:function(a){console.error("media error",a)},onMediaSuccess_video:function(a){this.fetch_instanceprops(a);this.set_visual_mode("startbuttonrecording",a)},onMediaSuccess_audio:function(a){var b=this.fetch_instanceprops(a);b.controlbar.preview.attr("src",null),b.uploader.Output(""),this.therecanim.start(),b.timer.reset(),b.timer.start(),this.update_status(a),"testbuttonrecording"!=this.buttonmode&&this.set_visual_mode("startbuttonrecording",a)},handle_timer_update:function(a){var b=this.fetch_instanceprops(a);b.controlbar.status.html(b.timer.fetch_display_time()),0==b.timer.seconds&&b.timer.initseconds>0&&this.process_recording_stop(a)},update_status:function(a){var b=this.fetch_instanceprops(a);b.controlbar.status.html(b.timer.fetch_display_time())},fetch_uploader_skin:function(a,b){var c=this.fetch_instanceprops(a),d=e.clone();return d.init(c.config,b,c.controlbar.playcanvas,c.controlbar.status),d},set_button_style:function(b){var c=["testbuttonready","testbuttonrecording","startbuttonready","startbuttoncountdown","startbuttonrecording","uploading","allfinished"];a.each(c,function(b,c){a(".poodll_mediarecorderbox_readseed").removeClass("poodll_mediarecorder_readseed_"+c),a(".poodll_mediarecorderbox_readseed").removeClass("readseed_canclick")}),a(".poodll_mediarecorderbox_readseed").addClass("poodll_mediarecorder_readseed_"+b),"testbuttonready"!=b&&"startbuttonready"!=b||a(".poodll_mediarecorderbox_readseed").addClass("readseed_canclick")},set_visual_mode:function(a,b){var c=this,d=this.fetch_instanceprops(b);this.buttonmode=a;var e={};switch(e.type="recorderstatus",e.status=a,d.config.hermes.postMessage(e),a){case"testbuttonready":d.controlbar.status.hide(),d.controlbar.thecaption.text("SPEAK"),d.controlbar.thecaption.show(),d.controlbar.playcanvas.hide(),c.set_button_style(a);break;case"testbuttonrecording":d.controlbar.thecaption.hide(),d.controlbar.playcanvas.show(),c.set_button_style(a);break;case"startbuttonready":d.controlbar.thecaption.text("START"),d.controlbar.thecaption.show(),d.controlbar.playcanvas.hide(),c.set_button_style(a);break;case"startbuttoncountdown":d.controlbar.thecaption.text("----------"),d.controlbar.thecaption.show(),d.controlbar.playcanvas.hide(),c.set_button_style(a);break;case"startbuttonrecording":if(d.controlbar.playcanvas.show(),"1"==d.config.allowearlyexit&&d.timer.enabled){var f=M.util.get_string("recui_clicktofinish","filter_poodll");d.controlbar.thecaption.text(f),d.controlbar.thecaption.show()}else d.controlbar.thecaption.hide();c.set_button_style(a);break;case"uploading":var g='<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i>';d.controlbar.thecaption.html(g),d.controlbar.thecaption.show(),d.controlbar.playcanvas.hide(),c.set_button_style(a),d.controlbar.status.show();break;case"allfinished":d.controlbar.thecaption.text("Finished"),d.controlbar.thecaption.show(),d.controlbar.playcanvas.hide(),d.controlbar.status.hide(),c.set_button_style(a)}},insert_controlbar_video:function(a,b,c,d){return this.prepare_controlbar_audio(a,b,c,d)},insert_controlbar_audio:function(a,b,c,d){var e=this.prepare_controlbar(a,b,c,d,"audio");return e},prepare_controlbar:function(b,c,d,e,f){var g=this.fetch_instanceprops(c),h=g.config.media_skin_style,i="poodll_mediarecorder_audio",j=(this.pmr.fetch_strings(),M.util.get_string("recui_startactivity","filter_poodll"),M.util.get_string("recui_testmic","filter_poodll"),M.util.get_string("recui_stop","filter_poodll"),this.fetch_status_bar("readseed")),k='<div class="poodll_mediarecorderholder_readseed '+i+'" id="holder_'+c+'">';k+='<div class="poodll_mediarecorderbox_readseed" id="'+c+'">',k+=this.devsettings.fetch_dialogue_box(),k+=g.downloaddialog.fetch_dialogue_box(),k+=g.errordialog.fetch_dialogue_box(),k+='<div class="style-holder '+h+'">',k+=d,k+='<div class="settingsicon" id="settingsicon_'+c+'"><button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal"><i class="fa fa-cogs" aria-hidden="true"></i></button></div>',k+='<canvas id="'+c+'_playcanvas" class="poodll_mediarecorder_playcanvas_readseed" width="180" height="50"></canvas>',k+='<span id="'+c+'_caption" class="poodll_mediarecorder_caption_readseed"></span>',k+='<span id="'+c+'_bogusstartbutton" class="poodll_mediarecorder_bogusstartbutton_readseed"></span>',k+='<span id="'+c+'_bogusstopbutton" class="poodll_mediarecorder_bogusstopbutton_readseed"></span>',k+=j,k+="</div></div></div>",a(b).prepend(k);var l={settingsdialog:a("#"+c+" .poodll_dialogue_box_settings"),downloaddialog:a("#"+c+" .poodll_dialogue_box_download"),errorsdialog:a("#"+c+" .poodll_dialogue_box_errors"),settingsicon:a("#"+c+" .settingsicon"),status:a("#"+c+" .poodll_status_readseed"),preview:a("#"+c+" .poodll_preview_readseed"),bigbutton:a("#"+c+".poodll_mediarecorderbox_readseed"),playcanvas:a("#"+c+"_playcanvas"),thecaption:a("#"+c+"_caption"),stopbutton:a("#"+c+" .poodll_mediarecorder_bogusstopbutton_readseed"),startbutton:a("#"+c+" .poodll_mediarecorder_bogusstartbutton_readseed")};return g.downloaddialog.set_dialogue_box(l.downloaddialog),g.errordialog.set_dialogue_box(l.errorsdialog),this.devsettings.set_dialogue_box(l.settingsdialog),l},register_controlbar_events_video:function(a,b){return this.register_controlbar_events_audio(a,b)},register_controlbar_events_audio:function(c,d){var e=this,g=this.pmr,h=this.fetch_instanceprops(d);h.config.recanim="hwave_mic";var i=f.clone();e.therecanim=i,i.init(h.audioanalyser,h.controlbar.playcanvas.get(0)),this.set_visual_mode("testbuttonready",d),h.controlbar.bigbutton.click(function(b){if(b.target===this||a(b.target).hasClass("poodll_mediarecorder_caption_readseed")||a(b.target).hasClass("poodll_mediarecorder_playcanvas_readseed"))switch(e.buttonmode){case"testbuttonready":var f={};f.type="recorderstatus",f.status="testbuttonrecording",h.config.hermes.postMessage(f),h.config.hermes.disable(),h.timer.disable();var j=function(){if(h.mediaRecorder&&g.do_stop_audio(h),i.clear(),h.config.hermes.enable(),i.sounddetected)e.set_visual_mode("startbuttonready",d);else{var a={};a.type="recorderstatus",a.status="testrecordingfailed",h.config.hermes.postMessage(a),e.set_visual_mode("testbuttonready",d)}};g.do_start_audio(h,c),setTimeout(j,4e3),e.set_visual_mode("testbuttonrecording",d);break;case"startbuttonready":var k=function(){var a=(new Date).getTime(),b=a-l;if(b>m)h.timer.enable(),g.do_start_audio(h,c);else{var d=!1;if(n<0&&b>0?d=m/1e3:n<1e3&&b>1e3?d=m/1e3-1:n<2e3&&b>2e3&&(d=m/1e3-2),d){var e={};e.type="countdownstatus",e.status=d,h.config.hermes.postMessage(e)}n=b,setTimeout(k,100)}};h.config.hermes.enable(),e.set_visual_mode("startbuttoncountdown",d);var l=(new Date).getTime(),m=3e3,n=-1;setTimeout(k,100);break;case"startbuttonrecording":"1"==h.config.allowearlyexit&&h.timer.enabled&&e.process_recording_stop(d);break;case"stopbutton":e.process_recording_stop()}}),h.controlbar.settingsicon.click(function(a){b.debug("we no proapagato"),a.stopPropagation(),e.uploaded?h.downloaddialog.open():e.devsettings.open()}),window.onbeforeunload=function(){}},process_recording_stop:function(a){var b=this,c=this.pmr,d=this.fetch_instanceprops(a),e=b.therecanim;c.do_stop_audio(d),e.clear(),d.timer.stop(),b.update_status(a);var f=function(){d.blobs&&d.blobs.length>0?(c.do_save_audio(d),d.uploaded=!0):setTimeout(f,200)};setTimeout(f,200),b.set_visual_mode("uploading",a)},enable_button:function(b){a(b).attr("disabled",!1),a(b).removeClass("pmr_disabled")},disable_button:function(b){a(b).attr("disabled",!0),a(b).addClass("pmr_disabled")}}});