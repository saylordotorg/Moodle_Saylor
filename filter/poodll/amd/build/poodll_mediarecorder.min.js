define(["jquery","core/log","filter_poodll/utils_amd","filter_poodll/adapter","filter_poodll/uploader","filter_poodll/hermes","filter_poodll/timer","filter_poodll/audioanalyser","filter_poodll/msr_poodll","filter_poodll/dlg_errordisplay","filter_poodll/dlg_download","filter_poodll/speech_poodll","filter_poodll/poodll_mediaskins"],(function($,log,utils,adapter,uploader,hermes,timer,audioanalyser,poodll_msr,errordialog,downloaddialog,speechrecognition,mediaskins){return log.debug("PoodLL Media Recorder: initialising"),{instanceprops:[],skins:[],laststream:[],fetch_instanceprops:function(controlbarid){return this.instanceprops[controlbarid]},fetch_skin:function(controlbarid){return this.skins[controlbarid]},is_ios:function(){return utils.is_ios()},supports_current_browser:function(config){if(!(0==M.cfg.wwwroot.indexOf("https:")||0==M.cfg.wwwroot.indexOf("http://localhost")))return!1;if("audio"!=config.mediatype&&"video"!=config.mediatype)return!1;var ret=utils.can_html5_record(config.mediatype);return ret&&log.debug("PoodLL Media Recorder: supports this browser"),ret},embed:function(element,config){var that=this,controlbarid="filter_poodll_controlbar_"+config.widgetid;this.init_instance_props(controlbarid);var ip=this.fetch_instanceprops(controlbarid);ip.config=config,ip.controlbarid=controlbarid,config.hideupload?ip.showupload=!1:ip.showupload=!0,ip.timeinterval=config.media_timeinterval,ip.audiomimetype=config.media_audiomimetype,ip.videorecordertype=config.media_videorecordertype,ip.videocaptureheight=config.media_videocaptureheight,ip.errordialog=errordialog.clone(),ip.errordialog.init(ip),ip.downloaddialog=downloaddialog.clone(),ip.downloaddialog.init(this,ip),ip.config.hermes=hermes.clone(),ip.config.hermes.init(config.id,config.allowedURL,config.iframeembed);var theskin=this.init_skin(controlbarid,ip.config.media_skin,ip);switch(ip.config.speechevents&&ip.speechrec.will_work_ok(ip.config)?(ip.config.language||(ip.config.language="en-US"),ip.speechrec.init(ip.config),ip.speechrec.onfinalspeechcapture=function(speechtext,speechresults){var messageObject={type:"speech"};messageObject.capturedspeech=speechtext,messageObject.speechresults=speechresults,ip.config.hermes.postMessage(messageObject),theskin.hasOwnProperty("onfinalspeechcapture")&&theskin.onfinalspeechcapture(speechtext,speechresults)}):(log.debug("turning off speech events. not req. or not supported."),ip.config.speechevents=!1),ip.config.onuploadsuccess=function(widgetid){that.onUploadSuccess(widgetid,theskin)},ip.config.onuploadfailure=function(widgetid){that.onUploadFailure(widgetid,theskin)},config.mediatype){case"audio":var preview=theskin.fetch_preview_audio(config.media_skin),resource=theskin.fetch_resource_audio(config.media_skin);ip.controlbar=this.fetch_controlbar_audio(element,controlbarid,preview,resource),ip.uploader=uploader.clone();var upskin=theskin.fetch_uploader_skin(ip.controlbarid,element);if(ip.uploader.init(element,config,upskin),this.register_events_audio(controlbarid),"upload"==ip.config.media_skin||"warning"==ip.config.media_skin)break;navigator.mediaDevices.getUserMedia({audio:!0}).then((function(stream){log.debug("successfully forced permissions and got user media")})).catch((function(err){log.debug("location 9998"),log.debug(err),ip.errordialog.open(err)}));break;case"video":preview=theskin.fetch_preview_video(config.media_skin),resource=theskin.fetch_resource_video(config.media_skin);ip.controlbar=this.fetch_controlbar_video(element,controlbarid,preview,resource),ip.uploader=uploader.clone();upskin=theskin.fetch_uploader_skin(ip.controlbarid,element);if(ip.uploader.init(element,config,upskin),this.register_events_video(controlbarid),"upload"==ip.config.media_skin||"warning"==ip.config.media_skin||"screen"==ip.config.media_skin)break;navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then((function(stream){that.restream_preview_video_player(controlbarid,stream)})).catch((function(err){log.debug("location 9999"),log.debug(err)}))}return ip.timer=timer.clone(),ip.timer.init(ip.config.timelimit,(function(){theskin.handle_timer_update(controlbarid)})),theskin.handle_timer_update(controlbarid),theskin},init_instance_props:function(controlbarid){this.instanceprops[controlbarid]={},this.instanceprops[controlbarid].recorded_index=0,this.instanceprops[controlbarid].mediaRecorder=null,this.instanceprops[controlbarid].blobs=[],this.instanceprops[controlbarid].timeinterval=1e3,this.instanceprops[controlbarid].audiomimetype="audio/webm",this.instanceprops[controlbarid].videorecordertype="auto",this.instanceprops[controlbarid].videocapturewidth=320,this.instanceprops[controlbarid].videocaptureheight=240,this.instanceprops[controlbarid].controlbar="",this.instanceprops[controlbarid].previewvolume=1,this.instanceprops[controlbarid].timer={},this.instanceprops[controlbarid].timer={},this.instanceprops[controlbarid].showupload=!0,this.instanceprops[controlbarid].uploader={},this.instanceprops[controlbarid].uploaded=!1,this.instanceprops[controlbarid].useraudiodeviceid=!1,this.instanceprops[controlbarid].uservideodeviceid=!1,this.instanceprops[controlbarid].devices=[];var AudioContext=window.AudioContext||window.webkitAudioContext||!1;if(void 0===window.poodllmediarecorder_actx){var ac=new AudioContext;window.poodllmediarecorder_actx=ac,window.poodllmediarecorder_actx_cnt=1}else if(6==window.poodllmediarecorder_actx_cnt){ac=window.poodllmediarecorder_actx;log.debug("More than 6 contexts, reusing first one. visualizations might go weird")}else{ac=new AudioContext;window.poodllmediarecorder_actx_cnt+=1}this.instanceprops[controlbarid].audioctx=ac;var aa=audioanalyser.clone();aa.init(ac),this.instanceprops[controlbarid].audioanalyser=aa,this.instanceprops[controlbarid].previewstillcold=!0,this.instanceprops[controlbarid].speechrec=speechrecognition.clone()},init_skin:function(controlbarid,skinname,instanceprops){return this.skins[controlbarid]=mediaskins.fetch_skin_clone(skinname),this.skins[controlbarid].init(instanceprops,this),this.skins[controlbarid]},onUploadSuccess:function(widgetid,theskin){log.debug("from poodllmediarecorder: uploadsuccess");var controlbarid="filter_poodll_controlbar_"+widgetid;theskin.onUploadSuccess(controlbarid)},onUploadFailure:function(widgetid,theskin){log.debug("from poodllmediarecorder: uploadfailure");var controlbarid="filter_poodll_controlbar_"+widgetid;theskin.onUploadFailure(controlbarid),theskin.fetch_instanceprops().downloaddialog.open(theskin.pmr,theskin.instanceprops)},onMediaError:function(e,ip){ip.hasOwnProperty("errordialog")&&ip.errordialog.open(e),log.error("media error",e)},captureUserMedia:function(mediaConstraints,successCallback,errorCallback){navigator.mediaDevices.getUserMedia(mediaConstraints).then(successCallback).catch(errorCallback)},warmup_context:function(ip){var ctx=ip.audioctx;"suspended"==ctx.state&&ctx.resume();var buffer=ctx.createBuffer(1,1,22050),source=ctx.createBufferSource();source.buffer=buffer,source.connect(ctx.destination),source.start(0)},warmup_preview:function(ip){var preview=ip.controlbar.preview;if(ip.previewstillcold&&preview&&preview.get(0)){var pPromise=ip.controlbar.preview[0].play();void 0!==pPromise&&pPromise.then((function(){})).catch((function(error){log.debug(error)})),ip.previewstillcold=!1}},do_start_audio:function(ip,onMediaSuccess){var that=this;switch(this.warmup_context(ip),this.warmup_preview(ip),ip.controlbar.preview[0].muted=!0,ip.blobs=[],ip.config.mediatype){case"audio":var mediaConstraints=this.fetch_audio_constraints(ip);break;case"video":mediaConstraints=this.fetch_video_constraints(ip)}this.captureUserMedia(mediaConstraints,onMediaSuccess,(function(e){that.onMediaError(e,ip)}))},do_start_screen:function(ip,onMediaSuccess){var that=this;this.warmup_context(ip),this.warmup_preview(ip),ip.controlbar.preview[0].muted=!0,ip.blobs=[];var mediaConstraints={audio:{echoCancellation:!0},video:{cursor:"motion"}};navigator.mediaDevices.getDisplayMedia(mediaConstraints).then((function(displayStream){if(ip.useraudiodeviceid){var audiodeviceid=ip.useraudiodeviceid.valueOf();mediaConstraints.audio.deviceId=audiodeviceid?{exact:audiodeviceid}:void 0}navigator.mediaDevices.getUserMedia({audio:mediaConstraints.audio,video:!1}).then((function(voiceStream){var tracks=displayStream.getTracks().concat(voiceStream.getAudioTracks()),stream=new MediaStream(tracks);onMediaSuccess(stream)}))})).catch((function(e){that.onMediaError(e,ip)}))},do_start_video:function(ip,onMediaSuccess){},do_stopplay_audio:function(ip,preview){switch(preview.pause(),preview.muted=!1,ip.config.mediatype){case"audio":break;case"video":ip.controlbar.hasOwnProperty("livepreview")&&(ip.controlbar.preview.hide(),ip.controlbar.preview=ip.controlbar.livepreview,ip.controlbar.preview.show())}},do_play_audio:function(ip,preview_unused){ip.blobs&&ip.blobs.length>0&&(log.debug("playing type:"+ip.blobs[0].type),log.debug(ip.blobs),utils.doConcatenateBlobs(ip.blobs,(function(concatenatedBlob){log.debug(concatenatedBlob);var mediaurl=URL.createObjectURL(concatenatedBlob);switch(ip.config.mediatype){case"audio":var preview=ip.controlbar.preview[0];break;case"video":ip.controlbar.livepreview=ip.controlbar.preview,ip.controlbar.preview=ip.controlbar.preview.clone().insertAfter(ip.controlbar.preview);preview=ip.controlbar.preview[0];ip.controlbar.livepreview.hide()}preview.src=mediaurl,preview.controls=!1,preview.volume=ip.previewvolume,preview.muted=!1,$(preview).bind("ended",(function(){ip.controlbar.stopbutton.click()}));var ppromise=preview.play();void 0!==ppromise&&ppromise.then((function(){})).catch((function(error){log.debug("location: do_play_audio"),log.debug(error)}))})))},do_play_video:function(ip){},do_save_audio:function(ip){ip.blobs&&ip.blobs.length>0&&(utils.doConcatenateBlobs(ip.blobs,(function(concatenatedBlob){ip.uploader.uploadBlob(concatenatedBlob,ip.blobs[0].type)})),ip.uploaded=!0,ip.controlbar.startbutton.attr("disabled",!0))},do_save_video:function(ip){},do_stop_audio:function(ip){ip.mediaRecorder.resume(),ip.mediaRecorder.stop(),ip.config.speechevents&&ip.speechrec.stop();var messageObject={type:"recording",action:"stopped"};ip.config.hermes.postMessage(messageObject)},do_stop_video:function(ip){},do_stop_screen:function(ip){},do_pause_audio:function(ip){ip.mediaRecorder.resume(),ip.mediaRecorder.pause()},do_pause_video:function(ip){},do_resume_audio:function(ip){ip.mediaRecorder.resume()},do_resume_video:function(ip){},fetch_video_constraints:function(ip){var mediaConstraints={audio:!utils.is_opera()&&!utils.is_edge(),video:{width:{ideal:640},height:{ideal:480}}};if(ip.uservideodeviceid){var videodeviceid=ip.uservideodeviceid.valueOf(),videoconstraints={deviceId:videodeviceid?{exact:videodeviceid}:void 0,width:{ideal:640},height:{ideal:480}};mediaConstraints.video=videoconstraints}if(ip.useraudiodeviceid){var audiodeviceid=ip.useraudiodeviceid.valueOf(),audioconstraints={deviceId:audiodeviceid?{exact:audiodeviceid}:void 0};mediaConstraints.audio=audioconstraints}return mediaConstraints},fetch_screen_constraints:function(ip){var mediaConstraints={audio:!utils.is_opera()&&!utils.is_edge(),video:!0};if(ip.uservideodeviceid){var videodeviceid=ip.uservideodeviceid.valueOf(),constraints={deviceId:videodeviceid?{exact:videodeviceid}:void 0};mediaConstraints.video=constraints}if(ip.useraudiodeviceid){var audiodeviceid=ip.useraudiodeviceid.valueOf();constraints={deviceId:audiodeviceid?{exact:audiodeviceid}:void 0};mediaConstraints.audio=constraints}return mediaConstraints},fetch_audio_constraints:function(ip){var mediaConstraints={audio:!0};if(utils.is_safari()&&!ip.useraudiodeviceid&&(ip.audiomimetype="audio/wav"),ip.useraudiodeviceid){var constraints={deviceId:ip.useraudiodeviceid};mediaConstraints.audio=constraints}return mediaConstraints},register_events_audio:function(controlbarid){var self=this,ip=this.fetch_instanceprops(controlbarid),skin=this.skins[controlbarid];skin.register_controlbar_events_audio((function(stream){self.laststream[controlbarid]=stream;var encoder="auto";if(ip.config.hasOwnProperty("encoder")&&(encoder=ip.config.encoder),ip.mediaRecorder=poodll_msr,ip.mediaRecorder.init(stream,ip.audioctx,ip.audioanalyser,ip.config.mediatype,encoder),ip.mediaRecorder.mimeType=ip.audiomimetype,ip.mediaRecorder.audioChannels=1,ip.mediaRecorder.start(ip.timeinterval,ip.audioctx),ip.mediaRecorder.ondataavailable=function(blob){ip.blobs.push(blob)},!ip.config.iframeembed&&ip.config.callbackjs&&""!=ip.config.callbackjs){var callbackObject=new Array;callbackObject[0]=ip.config.widgetid,callbackObject[1]="started",callbackObject[2]=ip.config.filename,callbackObject[3]=ip.config.updatecontrol,callbackObject[4]=ip.config.s3filename,"function"==typeof ip.config.callbackjs?ip.config.callbackjs(callbackObject):uploader.executeFunctionByName(ip.config.callbackjs,window,callbackObject)}var messageObject={type:"recording",action:"started"};ip.config.hermes.postMessage(messageObject),ip.config.speechevents&&ip.speechrec.start(stream),skin.onMediaSuccess_audio(controlbarid)}),controlbarid)},register_events_video:function(controlbarid){var self=this,ip=this.fetch_instanceprops(controlbarid),skin=this.skins[controlbarid];skin.register_controlbar_events_video((function(stream){self.restream_preview_video_player(controlbarid,stream);var encoder="auto";if(ip.config.hasOwnProperty("encoder")&&(encoder=ip.config.encoder),ip.mediaRecorder=poodll_msr,ip.mediaRecorder.init(stream,ip.audioctx,ip.audioanalyser,ip.config.mediatype,encoder),"mediarec"===ip.videorecordertype&&(ip.mediaRecorder.recorderType=MediaRecorderWrapper),ip.mediaRecorder.videoWidth=ip.videocapturewidth,ip.mediaRecorder.videoHeight=ip.videocaptureheight,ip.mediaRecorder.start(ip.timeinterval),ip.mediaRecorder.ondataavailable=function(blob){ip.blobs.push(blob)},!ip.config.iframeembed&&ip.config.callbackjs&&""!=ip.config.callbackjs){var callbackObject=new Array;callbackObject[0]=ip.config.widgetid,callbackObject[1]="started",callbackObject[2]=ip.config.filename,callbackObject[3]=ip.config.updatecontrol,callbackObject[4]=ip.config.s3filename,"function"==typeof ip.config.callbackjs?ip.config.callbackjs(callbackObject):uploader.executeFunctionByName(ip.config.callbackjs,window,callbackObject)}var messageObject={type:"recording",action:"started"};ip.config.hermes.postMessage(messageObject),ip.config.speechevents&&ip.speechrec.start(stream),skin.onMediaSuccess_video(controlbarid)}),controlbarid)},tidy_old_stream:function(controlbarid){this.laststream[controlbarid]&&this.laststream[controlbarid].getTracks().forEach((function(track){track.stop()}))},restream_preview_video_player:function(controlbarid,stream){this.laststream[controlbarid]=stream,this.init_video_preview(controlbarid),utils.is_android()&&navigator.mediaDevices.enumerateDevices()},init_video_preview:function(controlbarid){var preview=this.fetch_instanceprops(controlbarid).controlbar.preview[0];preview.srcObject=this.laststream[controlbarid],preview.controls=!1,preview.volume=0;var ppromise=preview.play();void 0!==ppromise&&ppromise.then((function(){})).catch((function(error){log.debug("location: init_video_preview"),log.debug(error)}))},update_status:function(controlbarid){var ip=this.fetch_instanceprops(controlbarid);ip.controlbar.status.html(ip.timer.fetch_display_time())},fetch_controlbar_audio:function(element,controlbarid,preview,resource){this.fetch_instanceprops(controlbarid);return this.fetch_skin(controlbarid).insert_controlbar_audio(element,controlbarid,preview,resource)},fetch_controlbar_video:function(element,controlbarid,preview,resource){this.fetch_instanceprops(controlbarid);return this.fetch_skin(controlbarid).insert_controlbar_video(element,controlbarid,preview,resource)},fetch_strings:function(){var ss=[];return $.each(["record","play","pause","continue","stop","save","restart","testmic","upload","recordagain","readytorecord","downloadfile"],(function(index,key){ss["recui_"+key]=M.util.get_string("recui_"+key,"filter_poodll"),(ss["recui_"+key].indexOf(",filter_poodll]]")>1||""==ss["recui_"+key])&&(ss["recui_"+key]=key)})),ss}}}));

//# sourceMappingURL=poodll_mediarecorder.min.js.map