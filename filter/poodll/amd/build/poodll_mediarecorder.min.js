define(["jquery","core/log","filter_poodll/utils_amd","filter_poodll/adapter","filter_poodll/uploader","filter_poodll/hermes","filter_poodll/timer","filter_poodll/audioanalyser","filter_poodll/msr_poodll","filter_poodll/dlg_errordisplay","filter_poodll/dlg_download","filter_poodll/speech_poodll","filter_poodll/poodll_mediaskins"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){"use strict";return b.debug("PoodLL Media Recorder: initialising"),{instanceprops:[],skins:[],laststream:[],fetch_instanceprops:function(a){return this.instanceprops[a]},fetch_skin:function(a){return this.skins[a]},is_ios:function(){return c.is_ios()},supports_current_browser:function(a){var d=0==M.cfg.wwwroot.indexOf("https:")||0==M.cfg.wwwroot.indexOf("http://localhost");if(!d)return!1;if("audio"!=a.mediatype&&"video"!=a.mediatype)return!1;var e=c.can_html5_record(a.mediatype);return e&&b.debug("PoodLL Media Recorder: supports this browser"),e},embed:function(a,c){var d=this,h="filter_poodll_controlbar_"+c.widgetid;this.init_instance_props(h);var i=this.fetch_instanceprops(h);i.config=c,i.controlbarid=h,c.hideupload?i.showupload=!1:i.showupload=!0,i.timeinterval=c.media_timeinterval,i.audiomimetype=c.media_audiomimetype,i.videorecordertype=c.media_videorecordertype,i.videocaptureheight=c.media_videocaptureheight,i.errordialog=j.clone(),i.errordialog.init(i),i.downloaddialog=k.clone(),i.downloaddialog.init(this,i),i.config.hermes=f.clone(),i.config.hermes.init(c.id,c.allowedURL,c.iframeembed);var l=this.init_skin(h,i.config.media_skin,i);switch(i.config.speechevents&&i.speechrec.will_work_ok(i.config)?(i.config.language||(i.config.language="en-US"),i.speechrec.init(i.config),i.speechrec.onfinalspeechcapture=function(a,b){var c={};c.type="speech",c.capturedspeech=a,c.speechresults=b,i.config.hermes.postMessage(c),l.hasOwnProperty("onfinalspeechcapture")&&l.onfinalspeechcapture(a,b)}):(b.debug("turning off speech events. not req. or not supported."),i.config.speechevents=!1),i.config.onuploadsuccess=function(a){d.onUploadSuccess(a,l)},i.config.onuploadfailure=function(a){d.onUploadFailure(a,l)},c.mediatype){case"audio":var m=l.fetch_preview_audio(c.media_skin),n=l.fetch_resource_audio(c.media_skin);i.controlbar=this.fetch_controlbar_audio(a,h,m,n),i.uploader=e.clone();var o=l.fetch_uploader_skin(i.controlbarid,a);if(i.uploader.init(a,c,o),this.register_events_audio(h),"upload"==i.config.media_skin||"warning"==i.config.media_skin)break;navigator.mediaDevices.getUserMedia({audio:!0}).then(function(a){b.debug("successfully forced permissions and got user media")})["catch"](function(a){b.debug("location 9998"),b.debug(a),i.errordialog.open(a)});break;case"video":var m=l.fetch_preview_video(c.media_skin),n=l.fetch_resource_video(c.media_skin);i.controlbar=this.fetch_controlbar_video(a,h,m,n),i.uploader=e.clone();var o=l.fetch_uploader_skin(i.controlbarid,a);if(i.uploader.init(a,c,o),this.register_events_video(h),"upload"==i.config.media_skin||"warning"==i.config.media_skin||"screen"==i.config.media_skin)break;navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then(function(a){d.restream_preview_video_player(h,a)})["catch"](function(a){b.debug("location 9999"),b.debug(a)})}return i.timer=g.clone(),i.timer.init(i.config.timelimit,function(){l.handle_timer_update(h)}),l.handle_timer_update(h),l},init_instance_props:function(a){this.instanceprops[a]={},this.instanceprops[a].recorded_index=0,this.instanceprops[a].mediaRecorder=null,this.instanceprops[a].blobs=[],this.instanceprops[a].timeinterval=1e3,this.instanceprops[a].audiomimetype="audio/webm",this.instanceprops[a].videorecordertype="auto",this.instanceprops[a].videocapturewidth=320,this.instanceprops[a].videocaptureheight=240,this.instanceprops[a].controlbar="",this.instanceprops[a].previewvolume=1,this.instanceprops[a].timer={},this.instanceprops[a].timer={},this.instanceprops[a].showupload=!0,this.instanceprops[a].uploader={},this.instanceprops[a].uploaded=!1,this.instanceprops[a].useraudiodeviceid=!1,this.instanceprops[a].uservideodeviceid=!1,this.instanceprops[a].devices=[];var c=window.AudioContext||window.webkitAudioContext||!1;if("undefined"==typeof window.poodllmediarecorder_actx){var d=new c;window.poodllmediarecorder_actx=d,window.poodllmediarecorder_actx_cnt=1}else if(6==window.poodllmediarecorder_actx_cnt){var d=window.poodllmediarecorder_actx;b.debug("More than 6 contexts, reusing first one. visualizations might go weird")}else{var d=new c;window.poodllmediarecorder_actx_cnt+=1}this.instanceprops[a].audioctx=d;var e=h.clone();e.init(d),this.instanceprops[a].audioanalyser=e,this.instanceprops[a].previewstillcold=!0,this.instanceprops[a].speechrec=l.clone()},init_skin:function(a,b,c){return this.skins[a]=m.fetch_skin_clone(b),this.skins[a].init(c,this),this.skins[a]},onUploadSuccess:function(a,c){b.debug("from poodllmediarecorder: uploadsuccess");var d="filter_poodll_controlbar_"+a;c.onUploadSuccess(d)},onUploadFailure:function(a,c){b.debug("from poodllmediarecorder: uploadfailure");var d="filter_poodll_controlbar_"+a;c.onUploadFailure(d),c.fetch_instanceprops().downloaddialog.open(c.pmr,c.instanceprops)},onMediaError:function(a,c){c.hasOwnProperty("errordialog")&&c.errordialog.open(a),b.error("media error",a)},captureUserMedia:function(a,b,c){navigator.mediaDevices.getUserMedia(a).then(b)["catch"](c)},warmup_context:function(a){var b=a.audioctx;"suspended"==b.state&&b.resume();var c=b.createBuffer(1,1,22050),d=b.createBufferSource();d.buffer=c,d.connect(b.destination),d.start(0)},warmup_preview:function(a){var c=a.controlbar.preview;if(a.previewstillcold&&c&&c.get(0)){var d=a.controlbar.preview[0].play();void 0!==d&&d.then(function(){})["catch"](function(a){b.debug(a)}),a.previewstillcold=!1}},do_start_audio:function(a,b){var c=this;switch(this.warmup_context(a),this.warmup_preview(a),a.controlbar.preview[0].muted=!0,a.blobs=[],a.config.mediatype){case"audio":var d=this.fetch_audio_constraints(a);break;case"video":var d=this.fetch_video_constraints(a)}this.captureUserMedia(d,b,function(b){c.onMediaError(b,a)})},do_start_screen:function(a,b){var c=this;this.warmup_context(a),this.warmup_preview(a),a.controlbar.preview[0].muted=!0,a.blobs=[];var d={audio:{echoCancellation:!0},video:{cursor:"motion"}};navigator.mediaDevices.getDisplayMedia(d).then(function(c){if(a.useraudiodeviceid){var e=a.useraudiodeviceid.valueOf();d.audio.deviceId=e?{exact:e}:void 0}navigator.mediaDevices.getUserMedia({audio:d.audio,video:!1}).then(function(a){var d=c.getTracks().concat(a.getAudioTracks()),e=new MediaStream(d);b(e)})})["catch"](function(b){c.onMediaError(b,a)})},do_start_video:function(a,b){},do_stopplay_audio:function(a,b){switch(b.pause(),b.muted=!1,a.config.mediatype){case"audio":break;case"video":a.controlbar.hasOwnProperty("livepreview")&&(a.controlbar.preview.hide(),a.controlbar.preview=a.controlbar.livepreview,a.controlbar.preview.show())}},do_play_audio:function(d,e){d.blobs&&d.blobs.length>0&&(b.debug("playing type:"+d.blobs[0].type),b.debug(d.blobs),c.doConcatenateBlobs(d.blobs,function(c){b.debug(c);var e=URL.createObjectURL(c);switch(d.config.mediatype){case"audio":var f=d.controlbar.preview[0];break;case"video":d.controlbar.livepreview=d.controlbar.preview,d.controlbar.preview=d.controlbar.preview.clone().insertAfter(d.controlbar.preview);var f=d.controlbar.preview[0];d.controlbar.livepreview.hide()}f.src=e,f.controls=!1,f.volume=d.previewvolume,f.muted=!1,a(f).bind("ended",function(){d.controlbar.stopbutton.click()});var g=f.play();void 0!==g&&g.then(function(){})["catch"](function(a){b.debug("location: do_play_audio"),b.debug(a)})}))},do_play_video:function(a){},do_save_audio:function(a){a.blobs&&a.blobs.length>0&&(c.doConcatenateBlobs(a.blobs,function(b){a.uploader.uploadBlob(b,a.blobs[0].type)}),a.uploaded=!0,a.controlbar.startbutton.attr("disabled",!0))},do_save_video:function(a){},do_stop_audio:function(a){a.mediaRecorder.resume(),a.mediaRecorder.stop(),a.config.speechevents&&a.speechrec.stop();var b={};b.type="recording",b.action="stopped",a.config.hermes.postMessage(b)},do_stop_video:function(a){},do_stop_screen:function(a){},do_pause_audio:function(a){a.mediaRecorder.resume(),a.mediaRecorder.pause()},do_pause_video:function(a){},do_resume_audio:function(a){a.mediaRecorder.resume()},do_resume_video:function(a){},fetch_video_constraints:function(a){var b={audio:!c.is_opera()&&!c.is_edge(),video:{width:{ideal:640},height:{ideal:480}}};if(a.uservideodeviceid){var d=a.uservideodeviceid.valueOf(),e={deviceId:d?{exact:d}:void 0};e.width={ideal:640},e.height={ideal:480},b.video=e}if(a.useraudiodeviceid){var f=a.useraudiodeviceid.valueOf(),g={deviceId:f?{exact:f}:void 0};b.audio=g}return b},fetch_screen_constraints:function(a){var b={audio:!c.is_opera()&&!c.is_edge(),video:!0};if(a.uservideodeviceid){var d=a.uservideodeviceid.valueOf(),e={deviceId:d?{exact:d}:void 0};b.video=e}if(a.useraudiodeviceid){var f=a.useraudiodeviceid.valueOf(),e={deviceId:f?{exact:f}:void 0};b.audio=e}return b},fetch_audio_constraints:function(a){var b={audio:!0};if(c.is_safari()&&!a.useraudiodeviceid&&(a.audiomimetype="audio/wav"),a.useraudiodeviceid){var d={deviceId:a.useraudiodeviceid};b.audio=d}return b},register_events_audio:function(a){var b=this,c=this.fetch_instanceprops(a),d=this.skins[a],f=function(f){b.laststream[a]=f;var g="auto";if(c.config.hasOwnProperty("encoder")&&(g=c.config.encoder),c.mediaRecorder=i,c.mediaRecorder.init(f,c.audioctx,c.audioanalyser,c.config.mediatype,g),c.mediaRecorder.mimeType=c.audiomimetype,c.mediaRecorder.audioChannels=1,c.mediaRecorder.start(c.timeinterval,c.audioctx),c.mediaRecorder.ondataavailable=function(a){c.blobs.push(a)},!c.config.iframeembed&&c.config.callbackjs&&""!=c.config.callbackjs){var h=new Array;h[0]=c.config.widgetid,h[1]="started",h[2]=c.config.filename,h[3]=c.config.updatecontrol,h[4]=c.config.s3filename,"function"==typeof c.config.callbackjs?c.config.callbackjs(h):e.executeFunctionByName(c.config.callbackjs,window,h)}var j={};j.type="recording",j.action="started",c.config.hermes.postMessage(j),c.config.speechevents&&c.speechrec.start(f),d.onMediaSuccess_audio(a)};d.register_controlbar_events_audio(f,a)},register_events_video:function(a){var b=this,c=this.fetch_instanceprops(a),d=this.skins[a],f=function(f){b.restream_preview_video_player(a,f);var g="auto";if(c.config.hasOwnProperty("encoder")&&(g=c.config.encoder),c.mediaRecorder=i,c.mediaRecorder.init(f,c.audioctx,c.audioanalyser,c.config.mediatype,g),"mediarec"===c.videorecordertype&&(c.mediaRecorder.recorderType=MediaRecorderWrapper),c.mediaRecorder.videoWidth=c.videocapturewidth,c.mediaRecorder.videoHeight=c.videocaptureheight,c.mediaRecorder.start(c.timeinterval),c.mediaRecorder.ondataavailable=function(a){c.blobs.push(a)},!c.config.iframeembed&&c.config.callbackjs&&""!=c.config.callbackjs){var h=new Array;h[0]=c.config.widgetid,h[1]="started",h[2]=c.config.filename,h[3]=c.config.updatecontrol,h[4]=c.config.s3filename,"function"==typeof c.config.callbackjs?c.config.callbackjs(h):e.executeFunctionByName(c.config.callbackjs,window,h)}var j={};j.type="recording",j.action="started",c.config.hermes.postMessage(j),c.config.speechevents&&c.speechrec.start(f),d.onMediaSuccess_video(a)};d.register_controlbar_events_video(f,a)},tidy_old_stream:function(a){this.laststream[a]&&this.laststream[a].getTracks().forEach(function(a){a.stop()})},restream_preview_video_player:function(a,b){this.laststream[a]=b,this.init_video_preview(a),c.is_android()&&navigator.mediaDevices.enumerateDevices()},init_video_preview:function(a){var c=this.fetch_instanceprops(a),d=c.controlbar.preview[0];d.srcObject=this.laststream[a],d.controls=!1,d.volume=0;var e=d.play();void 0!==e&&e.then(function(){})["catch"](function(a){b.debug("location: init_video_preview"),b.debug(a)})},update_status:function(a){var b=this.fetch_instanceprops(a);b.controlbar.status.html(b.timer.fetch_display_time())},fetch_controlbar_audio:function(a,b,c,d){var e=(this.fetch_instanceprops(b),this.fetch_skin(b)),f=e.insert_controlbar_audio(a,b,c,d);return f},fetch_controlbar_video:function(a,b,c,d){var e=(this.fetch_instanceprops(b),this.fetch_skin(b)),f=e.insert_controlbar_video(a,b,c,d);return f},fetch_strings:function(){var b=[],c=["record","play","pause","continue","stop","save","restart","testmic","upload","recordagain","readytorecord","downloadfile"];return a.each(c,function(a,c){b["recui_"+c]=M.util.get_string("recui_"+c,"filter_poodll"),(b["recui_"+c].indexOf(",filter_poodll]]")>1||""==b["recui_"+c])&&(b["recui_"+c]=c)}),b}}});