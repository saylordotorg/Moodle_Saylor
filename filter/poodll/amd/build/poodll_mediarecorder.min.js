define ("filter_poodll/poodll_mediarecorder",["jquery","core/log","filter_poodll/utils_amd","filter_poodll/adapter","filter_poodll/uploader","filter_poodll/hermes","filter_poodll/timer","filter_poodll/audioanalyser","filter_poodll/msr_poodll","filter_poodll/dlg_errordisplay","filter_poodll/dlg_download","filter_poodll/speech_poodll","filter_poodll/poodll_mediaskins"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){"use strict";b.debug("PoodLL Media Recorder: initialising");return{instanceprops:[],skins:[],laststream:[],fetch_instanceprops:function fetch_instanceprops(a){return this.instanceprops[a]},fetch_skin:function fetch_skin(a){return this.skins[a]},is_ios:function is_ios(){return c.is_ios()},supports_current_browser:function supports_current_browser(a){var d=0==M.cfg.wwwroot.indexOf("https:")||0==M.cfg.wwwroot.indexOf("http://localhost");if(!d){return!1}if("audio"!=a.mediatype&&"video"!=a.mediatype){return!1}var e=c.can_html5_record(a.mediatype);if(e){b.debug("PoodLL Media Recorder: supports this browser")}return e},embed:function embed(a,c){var d=this,h="filter_poodll_controlbar_"+c.widgetid;this.init_instance_props(h);var i=this.fetch_instanceprops(h);i.config=c;i.controlbarid=h;if(c.hideupload){i.showupload=!1}else{i.showupload=!0}i.timeinterval=c.media_timeinterval;i.audiomimetype=c.media_audiomimetype;i.videorecordertype=c.media_videorecordertype;i.videocaptureheight=c.media_videocaptureheight;i.errordialog=j.clone();i.errordialog.init(i);i.downloaddialog=k.clone();i.downloaddialog.init(this,i);i.config.hermes=f.clone();i.config.hermes.init(c.id,c.allowedURL,c.iframeembed);var l=this.init_skin(h,i.config.media_skin,i);if(i.config.speechevents&&i.speechrec.will_work_ok(i.config)){if(!i.config.language){i.config.language="en-US"}i.speechrec.init(i.config);i.speechrec.onfinalspeechcapture=function(a,b){i.config.hermes.postMessage({type:"speech",capturedspeech:a,speechresults:b});if(l.hasOwnProperty("onfinalspeechcapture")){l.onfinalspeechcapture(a,b)}}}else{b.debug("turning off speech events. not req. or not supported.");i.config.speechevents=!1}i.config.onuploadsuccess=function(a){d.onUploadSuccess(a,l)};i.config.onuploadfailure=function(a){d.onUploadFailure(a,l)};switch(c.mediatype){case"audio":var m=l.fetch_preview_audio(c.media_skin),n=l.fetch_resource_audio(c.media_skin);i.controlbar=this.fetch_controlbar_audio(a,h,m,n);i.uploader=e.clone();var o=l.fetch_uploader_skin(i.controlbarid,a);i.uploader.init(a,c,o);this.register_events_audio(h);if("upload"==i.config.media_skin||"warning"==i.config.media_skin){break}navigator.mediaDevices.getUserMedia({audio:!0}).then(function(){b.debug("successfully forced permissions and got user media")}).catch(function(a){b.debug("location 9998");b.debug(a);i.errordialog.open(a)});break;case"video":var m=l.fetch_preview_video(c.media_skin),n=l.fetch_resource_video(c.media_skin);i.controlbar=this.fetch_controlbar_video(a,h,m,n);i.uploader=e.clone();var o=l.fetch_uploader_skin(i.controlbarid,a);i.uploader.init(a,c,o);this.register_events_video(h);if("upload"==i.config.media_skin||"warning"==i.config.media_skin){break}navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then(function(a){d.restream_preview_video_player(h,a)}).catch(function(a){b.debug("location 9999");b.debug(a)});break;}i.timer=g.clone();i.timer.init(i.config.timelimit,function(){l.handle_timer_update(h)});l.handle_timer_update(h);return l},init_instance_props:function init_instance_props(a){this.instanceprops[a]={};this.instanceprops[a].recorded_index=0;this.instanceprops[a].mediaRecorder=null;this.instanceprops[a].blobs=[];this.instanceprops[a].timeinterval=1e3;this.instanceprops[a].audiomimetype="audio/webm";this.instanceprops[a].videorecordertype="auto";this.instanceprops[a].videocapturewidth=320;this.instanceprops[a].videocaptureheight=240;this.instanceprops[a].controlbar="";this.instanceprops[a].previewvolume=1;this.instanceprops[a].timer={};this.instanceprops[a].timer={};this.instanceprops[a].showupload=!0;this.instanceprops[a].uploader={};this.instanceprops[a].uploaded=!1;this.instanceprops[a].useraudiodeviceid=!1;this.instanceprops[a].uservideodeviceid=!1;this.instanceprops[a].devices=[];var c=window.AudioContext||window.webkitAudioContext||!1;if("undefined"==typeof window.poodllmediarecorder_actx){var d=new c;window.poodllmediarecorder_actx=d;window.poodllmediarecorder_actx_cnt=1}else if(6==window.poodllmediarecorder_actx_cnt){var d=window.poodllmediarecorder_actx;b.debug("More than 6 contexts, reusing first one. visualizations might go weird")}else{var d=new c;window.poodllmediarecorder_actx_cnt+=1}this.instanceprops[a].audioctx=d;var e=h.clone();e.init(d);this.instanceprops[a].audioanalyser=e;this.instanceprops[a].previewstillcold=!0;this.instanceprops[a].speechrec=l.clone()},init_skin:function init_skin(a,b,c){this.skins[a]=m.fetch_skin_clone(b);this.skins[a].init(c,this);return this.skins[a]},onUploadSuccess:function onUploadSuccess(a,c){b.debug("from poodllmediarecorder: uploadsuccess");c.onUploadSuccess("filter_poodll_controlbar_"+a)},onUploadFailure:function onUploadFailure(a,c){b.debug("from poodllmediarecorder: uploadfailure");c.onUploadFailure("filter_poodll_controlbar_"+a);c.fetch_instanceprops().downloaddialog.open(c.pmr,c.instanceprops)},onMediaError:function onMediaError(a,c){if(c.hasOwnProperty("errordialog")){c.errordialog.open(a)}b.error("media error",a)},captureUserMedia:function captureUserMedia(a,b,c){navigator.mediaDevices.getUserMedia(a).then(b).catch(c)},warmup_context:function warmup_context(a){var b=a.audioctx;if("suspended"==b.state){b.resume()}var c=b.createBuffer(1,1,22050),d=b.createBufferSource();d.buffer=c;d.connect(b.destination);d.start(0)},warmup_preview:function warmup_preview(a){var c=a.controlbar.preview;if(a.previewstillcold&&c&&c.get(0)){var d=a.controlbar.preview[0].play();if(d!==void 0){d.then(function(){}).catch(function(a){b.debug(a)})}a.previewstillcold=!1}},do_start_audio:function do_start_audio(a,b){var c=this;this.warmup_context(a);this.warmup_preview(a);a.controlbar.preview[0].muted=!0;a.blobs=[];switch(a.config.mediatype){case"audio":var d=this.fetch_audio_constraints(a);break;case"video":var d=this.fetch_video_constraints(a);}this.captureUserMedia(d,b,function(b){c.onMediaError(b,a)})},do_start_video:function do_start_video(){},do_stopplay_audio:function do_stopplay_audio(a,b){b.pause();b.muted=!1;switch(a.config.mediatype){case"audio":break;case"video":if(a.controlbar.hasOwnProperty("livepreview")){a.controlbar.preview.hide();a.controlbar.preview=a.controlbar.livepreview;a.controlbar.preview.show()}}},do_play_audio:function do_play_audio(d){if(d.blobs&&0<d.blobs.length){b.debug("playing type:"+d.blobs[0].type);b.debug(d.blobs);c.doConcatenateBlobs(d.blobs,function(c){b.debug(c);var e=URL.createObjectURL(c);switch(d.config.mediatype){case"audio":var f=d.controlbar.preview[0];break;case"video":d.controlbar.livepreview=d.controlbar.preview;d.controlbar.preview=d.controlbar.preview.clone().insertAfter(d.controlbar.preview);var f=d.controlbar.preview[0];d.controlbar.livepreview.hide();}f.src=e;f.controls=!1;f.volume=d.previewvolume;f.muted=!1;a(f).bind("ended",function(){d.controlbar.stopbutton.click()});var g=f.play();if(g!==void 0){g.then(function(){}).catch(function(a){b.debug("location: do_play_audio");b.debug(a)})}})}},do_play_video:function do_play_video(){},do_save_audio:function do_save_audio(a){if(a.blobs&&0<a.blobs.length){c.doConcatenateBlobs(a.blobs,function(b){a.uploader.uploadBlob(b,a.blobs[0].type)});a.uploaded=!0;a.controlbar.startbutton.attr("disabled",!0)}},do_save_video:function do_save_video(){},do_stop_audio:function do_stop_audio(a){a.mediaRecorder.resume();a.mediaRecorder.stop();if(a.config.speechevents){a.speechrec.stop()}a.config.hermes.postMessage({type:"recording",action:"stopped"})},do_stop_video:function do_stop_video(){},do_pause_audio:function do_pause_audio(a){a.mediaRecorder.resume();a.mediaRecorder.pause()},do_pause_video:function do_pause_video(){},do_resume_audio:function do_resume_audio(a){a.mediaRecorder.resume()},do_resume_video:function do_resume_video(){},fetch_video_constraints:function fetch_video_constraints(a){var b={audio:!c.is_opera()&&!c.is_edge(),video:!0};if(a.uservideodeviceid){var d=a.uservideodeviceid.valueOf(),e={deviceId:d?{exact:d}:void 0};b.video=e}if(a.useraudiodeviceid){var f=a.useraudiodeviceid.valueOf(),e={deviceId:f?{exact:f}:void 0};b.audio=e}return b},fetch_audio_constraints:function fetch_audio_constraints(a){var b={audio:!0};if(c.is_safari()&&!a.useraudiodeviceid){a.audiomimetype="audio/wav"}if(a.useraudiodeviceid){var d={deviceId:a.useraudiodeviceid};b.audio=d}return b},register_events_audio:function register_events_audio(a){var b=this,c=this.fetch_instanceprops(a),d=this.skins[a];d.register_controlbar_events_audio(function onMediaSuccess(e){b.laststream[a]=e;var f="auto";if(c.config.hasOwnProperty("encoder")){f=c.config.encoder}c.mediaRecorder=i;c.mediaRecorder.init(e,c.audioctx,c.audioanalyser,c.config.mediatype,f);c.mediaRecorder.mimeType=c.audiomimetype;c.mediaRecorder.audioChannels=1;c.mediaRecorder.start(c.timeinterval,c.audioctx);c.mediaRecorder.ondataavailable=function(a){c.blobs.push(a)};c.config.hermes.postMessage({type:"recording",action:"started"});if(c.config.speechevents){c.speechrec.start(e)}d.onMediaSuccess_audio(a)},a)},register_events_video:function register_events_video(a){var b=this,c=this.fetch_instanceprops(a),d=this.skins[a];d.register_controlbar_events_video(function onMediaSuccess(e){b.restream_preview_video_player(a,e);var f="auto";if(c.config.hasOwnProperty("encoder")){f=c.config.encoder}c.mediaRecorder=i;c.mediaRecorder.init(e,c.audioctx,c.audioanalyser,c.config.mediatype,f);if("mediarec"===c.videorecordertype){c.mediaRecorder.recorderType=MediaRecorderWrapper}c.mediaRecorder.videoWidth=c.videocapturewidth;c.mediaRecorder.videoHeight=c.videocaptureheight;c.mediaRecorder.start(c.timeinterval);c.mediaRecorder.ondataavailable=function(a){c.blobs.push(a)};c.config.hermes.postMessage({type:"recording",action:"started"});if(c.config.speechevents){c.speechrec.start(e)}d.onMediaSuccess_video(a)},a)},tidy_old_stream:function tidy_old_stream(a){if(this.laststream[a]){this.laststream[a].getTracks().forEach(function(a){a.stop()})}},restream_preview_video_player:function restream_preview_video_player(a,b){this.laststream[a]=b;this.init_video_preview(a);if(c.is_android()){navigator.mediaDevices.enumerateDevices()}},init_video_preview:function init_video_preview(a){var c=this.fetch_instanceprops(a),d=c.controlbar.preview[0];d.srcObject=this.laststream[a];d.controls=!1;d.volume=0;var e=d.play();if(e!==void 0){e.then(function(){}).catch(function(a){b.debug("location: init_video_preview");b.debug(a)})}},update_status:function update_status(a){var b=this.fetch_instanceprops(a);b.controlbar.status.html(b.timer.fetch_display_time())},fetch_controlbar_audio:function fetch_controlbar_audio(a,b,c,d){var e=this.fetch_instanceprops(b),f=this.fetch_skin(b),g=f.insert_controlbar_audio(a,b,c,d);return g},fetch_controlbar_video:function fetch_controlbar_video(a,b,c,d){var e=this.fetch_instanceprops(b),f=this.fetch_skin(b),g=f.insert_controlbar_video(a,b,c,d);return g},fetch_strings:function fetch_strings(){var b=[];a.each(["record","play","pause","continue","stop","save","restart","testmic","upload","recordagain","readytorecord","downloadfile"],function(a,c){b["recui_"+c]=M.util.get_string("recui_"+c,"filter_poodll");if(1<b["recui_"+c].indexOf(",filter_poodll]]")||""==b["recui_"+c]){b["recui_"+c]=c}});return b}}});
//# sourceMappingURL=poodll_mediarecorder.min.js.map
