define ("filter_poodll/s3multipartupload",["jquery","core/log"],function(a,b){"use strict";b.debug("Filter PoodLL: s3multipartupload initialising");return{PART_SIZE:10485760,SERVER_LOC:"?",completed:!1,file:null,fileInfo:null,sendBackData:null,uploadXHR:[],partURLs:[],byterate:[],lastUploadedSize:[],lastUploadedTime:[],loaded:[],total:[],init:function init(a){this.completed=!1;this.file=a;this.fileInfo={name:this.file.name,type:this.file.type,size:this.file.size,lastModifiedDate:this.file.lastModifiedDate};this.sendBackData=null;this.uploadXHR=[];this.byterate=[];this.lastUploadedSize=[];this.lastUploadedTime=[];this.loaded=[];this.total=[]},createMultipartUpload:function createMultipartUpload(){var a=new XMLHttpRequest,c=this;a.onreadystatechange=function(){if(4===this.readyState){if(200==a.status){var d=a.responseText,e=JSON.parse(d);if(e){if(0<e.returnCode){var f={id:c.config.id,type:"error",code:e.returnCode,message:e.returnMessage};c.config.hermes.postMessage(f)}else{c.partURLs=e.partURLs;c.config.allowedURL=e.allowedURL;c.config.posturl=e.postURL;c.config.filename=e.filename;c.config.s3filename=e.s3filename;c.config.s3root=e.s3root;c.config.cloudfilename=e.shortfilename;c.config.cloudroot=e.shortroot;c.sendAll()}}else{b.debug("error:"+e.message)}}else{b.debug("Not 200 response:"+a.status)}}};var d=this.prepareParts(),e="wstoken="+this.config.wstoken+"&wsfunction="+"local_cpapi_fetch_multipartupload_details"+"&moodlewsrestformat="+this.config.moodlewsrestformat+"&mediatype="+this.config.mediatype+"&parts="+d,f=M.cfg.wwwroot+"/webservice/rest/server.php";a.open("POST",f,!0);a.setRequestHeader("Cache-Control","no-cache");a.setRequestHeader("Content-Type","application/x-www-form-urlencoded");a.send(e)},doMultipartUpload:function doMultipartUpload(){var a=new XMLHttpRequest,c=this;a.onreadystatechange=function(){if(4===this.readyState){if(200==a.status){var d=a.responseText,e=JSON.parse(d);if(e){if(0<e.returnCode){var f={id:c.config.id,type:"error",code:e.returnCode,message:e.returnMessage};c.config.hermes.postMessage(f)}else{c.partURLs=e.partURLs;c.config.allowedURL=e.allowedURL;c.config.posturl=e.postURL;c.config.filename=e.filename;c.config.s3filename=e.s3filename;c.config.s3root=e.s3root;c.config.cloudfilename=e.shortfilename;c.config.cloudroot=e.shortroot;c.sendAll()}}else{b.debug("error:"+e.message)}}else{b.debug("Not 200 response:"+a.status)}}};var d=this.prepareParts(),e="wstoken="+this.config.wstoken+"&wsfunction="+"local_cpapi_fetch_multipartupload_urls"+"&moodlewsrestformat="+this.config.moodlewsrestformat+"&mediatype="+this.config.mediatype+"&parts="+d,f=M.cfg.wwwroot+"/webservice/rest/server.php";a.open("POST",f,!0);a.setRequestHeader("Cache-Control","no-cache");a.setRequestHeader("Content-Type","application/x-www-form-urlencoded");a.send(e)},start:function start(){this.createMultipartUpload()},prepareParts:function prepareParts(){var a=this.blobs=[];this.partURLs=[];var b=0,c=[],d,e,f=0;while(b<this.file.size){d=Math.min(b+this.PART_SIZE,this.file.size);filePart=this.file.slice(b,d);if(0<filePart.size)a.push(filePart);b=this.PART_SIZE*++f}for(var g=0;g<a.length;g++){e=a[g];c[g]={};c[g].partNumber=g+1;c[g].contentLength=e.size}return c},sendAll:function sendAll(){for(var a=this.blobs,b=a.length,c=0;c<b;c++){this.sendToS3(partURLs[c],a[c],c)}},sendToS3:function sendToS3(a,b,c){var d=this,f=b.size,g=d.uploadXHR[c]=new XMLHttpRequest;g.onreadystatechange=function(){if(4===g.readyState){if(200!==g.status){d.updateProgress();d.onS3UploadError(g);return}d.updateProgress()}};g.upload.onprogress=function(a){if(a.lengthComputable){d.total[c]=f;d.loaded[c]=a.loaded;if(d.lastUploadedTime[c]){var b=(new Date().getTime()-d.lastUploadedTime[c])/1e3;if(.005<b){var e=(d.loaded[c]-d.lastUploadedSize[c])/b;d.byterate[c]=e;d.lastUploadedTime[c]=new Date().getTime();d.lastUploadedSize[c]=d.loaded[c]}}else{d.byterate[c]=0;d.lastUploadedTime[c]=new Date().getTime();d.lastUploadedSize[c]=d.loaded[c]}if(0==c||d.total[0]==d.loaded[0])d.updateProgress()}};g.open("PUT",a,!0);g.send(b)},cancel:function cancel(){for(var b=this,c=0;c<this.uploadXHR.length;++c){this.uploadXHR[c].abort()}a.post(b.SERVER_LOC,{command:"abort",sendBackData:b.sendBackData}).done(function(){})},completeMultipartUpload:function completeMultipartUpload(){var b=this;if(this.completed)return;this.completed=!0;a.post(b.SERVER_LOC,{command:"complete",sendBackData:b.sendBackData}).done(function(a){b.onUploadCompleted(a)}).fail(function(a,c,d){b.onServerError("complete",a,c,d)})},updateProgress:function updateProgress(){for(var a=0,b=0,c=0,d=1,e=0;e<this.total.length;++e){b+=+this.loaded[e]||0;a+=this.total[e];if(this.loaded[e]!=this.total[e]){c+=+this.byterate[e]||0;d=0}}if(d)this.completeMultipartUpload();a=this.fileInfo.size;this.onProgressChanged(b,a,c)},onServerError:function onServerError(){},onS3UploadError:function onS3UploadError(){},onProgressChanged:function onProgressChanged(){},onUploadCompleted:function onUploadCompleted(){},onPrepareCompleted:function onPrepareCompleted(){}}});
//# sourceMappingURL=s3multipartupload.min.js.map
