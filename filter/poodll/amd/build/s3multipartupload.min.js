define(["jquery","core/log"],function(a,b){"use strict";return b.debug("Filter PoodLL: s3multipartupload initialising"),{PART_SIZE:10485760,SERVER_LOC:"?",completed:!1,file:null,fileInfo:null,sendBackData:null,uploadXHR:[],partURLs:[],byterate:[],lastUploadedSize:[],lastUploadedTime:[],loaded:[],total:[],init:function(a){this.completed=!1,this.file=a,this.fileInfo={name:this.file.name,type:this.file.type,size:this.file.size,lastModifiedDate:this.file.lastModifiedDate},this.sendBackData=null,this.uploadXHR=[],this.byterate=[],this.lastUploadedSize=[],this.lastUploadedTime=[],this.loaded=[],this.total=[]},createMultipartUpload:function(){var a="local_cpapi_fetch_multipartupload_details",c=new XMLHttpRequest,d=this;c.onreadystatechange=function(a){if(4===this.readyState)if(200==c.status){var e=c.responseText,f=JSON.parse(e);if(f){if(f.returnCode>0){var g={};return g.id=d.config.id,g.type="error",g.code=f.returnCode,g.message=f.returnMessage,void d.config.hermes.postMessage(g)}d.partURLs=f.partURLs,d.config.allowedURL=f.allowedURL,d.config.posturl=f.postURL,d.config.filename=f.filename,d.config.s3filename=f.s3filename,d.config.s3root=f.s3root,d.config.cloudfilename=f.shortfilename,d.config.cloudroot=f.shortroot,d.sendAll()}else b.debug("error:"+f.message)}else b.debug("Not 200 response:"+c.status)};var e=this.prepareParts(),f="wstoken="+this.config.wstoken+"&wsfunction="+a+"&moodlewsrestformat="+this.config.moodlewsrestformat+"&mediatype="+this.config.mediatype+"&parts="+e,g=M.cfg.wwwroot+"/webservice/rest/server.php";c.open("POST",g,!0),c.setRequestHeader("Cache-Control","no-cache"),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.send(f)},doMultipartUpload:function(){var a="local_cpapi_fetch_multipartupload_urls",c=new XMLHttpRequest,d=this;c.onreadystatechange=function(a){if(4===this.readyState)if(200==c.status){var e=c.responseText,f=JSON.parse(e);if(f){if(f.returnCode>0){var g={};return g.id=d.config.id,g.type="error",g.code=f.returnCode,g.message=f.returnMessage,void d.config.hermes.postMessage(g)}d.partURLs=f.partURLs,d.config.allowedURL=f.allowedURL,d.config.posturl=f.postURL,d.config.filename=f.filename,d.config.s3filename=f.s3filename,d.config.s3root=f.s3root,d.config.cloudfilename=f.shortfilename,d.config.cloudroot=f.shortroot,d.sendAll()}else b.debug("error:"+f.message)}else b.debug("Not 200 response:"+c.status)};var e=this.prepareParts(),f="wstoken="+this.config.wstoken+"&wsfunction="+a+"&moodlewsrestformat="+this.config.moodlewsrestformat+"&mediatype="+this.config.mediatype+"&parts="+e,g=M.cfg.wwwroot+"/webservice/rest/server.php";c.open("POST",g,!0),c.setRequestHeader("Cache-Control","no-cache"),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.send(f)},start:function(){this.createMultipartUpload()},prepareParts:function(){var a=this.blobs=[];this.partURLs=[];for(var b,c,d=0,e=[],f=0;d<this.file.size;)b=Math.min(d+this.PART_SIZE,this.file.size),filePart=this.file.slice(d,b),filePart.size>0&&a.push(filePart),d=this.PART_SIZE*++f;for(var g=0;g<a.length;g++)c=a[g],e[g]={},e[g].partNumber=g+1,e[g].contentLength=c.size;return e},sendAll:function(){for(var a=this.blobs,b=a.length,c=0;c<b;c++)this.sendToS3(partURLs[c],a[c],c)},sendToS3:function(a,b,c){var d=this,e=b.size,f=d.uploadXHR[c]=new XMLHttpRequest;f.onreadystatechange=function(){if(4===f.readyState){if(200!==f.status)return d.updateProgress(),void d.onS3UploadError(f);d.updateProgress()}},f.upload.onprogress=function(a){if(a.lengthComputable){if(d.total[c]=e,d.loaded[c]=a.loaded,d.lastUploadedTime[c]){var b=((new Date).getTime()-d.lastUploadedTime[c])/1e3;if(b>.005){var f=(d.loaded[c]-d.lastUploadedSize[c])/b;d.byterate[c]=f,d.lastUploadedTime[c]=(new Date).getTime(),d.lastUploadedSize[c]=d.loaded[c]}}else d.byterate[c]=0,d.lastUploadedTime[c]=(new Date).getTime(),d.lastUploadedSize[c]=d.loaded[c];0!=c&&d.total[0]!=d.loaded[0]||d.updateProgress()}},f.open("PUT",a,!0),f.send(b)},cancel:function(){for(var b=this,c=0;c<this.uploadXHR.length;++c)this.uploadXHR[c].abort();a.post(b.SERVER_LOC,{command:"abort",sendBackData:b.sendBackData}).done(function(a){})},completeMultipartUpload:function(){var b=this;this.completed||(this.completed=!0,a.post(b.SERVER_LOC,{command:"complete",sendBackData:b.sendBackData}).done(function(a){b.onUploadCompleted(a)}).fail(function(a,c,d){b.onServerError("complete",a,c,d)}))},updateProgress:function(){for(var a=0,b=0,c=0,d=1,e=0;e<this.total.length;++e)b+=+this.loaded[e]||0,a+=this.total[e],this.loaded[e]!=this.total[e]&&(c+=+this.byterate[e]||0,d=0);d&&this.completeMultipartUpload(),a=this.fileInfo.size,this.onProgressChanged(b,a,c)},onServerError:function(a,b,c,d){},onS3UploadError:function(a){},onProgressChanged:function(a,b,c){},onUploadCompleted:function(a){},onPrepareCompleted:function(){}}});