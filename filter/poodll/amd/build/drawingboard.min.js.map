{"version":3,"file":"drawingboard.min.js","sources":["../src/drawingboard.js"],"sourcesContent":["define([], function() {\n\n// -- Original code starts here\n/* drawingboard.js v0.4.2 - https://github.com/Leimi/drawingboard.js\n* Copyright (c) 2013 Emmanuel Pelletier\n* Licensed MIT */\nvar DrawingBoard = {};\n/**\n * pass the id of the html element to put the drawing board into\n * and some options : {\n *\tcontrols: array of controls to initialize with the drawingboard. 'Colors', 'Size', and 'Navigation' by default\n *\t\tinstead of simple strings, you can pass an object to define a control opts\n *\t\tie ['Color', { Navigation: { reset: false }}]\n *\tcontrolsPosition: \"top left\" by default. Define where to put the controls: at the \"top\" or \"bottom\" of the canvas, aligned to \"left\"/\"right\"/\"center\"\n *\tbackground: background of the drawing board. Give a hex color or an image url \"#ffffff\" (white) by default\n *\tcolor: pencil color (\"#000000\" by default)\n *\tsize: pencil size (3 by default)\n *\twebStorage: 'session', 'local' or false ('session' by default). store the current drawing in session or local storage and restore it when you come back\n *\tdroppable: true or false (false by default). If true, dropping an image on the canvas will include it and allow you to draw on it,\n *\terrorMessage: html string to put in the board's element on browsers that don't support canvas.\n * }\n */\nDrawingBoard.Board = function (id, opts) {\n    this.opts = $.extend({}, DrawingBoard.Board.defaultOpts, opts);\n\n    this.ev = new DrawingBoard.Utils.MicroEvent();\n\n    this.id = id;\n    this.$el = $(document.getElementById(id));\n    if (!this.$el.length)\n        return false;\n\n    var tpl = '<div class=\"drawing-board-canvas-wrapper\"></canvas><canvas class=\"drawing-board-canvas\"></canvas><div class=\"drawing-board-cursor drawing-board-utils-hidden\"></div></div>';\n    if (this.opts.controlsPosition.indexOf(\"bottom\") > -1) tpl += '<div class=\"drawing-board-controls\"></div>';\n    else tpl = '<div class=\"drawing-board-controls\"></div>' + tpl;\n\n    this.$el.addClass('drawing-board').append(tpl);\n    this.dom = {\n        $canvasWrapper: this.$el.find('.drawing-board-canvas-wrapper'),\n        $canvas: this.$el.find('.drawing-board-canvas'),\n        $cursor: this.$el.find('.drawing-board-cursor'),\n        $controls: this.$el.find('.drawing-board-controls')\n    };\n\n    $.each(['left', 'right', 'center'], $.proxy(function (n, val) {\n        if (this.opts.controlsPosition.indexOf(val) > -1) {\n            this.dom.$controls.attr('data-align', val);\n            return false;\n        }\n    }, this));\n\n    this.canvas = this.dom.$canvas.get(0);\n    this.ctx = this.canvas && this.canvas.getContext && this.canvas.getContext('2d') ? this.canvas.getContext('2d') : null;\n    this.color = this.opts.color;\n\n    if (!this.ctx) {\n        if (this.opts.errorMessage)\n            this.$el.html(this.opts.errorMessage);\n        return false;\n    }\n\n    this.storage = this._getStorage();\n\n    this.initHistory();\n    //init default board values before controls are added (mostly pencil color and size)\n    this.reset({webStorage: false, history: false, background: false});\n    //init controls (they will need the default board values to work like pencil color and size)\n    this.initControls();\n    //set board's size after the controls div is added\n    this.resize();\n    //reset the board to take all resized space\n    this.reset({webStorage: false, history: true, background: true});\n    this.restoreWebStorage();\n    this.initDropEvents();\n    this.initDrawEvents();\n};\n\n\nDrawingBoard.Board.defaultOpts = {\n    controls: ['Color', 'DrawingMode', 'Size', 'Navigation'],\n    controlsPosition: \"top left\",\n    color: \"#000000\",\n    size: 1,\n    background: \"#fff\",\n    eraserColor: \"background\",\n    webStorage: 'session',\n    droppable: false,\n    enlargeYourContainer: false,\n    errorMessage: \"<p>It seems you use an obsolete browser. <a href=\\\"http://browsehappy.com/\\\" target=\\\"_blank\\\">Update it</a> to start drawing.</p>\"\n};\n\n\nDrawingBoard.Board.prototype = {\n\n    /**\n     * Canvas reset/resize methods: put back the canvas to its default values\n     *\n     * depending on options, can set color, size, background back to default values\n     * and store the reseted canvas in webstorage and history queue\n     *\n     * resize values depend on the `enlargeYourContainer` option\n     */\n\n    reset: function (opts) {\n        opts = $.extend({\n            color: this.opts.color,\n            size: this.opts.size,\n            webStorage: true,\n            history: true,\n            background: false\n        }, opts);\n\n        this.setMode('pencil');\n\n        if (opts.background) this.resetBackground(this.opts.background, false);\n\n        if (opts.color) this.setColor(opts.color);\n        if (opts.size) this.ctx.lineWidth = opts.size;\n\n        this.ctx.lineCap = \"round\";\n        this.ctx.lineJoin = \"round\";\n        // this.ctx.clearRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.width);\n\n        if (opts.webStorage) this.saveWebStorage();\n\n        if (opts.history) this.saveHistory();\n\n        this.blankCanvas = this.getImg();\n\n        this.ev.trigger('board:reset', opts);\n    },\n\n    resetBackground: function (background, historize) {\n        background = background || this.opts.background;\n        historize = typeof historize !== \"undefined\" ? historize : true;\n        var bgIsColor = DrawingBoard.Utils.isColor(background);\n        var prevMode = this.getMode();\n        this.setMode('pencil');\n        this.ctx.clearRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.width);\n        if (bgIsColor) {\n            this.ctx.fillStyle = background;\n            this.ctx.fillRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height);\n        } else if (background)\n            this.setImg(background);\n        this.setMode(prevMode);\n        if (historize) this.saveHistory();\n    },\n\n    resize: function () {\n        this.dom.$controls.toggleClass('drawing-board-controls-hidden', (!this.controls || !this.controls.length));\n\n        var canvasWidth, canvasHeight;\n        var widths = [\n            this.$el.width(),\n            DrawingBoard.Utils.boxBorderWidth(this.$el),\n            DrawingBoard.Utils.boxBorderWidth(this.dom.$canvasWrapper, true, true)\n        ];\n        var heights = [\n            this.$el.height(),\n            DrawingBoard.Utils.boxBorderHeight(this.$el),\n            this.dom.$controls.height(),\n            DrawingBoard.Utils.boxBorderHeight(this.dom.$controls, false, true),\n            DrawingBoard.Utils.boxBorderHeight(this.dom.$canvasWrapper, true, true)\n        ];\n        var that = this;\n        var sum = function (values, multiplier) { //make the sum of all array values\n            multiplier = multiplier || 1;\n            var res = values[0];\n            for (var i = 1; i < values.length; i++) {\n                res = res + (values[i] * multiplier);\n            }\n            return res;\n        };\n        var sub = function (values) {\n            return sum(values, -1);\n        }; //substract all array values from the first one\n\n        if (this.opts.enlargeYourContainer) {\n            canvasWidth = this.$el.width();\n            canvasHeight = this.$el.height();\n\n            this.$el.width(sum(widths));\n            this.$el.height(sum(heights));\n        } else {\n            canvasWidth = sub(widths);\n            canvasHeight = sub(heights);\n        }\n\n        this.dom.$canvasWrapper.css('width', canvasWidth + 'px');\n        this.dom.$canvasWrapper.css('height', canvasHeight + 'px');\n\n        this.dom.$canvas.css('width', canvasWidth + 'px');\n        this.dom.$canvas.css('height', canvasHeight + 'px');\n\n        this.canvas.width = canvasWidth;\n        this.canvas.height = canvasHeight;\n    },\n\n\n    /**\n     * Controls:\n     * the drawing board can has various UI elements to control it.\n     * one control is represented by a class in the namespace DrawingBoard.Control\n     * it must have a $el property (jQuery object), representing the html element to append on the drawing board at initialization.\n     *\n     */\n\n    initControls: function () {\n        this.controls = [];\n        if (!this.opts.controls.length || !DrawingBoard.Control) return false;\n        for (var i = 0; i < this.opts.controls.length; i++) {\n            var c = null;\n            if (typeof this.opts.controls[i] == \"string\")\n                c = new window['DrawingBoard']['Control'][this.opts.controls[i]](this);\n            else if (typeof this.opts.controls[i] == \"object\") {\n                for (var controlName in this.opts.controls[i]) break;\n                c = new window['DrawingBoard']['Control'][controlName](this, this.opts.controls[i][controlName]);\n            }\n            if (c) {\n                this.addControl(c);\n            }\n        }\n    },\n\n    //add a new control or an existing one at the position you want in the UI\n    //to add a totally new control, you can pass a string with the js class as 1st parameter and control options as 2nd ie \"addControl('Navigation', { reset: false }\"\n    //the last parameter (2nd or 3rd depending on the situation) is always the position you want to place the control at\n    addControl: function (control, optsOrPos, pos) {\n        if (typeof control !== \"string\" && (typeof control !== \"object\" || !control instanceof DrawingBoard.Control))\n            return false;\n\n        var opts = typeof optsOrPos == \"object\" ? optsOrPos : {};\n        pos = pos ? pos * 1 : (typeof optsOrPos == \"number\" ? optsOrPos : null);\n\n        if (typeof control == \"string\")\n            control = new window['DrawingBoard']['Control'][control](this, opts);\n\n        if (pos)\n            this.dom.$controls.children().eq(pos).before(control.$el);\n        else\n            this.dom.$controls.append(control.$el);\n\n        if (!this.controls)\n            this.controls = [];\n        this.controls.push(control);\n        this.dom.$controls.removeClass('drawing-board-controls-hidden');\n    },\n\n\n    /**\n     * History methods: undo and redo drawed lines\n     */\n\n    initHistory: function () {\n        this.history = {\n            values: [],\n            position: 0\n        };\n    },\n\n    saveHistory: function () {\n        while (this.history.values.length > 30) {\n            this.history.values.shift();\n            this.history.position--;\n        }\n        if (this.history.position !== 0 && this.history.position < this.history.values.length) {\n            this.history.values = this.history.values.slice(0, this.history.position);\n            this.history.position++;\n        } else {\n            this.history.position = this.history.values.length + 1;\n        }\n        this.history.values.push(this.getImg());\n        this.ev.trigger('historyNavigation', this.history.position);\n    },\n\n    _goThroughHistory: function (goForth) {\n        if ((goForth && this.history.position == this.history.values.length) ||\n            (!goForth && this.history.position == 1))\n            return;\n        var pos = goForth ? this.history.position + 1 : this.history.position - 1;\n        if (this.history.values.length && this.history.values[pos - 1] !== undefined) {\n            this.history.position = pos;\n            this.setImg(this.history.values[pos - 1]);\n        }\n        this.ev.trigger('historyNavigation', pos);\n        this.saveWebStorage();\n    },\n\n    goBackInHistory: function () {\n        this._goThroughHistory(false);\n    },\n\n    goForthInHistory: function () {\n        this._goThroughHistory(true);\n    },\n\n\n    /**\n     * Image methods: you can directly put an image on the canvas, get it in base64 data url or start a download\n     */\n\n    setImg: function (src) {\n        var ctx = this.ctx;\n        var img = new Image();\n        var oldGCO = ctx.globalCompositeOperation;\n        img.onload = function () {\n            ctx.globalCompositeOperation = \"source-over\";\n            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.width);\n            ctx.drawImage(img, 0, 0);\n            ctx.globalCompositeOperation = oldGCO;\n        };\n        img.src = src;\n    },\n\n    getImg: function () {\n        return this.canvas.toDataURL(\"image/png\");\n    },\n\n    downloadImg: function () {\n        var img = this.getImg();\n        img = img.replace(\"image/png\", \"image/octet-stream\");\n        window.location.href = img;\n    },\n\n\n    /**\n     * WebStorage handling : save and restore to local or session storage\n     */\n\n    saveWebStorage: function () {\n        if (window[this.storage]) {\n            window[this.storage].setItem('drawing-board-' + this.id, this.getImg());\n            this.ev.trigger('board:save' + this.storage.charAt(0).toUpperCase() + this.storage.slice(1), this.getImg());\n        }\n    },\n\n    restoreWebStorage: function () {\n        if (window[this.storage] && window[this.storage].getItem('drawing-board-' + this.id) !== null) {\n            this.setImg(window[this.storage].getItem('drawing-board-' + this.id));\n            this.ev.trigger('board:restore' + this.storage.charAt(0).toUpperCase() + this.storage.slice(1), window[this.storage].getItem('drawing-board-' + this.id));\n        }\n    },\n\n    clearWebStorage: function () {\n        if (window[this.storage] && window[this.storage].getItem('drawing-board-' + this.id) !== null) {\n            window[this.storage].removeItem('drawing-board-' + this.id);\n            this.ev.trigger('board:clear' + this.storage.charAt(0).toUpperCase() + this.storage.slice(1));\n        }\n    },\n\n    _getStorage: function () {\n        if (!this.opts.webStorage || !(this.opts.webStorage === 'session' || this.opts.webStorage === 'local')) return false;\n        return this.opts.webStorage + 'Storage';\n    },\n\n\n    /**\n     * Drop an image on the canvas to draw on it\n     */\n\n    initDropEvents: function () {\n        if (!this.opts.droppable)\n            return false;\n\n        this.dom.$canvas.on('dragover dragenter drop', function (e) {\n            e.stopPropagation();\n            e.preventDefault();\n        });\n\n        this.dom.$canvas.on('drop', $.proxy(this._onCanvasDrop, this));\n    },\n\n    _onCanvasDrop: function (e) {\n        e = e.originalEvent ? e.originalEvent : e;\n        var files = e.dataTransfer.files;\n        if (!files || !files.length || files[0].type.indexOf('image') == -1 || !window.FileReader)\n            return false;\n        var fr = new FileReader();\n        fr.readAsDataURL(files[0]);\n        fr.onload = $.proxy(function (ev) {\n            this.setImg(ev.target.result);\n            this.ev.trigger('board:imageDropped', ev.target.result);\n            this.ev.trigger('board:userAction');\n            this.saveHistory();\n        }, this);\n    },\n\n\n    /**\n     * set and get current drawing mode\n     *\n     * possible modes are \"pencil\" (draw normally), \"eraser\" (draw transparent, like, erase, you know), \"filler\" (paint can)\n     */\n\n    setMode: function (newMode, silent) {\n        silent = silent || false;\n        newMode = newMode || 'pencil';\n\n        this.ev.unbind('board:startDrawing', $.proxy(this.fill, this));\n\n        if (this.opts.eraserColor === \"transparent\")\n            this.ctx.globalCompositeOperation = newMode === \"eraser\" ? \"destination-out\" : \"source-over\";\n        else {\n            if (newMode === \"eraser\") {\n                if (this.opts.eraserColor === \"background\" && DrawingBoard.Utils.isColor(this.opts.background))\n                    this.ctx.strokeStyle = this.opts.background;\n                else if (DrawingBoard.Utils.isColor(this.opts.eraserColor))\n                    this.ctx.strokeStyle = this.opts.eraserColor;\n            } else if (!this.mode || this.mode === \"eraser\") {\n                this.ctx.strokeStyle = this.color;\n            }\n\n            if (newMode === \"filler\")\n                this.ev.bind('board:startDrawing', $.proxy(this.fill, this));\n        }\n        this.mode = newMode;\n        if (!silent)\n            this.ev.trigger('board:mode', this.mode);\n    },\n\n    getMode: function () {\n        return this.mode || \"pencil\";\n    },\n\n    setColor: function (color) {\n        var that = this;\n        color = color || this.color;\n        if (!DrawingBoard.Utils.isColor(color))\n            return false;\n        this.color = color;\n        if (this.opts.eraserColor !== \"transparent\" && this.mode === \"eraser\") {\n            var setStrokeStyle = function (mode) {\n                if (mode !== \"eraser\")\n                    that.strokeStyle = that.color;\n                that.ev.unbind('board:mode', setStrokeStyle);\n            };\n            this.ev.bind('board:mode', setStrokeStyle);\n        } else\n            this.ctx.strokeStyle = this.color;\n    },\n\n    /**\n     * Fills an area with the current stroke color.\n     */\n    fill: function (e) {\n        if (this.getImg() === this.blankCanvas) {\n            this.ctx.clearRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.width);\n            this.ctx.fillStyle = this.color;\n            this.ctx.fillRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height);\n            return;\n        }\n\n        var img = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);\n\n        // constants identifying pixels components\n        var INDEX = 0, X = 1, Y = 2, COLOR = 3;\n\n        // target color components\n        var stroke = this.ctx.strokeStyle;\n        var r = parseInt(stroke.substr(1, 2), 16);\n        var g = parseInt(stroke.substr(3, 2), 16);\n        var b = parseInt(stroke.substr(5, 2), 16);\n\n        // starting point\n        var start = DrawingBoard.Utils.pixelAt(img, parseInt(e.coords.x, 10), parseInt(e.coords.y, 10));\n\n        // no need to continue if starting and target colors are the same\n        if (start[COLOR] === DrawingBoard.Utils.RGBToInt(r, g, b))\n            return;\n\n        // pixels to evaluate\n        var queue = [start];\n\n        // loop vars\n        var pixel, x, y;\n        var maxX = img.width - 1;\n        var maxY = img.height - 1;\n\n        while ((pixel = queue.pop())) {\n            if (pixel[COLOR] === start[COLOR]) {\n                img.data[pixel[INDEX]] = r;\n                img.data[pixel[INDEX] + 1] = g;\n                img.data[pixel[INDEX] + 2] = b;\n                if (pixel[X] > 0) // west\n                    queue.push(DrawingBoard.Utils.pixelAt(img, pixel[X] - 1, pixel[Y]));\n                if (pixel[X] < maxX) // east\n                    queue.push(DrawingBoard.Utils.pixelAt(img, pixel[X] + 1, pixel[Y]));\n                if (pixel[Y] > 0) // north\n                    queue.push(DrawingBoard.Utils.pixelAt(img, pixel[X], pixel[Y] - 1));\n                if (pixel[Y] < maxY) // south\n                    queue.push(DrawingBoard.Utils.pixelAt(img, pixel[X], pixel[Y] + 1));\n            }\n        }\n\n        this.ctx.putImageData(img, 0, 0);\n    },\n\n\n    /**\n     * Drawing handling, with mouse or touch\n     */\n\n    initDrawEvents: function () {\n        this.isDrawing = false;\n        this.isMouseHovering = false;\n        this.coords = {};\n        this.coords.old = this.coords.current = this.coords.oldMid = {x: 0, y: 0};\n\n        this.dom.$canvas.on('mousedown touchstart', $.proxy(function (e) {\n            this._onInputStart(e, this._getInputCoords(e));\n        }, this));\n\n        this.dom.$canvas.on('mousemove touchmove', $.proxy(function (e) {\n            this._onInputMove(e, this._getInputCoords(e));\n        }, this));\n\n        this.dom.$canvas.on('mousemove', $.proxy(function (e) {\n\n        }, this));\n\n        this.dom.$canvas.on('mouseup touchend', $.proxy(function (e) {\n            this._onInputStop(e, this._getInputCoords(e));\n        }, this));\n\n        this.dom.$canvas.on('mouseover', $.proxy(function (e) {\n            this._onMouseOver(e, this._getInputCoords(e));\n        }, this));\n\n        this.dom.$canvas.on('mouseout', $.proxy(function (e) {\n            this._onMouseOut(e, this._getInputCoords(e));\n\n        }, this));\n\n        $('body').on('mouseup touchend', $.proxy(function (e) {\n            this.isDrawing = false;\n        }, this));\n\n        if (window.requestAnimationFrame) requestAnimationFrame($.proxy(this.draw, this));\n    },\n\n    draw: function () {\n        //if the pencil size is big (>10), the small crosshair makes a friend: a circle of the size of the pencil\n        //todo: have the circle works on every browser - it currently should be added only when CSS pointer-events are supported\n        //we assume that if requestAnimationFrame is supported, pointer-events is too, but this is terribad.\n        if (window.requestAnimationFrame && this.ctx.lineWidth > 10 && this.isMouseHovering) {\n            this.dom.$cursor.css({width: this.ctx.lineWidth + 'px', height: this.ctx.lineWidth + 'px'});\n            var transform = DrawingBoard.Utils.tpl(\"translateX({{x}}px) translateY({{y}}px)\", {\n                x: this.coords.current.x - (this.ctx.lineWidth / 2),\n                y: this.coords.current.y - (this.ctx.lineWidth / 2)\n            });\n            this.dom.$cursor.css({'transform': transform, '-webkit-transform': transform, '-ms-transform': transform});\n            this.dom.$cursor.removeClass('drawing-board-utils-hidden');\n        } else {\n            this.dom.$cursor.addClass('drawing-board-utils-hidden');\n        }\n\n        if (this.isDrawing) {\n            var currentMid = this._getMidInputCoords(this.coords.current);\n            this.ctx.beginPath();\n            this.ctx.moveTo(currentMid.x, currentMid.y);\n            this.ctx.quadraticCurveTo(this.coords.old.x, this.coords.old.y, this.coords.oldMid.x, this.coords.oldMid.y);\n            this.ctx.stroke();\n\n            this.coords.old = this.coords.current;\n            this.coords.oldMid = currentMid;\n        }\n\n        if (window.requestAnimationFrame) requestAnimationFrame($.proxy(function () {\n            this.draw();\n        }, this));\n    },\n\n    _onInputStart: function (e, coords) {\n        this.coords.current = this.coords.old = coords;\n        this.coords.oldMid = this._getMidInputCoords(coords);\n        this.isDrawing = true;\n\n        if (!window.requestAnimationFrame) this.draw();\n\n        this.ev.trigger('board:startDrawing', {e: e, coords: coords});\n        e.preventDefault();\n    },\n\n    _onInputMove: function (e, coords) {\n        this.coords.current = coords;\n        this.ev.trigger('board:drawing', {e: e, coords: coords});\n\n        if (!window.requestAnimationFrame) this.draw();\n\n        e.preventDefault();\n    },\n\n    _onInputStop: function (e, coords) {\n        if (this.isDrawing && (!e.touches || e.touches.length === 0)) {\n            this.isDrawing = false;\n\n            this.saveWebStorage();\n            this.saveHistory();\n\n            this.ev.trigger('board:stopDrawing', {e: e, coords: coords});\n            this.ev.trigger('board:userAction');\n            e.preventDefault();\n        }\n    },\n\n    _onMouseOver: function (e, coords) {\n        this.isMouseHovering = true;\n        this.coords.old = this._getInputCoords(e);\n        this.coords.oldMid = this._getMidInputCoords(this.coords.old);\n\n        this.ev.trigger('board:mouseOver', {e: e, coords: coords});\n    },\n\n    _onMouseOut: function (e, coords) {\n        this.isMouseHovering = false;\n\n        this.ev.trigger('board:mouseOut', {e: e, coords: coords});\n    },\n\n    _getInputCoords: function (e) {\n        e = e.originalEvent ? e.originalEvent : e;\n        var x, y;\n        if (e.touches && e.touches.length == 1) {\n            x = e.touches[0].pageX;\n            y = e.touches[0].pageY;\n        } else {\n            x = e.pageX;\n            y = e.pageY;\n        }\n        return {\n            x: x - this.dom.$canvas.offset().left,\n            y: y - this.dom.$canvas.offset().top\n        };\n    },\n\n    _getMidInputCoords: function (coords) {\n        return {\n            x: this.coords.old.x + coords.x >> 1,\n            y: this.coords.old.y + coords.y >> 1\n        };\n    }\n};\n\nDrawingBoard.Control = function (drawingBoard, opts) {\n    this.board = drawingBoard;\n    this.opts = $.extend({}, this.defaults, opts);\n\n    this.$el = $(document.createElement('div')).addClass('drawing-board-control');\n    if (this.name)\n        this.$el.addClass('drawing-board-control-' + this.name);\n\n    this.board.ev.bind('board:reset', $.proxy(this.onBoardReset, this));\n\n    this.initialize.apply(this, arguments);\n    return this;\n};\n\nDrawingBoard.Control.prototype = {\n\n    name: '',\n\n    defaults: {},\n\n    initialize: function () {\n\n    },\n\n    addToBoard: function () {\n        this.board.addControl(this);\n    },\n\n    onBoardReset: function (opts) {\n\n    }\n\n};\n\n//extend directly taken from backbone.js\nDrawingBoard.Control.extend = function (protoProps, staticProps) {\n    var parent = this;\n    var child;\n    if (protoProps && protoProps.hasOwnProperty('constructor')) {\n        child = protoProps.constructor;\n    } else {\n        child = function () {\n            return parent.apply(this, arguments);\n        };\n    }\n    $.extend(child, parent, staticProps);\n    var Surrogate = function () {\n        this.constructor = child;\n    };\n    Surrogate.prototype = parent.prototype;\n    child.prototype = new Surrogate();\n    if (protoProps) $.extend(child.prototype, protoProps);\n    child.__super__ = parent.prototype;\n    return child;\n};\nDrawingBoard.Control.Color = DrawingBoard.Control.extend({\n    name: 'colors',\n\n    initialize: function () {\n        this.initTemplate();\n\n        var that = this;\n        this.$el.on('click', '.drawing-board-control-colors-picker', function (e) {\n            var color = $(this).attr('data-color');\n            that.board.setColor(color);\n            that.$el.find('.drawing-board-control-colors-current')\n                .css('background-color', color)\n                .attr('data-color', color);\n\n            that.board.ev.trigger('color:changed', color);\n            that.$el.find('.drawing-board-control-colors-rainbows').addClass('drawing-board-utils-hidden');\n\n            e.preventDefault();\n        });\n\n        this.$el.on('click', '.drawing-board-control-colors-current', function (e) {\n            that.$el.find('.drawing-board-control-colors-rainbows').toggleClass('drawing-board-utils-hidden');\n            e.preventDefault();\n        });\n\n        $('body').on('click', function (e) {\n            var $target = $(e.target);\n            var $relatedButton = $target.hasClass('drawing-board-control-colors-current') ? $target : $target.closest('.drawing-board-control-colors-current');\n            var $myButton = that.$el.find('.drawing-board-control-colors-current');\n            var $popup = that.$el.find('.drawing-board-control-colors-rainbows');\n            if ((!$relatedButton.length || $relatedButton.get(0) !== $myButton.get(0)) && !$popup.hasClass('drawing-board-utils-hidden'))\n                $popup.addClass('drawing-board-utils-hidden');\n        });\n    },\n\n    initTemplate: function () {\n        var tpl = '<div class=\"drawing-board-control-inner\">' +\n            '<div class=\"drawing-board-control-colors-current\" style=\"background-color: {{color}}\" data-color=\"{{color}}\"></div>' +\n            '<div class=\"drawing-board-control-colors-rainbows\">{{rainbows}}</div>' +\n            '</div>';\n        var oneColorTpl = '<div class=\"drawing-board-control-colors-picker\" data-color=\"{{color}}\" style=\"background-color: {{color}}\"></div>';\n        var rainbows = '';\n        $.each([0.75, 0.5, 0.25], $.proxy(function (key, val) {\n            var i = 0;\n            var additionalColor = null;\n            rainbows += '<div class=\"drawing-board-control-colors-rainbow\">';\n            if (val == 0.25) additionalColor = this._rgba(0, 0, 0, 1);\n            if (val == 0.5) additionalColor = this._rgba(150, 150, 150, 1);\n            if (val == 0.75) additionalColor = this._rgba(255, 255, 255, 1);\n            rainbows += DrawingBoard.Utils.tpl(oneColorTpl, {color: additionalColor.toString()});\n            while (i <= 330) {\n                rainbows += DrawingBoard.Utils.tpl(oneColorTpl, {color: this._hsl2Rgba(this._hsl(i - 60, 1, val)).toString()});\n                i += 30;\n            }\n            rainbows += '</div>';\n        }, this));\n\n        this.$el.append($(DrawingBoard.Utils.tpl(tpl, {color: this.board.color, rainbows: rainbows})));\n        this.$el.find('.drawing-board-control-colors-rainbows').addClass('drawing-board-utils-hidden');\n    },\n\n    onBoardReset: function (opts) {\n        this.board.setColor(this.$el.find('.drawing-board-control-colors-current').attr('data-color'));\n    },\n\n    _rgba: function (r, g, b, a) {\n        return {\n            r: r, g: g, b: b, a: a, toString: function () {\n                return \"rgba(\" + r + \", \" + g + \", \" + b + \", \" + a + \")\";\n            }\n        };\n    },\n\n    _hsl: function (h, s, l) {\n        return {\n            h: h, s: s, l: l, toString: function () {\n                return \"hsl(\" + h + \", \" + s * 100 + \"%, \" + l * 100 + \"%)\";\n            }\n        };\n    },\n\n    _hex2Rgba: function (hex) {\n        var num = parseInt(hex.substring(1), 16);\n        return this._rgba(num >> 16, num >> 8 & 255, num & 255, 1);\n    },\n\n    //conversion function (modified a bit) taken from http://mjijackson.com/2008/02/rgb-to-hsl-and-rgb-to-hsv-color-model-conversion-algorithms-in-javascript\n    _hsl2Rgba: function (hsl) {\n        var h = hsl.h / 360, s = hsl.s, l = hsl.l, r, g, b;\n\n        function hue2rgb(p, q, t) {\n            if (t < 0) t += 1;\n            if (t > 1) t -= 1;\n            if (t < 1 / 6) return p + (q - p) * 6 * t;\n            if (t < 1 / 2) return q;\n            if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;\n            return p;\n        }\n\n        if (s === 0) {\n            r = g = b = l; // achromatic\n        } else {\n            var q = l < 0.5 ? l * (1 + s) : l + s - l * s;\n            var p = 2 * l - q;\n            r = Math.floor((hue2rgb(p, q, h + 1 / 3)) * 255);\n            g = Math.floor((hue2rgb(p, q, h)) * 255);\n            b = Math.floor((hue2rgb(p, q, h - 1 / 3)) * 255);\n        }\n        return this._rgba(r, g, b, 1);\n    }\n});\nDrawingBoard.Control.DrawingMode = DrawingBoard.Control.extend({\n\n    name: 'drawingmode',\n\n    defaults: {\n        pencil: true,\n        eraser: true,\n        filler: true\n    },\n\n    initialize: function () {\n\n        this.prevMode = this.board.getMode();\n\n        $.each([\"pencil\", \"eraser\", \"filler\"], $.proxy(function (k, value) {\n            if (this.opts[value]) {\n                this.$el.append('<button class=\"drawing-board-control-drawingmode-' + value + '-button\" data-mode=\"' + value + '\"></button>');\n            }\n        }, this));\n\n        this.$el.on('click', 'button[data-mode]', $.proxy(function (e) {\n            var value = $(e.currentTarget).attr('data-mode');\n            var mode = this.board.getMode();\n            if (mode !== value) this.prevMode = mode;\n            var newMode = mode === value ? this.prevMode : value;\n            this.board.setMode(newMode);\n            e.preventDefault();\n        }, this));\n\n        this.board.ev.bind('board:mode', $.proxy(function (mode) {\n            this.toggleButtons(mode);\n        }, this));\n\n        this.toggleButtons(this.board.getMode());\n    },\n\n    toggleButtons: function (mode) {\n        this.$el.find('button[data-mode]').each(function (k, item) {\n            var $item = $(item);\n            $item.toggleClass('active', mode === $item.attr('data-mode'));\n        });\n    }\n\n});\n\nDrawingBoard.Control.Navigation = DrawingBoard.Control.extend({\n\n    name: 'navigation',\n\n    defaults: {\n        back: true,\n        forward: true,\n        reset: true\n    },\n\n    initialize: function () {\n        var el = '';\n        if (this.opts.back) el += '<button class=\"drawing-board-control-navigation-back\">&larr;</button>';\n        if (this.opts.forward) el += '<button class=\"drawing-board-control-navigation-forward\">&rarr;</button>';\n        if (this.opts.reset) el += '<button class=\"drawing-board-control-navigation-reset\">&times;</button>';\n        this.$el.append(el);\n\n        if (this.opts.back) {\n            var $back = this.$el.find('.drawing-board-control-navigation-back');\n            this.board.ev.bind('historyNavigation', $.proxy(function (pos) {\n                if (pos === 1)\n                    $back.attr('disabled', 'disabled');\n                else\n                    $back.removeAttr('disabled');\n            }, this));\n            this.$el.on('click', '.drawing-board-control-navigation-back', $.proxy(function (e) {\n                this.board.goBackInHistory();\n                e.preventDefault();\n            }, this));\n        }\n\n        if (this.opts.forward) {\n            var $forward = this.$el.find('.drawing-board-control-navigation-forward');\n            this.board.ev.bind('historyNavigation', $.proxy(function (pos) {\n                if (pos === this.board.history.values.length)\n                    $forward.attr('disabled', 'disabled');\n                else\n                    $forward.removeAttr('disabled');\n            }, this));\n            this.$el.on('click', '.drawing-board-control-navigation-forward', $.proxy(function (e) {\n                this.board.goForthInHistory();\n                e.preventDefault();\n            }, this));\n        }\n\n        if (this.opts.reset) {\n            this.$el.on('click', '.drawing-board-control-navigation-reset', $.proxy(function (e) {\n                this.board.reset({background: true});\n                e.preventDefault();\n            }, this));\n        }\n    }\n});\nDrawingBoard.Control.Size = DrawingBoard.Control.extend({\n\n    name: 'size',\n\n    defaults: {\n        type: \"auto\",\n        dropdownValues: [1, 3, 6, 10, 20, 30, 40, 50]\n    },\n\n    types: ['dropdown', 'range'],\n\n    initialize: function () {\n        if (this.opts.type == \"auto\")\n            this.opts.type = this._iHasRangeInput() ? 'range' : 'dropdown';\n        var tpl = $.inArray(this.opts.type, this.types) > -1 ? this['_' + this.opts.type + 'Template']() : false;\n        if (!tpl) return false;\n\n        this.val = this.board.opts.size;\n\n        this.$el.append($(tpl));\n        this.$el.attr('data-drawing-board-type', this.opts.type);\n        this.updateView();\n\n        var that = this;\n\n        if (this.opts.type == \"range\") {\n            this.$el.on('change', '.drawing-board-control-size-range-input', function (e) {\n                that.val = $(this).val();\n                that.updateView();\n\n                that.board.ev.trigger('size:changed', that.val);\n\n                e.preventDefault();\n            });\n        }\n\n        if (this.opts.type == \"dropdown\") {\n            this.$el.on('click', '.drawing-board-control-size-dropdown-current', $.proxy(function (e) {\n                this.$el.find('.drawing-board-control-size-dropdown').toggleClass('drawing-board-utils-hidden');\n            }, this));\n\n            this.$el.on('click', '[data-size]', function (e) {\n                that.val = parseInt($(this).attr('data-size'), 0);\n                that.updateView();\n\n                that.board.ev.trigger('size:changed', that.val);\n\n                e.preventDefault();\n            });\n        }\n    },\n\n    _rangeTemplate: function () {\n        var tpl = '<div class=\"drawing-board-control-inner\" title=\"{{size}}\">' +\n            '<input type=\"range\" min=\"1\" max=\"50\" value=\"{{size}}\" step=\"1\" class=\"drawing-board-control-size-range-input\">' +\n            '<span class=\"drawing-board-control-size-range-current\"></span>' +\n            '</div>';\n        return DrawingBoard.Utils.tpl(tpl, {size: this.board.opts.size});\n    },\n\n    _dropdownTemplate: function () {\n        var tpl = '<div class=\"drawing-board-control-inner\" title=\"{{size}}\">' +\n            '<div class=\"drawing-board-control-size-dropdown-current\"><span></span></div>' +\n            '<ul class=\"drawing-board-control-size-dropdown\">';\n        $.each(this.opts.dropdownValues, function (i, size) {\n            tpl += DrawingBoard.Utils.tpl(\n                '<li data-size=\"{{size}}\"><span style=\"width: {{size}}px; height: {{size}}px; border-radius: {{size}}px;\"></span></li>',\n                {size: size}\n            );\n        });\n        tpl += '</ul></div>';\n        return tpl;\n    },\n\n    onBoardReset: function (opts) {\n        this.updateView();\n    },\n\n    updateView: function () {\n        var val = this.val;\n        this.board.ctx.lineWidth = val;\n\n        this.$el.find('.drawing-board-control-size-range-current, .drawing-board-control-size-dropdown-current span').css({\n            width: val + 'px',\n            height: val + 'px',\n            borderRadius: val + 'px',\n            marginLeft: -1 * val / 2 + 'px',\n            marginTop: -1 * val / 2 + 'px'\n        });\n\n        this.$el.find('.drawing-board-control-inner').attr('title', val);\n\n        if (this.opts.type == 'dropdown') {\n            var closest = null;\n            $.each(this.opts.dropdownValues, function (i, size) {\n                if (closest === null || Math.abs(size - val) < Math.abs(closest - val))\n                    closest = size;\n            });\n            this.$el.find('.drawing-board-control-size-dropdown').addClass('drawing-board-utils-hidden');\n        }\n    },\n\n    _iHasRangeInput: function () {\n        var inputElem = document.createElement('input'),\n            smile = ':)',\n            docElement = document.documentElement,\n            inputElemType = 'range',\n            available;\n        inputElem.setAttribute('type', inputElemType);\n        available = inputElem.type !== 'text';\n        inputElem.value = smile;\n        inputElem.style.cssText = 'position:absolute;visibility:hidden;';\n        if (/^range$/.test(inputElemType) && inputElem.style.WebkitAppearance !== undefined) {\n            docElement.appendChild(inputElem);\n            defaultView = document.defaultView;\n            available = defaultView.getComputedStyle &&\n                defaultView.getComputedStyle(inputElem, null).WebkitAppearance !== 'textfield' &&\n                (inputElem.offsetHeight !== 0);\n            docElement.removeChild(inputElem);\n        }\n        return !!available;\n    }\n});\nDrawingBoard.Control.Download = DrawingBoard.Control.extend({\n\n    name: 'download',\n\n    initialize: function () {\n        this.$el.append('<button class=\"drawing-board-control-download-button\"></button>');\n        this.$el.on('click', '.drawing-board-control-download-button', $.proxy(function (e) {\n            this.board.downloadImg();\n            e.preventDefault();\n        }, this));\n    }\n\n});\nDrawingBoard.Utils = {};\n\n/*!\n* Tim (lite)\n*   github.com/premasagar/tim\n*/\n/*\n\tA tiny, secure JavaScript micro-templating script.\n*/\nDrawingBoard.Utils.tpl = (function () {\n    \"use strict\";\n\n    var start = \"{{\",\n        end = \"}}\",\n        path = \"[a-z0-9_][\\\\.a-z0-9_]*\", // e.g. config.person.name\n        pattern = new RegExp(start + \"\\\\s*(\" + path + \")\\\\s*\" + end, \"gi\"),\n        undef;\n\n    return function (template, data) {\n        // Merge data into the template string\n        return template.replace(pattern, function (tag, token) {\n            var path = token.split(\".\"),\n                len = path.length,\n                lookup = data,\n                i = 0;\n\n            for (; i < len; i++) {\n                lookup = lookup[path[i]];\n\n                // Property not found\n                if (lookup === undef) {\n                    throw \"tim: '\" + path[i] + \"' not found in \" + tag;\n                }\n\n                // Return the required value\n                if (i === len - 1) {\n                    return lookup;\n                }\n            }\n        });\n    };\n}());\n\n/**\n * https://github.com/jeromeetienne/microevent.js\n * MicroEvent - to make any js object an event emitter (server or browser)\n *\n * - pure javascript - server compatible, browser compatible\n * - dont rely on the browser doms\n * - super simple - you get it immediatly, no mistery, no magic involved\n *\n * - create a MicroEventDebug with goodies to debug\n *   - make it safer to use\n */\nDrawingBoard.Utils.MicroEvent = function () {\n};\n\nDrawingBoard.Utils.MicroEvent.prototype = {\n    bind: function (event, fct) {\n        this._events = this._events || {};\n        this._events[event] = this._events[event] || [];\n        this._events[event].push(fct);\n    },\n    unbind: function (event, fct) {\n        this._events = this._events || {};\n        if (event in this._events === false) return;\n        this._events[event].splice(this._events[event].indexOf(fct), 1);\n    },\n    trigger: function (event /* , args... */) {\n        this._events = this._events || {};\n        if (event in this._events === false) return;\n        for (var i = 0; i < this._events[event].length; i++) {\n            this._events[event][i].apply(this, Array.prototype.slice.call(arguments, 1));\n        }\n    }\n};\n\n//I know.\nDrawingBoard.Utils._boxBorderSize = function ($el, withPadding, withMargin, direction) {\n    withPadding = !!withPadding || true;\n    withMargin = !!withMargin || false;\n    var width = 0,\n        props;\n    if (direction == \"width\") {\n        props = ['border-left-width', 'border-right-width'];\n        if (withPadding) props.push('padding-left', 'padding-right');\n        if (withMargin) props.push('margin-left', 'margin-right');\n    } else {\n        props = ['border-top-width', 'border-bottom-width'];\n        if (withPadding) props.push('padding-top', 'padding-bottom');\n        if (withMargin) props.push('margin-top', 'margin-bottom');\n    }\n    for (var i = props.length - 1; i >= 0; i--)\n        width += parseInt($el.css(props[i]).replace('px', ''), 10);\n    return width;\n};\n\nDrawingBoard.Utils.boxBorderWidth = function ($el, withPadding, withMargin) {\n    return DrawingBoard.Utils._boxBorderSize($el, withPadding, withMargin, 'width');\n};\n\nDrawingBoard.Utils.boxBorderHeight = function ($el, withPadding, withMargin) {\n    return DrawingBoard.Utils._boxBorderSize($el, withPadding, withMargin, 'height');\n};\n\nDrawingBoard.Utils.isColor = function (string) {\n    if (!string || !string.length) return false;\n    return (/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i).test(string) || $.inArray(string.substring(0, 3), ['rgb', 'hsl']) !== -1;\n};\n\n/**\n * Packs an RGB color into a single integer.\n */\nDrawingBoard.Utils.RGBToInt = function (r, g, b) {\n    var c = 0;\n    c |= (r & 255) << 16;\n    c |= (g & 255) << 8;\n    c |= (b & 255);\n    return c;\n};\n\n/**\n * Returns informations on the pixel located at (x,y).\n */\nDrawingBoard.Utils.pixelAt = function (image, x, y) {\n    var i = (y * image.width + x) * 4;\n    var c = DrawingBoard.Utils.RGBToInt(\n        image.data[i],\n        image.data[i + 1],\n        image.data[i + 2]\n    );\n\n    return [\n        i, // INDEX\n        x, // X\n        y, // Y\n        c  // COLOR\n    ];\n};\n\n(function () {\n    var lastTime = 0;\n    var vendors = ['ms', 'moz', 'webkit', 'o'];\n    for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {\n        window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];\n        window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame'] || window[vendors[x] + 'CancelRequestAnimationFrame'];\n    }\n}());\n//original code stops here\n    var g;\n    if (typeof window !== \"undefined\") {\n        g = window\n    } else if (typeof global !== \"undefined\") {\n        g = global\n    } else if (typeof self !== \"undefined\") {\n        g = self\n    } else {\n        g = this\n    }\n    g.DrawingBoard = DrawingBoard;\n\n  // This is our factory method. Return our module object here...\n  return DrawingBoard;\n\n});\n"],"names":["define","pattern","DrawingBoard","Board","id","opts","$","extend","defaultOpts","ev","Utils","MicroEvent","$el","document","getElementById","this","length","tpl","controlsPosition","indexOf","addClass","append","dom","$canvasWrapper","find","$canvas","$cursor","$controls","each","proxy","n","val","attr","canvas","get","ctx","getContext","color","errorMessage","html","storage","_getStorage","initHistory","reset","webStorage","history","background","initControls","resize","restoreWebStorage","initDropEvents","initDrawEvents","controls","size","eraserColor","droppable","enlargeYourContainer","prototype","setMode","resetBackground","setColor","lineWidth","lineCap","lineJoin","saveWebStorage","saveHistory","blankCanvas","getImg","trigger","historize","bgIsColor","isColor","prevMode","getMode","clearRect","width","fillStyle","fillRect","height","setImg","canvasWidth","canvasHeight","toggleClass","widths","boxBorderWidth","heights","boxBorderHeight","sum","values","multiplier","res","i","sub","css","Control","c","window","_typeof","controlName","addControl","control","optsOrPos","pos","children","eq","before","push","removeClass","position","shift","slice","_goThroughHistory","goForth","undefined","goBackInHistory","goForthInHistory","src","img","Image","oldGCO","globalCompositeOperation","onload","drawImage","toDataURL","downloadImg","replace","location","href","setItem","charAt","toUpperCase","getItem","clearWebStorage","removeItem","on","e","stopPropagation","preventDefault","_onCanvasDrop","files","originalEvent","dataTransfer","type","FileReader","fr","readAsDataURL","target","result","newMode","silent","unbind","fill","strokeStyle","mode","bind","that","setStrokeStyle","getImageData","stroke","r","parseInt","substr","g","b","start","pixelAt","coords","x","y","RGBToInt","pixel","queue","maxX","maxY","pop","data","putImageData","isDrawing","isMouseHovering","old","current","oldMid","_onInputStart","_getInputCoords","_onInputMove","_onInputStop","_onMouseOver","_onMouseOut","requestAnimationFrame","draw","transform","currentMid","_getMidInputCoords","beginPath","moveTo","quadraticCurveTo","touches","pageX","pageY","offset","left","top","drawingBoard","board","defaults","createElement","name","onBoardReset","initialize","apply","arguments","addToBoard","protoProps","staticProps","child","parent","hasOwnProperty","constructor","Surrogate","__super__","Color","initTemplate","$target","$relatedButton","hasClass","closest","$myButton","$popup","oneColorTpl","rainbows","key","additionalColor","_rgba","toString","_hsl2Rgba","_hsl","a","h","s","l","_hex2Rgba","hex","num","substring","hsl","hue2rgb","p","q","t","Math","floor","DrawingMode","pencil","eraser","filler","k","value","currentTarget","toggleButtons","item","$item","Navigation","back","forward","el","$back","removeAttr","$forward","Size","dropdownValues","types","_iHasRangeInput","inArray","updateView","_rangeTemplate","_dropdownTemplate","borderRadius","marginLeft","marginTop","abs","available","inputElem","docElement","documentElement","setAttribute","style","cssText","test","WebkitAppearance","appendChild","defaultView","getComputedStyle","offsetHeight","removeChild","Download","RegExp","template","tag","token","path","split","len","lookup","undef","event","fct","_events","splice","Array","call","_boxBorderSize","withPadding","withMargin","direction","props","string","image","vendors","cancelAnimationFrame","global","self"],"mappings":"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"}