define(["jquery","core/log","filter_poodll/utils_amd","filter_poodll/dlg_devicesettings","filter_poodll/anim_progress_bar_fresh","filter_poodll/anim_hwave_fresh","filter_poodll/anim_hwave_timer","filter_poodll/upskin_text"],function(a,b,c,d,e,f,g,h){"use strict";return b.debug("PoodLL BMR Skin: initialising"),{instanceprops:null,pmr:null,uploaded:!1,devsettings:null,therecanim:null,canpause:!0,clone:function(){return a.extend(!0,{},this)},init:function(a,b){this.instanceprops=a,this.pmr=b,this.devsettings=d.clone(),this.devsettings.init(b,a)},fetch_instanceprops:function(){return this.instanceprops},onUploadSuccess:function(b){a("#"+b+" > .poodll_save-recording").hide(),a("#"+b+" > .poodll_savedsuccessfully").show()},onUploadFailure:function(a){},fetch_status_bar:function(a){var b='<div class="poodll_status_'+a+'">00:00:00</div>';return b},fetch_preview_audio:function(a){var b='<audio class="poodll_preview_'+a+'" style="display: none;" controls playsinline="playsinline" muted></audio>';return b},fetch_preview_video:function(a){var b='<video class="poodll_preview_'+a+'" playsinline="playsinline" muted></video>';return b},fetch_resource_audio:function(a){var b="";return b},fetch_resource_video:function(a){var b="";return b},fetch_uploader_skin:function(a,b){var c=this.fetch_instanceprops(),d=h.clone();return d.init(c.config,b,c.controlbar.bmr_progresscanvas,c.controlbar.status),d},onMediaError:function(a){console.error("media error",a)},onMediaSuccess_video:function(a){var b=this.fetch_instanceprops();b.uploader.Output(""),this.set_visual_mode("recordmode",a),b.timer.reset(),b.timer.start(),this.update_status(a)},onMediaSuccess_audio:function(a){var b=this.fetch_instanceprops();b.uploader.Output(""),b.controlbar.preview.attr("src",null),this.set_visual_mode("recordmode",a),this.therecanim.start(),b.timer.reset(),b.timer.start(),this.update_status(a)},handle_timer_update:function(a){var b=this.fetch_instanceprops();b.controlbar.status.html(b.timer.fetch_display_time()),0==b.timer.seconds&&b.timer.initseconds>0&&b.controlbar.startbutton.hasClass("poodll_in_progress")&&b.controlbar.startbutton.click()},update_status:function(a){var b=this.fetch_instanceprops();b.controlbar.status.html(b.timer.fetch_display_time())},set_visual_mode:function(a,b){var c=this,d=this.fetch_instanceprops();switch(this.visualmode=a,a){case"initmode":d.controlbar.statusText.text("Ready to record"),d.controlbar.status.html("00:00:00"),d.controlbar.stoprecbutton.attr("class","poodll_stop-recording_fresh poodll_fresh_stop_btn bmr_disabled"),d.controlbar.startbutton.attr("class","poodll_start-recording_fresh poodll_fresh_main_btn"),d.controlbar.playbutton.attr("class","poodll_play-recording_fresh poodll_fresh_play_btn bmr_disabled"),c.disable_button(d.controlbar.savebutton),c.disable_button(d.controlbar.recordAgain);break;case"recordmode":d.controlbar.statusText.text("Recording.."),c.enable_button(d.controlbar.startbutton),c.show_element(d.controlbar.startbutton),c.hide_element(d.controlbar.bmr_progresscanvas),c.enable_button(d.controlbar.pausebutton),c.show_element(d.controlbar.pausebutton),c.disable_button(d.controlbar.playbutton),c.hide_element(d.controlbar.resumebutton),c.enable_button(d.controlbar.stoprecbutton),c.disable_button(d.controlbar.savebutton),c.disable_button(d.controlbar.recordAgain),d.controlbar.preview.addClass("poodll_recording"),d.controlbar.status.addClass("poodll_recording"),d.controlbar.preview.removeClass("poodll_playing"),d.controlbar.status.removeClass("poodll_playing"),d.controlbar.startbutton.addClass("poodll_in_progress").removeClass("poodll_resume_button"),d.controlbar.playbutton.removeClass("poodll_play_special poodll_play_green"),"audio"==d.config.mediatype&&c.hide_element(d.controlbar.preview),d.controlbar.root.removeClass("poodll_controllbar_playmode");break;case"previewmode":d.controlbar.statusText.text("Ready to Play"),c.disable_button(d.controlbar.stoprecbutton),c.disable_button(d.controlbar.startbutton),c.enable_button(d.controlbar.playbutton),c.disable_button(d.controlbar.pausebutton),d.controlbar.status.html(d.timer.fetch_display_time(d.timer.finalSeconds)),c.show_element(d.controlbar.startbutton),c.disable_button(d.controlbar.resumebutton),c.hide_element(d.controlbar.resumebutton),c.hide_element(d.controlbar.bmr_progresscanvas),c.uploaded?(c.disable_button(d.controlbar.savebutton),c.disable_button(d.controlbar.recordAgain)):(c.enable_button(d.controlbar.savebutton),c.enable_button(d.controlbar.recordAgain)),c.show_element(d.controlbar.pausebutton),d.controlbar.preview.removeClass("poodll_recording"),d.controlbar.status.removeClass("poodll_recording"),d.controlbar.preview.removeClass("poodll_playing"),d.controlbar.status.removeClass("poodll_playing"),d.controlbar.startbutton.removeClass("poodll_in_progress"),d.controlbar.playbutton.addClass("poodll_play_green").removeClass("poodll_play_special").removeClass("poodll_play_pause").removeClass("poodll_stop_green"),"audio"==d.config.mediatype&&c.show_element(d.controlbar.preview),c.enable_button(d.controlbar.playbutton),d.controlbar.root.removeClass("poodll_controllbar_playmode poodll_controllbar_pausemode");break;case"playmode":d.controlbar.statusText.text("Playing"),d.controlbar.status.html("00:00:00"),c.enable_button(d.controlbar.stoprecbutton),c.enable_button(d.controlbar.pausebutton),c.disable_button(d.controlbar.startbutton),c.disable_button(d.controlbar.resumebutton),c.disable_button(d.controlbar.savebutton),c.disable_button(d.controlbar.recordAgain),c.show_element(d.controlbar.bmr_progresscanvas),d.controlbar.playbutton.removeClass("poodll_play_green").removeClass("poodll_play_special").addClass("poodll_stop_green"),d.controlbar.preview.addClass("poodll_playing"),d.controlbar.status.addClass("poodll_playing"),c.show_element(d.controlbar.startbutton),c.hide_element(d.controlbar.resumebutton),d.controlbar.root.addClass("poodll_controllbar_playmode").removeClass("poodll_controllbar_pausemode");break;case"pausedmode":d.controlbar.statusText.text("Paused"),c.show_element(d.controlbar.resumebutton),c.enable_button(d.controlbar.resumebutton),c.enable_button(d.controlbar.savebutton),d.controlbar.preview.removeClass("poodll_recording"),d.controlbar.status.removeClass("poodll_recording"),d.controlbar.startbutton.removeClass("poodll_in_progress").addClass("poodll_resume_button"),d.controlbar.playbutton.removeClass("poodll_play_green").removeClass("poodll_play_pause"),d.controlbar.root.addClass("poodll_controllbar_pausemode");break;case"uploadmode":d.controlbar.statusText.text("Uploading"),c.disable_button(d.controlbar.savebutton),c.disable_button(d.controlbar.recordAgain),c.disable_button(d.controlbar.startbutton),c.show_element(d.controlbar.bmr_progresscanvas),d.controlbar.root.removeClass("poodll_controllbar_playmode poodll_controllbar_pausemode")}},insert_controlbar_video:function(a,b,c,d){var e=this.prepare_controlbar(a,b,c,d,"video");return e},insert_controlbar_audio:function(a,b,c,d){var e=this.prepare_controlbar(a,b,c,d,"audio");return e},prepare_controlbar:function(b,c,d,e,f){var g=this.fetch_instanceprops(),h=g.config.media_skin_style,i="poodll_mediarecorder_size_auto";switch(g.config.size){case"small":i="poodll_mediarecorder_size_small";break;case"big":i="poodll_mediarecorder_size_big";break;case"auto":i="poodll_mediarecorder_size_auto"}var j=this.pmr.fetch_strings(),k="video"==f?"poodll_mediarecorder_video":"poodll_mediarecorder_audio",l='<div class="poodll_mediarecorderholder_fresh poodll_videorecorderholder_fresh '+k+" "+i+'" id="holder_'+c+'">';l+='<div class="poodll_mediarecorderbox_fresh" id="'+c+'">',l+='<audio style="display: none !important;" class="poodll-alert-recording" id="'+c+'"><source src="#" type="audio/mpeg"></audio>',l+='<div class="style-holder '+h+'">',l+='<div class="poodll_statusholder_fresh" >';var m=this.fetch_status_bar("fresh");l+=m,l+="</div>",l+='<div class="poodll_fresh_musik_line"><canvas class="fresh_range"></canvas><canvas id="'+c+'_playcanvas" class="poodll_fresh_playcanvas" width="300" height="50"></canvas><div class="poodll_fresh_wave"></div></div><div class="poodll_fresh_control"><div class="poodll_fresh_txt_control">'+j.recui_readytorecord+'</div><div class="poodll_fresh_settings_btn settingsicon" data-toggle="modal" data-target="#myModal id="settingsicon_'+c+'"></div><div class="poodll_start-recording_fresh poodll_fresh_main_btn"></div><div class="poodll_stop-playing-recording_fresh" style="display: none;"></div><div class="poodll_pause-recording_fresh poodll_fresh_pause_btn bmr_disabled"></div><div class="poodll_play-recording_fresh poodll_fresh_play_btn bmr_disabled"></div></div><div class="poodll_fresh_bottom_btns"><a class="poodll_save-recording_fresh poodll_fresh_upload_btn bmr_disabled" href="#">'+j.recui_upload+'</a><a class="poodll_fresh_record_btn bmr_disabled" href="#">'+j.recui_recordagain+"</a></div>",l+=d,l+="</div>",l+=this.devsettings.fetch_dialogue_box(),l+=g.downloaddialog.fetch_dialogue_box(),l+=g.errordialog.fetch_dialogue_box(),l+="</div>",l+="</div>",a(b).prepend(l);var n={poodll_recording_alert:a("#"+c+" .poodll-alert-recording"),bmr_progresscanvas:a("#"+c+" .fresh_range"),settingsdialog:a("#"+c+" .poodll_dialogue_box_settings"),downloaddialog:a("#"+c+" .poodll_dialogue_box_download"),errorsdialog:a("#"+c+" .poodll_dialogue_box_errors"),settingsicon:a("#"+c+" .settingsicon"),status:a("#"+c+" .poodll_status_fresh"),statusText:a("#"+c+" .poodll_fresh_txt_control"),preview:a("#"+c+" .poodll_preview_fresh"),startbutton:a("#"+c+" .poodll_start-recording_fresh"),stoprecbutton:a("#"+c+" .poodll_stop-recording_fresh"),pausebutton:a("#"+c+" .poodll_pause-recording_fresh"),resumebutton:a("#"+c+" .poodll_resume-recording_fresh"),playbutton:a("#"+c+" .poodll_play-recording_fresh"),stopbutton:a("#"+c+" .poodll_stop-playing-recording_fresh"),savebutton:a("#"+c+" .poodll_save-recording_fresh"),recordAgain:a("#"+c+" .poodll_fresh_record_btn"),playcanvas:a("#"+c+"_playcanvas"),root:a("#"+c)};return g.downloaddialog.set_dialogue_box(n.downloaddialog),g.errordialog.set_dialogue_box(n.errorsdialog),this.devsettings.set_dialogue_box(n.settingsdialog),n},register_controlbar_events_video:function(a,b){return this.register_controlbar_events_audio(a,b)},register_controlbar_events_audio:function(b,c){var d=this,g=this.pmr,h=this.fetch_instanceprops();h.controlbar.settingsicon.click(function(){d.uploaded?h.downloaddialog.open():d.devsettings.open()});var i=e.clone();i.init(h.controlbar.bmr_progresscanvas),i.readyBars();var j=f.clone();j.init(h.audioanalyser,h.controlbar.playcanvas.get(0)),h.controlbar.startbutton.click(function(){if(a(this).hasClass("poodll_in_progress")){g.do_stop_audio(h);var e=h.controlbar.preview;e&&e.get(0)&&e.get(0).pause(),j.clear(),h.timer.stop(),d.update_status(c),d.set_visual_mode("previewmode",c)}else a(this).hasClass("poodll_resume_button")?(g.do_resume_audio(h),h.timer.resume(),d.update_status(c),d.set_visual_mode("recordmode",c)):(d.therecanim=j,g.do_start_audio(h,b))}),h.controlbar.recordAgain.click(function(){g.do_stop_audio(h),d.update_status(c),d.set_visual_mode("initmode",c)}),h.controlbar.stoprecbutton.click(function(){g.do_stop_audio(h);var a=h.controlbar.preview;a&&a.get(0)&&a.get(0).pause(),j.clear(),h.timer.stop(),d.update_status(c),d.set_visual_mode("previewmode",c)}),h.controlbar.pausebutton.click(function(){g.do_pause_audio(h);var a=h.controlbar.preview;a&&a.get(0)&&(a.get(0).pause(),a.get(0).controls=!1),console.log("PAUSE"),h.timer.pause(),d.update_status(c),d.set_visual_mode("pausedmode",c)}),h.controlbar.resumebutton.click(function(){g.do_resume_audio(h),h.timer.resume(),d.update_status(c),d.set_visual_mode("recordmode",c)}),h.controlbar.preview.on("timeupdate",function(){if("playmode"==d.visualmode){var a=this.currentTime;h.controlbar.status.html(h.timer.fetch_display_time(a))}}),h.controlbar.stopbutton.click(function(){g.do_stop_audio(h);var a=h.controlbar.preview;a&&a.get(0)&&a.get(0).pause(),j.clear(),h.timer.stop(),d.update_status(c),d.set_visual_mode("previewmode",c)}),h.controlbar.playbutton.click(function(){if(a(this).hasClass("poodll_play_pause")){var b=h.controlbar.preview.get(0);g.do_stopplay_audio(h,b),g.do_stop_audio(h),h.timer.pause(),d.update_status(c),d.set_visual_mode("pausedmode",c)}else if(a(this).hasClass("poodll_stop_green")){g.do_stop_audio(h);var b=h.controlbar.preview;b&&b.get(0)&&b.get(0).pause(),j.clear(),h.timer.stop(),d.update_status(c),d.set_visual_mode("previewmode",c)}else{var b=h.controlbar.preview.get(0);g.do_play_audio(h,b),d.set_visual_mode("playmode",c),i.clear(),i.fetchCurrent=function(){var a=h.controlbar.preview.prop("currentTime"),b=h.controlbar.preview.prop("duration");return isFinite(b)||(b=h.timer.finalseconds),a/b},i.start();var e=h.controlbar.preview.prop("currentTime"),f=h.controlbar.preview.prop("duration");i.playBars(e,f)}}),h.controlbar.savebutton.click(function(){return h.blobs&&h.blobs.length>0?(d.set_visual_mode("uploadmode",c),g.do_save_audio(h),d.uploaded=!0):h.uploader.Output(M.util.get_string("recui_nothingtosaveerror","filter_poodll")),!1}),window.onbeforeunload=function(){d.enable_button(h.controlbar.startbutton);var a=h.controlbar.preview;a&&a.get(0)&&(a.get(0).pause(),a.get(0).controls=!1)}},show_element:function(b){a(b).show()},hide_element:function(b){a(b).hide()},enable_button:function(b){a(b).attr("disabled",!1),a(b).removeClass("bmr_disabled")},disable_button:function(b){a(b).attr("disabled",!0),a(b).addClass("bmr_disabled")}}});