define(["jquery","core/log","filter_poodll/dlg_poodll"],function(a,b,c){return b.debug("Device settings dialog: initialising"),{dlg:null,pmr:null,instanceprops:null,dlgbox:null,mediatype:null,init:function(a,b){this.dlg=c.clone(),this.dlg.setHeader("settings"),this.pmr=a,this.instanceprops=b,this.mediatype=b.config.mediatype},clone:function(){return a.extend(!0,{},this)},fetch_dialogue_box:function(){return this.dlg.fetch_dialogue_box("settings")},set_dialogue_box:function(a){this.dlgbox=a,this.dlg.set_dialogue_box(a)},set_media_type:function(a){this.mediatype=a},open:function(){var a=this;this.instanceprops;navigator.mediaDevices.enumerateDevices().then(function(b){var c=[],d=[];b.forEach(function(a){switch(a.kind){case"audioinput":c.push(a);break;case"videoinput":d.push(a)}});var e='<div class="devicesettings_select"><span class="devicesettings_select_label">Audio: </span>'+a.makeSelect(c,"audio")+"</div>",f='<div class="devicesettings_select"><span class="devicesettings_select_label">Video: </span>'+a.makeSelect(d,"video")+"</div>",g='<div class="filter_poodll_mediadevices">';g+="video"==a.mediatype?e+"<br>"+f:e,g+="</div>",a.dlg.setContent(g),a.registerEvents(),"video"==a.mediatype&&(a.dlg.onclose=function(){a.resetVideoUserInterface()}),a.dlg.open()})["catch"](function(a){b.debug(a)})},registerEvents:function(){var a=this,b=this.instanceprops,c=b.controlbar.preview[0];c&&c.pause(),b.mediaRecorder&&b.mediaRecorder.stop(),this.dlgbox.find(".select_settings_audio").change(function(){a.instanceprops.useraudiodeviceid=this.value}),this.dlgbox.find(".select_settings_video").change(function(){a.instanceprops.uservideodeviceid=this.value})},resetVideoUserInterface:function(){var a=this.instanceprops,c=(a.controlbar.preview[0],this.pmr),d=c.fetch_video_constraints(a);c.tidy_old_stream(a.controlbarid),navigator.mediaDevices.getUserMedia(d).then(function(b){c.restream_preview_video_player(a.controlbarid,b)})["catch"](function(a){b.debug("location 4567"),b.debug(a)})},makeSelect:function(a,b){if(1==a.length&&""==a[0].label)return"<div>No devices available yet.</div>";switch(b){case"audio":var c=this.instanceprops.useraudiodeviceid;break;case"video":var c=this.instanceprops.uservideodeviceid}var d='<select class="select_settings_'+b+'">';return a.forEach(function(a){var b="";c==a.deviceId&&(b="selected"),d+='<option value="'+a.deviceId+'"  '+b+">"+a.label+"</option>"}),d+="</select>"}}});