define(["jquery","core/log","filter_poodll/utils_amd","filter_poodll/uploader","filter_poodll/poodll_uploadrecorder"],(function($,log,utils,uploader,uploadrec){return log.debug("PoodLL Mobile Recorder: initialising"),{instanceprops:[],fetch_instance_props:function(widgetid){return this.instanceprops[widgetid]},init_instance_props:function(widgetid){var props={config:null,uploader:null,linkid:null};this.instanceprops[widgetid]=props},supports_current_browser:function(config){return("audio"==config.mediatype||"video"==config.mediatype)&&utils.is_ios()},embed:function(element,config){this.init_instance_props(config.widgetid);var ip=this.fetch_instance_props(config.widgetid);switch(ip.config=config,ip.uploader=uploader.clone(),ip.uploader.init(element,config),ip.linkid="filter_poodll_mobilerecorder_link_"+config.widgetid,config.mediatype){case"audio":this.insert_upload_button(element,config.widgetid),1==config.showmobile&&this.insert_audio_button(element,config.widgetid);break;case"video":this.insert_upload_button(element,config.widgetid),1==config.showmobile&&this.insert_video_button(element,config.widgetid)}return this.register_events(element,config.widgetid),!0},register_events:function(element,widgetid){var ip=this.fetch_instance_props(widgetid),config=ip.config,mobilerecorder=this;$("#"+ip.linkid).on("mousedown touchstart",(function(e){mobilerecorder.confirm_s3_arrival(widgetid),ip.uploader.Output(M.util.get_string("recui_awaitingconfirmation","filter_poodll"))})),$("#"+ip.linkid+"_uploadafile").on("mousedown touchstart",(function(e){$(element).empty(),uploadrec.embed(element,config)}))},insert_video_button:function(element,widgetid){var ip=this.fetch_instance_props(widgetid),controls='<a class ="filter_poodll_mobilerecorderlink" id="'+ip.linkid+'" href="poodllrecorder://?presignedurl='+encodeURIComponent(ip.config.quicktimesignedurl)+"&type="+ip.config.mediatype+"&quality="+ip.config.mobilequality+"&camera="+ip.config.mobilecamera+"&timelimit="+ip.config.timelimit+'">'+M.util.get_string("recui_openrecorderapp","filter_poodll")+"</a>";$(element).prepend(controls)},insert_audio_button:function(element,widgetid){var ip=this.fetch_instance_props(widgetid),controls='<a class ="filter_poodll_mobilerecorderlink"  id="'+ip.linkid+'" href="poodllrecorder://?presignedurl='+encodeURIComponent(ip.config.posturl)+"&type="+ip.config.mediatype+"&quality="+ip.config.mobilequality+"&camera="+ip.config.mobilecamera+"&timelimit="+ip.config.timelimit+'">'+M.util.get_string("recui_openrecorderapp","filter_poodll")+"</a>";$(element).prepend(controls)},insert_upload_button:function(element,widgetid){var controls='<a class ="filter_poodll_uploadafilelink" id="'+this.fetch_instance_props(widgetid).linkid+'_uploadafile" href="#">'+M.util.get_string("recui_uploadafile","filter_poodll")+"</a>";$(element).prepend(controls)},confirm_s3_arrival:function(widgetid){var ip=this.fetch_instance_props(widgetid),xhr=new XMLHttpRequest,config=ip.config,posturl=config.wwwroot+"/filter/poodll/poodllfilelib.php",params="datatype=confirmarrival";params+="&mediatype="+config.mediatype,params+="&filename="+config.filename,xhr.open("POST",posturl,!0),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.setRequestHeader("Cache-Control","no-cache"),xhr.setRequestHeader("Content-length",params.length),xhr.setRequestHeader("Connection","close"),xhr.addEventListener("load",(function(){xhr.response&&xhr.response.indexOf(config.filename)>0?(ip.uploader.pokeFilename(config.filename,ip.uploader),ip.uploader.postprocess_s3_upload(ip.uploader),ip.uploader.Output(M.util.get_string("recui_uploadsuccess","filter_poodll")),ip.uploader.doCallback(ip.uploader,config.filename)):setTimeout((function(){xhr.open("POST",posturl,!0),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.setRequestHeader("Cache-Control","no-cache"),xhr.setRequestHeader("Content-length",params.length),xhr.setRequestHeader("Connection","close"),xhr.send(params)}),2e3)})),xhr.send(params)}}}));

//# sourceMappingURL=poodll_mobilerecorder.min.js.map