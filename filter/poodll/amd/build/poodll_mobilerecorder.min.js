define(["jquery","core/log","filter_poodll/utils_amd","filter_poodll/uploader","filter_poodll/poodll_uploadrecorder"],function(a,b,c,d,e){"use strict";return b.debug("PoodLL Mobile Recorder: initialising"),{instanceprops:[],fetch_instance_props:function(a){return this.instanceprops[a]},init_instance_props:function(a){var b={};b.config=null,b.uploader=null,b.linkid=null,this.instanceprops[a]=b},supports_current_browser:function(a){if("audio"!=a.mediatype&&"video"!=a.mediatype)return!1;var b=c.is_ios();return b},embed:function(a,b){this.init_instance_props(b.widgetid);var c=this.fetch_instance_props(b.widgetid);switch(c.config=b,c.uploader=d.clone(),c.uploader.init(a,b),c.linkid="filter_poodll_mobilerecorder_link_"+b.widgetid,b.mediatype){case"audio":this.insert_upload_button(a,b.widgetid),1==b.showmobile&&this.insert_audio_button(a,b.widgetid);break;case"video":this.insert_upload_button(a,b.widgetid),1==b.showmobile&&this.insert_video_button(a,b.widgetid)}return this.register_events(a,b.widgetid),!0},register_events:function(b,c){var d=this.fetch_instance_props(c),f=d.config,g=this;a("#"+d.linkid).on("mousedown touchstart",function(a){g.confirm_s3_arrival(c),d.uploader.Output(M.util.get_string("recui_awaitingconfirmation","filter_poodll"))}),a("#"+d.linkid+"_uploadafile").on("mousedown touchstart",function(c){a(b).empty(),e.embed(b,f)})},insert_video_button:function(b,c){var d=this.fetch_instance_props(c),e='<a class ="filter_poodll_mobilerecorderlink" id="'+d.linkid+'" href="poodllrecorder://?presignedurl='+encodeURIComponent(d.config.quicktimesignedurl)+"&type="+d.config.mediatype+"&quality="+d.config.mobilequality+"&camera="+d.config.mobilecamera+"&timelimit="+d.config.timelimit+'">'+M.util.get_string("recui_openrecorderapp","filter_poodll")+"</a>";a(b).prepend(e)},insert_audio_button:function(b,c){var d=this.fetch_instance_props(c),e='<a class ="filter_poodll_mobilerecorderlink"  id="'+d.linkid+'" href="poodllrecorder://?presignedurl='+encodeURIComponent(d.config.posturl)+"&type="+d.config.mediatype+"&quality="+d.config.mobilequality+"&camera="+d.config.mobilecamera+"&timelimit="+d.config.timelimit+'">'+M.util.get_string("recui_openrecorderapp","filter_poodll")+"</a>";a(b).prepend(e)},insert_upload_button:function(b,c){var d=this.fetch_instance_props(c),e='<a class ="filter_poodll_uploadafilelink" id="'+d.linkid+'_uploadafile" href="#">'+M.util.get_string("recui_uploadafile","filter_poodll")+"</a>";a(b).prepend(e)},confirm_s3_arrival:function(a){var b=this.fetch_instance_props(a),c=new XMLHttpRequest,d=b.config,e=d.wwwroot+"/filter/poodll/poodllfilelib.php",f="datatype=confirmarrival";f+="&mediatype="+d.mediatype,f+="&filename="+d.filename,c.open("POST",e,!0),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.setRequestHeader("Cache-Control","no-cache"),c.setRequestHeader("Content-length",f.length),c.setRequestHeader("Connection","close"),c.addEventListener("load",function(){c.response&&c.response.indexOf(d.filename)>0?(b.uploader.pokeFilename(d.filename,b.uploader),b.uploader.postprocess_s3_upload(b.uploader),b.uploader.Output(M.util.get_string("recui_uploadsuccess","filter_poodll")),b.uploader.doCallback(b.uploader,d.filename)):setTimeout(function(){c.open("POST",e,!0),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.setRequestHeader("Cache-Control","no-cache"),c.setRequestHeader("Content-length",f.length),c.setRequestHeader("Connection","close"),c.send(f)},2e3)}),c.send(f)}}});