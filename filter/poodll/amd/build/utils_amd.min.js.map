{"version":3,"sources":["../src/utils_amd.js"],"names":["define","$","log","debug","timeouthandles","WhiteboardUploadHandler","recid","wboard","opts","theuploader","savebutton","disabled","clearTimeout","cvs","getCvs","pokeVectorData","uploadFile","toDataURL","indexOf","canvas","canvasForExport","escapeColon","thestring","replace","vectordata","JSON","stringify","history","getSnapshot","val","_concatenateWavBlobs","blobs","callback","self","allbytes","loadedblobs","totalbytes","lng","length","i","index","fileReader","FileReader","onload","ab","result","audiodata","slice","byteLength","header","headerview","DataView","setUint32","unshift","wavblob","Blob","type","readAsArrayBuffer","_simpleConcatenateBlobs","doConcatenateBlobs","theblobs","thecallback","mimetype","concatenatedBlob","bytesToSize","bytes","parseInt","Math","floor","pow","toPrecision","getTimeLength","milliseconds","data","Date","getUTCHours","getUTCMinutes","getUTCSeconds","has_mediarecorder","MediaRecorder","can_html5_record","mediatype","navigator","mediaDevices","getUserMedia","is_edge","userAgent","is_chrome","isChromium","window","chrome","winNav","vendorName","vendor","isOpera","isIEedge","isIOSChrome","match","is_safari","test","is_ios","MSStream","is_opera","opera","is_android","ua","isAndroid","is_ie","ms_ie","old_ie","new_ie","edge","parseQueryString","url","urlParams","$0","$1","$2","$3"],"mappings":"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","sourcesContent":["/* jshint ignore:start */\ndefine(['jquery', 'core/log'], function ($, log) {\n\n    \"use strict\"; // jshint ;_;\n\n    log.debug('Filter PoodLL: utils initialising');\n\n    return {\n        timeouthandles: [],\n\n        // Call Upload file from drawingboard a, first handle autosave bits and pieces\n        WhiteboardUploadHandler: function (recid, wboard, opts, theuploader) {\n            // Save button disabling a little risky db perm. fails publish \"startdrawing\" after mode change\n            var savebutton = $('#' + recid + '_btn_upload_whiteboard')[0];\n            savebutton.disabled = true;\n            clearTimeout(this.timeouthandles[recid]);\n            //call the file upload\n            var cvs = this.getCvs(recid, wboard, opts);\n            this.pokeVectorData(recid, wboard, opts);\n            theuploader.uploadFile(cvs.toDataURL(), 'image/png');\n        },\n        getCvs: function (recid, wboard) {\n            if (recid.indexOf('drawingboard_') == 0) {\n                var cvs = wboard.canvas;\n            } else {\n                var cvs = wboard.canvasForExport();\n            }//end of of drawing board\n            return cvs;\n        },\n\n        escapeColon: function (thestring) {\n            return thestring.replace(/:/, '\\\\:');\n        },\n\n        pokeVectorData: function (recid, wboard, opts) {\n            var vectordata = \"\";\n            if (recid.indexOf('drawingboard_') == 0) {\n                vectordata = JSON.stringify(wboard.history, null, 2);\n            } else {\n                //only LC has vector data it seems\n                vectordata = JSON.stringify(wboard.getSnapshot());\n            }//end of of drawing board\n\n            //need to do the poke here\n            if (typeof opts['vectorcontrol'] !== 'undefined' && opts['vectorcontrol'] !== '') {\n                //the moodle question has a colon in the field ids, so we need to escape that away\n                $('#' + this.escapeColon(opts['vectorcontrol'])).val(vectordata);\n                log.debug('Vectorcontrol:' + opts['vectorcontrol']);\n                //  log.debug('Vectordata:' + vectordata );\n            }\n            //end of poke vectordata\n        },\n\n\n        _concatenateWavBlobs: function (blobs, callback) {\n\n\n\n            //fetch our header\n            var self=this;\n            var allbytes = []; //this will be an array of arraybuffers\n            var loadedblobs = 0;\n            var totalbytes = 0;\n            // fetch the blob data\n            var lng = blobs.length;\n            for (var i = 0; i < lng; i++) {\n                //we run the filereader inside an an immediately executing function\n                //so that we can keep track of the index of the blob being read.\n                //in edge and IE they all get read simulatenously and the order of concatenation\n                //could not be relied on with : allbytes.push(audiodata); so we did: allbytes[index]=audiodata;\n                (function (index) {\n                    var fileReader = new FileReader();\n                    fileReader.onload = function () {\n                        //load blob into arraybuffer\n                        var ab = this.result;\n\n                        //remove header and add audiodata to the all data array\n                        //the slice is from(inclusive) to end(exclusive)\n                        var audiodata = ab.slice(44);\n                        totalbytes += audiodata.byteLength;\n                        //allbytes.push(audiodata);\n                        allbytes[index] = audiodata;\n                        loadedblobs++;\n\n                        //finally add the header and do callback if at end\n                        if (loadedblobs == lng) {\n                            //get header from last blob, and just adjust the data length\n                            var header = ab.slice(0, 44);\n                            var headerview = new DataView(header);\n                            headerview.setUint32(40, totalbytes, true);\n                            allbytes.unshift(header);\n\n                            //make our final binary blob and pass it to callback\n                            var wavblob = new Blob(allbytes, {type: 'audio/wav'});\n                            log.debug(totalbytes);\n                            log.debug(allbytes);\n                            callback(wavblob);\n                        }\n                    };\n                    fileReader.readAsArrayBuffer(blobs[i]);\n                })(i);\n\n            }//end of i loop\n\n        }, //end of concatenateWavBlobs\n\n\n\n        _simpleConcatenateBlobs: function (blobs, type) {\n            return new Blob(blobs, {'type': type});\n        },\n\n        doConcatenateBlobs: function (theblobs, thecallback) {\n           // var mimetype = 'audio/ogg';\n            //can be of format: \"audio/ogg; codecs=opus\"\n            //still works though\n           var mimetype =theblobs[0].type;\n            switch (mimetype) {\n                case 'audio/wav':\n                case 'audio/pcm':\n                    // mediastreamrecorder adds a header to each wav blob,\n                    // we remove them and combine audiodata and new header\n                    this._concatenateWavBlobs(theblobs, thecallback);\n                    break;\n                case 'audio/ogg':\n                case 'audio/webm':\n                case 'video/webm':\n                case 'video/mp4':\n                case 'audio/mp4':\n                case 'audio/mp3':\n                case 'audio/m4a':\n                default:\n                    var concatenatedBlob = this._simpleConcatenateBlobs(theblobs, mimetype);\n                    thecallback(concatenatedBlob);\n                    break;\n            }// end of switch case\n        },\n\n\n        bytesToSize: function (bytes) {\n            var k = 1000;\n            var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];\n            if (bytes === 0) {\n                return '0 Bytes';\n            }\n            var i = parseInt(Math.floor(Math.log(bytes) / Math.log(k)), 10);\n            return (bytes / Math.pow(k, i)).toPrecision(3) + ' ' + sizes[i];\n        },\n\n        // below function via: http://goo.gl/6QNDcI\n        getTimeLength: function (milliseconds) {\n            var data = new Date(milliseconds);\n            return data.getUTCHours() + \" hours, \" + data.getUTCMinutes() + \" minutes and \" + data.getUTCSeconds() + \" second(s)\";\n        },\n\n        has_mediarecorder: function(){\n          return typeof MediaRecorder !== 'undefined';\n        },\n\n        can_html5_record: function(mediatype){\n          if( navigator && navigator.mediaDevices\n            && navigator.mediaDevices.getUserMedia){\n              if(mediatype=='audio'){\n                  return true;\n              }else{\n                  return this.has_mediarecorder();\n              }\n          }else{\n              return false;\n          }\n        },\n\n        is_edge: function () {\n            return navigator.userAgent.indexOf('Edge') > -1;\n        },\n\n        is_chrome: function () {\n            var isChromium = window.chrome,\n                winNav = window.navigator,\n                vendorName = winNav.vendor,\n                isOpera = winNav.userAgent.indexOf(\"OPR\") > -1,\n                isIEedge = winNav.userAgent.indexOf(\"Edge\") > -1,\n                isIOSChrome = winNav.userAgent.match(\"CriOS\");\n\n            if (isIOSChrome) {\n                return true;\n            } else if (\n                isChromium !== null &&\n                typeof isChromium !== \"undefined\" &&\n                vendorName === \"Google Inc.\" &&\n                isOpera === false &&\n                isIEedge === false\n            ) {\n                return true;\n            } else {\n                return false;\n            }\n        },\n\n        is_safari: function () {\n            return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\n        },\n\n        is_ios: function () {\n            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;\n        },\n\n        is_opera: function () {\n            return (typeof opera !== 'undefined' && navigator.userAgent && navigator.userAgent.indexOf('OPR/') !== -1);\n        },\n\n        is_android: function () {\n            var ua = window.navigator.userAgent;\n            var isAndroid = (ua.indexOf(\"android\") > -1) || (ua.indexOf(\"Android\") > -1); //&& ua.indexOf(\"mobile\");\n            return isAndroid;\n        },\n\n        is_ie: function () {\n            var ms_ie = false;\n            var ua = window.navigator.userAgent;\n            var old_ie = ua.indexOf('MSIE ');\n            var new_ie = ua.indexOf('Trident/');\n            var edge = ua.indexOf('Edge/');\n            if ((old_ie > -1) || (new_ie > -1) || (edge > -1)) {\n                ms_ie = true;\n            }\n            return ms_ie;\n        },\n\n        parseQueryString: function (url) {\n            var urlParams = {};\n            url.replace(\n                new RegExp(\"([^?=&]+)(=([^&]*))?\", \"g\"),\n                function ($0, $1, $2, $3) {\n                    urlParams[$1] = $3;\n                }\n            );\n\n            return urlParams;\n        }\n    };//end of return object\n});"],"file":"utils_amd.min.js"}