define(["jquery","core/log"],function(a,b){"use strict";return b.debug("PoodLL Stereo Audio Recorder Helper: initialising"),{scriptprocessornode:null,requestDataInvoked:!1,recordingLength:0,isPaused:!1,deviceSampleRate:48e3,leftchannel:[],rightchannel:[],recording:!1,volume:null,audioInput:null,context:null,sampleRate:0,mimeType:0,isPCM:!1,numChannels:1,msr:null,audioctx:null,mediaStream:null,volumeGainNode:null,clone:function(){return a.extend(!0,{},this)},init:function(a,c,d){this.msr=a,this.audioctx=d,this.mediaStream=c,this.deviceSampleRate=d.sampleRate,this.sampleRate=this.deviceSampleRate,this.mimeType=a.mimeType||"audio/wav",this.isPCM=this.mimeType.indexOf("audio/pcm")>-1,this.numChannels=a.audioChannels||1,b.debug("stereohelper mimetype: "+this.mimeType),this.misc()},misc:function(){var a=this,c=this.audioctx;this.volumeGainNode=c.createGain();var d=this.volumeGainNode;this.audioInput=c.createMediaStreamSource(this.mediaStream);var e=this.audioInput;e.connect(d);var f=this.msr.bufferSize||2048;0===this.msr.bufferSize&&(f=0);var g=null;if(c.createJavaScriptNode)g=c.createJavaScriptNode(f,this.numChannels,this.numChannels);else{if(!c.createScriptProcessor)throw"WebAudio API has no support on this browser.";g=c.createScriptProcessor(f,this.numChannels,this.numChannels)}this.bufferSize=g.bufferSize,this.requestDataInvoked=!1,this.scriptprocessornode=g,1===this.numChannels&&b.debug("All right-channels are skipped."),this.isPaused=!1,g.onaudioprocess=function(b){if(a.recording&&!a.requestDataInvoked&&!a.isPaused){var c=b.inputBuffer.getChannelData(0);if(a.leftchannel.push(new Float32Array(c)),2===a.numChannels){var d=b.inputBuffer.getChannelData(1);a.rightchannel.push(new Float32Array(d))}a.recordingLength+=a.bufferSize}},d.connect(this.msr.audioanalyser.core),this.msr.audioanalyser.core.connect(g),g.connect(c.destination)},record:function(){this.recording=!0,this.leftchannel.length=this.rightchannel.length=0,this.recordingLength=0},encodeWAV:function(a){var c=new ArrayBuffer(44+2*a.length),d=new DataView(c);return this.writeString(d,0,"RIFF"),d.setUint32(4,36+2*a.length,!0),this.writeString(d,8,"WAVE"),this.writeString(d,12,"fmt "),d.setUint32(16,16,!0),d.setUint16(20,1,!0),d.setUint16(22,this.numChannels,!0),d.setUint32(24,this.sampleRate,!0),d.setUint32(28,4*this.sampleRate,!0),d.setUint16(32,2*this.numChannels,!0),d.setUint16(34,16,!0),this.writeString(d,36,"data"),d.setUint32(40,2*a.length,!0),this.floatTo16BitPCM(d,44,a),b.debug(2*a.length),d},floatTo16BitPCM:function(a,b,c){for(var d=0;d<c.length;d++,b+=2){var e=Math.max(-1,Math.min(1,c[d]));a.setInt16(b,e<0?32768*e:32767*e,!0)}},writeString:function(a,b,c){for(var d=0;d<c.length;d++)a.setUint8(b+d,c.charCodeAt(d))},requestData:function(){if(!this.isPaused){if(0===this.recordingLength)return void(this.requestDataInvoked=!1);this.requestDataInvoked=!0;var a=this.leftchannel.slice(0),b=this.rightchannel.slice(0),c=this.recordingLength;this.leftchannel.length=this.rightchannel.length=[],this.recordingLength=0,this.requestDataInvoked=!1;var d=this.mergeBuffers(a,c),e=d;if(2===this.numChannels){var f=this.mergeBuffers(b,c);e=this.interleave(d,f)}var g=this.encodeWAV(e),h=new Blob([g],{type:"audio/wav"});this.msr.ondataavailable(h)}},xrequestData:function(){if(!this.isPaused){if(0===this.recordingLength)return void(this.requestDataInvoked=!1);this.requestDataInvoked=!0;var a=this.leftchannel.slice(0),b=this.rightchannel.slice(0),c=this.recordingLength;this.leftchannel.length=this.rightchannel.length=[],this.recordingLength=0,this.requestDataInvoked=!1;var d=this.mergeBuffers(a,c),e=d;if(2===this.numChannels){var f=this.mergeBuffers(b,c);this.interleaved=this.interleave(d,f)}if(this.isPCM){var g=new Blob([this.convertoFloat32ToInt16(e)],{type:"audio/pcm"});return void this.msr.ondataavailable(g)}var h=new ArrayBuffer(44+2*e.length),i=new DataView(h);this.writeUTFBytes(i,0,"RIFF"),i.setUint32(4,44+2*e.length-8,!0),this.writeUTFBytes(i,8,"WAVE"),this.writeUTFBytes(i,12,"fmt "),i.setUint32(16,16,!0),i.setUint16(20,1,!0),i.setUint16(22,this.numChannels,!0),i.setUint32(24,this.sampleRate,!0),i.setUint32(28,this.sampleRate*this.numChannels*2,!0),i.setUint16(32,2*this.numChannels,!0),i.setUint16(34,16,!0),this.writeUTFBytes(i,36,"data"),i.setUint32(40,2*e.length,!0);for(var j=e.length,k=44,l=1,m=0;m<j;m++)i.setInt16(k,e[m]*(32767*l),!0),k+=2;var g=new Blob([i],{type:"audio/wav"});this.msr.ondataavailable(g)}},stop:function(){this.recording=!1,this.requestData(),this.audioInput.disconnect()},interleave:function(a,b){for(var c=a.length+b.length,d=new Float32Array(c),e=0,f=0;f<c;)d[f++]=a[e],d[f++]=b[e],e++;return d},mergeBuffers:function(a,b){for(var c=new Float32Array(b),d=0,e=a.length,f=0;f<e;f++){var g=a[f];c.set(g,d),d+=g.length}return c},writeUTFBytes:function(a,b,c){for(var d=c.length,e=0;e<d;e++)a.setUint8(b+e,c.charCodeAt(e))},convertoFloat32ToInt16:function(a){for(var b=a.length,c=new Int16Array(b);b--;)c[b]=65535*a[b];return c.buffer},pause:function(){this.isPaused=!0},resume:function(){this.isPaused=!1}}});