{"version":3,"file":"reorder.min.js","sources":["../src/reorder.js"],"sourcesContent":["/**\n * Local plugin \"Profile field based cohort membership\" - JS code for reordering rules\n *\n * @module    local_profilecohort/reorder\n * @copyright 2016 Davo Smith, Synergy Learning UK on behalf of Alexander Bias, Ulm University <alexander.bias@uni-ulm.de>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* Note: The @this comments throughout this file are just there to keep grunt satisfied */\n\ndefine(['jquery'], function($) {\n    \"use strict\";\n    var SELECTORS = {\n        MOVETO: 'select.moveto, .moveto select',\n        FIELDWRAPPER: '.localprofile-fieldwrapper',\n        RULENUMBER: '.localprofile-number'\n    };\n\n    /**\n     * The last rule should not show a 'and next rule' checkbox, but all the rest of the rules should.\n     */\n    function showHideAndNextCheckbox() {\n        var $andNextRule = $('#region-main form input.andnextrule');\n        if ($andNextRule.closest('label').length) {\n            // Boost theme wraps labels around input tags, instead of spans.\n            $andNextRule.closest('label').removeClass('hidden').last().addClass('hidden');\n        } else {\n            $andNextRule.closest('span').removeClass('hidden').last().addClass('hidden');\n        }\n    }\n\n    /**\n     * Remove all the divs that were wrapping rules that are combined together.\n     */\n    function removeCombinedDivs() {\n        var $form = $('#region-main form');\n        $form.find(SELECTORS.FIELDWRAPPER).removeClass('localprofile-flash').each(/* @this */function() {\n            var $this = $(this);\n            if ($this.closest('.localprofile-combined').length) {\n                $this.unwrap();\n            }\n        });\n    }\n\n    /**\n     * Find all rules that are combined together and wrap them in a div to visually indicate this.\n     */\n    function addCombinedDivs() {\n        var $collection = null;\n        var $form = $('#region-main form');\n        $form.find(SELECTORS.FIELDWRAPPER).each(/* @this */function() {\n            var $this = $(this);\n            var $andnextrule = $this.find('input.andnextrule');\n            if (!$andnextrule.length) {\n                return;\n            }\n            if ($andnextrule.prop('checked')) {\n                if ($collection) {\n                    $collection = $collection.add($this);\n                } else {\n                    $collection = $this;\n                }\n            } else {\n                if ($collection) {\n                    $collection = $collection.add($this);\n                    $collection.wrapAll('<div class=\"localprofile-combined\" />');\n                    $collection = null;\n                }\n            }\n        });\n        if ($collection) {\n            $collection.wrapAll('<div class=\"localprofile-combined\" />');\n            $collection = null;\n        }\n        showHideAndNextCheckbox();\n    }\n\n    /**\n     * Refresh the divs that show which rules are combined together.\n     */\n    function updateCombinedDivs() {\n        removeCombinedDivs();\n        addCombinedDivs();\n    }\n\n    /**\n     * Check if the item has been reordered and, if it has, insert it into the new position.\n     * @param {Object} e The event object.\n     */\n    function checkReorderItems(e) {\n        var $target = $(e.currentTarget);\n        var lastPosition = parseInt($target.data('lastPosition'), 10);\n        var newPosition = parseInt($target.val(), 10);\n        if (lastPosition === newPosition) {\n            return; // Nothing has changed.\n        }\n\n        // Find the item being displaced (i.e. the one that already has the 'position' we are moving to).\n        var $displace = null;\n        var $moveSelects = $(SELECTORS.MOVETO);\n        $moveSelects.each(/* @this */function() {\n            var $this = $(this);\n            if ($this.attr('id') !== $target.attr('id')) {\n                if (parseInt($this.val(), 10) === newPosition) {\n                    $displace = $this.closest(SELECTORS.FIELDWRAPPER);\n                    return false;\n                }\n            }\n            return true;\n        });\n        if (!$displace) {\n            return;\n        }\n\n        // Now we know we are moving elements, remove all 'combine with next rule' divs.\n        removeCombinedDivs();\n\n        // Put the moved item before, or after the 'displace' item, depending on whether we are moving up or down.\n        var $moveItem = $target.closest(SELECTORS.FIELDWRAPPER);\n        if (newPosition < lastPosition) {\n            $moveItem.insertBefore($displace);\n        } else {\n            $moveItem.insertAfter($displace);\n        }\n\n        // Update all the 'moveTo' selects.\n        $moveSelects = $(SELECTORS.MOVETO); // Reload the list of 'moveto' selects, in the new order.\n        $moveSelects.each(/* @this */function(idx) {\n            var $this = $(this);\n            var position = idx + 1;\n            $this.data('lastPosition', position);\n            $this.val(position);\n            $this.closest(SELECTORS.FIELDWRAPPER).find(SELECTORS.RULENUMBER).html(position);\n        });\n\n        // Flash the moved element.\n        $moveItem.removeClass('localprofile-flash').addClass('localprofile-flash');\n\n        // Replace the 'combine with next rule' divs.\n        addCombinedDivs();\n    }\n\n    /**\n     * Highlight each of the rules that will be deleted when the form is next saved.\n     */\n    function showRulesToBeDeleted() {\n        var $deleteRule = $('#region-main form input.deleterule');\n        $deleteRule.each(/* @this */function() {\n            var $this = $(this);\n            var $container = $this.closest('.localprofile-fieldwrapper');\n            if ($this.prop('checked')) {\n                $container.addClass('todelete');\n                $container.find(':input:not(.deleterule)').prop('disabled', true);\n            } else {\n                $container.removeClass('todelete');\n                $container.find(':input').prop('disabled', false);\n            }\n        });\n    }\n\n    return {\n        init: function() {\n            var $form = $('#region-main form');\n            $form.find(SELECTORS.MOVETO).each(/* @this */function() {\n                var $this = $(this);\n                $this.data('lastPosition', $this.val());\n            });\n            $form.on('change', SELECTORS.MOVETO, checkReorderItems);\n            $form.on('change', 'input.andnextrule', updateCombinedDivs);\n            $form.on('change', 'input.deleterule', showRulesToBeDeleted);\n            addCombinedDivs();\n        }\n    };\n});\n"],"names":["define","$","SELECTORS","removeCombinedDivs","find","removeClass","each","$this","this","closest","length","unwrap","addCombinedDivs","$andNextRule","$collection","$andnextrule","prop","add","wrapAll","last","addClass","updateCombinedDivs","checkReorderItems","e","$target","currentTarget","lastPosition","parseInt","data","newPosition","val","$displace","$moveSelects","attr","$moveItem","insertBefore","insertAfter","idx","position","html","showRulesToBeDeleted","$container","init","$form","on"],"mappings":";;;;;;;AAUAA,qCAAO,CAAC,WAAW,SAASC,OAEpBC,iBACQ,gCADRA,uBAEc,6BAFdA,qBAGY,gCAmBPC,qBACOF,EAAE,qBACRG,KAAKF,wBAAwBG,YAAY,sBAAsBC,MAAgB,eAC7EC,MAAQN,EAAEO,MACVD,MAAME,QAAQ,0BAA0BC,QACxCH,MAAMI,qBAQTC,sBAzBDC,aA0BAC,YAAc,KACNb,EAAE,qBACRG,KAAKF,wBAAwBI,MAAgB,eAC3CC,MAAQN,EAAEO,MACVO,aAAeR,MAAMH,KAAK,qBACzBW,aAAaL,SAGdK,aAAaC,KAAK,WAEdF,YADAA,YACcA,YAAYG,IAAIV,OAEhBA,MAGdO,eACAA,YAAcA,YAAYG,IAAIV,QAClBW,QAAQ,yCACpBJ,YAAc,UAItBA,cACAA,YAAYI,QAAQ,yCACpBJ,YAAc,OAlDdD,aAAeZ,EAAE,wCACJQ,QAAQ,SAASC,OAE9BG,aAAaJ,QAAQ,SAASJ,YAAY,UAAUc,OAAOC,SAAS,UAEpEP,aAAaJ,QAAQ,QAAQJ,YAAY,UAAUc,OAAOC,SAAS,mBAqDlEC,qBACLlB,qBACAS,2BAOKU,kBAAkBC,OACnBC,QAAUvB,EAAEsB,EAAEE,eACdC,aAAeC,SAASH,QAAQI,KAAK,gBAAiB,IACtDC,YAAcF,SAASH,QAAQM,MAAO,OACtCJ,eAAiBG,iBAKjBE,UAAY,KACZC,aAAe/B,EAAEC,qBACrB8B,aAAa1B,MAAgB,eACrBC,MAAQN,EAAEO,aACVD,MAAM0B,KAAK,QAAUT,QAAQS,KAAK,OAC9BN,SAASpB,MAAMuB,MAAO,MAAQD,cAC9BE,UAAYxB,MAAME,QAAQP,yBACnB,MAKd6B,WAKL5B,yBAGI+B,UAAYV,QAAQf,QAAQP,wBAC5B2B,YAAcH,aACdQ,UAAUC,aAAaJ,WAEvBG,UAAUE,YAAYL,YAI1BC,aAAe/B,EAAEC,mBACJI,MAAgB,SAAS+B,SAC9B9B,MAAQN,EAAEO,MACV8B,SAAWD,IAAM,EACrB9B,MAAMqB,KAAK,eAAgBU,UAC3B/B,MAAMuB,IAAIQ,UACV/B,MAAME,QAAQP,wBAAwBE,KAAKF,sBAAsBqC,KAAKD,aAI1EJ,UAAU7B,YAAY,sBAAsBe,SAAS,sBAGrDR,6BAMK4B,uBACavC,EAAE,sCACRK,MAAgB,eACpBC,MAAQN,EAAEO,MACViC,WAAalC,MAAME,QAAQ,8BAC3BF,MAAMS,KAAK,YACXyB,WAAWrB,SAAS,YACpBqB,WAAWrC,KAAK,2BAA2BY,KAAK,YAAY,KAE5DyB,WAAWpC,YAAY,YACvBoC,WAAWrC,KAAK,UAAUY,KAAK,YAAY,aAKhD,CACH0B,KAAM,eACEC,MAAQ1C,EAAE,qBACd0C,MAAMvC,KAAKF,kBAAkBI,MAAgB,eACrCC,MAAQN,EAAEO,MACdD,MAAMqB,KAAK,eAAgBrB,MAAMuB,UAErCa,MAAMC,GAAG,SAAU1C,iBAAkBoB,mBACrCqB,MAAMC,GAAG,SAAU,oBAAqBvB,oBACxCsB,MAAMC,GAAG,SAAU,mBAAoBJ,sBACvC5B"}