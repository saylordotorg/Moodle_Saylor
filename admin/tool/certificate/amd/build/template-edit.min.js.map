{"version":3,"file":"template-edit.min.js","sources":["../src/template-edit.js"],"sourcesContent":["// This file is part of the tool_certificate plugin for Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module used when editing a single template\n *\n * @module     tool_certificate/template-edit\n * @copyright  2019 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'jqueryui', 'tool_certificate/modal_form', 'core/notification', 'core/str', 'core/ajax', 'core/sortable_list'],\nfunction($, jqui, ModalForm, Notification, Str, Ajax, SortableList) {\n    var editReportDetailsHandler = function(e) {\n        e.preventDefault();\n        var el = $(e.currentTarget),\n            id = el.attr('data-id'),\n            name = el.attr('data-name');\n\n        var modal = new ModalForm({\n            formClass: 'tool_certificate\\\\form\\\\details',\n            args: {id: id},\n            modalConfig: {title: Str.get_string('editcertificate', 'tool_certificate', name)},\n            saveButtonText: Str.get_string('save'),\n            triggerElement: el,\n        });\n        modal.onSubmitSuccess = function() {\n            window.location.reload();\n        };\n    };\n\n    var deleteElement = function(e) {\n        e.preventDefault();\n        Str.get_strings([\n            {key: 'confirm', component: 'moodle'},\n            {key: 'deleteelementconfirm', component: 'tool_certificate', param: $(e.currentTarget).attr('data-name')},\n            {key: 'delete', component: 'moodle'},\n            {key: 'cancel', component: 'moodle'}\n        ]).done(function(s) {\n            Notification.confirm(s[0], s[1], s[2], s[3], function() {\n                var promises = Ajax.call([\n                    {methodname: 'tool_certificate_delete_element',\n                        args: {id: $(e.currentTarget).attr('data-id')}}\n                ]);\n                promises[0].done(function() {\n                    // TODO reload only list of elements.\n                    window.location.reload();\n                }).fail(Notification.exception);\n            });\n        }).fail(Notification.exception);\n    };\n\n    var editElement = function(e) {\n        e.preventDefault();\n        if ($(e.currentTarget).hasClass('isdragged')) {\n            return;\n        }\n        var modal = new ModalForm({\n            formClass: 'tool_certificate\\\\edit_element_form',\n            args: {id: $(e.currentTarget).attr('data-id')},\n            modalConfig: {title: Str.get_string('editelement', 'tool_certificate', $(e.currentTarget).attr('data-name'))},\n            saveButtonText: Str.get_string('save'),\n            triggerElement: $(e.currentTarget),\n        });\n        modal.onSubmitSuccess = function() {\n            window.location.reload();\n        };\n    };\n\n    var addElement = function(e) {\n        e.preventDefault();\n        var pageid = $(e.currentTarget).attr('data-pageid'),\n            type = $(e.currentTarget).attr('data-element');\n        var modal = new ModalForm({\n            formClass: 'tool_certificate\\\\edit_element_form',\n            args: {pageid: pageid, element: type},\n            modalConfig: {title: Str.get_string('addelementwithname', 'tool_certificate', $(e.currentTarget).text())},\n            saveButtonText: Str.get_string('save'),\n            triggerElement: $(e.currentTarget),\n        });\n        modal.onSubmitSuccess = function() {\n            window.location.reload();\n        };\n    };\n\n    var deletePage = function(e) {\n        e.preventDefault();\n        Str.get_strings([\n            {key: 'confirm', component: 'moodle'},\n            {key: 'deletepageconfirm', component: 'tool_certificate'},\n            {key: 'delete', component: 'moodle'},\n            {key: 'cancel', component: 'moodle'}\n        ]).done(function(s) {\n            Notification.confirm(s[0], s[1], s[2], s[3], function() {\n                window.location.href = $(e.currentTarget).attr('href');\n            });\n        }).fail(Notification.exception);\n    };\n\n    var addPage = function(e) {\n        e.preventDefault();\n        var modal = new ModalForm({\n            formClass: 'tool_certificate\\\\form\\\\page',\n            args: {templateid: $('[data-region=\"template\"][data-id]').attr('data-id')},\n            modalConfig: {title: Str.get_string('addcertpage', 'tool_certificate')},\n            saveButtonText: Str.get_string('save'),\n            triggerElement: $(e.currentTarget),\n        });\n        modal.onSubmitSuccess = function() {\n            window.location.reload();\n        };\n    };\n\n    var editPage = function(e) {\n        e.preventDefault();\n        var modal = new ModalForm({\n            formClass: 'tool_certificate\\\\form\\\\page',\n            args: {id: $(e.currentTarget).attr('data-id')},\n            modalConfig: {title: Str.get_string('editpage', 'tool_certificate', $(e.currentTarget).attr('data-pagenumber'))},\n            saveButtonText: Str.get_string('save'),\n            triggerElement: $(e.currentTarget),\n        });\n        modal.onSubmitSuccess = function() {\n            window.location.reload();\n        };\n    };\n\n    var initSorting = function() {\n        $('[data-region=\"page\"]').each(function() {\n            var sortablelist = new SortableList($(this).find('[data-region=\"elementlist\"]'));\n            sortablelist.getElementName = function(element) {\n                return $.Deferred().resolve(element.find('a.quickeditlink').text());\n            };\n            $(this).on(SortableList.EVENTS.DROP, '[data-region=\"elementlist\"] > *', function(_, info) {\n                if (info.positionChanged) {\n                    var request = {\n                        methodname: 'tool_certificate_update_element',\n                        args: {id: info.element.data('id'), sequence: info.element.index() + 1}\n                    };\n                    Ajax.call([request])[0].fail(Notification.exception);\n                }\n            });\n        });\n    };\n\n    var mmToPx = function(value) {\n        // TODO replace 2 with a ratio.\n        return parseFloat(value) * 2;\n    };\n\n    var pxToMm = function(value) {\n        // TODO replace 2 with a ratio.\n        return Math.round(parseFloat(value) / 2);\n    };\n\n    var ptToPx = function(value) {\n        // 1pt = 1/72 inch = 0.352778 mm .\n        return mmToPx(value) * 0.352778;\n    };\n\n    var recalculatePDF = function() {\n        var page = $(this);\n        page.css(\"width\", mmToPx(page.data('pagewidth')) + 'px');\n        page.css(\"height\", mmToPx(page.data('pageheight')) + 'px');\n        page.find('[data-width]').each(function() {\n            $(this).css('width', mmToPx($(this).data('width')) + 'px');\n        });\n        page.find('[data-height]').each(function() {\n            $(this).css('height', mmToPx($(this).data('height')) + 'px');\n        });\n        page.find('[data-fontsize]').each(function() {\n            $(this).css('font-size', ptToPx($(this).data('fontsize')) + 'px');\n        });\n        page.find('[data-posy]').each(function() {\n            $(this).css('top', mmToPx($(this).data('posy')) + 'px');\n        });\n        page.find('[data-posx]').each(function() {\n            // For elements with a refpoint calculate the posx of the top left corner.\n            // Refpoint=0 - no change, =1 - move left by half of the width, =2 - move left by the width.\n            var left = mmToPx($(this).data('posx')),\n                refpoint = $(this).data('refpoint') ? parseInt($(this).data('refpoint')) : 0,\n                offset = refpoint ? parseInt($(this).width()) * refpoint / 2 : 0;\n            $(this).css(\"left\", (left - offset) + 'px');\n        });\n        page.addClass('recalculated');\n        // Init draggable.\n        page.find('[data-drag-type=\"move\"]').draggable();\n    };\n\n    var initDraggable = function() {\n        var selector = '[data-region=\"pdf\"] [data-drag-type=\"move\"]';\n        $('body')\n            .on('mousedown', selector, function(e) {\n                var el = $(e.currentTarget),\n                    page = el.closest('[data-region=\"pdf\"]');\n                // Set element \"pagecenter\" to be the same width as this element and place it in the page center.\n                page.find('[data-region=\"pagecenter\"]')\n                    .css(\"left\", (mmToPx(page.data('pagecentre')) - el.width() / 2) + \"px\")\n                    .css(\"width\", el.width() + \"px\");\n                el.draggable({\n                    // Snap to elements only if Shift is not held.\n                    snap: e.shiftKey ? false : '.snapdraggable',\n                    snapMode: 'inner',\n                    snapTolerance: 10,\n                    // Set containment so it can't be moved far away from the page outlines.\n                    containment: [\n                        page.offset().left - el.width(),\n                        page.offset().top - el.height(),\n\n                        page.offset().left + mmToPx(page.data('pagewidth')),\n                        page.offset().top + mmToPx(page.data('pageheight'))\n                    ],\n                });\n            })\n            .on('dragstart', selector, function(e) {\n                $(e.currentTarget).addClass('isdragged');\n            })\n            .on('dragstop', selector, function(e) {\n                var el = $(e.currentTarget),\n                    page = el.closest('[data-region=\"pdf\"]'),\n                    refpoint = parseInt($(this).data('refpoint')),\n                    offset = refpoint ? parseInt($(this).width()) * refpoint / 2 : 0,\n                    left = pxToMm(el.offset().left - page.offset().left + offset),\n                    top = pxToMm(el.offset().top - page.offset().top);\n                setTimeout(function() {\n                    el.removeClass('isdragged');\n                }, 100);\n                var request = {\n                    methodname: 'tool_certificate_update_element',\n                    args: {id: el.data('id'), posx: left, posy: top}\n                };\n                Ajax.call([request])[0].fail(Notification.exception);\n            });\n    };\n\n    return {\n        init: function() {\n            // Add button is not inside a tab, so we can't use Tab.addButtonOnClick .\n            $('[data-action=\"editdetails\"]').on('click', editReportDetailsHandler);\n            $('[data-action=\"deleteelement\"]').on('click', deleteElement);\n            $('[data-action=\"editelement\"]').on('click', editElement);\n            $('[data-action=\"addelement\"]').on('click', addElement);\n            $('[data-action=\"deletepage\"]').on('click', deletePage);\n            $('[data-element=\"addbutton\"]').on('click', addPage);\n            $('[data-action=\"editpage\"]').on('click', editPage);\n            initSorting();\n            initDraggable();\n            $('[data-region=\"pdf\"]').each(recalculatePDF);\n        }\n    };\n});\n"],"names":["define","$","jqui","ModalForm","Notification","Str","Ajax","SortableList","editReportDetailsHandler","e","preventDefault","el","currentTarget","id","attr","name","formClass","args","modalConfig","title","get_string","saveButtonText","triggerElement","onSubmitSuccess","window","location","reload","deleteElement","get_strings","key","component","param","done","s","confirm","call","methodname","fail","exception","editElement","hasClass","addElement","pageid","type","element","text","deletePage","href","addPage","templateid","editPage","mmToPx","value","parseFloat","pxToMm","Math","round","recalculatePDF","page","this","css","data","find","each","left","refpoint","parseInt","offset","width","addClass","draggable","init","selector","on","getElementName","Deferred","resolve","EVENTS","DROP","_","info","positionChanged","request","sequence","index","closest","snap","shiftKey","snapMode","snapTolerance","containment","top","height","setTimeout","removeClass","posx","posy"],"mappings":"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"}