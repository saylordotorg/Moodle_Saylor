define ("tool_trigger/step_select",["jquery","core/str","core/modal_factory","core/modal_events","core/templates","core/ajax","core/fragment","core/notification"],function(a,b,c,d,e,f,g,h){var u={},v,w,x="<p class=\"text-center\"><i class=\"fa fa-spinner fa-pulse fa-2x fa-fw\"></i><span class=\"sr-only\">Loading...</span></p>";function i(){var b=a("[name=stepjson]").val(),c=[];if(""!==b){c=JSON.parse(b)}return c}function j(b){a("[name=stepjson]").val(JSON.stringify(b));a("[name=isstepschanged]").val(1)}function k(){var a={jsonformdata:JSON.stringify({})};w.setBody(x);w.setBody(g.loadFragment("tool_trigger","new_base_form",v,a))}function l(b){var c=b.map(function(a,b){return{name:a.name,typedesc:a.typedesc,stepdesc:a.stepdesc,steporder:b}});e.render("tool_trigger/workflow_steps",{rows:c}).then(function(b){a("#steps-table").html(b);t()}).fail(function(){h.exception({message:"Error updating steps table"})})}function m(b){b.preventDefault();var c=w.getRoot().find("form"),d=c.serializeArray().reduce(function(a,b){if(b.name.endsWith("[]")){var c=b.name.substring(0,b.name.length-2);if(a[c]===void 0){a[c]=[b.value]}else{a[c].push(b.value)}}else if("sesskey"!==b.name&&!b.name.startsWith("_qf__")&&!b.value.startsWith("_qf__")){a[b.name]=b.value}return a},{});d.stepdesc=a("[name=stepclass] option:selected").text();d.typedesc=a("[name=type] option:selected").text();f.call([{methodname:"tool_trigger_validate_form",args:{stepclass:d.stepclass,jsonformdata:JSON.stringify(c.serialize())}}])[0].done(function(){var a=i();if(0<=d.steporder){a[d.steporder]=d}else{a.push(d);d.steporder=a.length-1}j(a);l(a);w.hide()}).fail(function(){q(d.type,d.stepclass,"",c.serialize())})}function n(b){a("[name=stepclass]").empty().append(a("<option>",{value:"",text:"Choose..."}));a.each(b,function(b,c){a("[name=stepclass]").append(a("<option>",{value:c.class,text:c.name}))})}function o(a){f.call([{methodname:"tool_trigger_step_by_type",args:{steptype:a}}])[0].done(function(a){n(a)})}function p(){var b=a("[name=eventtomonitor]").val();return b}function q(a,b,c,d,e){if(c===void 0){c=""}if(d===void 0){d=""}if(e===void 0){e=0}w.setBody(x);w.setBody(g.loadFragment("tool_trigger","new_step_form",v,{steptype:a,stepclass:b,defaults:JSON.stringify(c),ajaxformdata:d,event:p(),existingsteps:JSON.stringify(i()),steporder:e}))}function r(){a("body").on("change","[name=type]",function(){o(this.value)});a("body").on("change","[name=stepclass]",function(){var b=a("[name=type]").val(),c=this.value;q(b,c,"","",-1)})}function s(b,c,d){var e=b[c],f=b[d];e.steporder=d;f.steporder=d;b[c]=f;b[d]=e;var g=a("tr.tool-trigger-step-table-row"),h=g.eq(c),i=g.eq(d),k=h.height(),m=i.height(),n=h.find("th").css("background-color"),o=i.find("th").css("background-color");a([h,i]).each(function(a,b){b[0].style.position="relative";b[0].style.top="0";b[0].style.transition="top 400ms";b.find("th,td").each(function(a,b){b.style.transition="background-color 400ms"})});window.setTimeout(function(){h[0].style.top=m+"px";h.find("td,th").each(function(a,b){b.style.backgroundColor=o});i[0].style.top=-1*k+"px";i.find("td,th").each(function(a,b){b.style.backgroundColor=n})});h.find(".tool-trigger-step-movedown").fadeTo(400,.1);i.find(".tool-trigger-step-moveup").fadeTo(400,.1).promise().always(function(){j(b);l(b)})}function t(){a(".tool-trigger-step-moveup").slice(1).removeClass("tool-trigger-initial-hidden").on("click",function(){var b=i(),c=a(this).data("steporder");if(0===c){return!0}s(b,c-1,c);return!0});a(".tool-trigger-step-movedown").slice(0,-1).removeClass("tool-trigger-initial-hidden").on("click",function(){var b=i(),c=a(this).data("steporder");if(c>=b.length-1){return!0}s(b,c,c+1);return!0});a(".tool-trigger-step-edit").removeClass("tool-trigger-initial-hidden").on("click",function(){w.setBody(x);w.show();var b=i(),c=a(this).data("steporder"),d=b[c];q(d.type,d.stepclass,d,void 0,c)});a(".tool-trigger-step-delete").removeClass("tool-trigger-initial-hidden").on("click",function(){var b=i(),c=a(this).data("steporder");b.splice(c,1);if(c<=b.length){b.slice(c).forEach(function(a){a.steporder=a.steporder-1})}j(b);a(this).closest("tr").fadeOut(function(){l(b)});return!0})}u.init=function(e){v=e;b.get_string("modaltitle","tool_trigger").then(function(b){c.create({type:c.types.SAVE_CANCEL,title:b,body:x,large:!0},a("#id_stepmodalbutton")).done(function(a){w=a;w.getRoot().on(d.save,m);w.getRoot().on(d.hidden,k);r();k()})});t()};return u});
//# sourceMappingURL=step_select.min.js.map
